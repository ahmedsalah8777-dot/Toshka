<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… ØªØ´ØºÙŠÙ„ Ù…Ø­Ø·Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø°ÙƒÙŠ (Toshka V1.5)</title>
    <style>
        :root {
            --primary-color: #1a5276;
            --secondary-color: #2e86c1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --light-bg: #f4f6f7;
            --card-bg: #ffffff;
            --header-bg: #eaf2f8;
            --scada-fault-color: #e67e22;
            --blue-fault: #87CEFA;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--light-bg); color: #333; line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 1400px; margin: 0 auto; padding: 10px; flex: 1; width: 100%; }
        
        /* Header */
        header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: bold; }
        
        /* Ticker Styles */
        .ticker-container { background-color: var(--danger-color); color: white; height: 40px; overflow: hidden; border-radius: 4px; margin-bottom: 15px; display: none; align-items: center; box-shadow: 0 3px 5px rgba(0,0,0,0.1); border: 2px solid #922b21; }
        .ticker-container.active { display: flex; }
        .ticker-label { background: rgba(0,0,0,0.3); height: 100%; padding: 0 10px; display: flex; align-items: center; font-weight: bold; white-space: nowrap; z-index: 2; }
        .ticker-text-wrap { flex: 1; overflow: hidden; white-space: nowrap; position: relative; height: 100%; display: flex; align-items: center; }
        .ticker { display: inline-block; white-space: nowrap; padding-right: 100%; animation-name: ticker; animation-timing-function: linear; animation-iteration-count: infinite; }
        .ticker-item { display: inline-flex; align-items: center; gap: 5px; padding: 0 2px; font-weight: bold; font-size: 1rem; color: white !important; }
        .ticker-separator { display: inline-block; margin: 0 8px; color: rgba(255, 255, 255, 0.8); font-weight: normal; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(100%, 0, 0); } }

        /* User Info & Alarm */
        .user-info { display: none; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .alarm-btn { background: transparent; border: none; color: white; font-size: 1.4rem; cursor: pointer; position: relative; margin-left: 10px; }
        .alarm-btn.flashing { animation: bell-shake 1s infinite cubic-bezier(.36,.07,.19,.97) both, red-glow 1.5s infinite; color: #ffcccc; }
        .alarm-count { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        
        @keyframes bell-shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes red-glow { 0% { text-shadow: 0 0 5px red; } 50% { text-shadow: 0 0 20px red; } 100% { text-shadow: 0 0 5px red; } }

        /* Shift Warning Icon (Red Bubble) */
        .missed-update-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; background-color: #e74c3c; color: white;
            border-radius: 50%; font-size: 14px; font-weight: bold; margin-right: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: pulse-red 2s infinite; vertical-align: middle;
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        /* UI Components */
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 5px; font-size: 14px; justify-content: center; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .btn-primary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-outline { background-color: transparent; border: 1px solid var(--secondary-color); color: var(--secondary-color); }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .screen { display: none; background: var(--card-bg); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 15px; margin-top: 15px; min-height: 500px; }
        .active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--primary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; font-size: 1.2rem; }
        
        /* Grid System */
        .stations-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        .station-details { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 20px; }
        .dashboard-stats { display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }

        /* Mobile Responsive Modifications */
        @media (max-width: 768px) {
            .stations-grid { grid-template-columns: 1fr 1fr !important; gap: 8px; }
            .station-card { padding: 8px; font-size: 0.85rem; }
            .station-card div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .dashboard-stats { display: flex !important; flex-direction: row; gap: 5px; }
            .dashboard-stats .stat-card { flex: 1; padding: 8px; text-align: center; min-width: 0; }
            .dashboard-stats .stat-label { font-size: 0.75rem; white-space: nowrap; }
            .dashboard-stats .stat-value { font-size: 1.1rem; }
        }
        
        .stat-card, .station-card, .detail-card { background: var(--card-bg); border-radius: 8px; padding: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .station-card { border-top: 4px solid var(--secondary-color); cursor: pointer; transition: 0.3s; padding: 10px; font-size: 0.95rem; position: relative; overflow: hidden; }
        .station-card:active { transform: scale(0.98); }
        .station-card.fault-active { border-top-color: var(--danger-color); animation: card-flash 2s infinite; background-color: #fff5f5; border: 1px solid var(--danger-color); }
        .station-card.fault-active.scada-fault { border-top-color: var(--scada-fault-color); background-color: #fffaf0; border: 1px solid var(--scada-fault-color); }
        
        @keyframes card-flash { 
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } 
        }
        
        .fault-badge { display: flex; align-items: center; justify-content: center; gap: 5px; background: var(--danger-color); color: white; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; margin-top: 5px; text-align: center; font-weight: bold; }
        .fault-badge.scada-badge { background: var(--scada-fault-color); }

        .stat-value { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .detail-title { font-size: 0.9rem; color: #777; margin-bottom: 5px; }
        .detail-value { font-size: 1.2rem; font-weight: 600; color: #333; word-break: break-all; }
        .detail-value.operator-highlight { color: var(--secondary-color); }

        .table-responsive { overflow-x: auto; margin-top: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background-color: var(--primary-color); color: white; padding: 12px; text-align: right; }
        td { padding: 10px 12px; text-align: right; border-bottom: 1px solid #eee; vertical-align: top; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        
        .station-status { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-inactive { background-color: #f8d7da; color: #721c24; }

        .zone-separator { grid-column: 1 / -1; background-color: var(--header-bg); color: var(--primary-color); padding: 10px 15px; border-radius: 6px; margin-top: 20px; margin-bottom: 10px; font-weight: bold; font-size: 1.1rem; border-right: 5px solid var(--secondary-color); display: flex; justify-content: space-between; align-items: center; }
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .nav-tab { padding: 8px 16px; border-radius: 20px; background: #eee; cursor: pointer; white-space: nowrap; border:none; }
        .nav-tab.active { background-color: var(--secondary-color); color: white; }
        
        .password-container { position: relative; }
        .toggle-password { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; justify-content: flex-start; margin-bottom: 15px; }
        .checkbox-group input { width: auto; margin: 0; }
        .pump-controls { display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        .pump-control { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .alert { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .alert-success { background-color: #d4edda; color: #155724; }
        .signature { text-align: center; margin-top: 30px; font-size: 12px; color: #888; border-top: 1px solid #eee; padding-top: 15px; font-weight: bold; }
        .login-form { max-width: 400px; margin: 40px auto; text-align: center; }
        
        .pagination-controls { text-align: center; margin-top: 20px; padding-bottom: 20px; }
        .status-text { font-size: 0.85rem; color: #666; margin-bottom: 10px; }
        
        .scada-icon-svg { vertical-align: text-bottom; }
        .fault-row-action { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-right: 3px solid var(--danger-color); }
        .desc-input { margin-top: 5px; font-size: 0.9rem; background: #fff; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i>ğŸ’§</i> <span>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø°ÙƒÙŠ (Toshka)</span>
                </div>
                <div class="user-info" id="header-user-info">
                    <button id="alarm-btn" class="alarm-btn" title="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„">
                        ğŸ””
                        <span id="alarm-count" class="alarm-count" style="display:none">0</span>
                    </button>
                    <div class="user-badge" id="current-user">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
                    <button id="users-management-btn" class="btn btn-warning" style="display: none;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                    <button id="history-management-btn" class="btn btn-info" style="display: none;">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…</button>
                    <button id="logout-btn" class="btn btn-danger">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="login-screen" class="screen active">
            <div class="login-form">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="password-container">
                        <input type="password" id="password" placeholder="admin123">
                        <span class="toggle-password" id="toggle-password-icon">ğŸ‘ï¸</span>
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">ØªØ°ÙƒØ±Ù†ÙŠ</label>
                </div>
                <button id="login-btn" class="btn" style="width: 100%; background-color: #bdc3c7; color: #fff; cursor: not-allowed;" disabled>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</button>
            </div>
            <div class="signature">Implemented by Ahmed Salah Ibrahim 2025 V1.5.8</div>
        </div>

        <div id="stations-screen" class="screen">
            <div id="ticker-container" class="ticker-container">
                <div class="ticker-label">âš ï¸</div>
                <div class="ticker-text-wrap">
                    <div id="ticker-content" class="ticker"></div>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card"><div class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="stat-value" id="total-stations">0</div></div>
                <div class="stat-card"><div class="stat-label">Ø§Ù„Ù†Ø´Ø·Ø©</div><div class="stat-value" id="active-stations">0</div></div>
                <div class="stat-card"><div class="stat-label">Ø§Ù„Ù…ØªÙˆÙ‚ÙØ©</div><div class="stat-value" id="inactive-stations">0</div></div>
            </div>
            <div id="repair-alert" class="alert alert-success" style="display:none; margin-top:10px;"></div>
            <div class="nav-tabs" id="zones-tabs"></div>
            <div id="stations-container" class="stations-wrapper">
                <div style="text-align:center; padding:20px; color:#666;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª...</div>
            </div>
        </div>

        <div id="station-screen" class="screen">
            <h2 id="station-title">Ø§Ù„ØªÙØ§ØµÙŠÙ„</h2>
            <button id="back-to-stations" class="btn btn-outline">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            
            <div id="station-fault-banner" class="alert" style="background: #ffecec; color: #b71c1c; border: 1px solid #ffcdd2; margin-top: 15px; display: none;">
                <div style="margin-bottom: 5px;">âš ï¸ <b>Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</b></div>
                <ul id="station-fault-list" style="padding-right: 20px; margin: 0;"></ul>
            </div>

            <div class="station-details" style="margin-top: 20px;">
                <div class="detail-card"><div class="detail-title">Ø§Ù„Ø­Ø§Ù„Ø©</div><div class="detail-value" id="station-status-value">-</div></div>
                <div class="detail-card"><div class="detail-title">Ø§Ù„Ù…Ø´ØºÙ„</div><div class="detail-value operator-highlight" id="operator-name-value">-</div></div>
                <div class="detail-card"><div class="detail-title">Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ (V)</div><div class="detail-value" id="voltage-value">-</div></div>
                <div class="detail-card"><div class="detail-title">Ø§Ù„Ø¶ØºØ· (Bar)</div><div class="detail-value" id="station-pressure-value">-</div></div>
                <div class="detail-card"><div class="detail-title">Ø§Ù„Ù…Ø¶Ø®Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„Ø©</div><div class="detail-value" id="active-pumps-value">-</div></div>
                <div class="detail-card"><div class="detail-title">Ø§Ù„ØªØ¯ÙÙ‚ (L/Sec)</div><div class="detail-value" id="water-flow-value">-</div></div>
                <div class="detail-card"><div class="detail-title">Ø§Ù„Ù†Ø¸Ø§Ù…</div><div class="detail-value" id="system-mode-value">-</div></div>
                
                <div style="grid-column: 1 / -1; display: flex; gap: 10px;">
                    <div class="detail-card" style="flex: 1;"><div class="detail-title">ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„</div><div class="detail-value" id="start-time-value" style="color:var(--success-color); font-weight:bold;">-</div></div>
                    <div class="detail-card" style="flex: 1;"><div class="detail-title">ÙˆÙ‚Øª Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù</div><div class="detail-value" id="stop-time-value" style="color:var(--danger-color); font-weight:bold;">-</div></div>
                </div>

                <div class="detail-card"><div class="detail-title">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« (System)</div><div class="detail-value" id="last-update-value" style="font-size:0.8rem; color:#666;">-</div></div>
                
                <div class="detail-card" style="grid-column: 1 / -1; background-color: #fffde7;">
                    <div class="detail-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</div>
                    <div class="detail-value" id="station-comments-value" style="font-weight: normal; font-size: 1rem;">-</div>
                </div>
            </div>
            <h3>Ø§Ù„Ù…Ø¶Ø®Ø§Øª</h3>
            <div class="table-responsive">
                <table class="pumps-table">
                    <thead><tr><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø³Ø­Ø¨</th><th>Ø·Ø±Ø¯</th><th>ØªØ±Ø¯Ø¯</th></tr></thead>
                    <tbody id="pumps-table-body"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px;">
                <button id="edit-station-btn" class="btn btn-primary" style="width: 100%;">ØªØ¹Ø¯ÙŠÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„</button>
            </div>
        </div>

        <div id="operator-screen" class="screen">
            <h2>ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</h2>
            <h3 id="editing-station-name" style="text-align: center; color: var(--secondary-color); margin-bottom: 20px; border-bottom: none;"></h3>
            <button id="back-to-station" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
            <div id="operator-alert" class="alert"></div>

            <div id="active-fault-control" style="background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
                <h4 style="color: #856404; margin-bottom: 10px;">ğŸ›‘ ØªÙ†Ø¨ÙŠÙ‡: Ø£Ø¹Ø·Ø§Ù„ Ù†Ø´Ø·Ø©</h4>
                <div id="fault-row-1" class="fault-row-action" style="display:none;">
                    <div><span style="font-weight:bold;">Ø¹Ø·Ù„ 1:</span> <span id="txt-fault-1"></span></div>
                    <button id="btn-resolve-f1" class="btn btn-success btn-sm">âœ… Ø¥ØµÙ„Ø§Ø­</button>
                </div>
                <div id="fault-row-2" class="fault-row-action" style="display:none;">
                    <div><span style="font-weight:bold;">Ø¹Ø·Ù„ 2:</span> <span id="txt-fault-2"></span></div>
                    <button id="btn-resolve-f2" class="btn btn-success btn-sm">âœ… Ø¥ØµÙ„Ø§Ø­</button>
                </div>
            </div>

            <div class="operator-form">
                <div class="form-section">
                    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø©</h3>
                    <div class="form-group"><label>Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><input type="text" id="operator-name" readonly style="background: #eee;"></div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„ ğŸŸ¢</label>
                            <input type="time" id="operator-start-time" style="direction: ltr;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>ÙˆÙ‚Øª Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ğŸ”´</label>
                            <input type="time" id="operator-stop-time" style="direction: ltr;">
                        </div>
                    </div>

                    <div class="form-group"><label>Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ (V)</label><input type="number" id="operator-voltage"></div>
                    <div class="form-group"><label>Ø§Ù„Ø¶ØºØ· (Bar)</label><input type="number" id="operator-pressure" step="0.1"></div>
                    <div class="form-group"><label>Ø§Ù„ØªØ¯ÙÙ‚ (L/Sec)</label><input type="number" id="operator-water-flow"></div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù†Ø¸Ø§Ù…</label>
                        <select id="operator-system-mode">
                            <option value="SCADA">SCADA</option><option value="PLC">PLC</option><option value="MIMIC">MIMIC</option><option value="LCP">LCP</option><option value="Marshlling">Marshlling</option><option value="HMI">HMI</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¶Ø®Ø§Øª</h3>
                    <div id="pumps-form-container" class="pump-controls"></div>
                </div>
                <div class="form-section">
                    <div class="form-group" style="border: 2px dashed var(--danger-color); padding: 10px; border-radius: 6px; background: #fff5f5;">
                        <label style="color: var(--danger-color);">âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ Ø¬Ø¯ÙŠØ¯</label>
                        <div id="fault-selectors-group">
                            <label style="font-size:0.9rem; margin-top:5px;">Ø¹Ø·Ù„ Ø±Ù‚Ù… (1):</label>
                            <select id="fault-selector" style="border-color: var(--danger-color);">
                                <option value="">-- Ø§Ù„Ù…Ø­Ø·Ø© ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ --</option>
                                <option value="Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ">Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ âš¡</option>
                                <option value="Ø§Ù†Ø®ÙØ§Ø¶ Ø¬Ù‡Ø¯">Ø§Ù†Ø®ÙØ§Ø¶ Ø¬Ù‡Ø¯ âš¡ğŸ“‰</option>
                                <option value="Ø§Ø±ØªÙØ§Ø¹ Ø¬Ù‡Ø¯">Ø§Ø±ØªÙØ§Ø¹ Ø¬Ù‡Ø¯ âš¡ğŸ“ˆ</option>
                                <option value="Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ù†Ø³ÙˆØ¨">Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ù†Ø³ÙˆØ¨ ğŸ“‰</option>
                                <option value="ØªÙˆÙ‚Ù Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±">ØªÙˆÙ‚Ù Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ âš™ï¸</option>
                                <option value="Ø§Ù†Ø³Ø¯Ø§Ø¯Ø§Øª">Ø§Ù†Ø³Ø¯Ø§Ø¯Ø§Øª â–¦</option>
                                <option value="ØªØ³Ø±ÙŠØ¨ Ù…ÙŠØ§Ù‡">ØªØ³Ø±ÙŠØ¨ Ù…ÙŠØ§Ù‡ Ø¨Ø§Ù„Ù…Ø­Ø·Ø© ğŸ’§</option>
                                <option value="ÙƒØ³Ø± ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©">ÙƒØ³Ø± ÙÙŠ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸ› ï¸</option>
                                <option value="Ø¹Ø¬Ø² ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ØºØ·">Ø¹Ø¬Ø² ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ØºØ· ğŸ”»</option>
                                <option value="Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA">Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA ğŸ“¡</option>
                            </select>
                            <input type="text" id="fault-1-desc" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="desc-input">

                            <label style="font-size:0.9rem; margin-top:10px;">Ø¹Ø·Ù„ Ø±Ù‚Ù… (2):</label>
                            <select id="fault-selector-secondary" style="border-color: #e67e22;">
                                <option value="">-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø·Ù„ Ø¢Ø®Ø± --</option>
                                <option value="Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ">Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ âš¡</option>
                                <option value="Ø§Ù†Ø®ÙØ§Ø¶ Ø¬Ù‡Ø¯">Ø§Ù†Ø®ÙØ§Ø¶ Ø¬Ù‡Ø¯ âš¡ğŸ“‰</option>
                                <option value="Ø§Ø±ØªÙØ§Ø¹ Ø¬Ù‡Ø¯">Ø§Ø±ØªÙØ§Ø¹ Ø¬Ù‡Ø¯ âš¡ğŸ“ˆ</option>
                                <option value="Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ù†Ø³ÙˆØ¨">Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ù†Ø³ÙˆØ¨ ğŸ“‰</option>
                                <option value="ØªÙˆÙ‚Ù Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±">ØªÙˆÙ‚Ù Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ âš™ï¸</option>
                                <option value="Ø§Ù†Ø³Ø¯Ø§Ø¯Ø§Øª">Ø§Ù†Ø³Ø¯Ø§Ø¯Ø§Øª â–¦</option>
                                <option value="ØªØ³Ø±ÙŠØ¨ Ù…ÙŠØ§Ù‡">ØªØ³Ø±ÙŠØ¨ Ù…ÙŠØ§Ù‡ Ø¨Ø§Ù„Ù…Ø­Ø·Ø© ğŸ’§</option>
                                <option value="ÙƒØ³Ø± ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©">ÙƒØ³Ø± ÙÙŠ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ÙŠØ§Ù‡ ğŸ› ï¸</option>
                                <option value="Ø¹Ø¬Ø² ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ØºØ·">Ø¹Ø¬Ø² ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ØºØ· ğŸ”»</option>
                                <option value="Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA">Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA ğŸ“¡</option>
                            </select>
                            <input type="text" id="fault-2-desc" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="desc-input">
                        </div>
                    </div>

                    <div class="form-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</label><textarea id="operator-comments" rows="3"></textarea></div>
                    <div class="form-actions"><button id="save-operator-data" class="btn btn-success" style="width: 100%;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></div>
                </div>
            </div>
        </div>

        <div id="faults-log-screen" class="screen">
            <h2 style="color: var(--danger-color);">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</h2>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="back-to-stations-from-faults" class="btn btn-outline">Ø¹ÙˆØ¯Ø©</button>
            </div>
            
            <div style="margin-top:20px;">
                <h3 style="margin-bottom:10px;">Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                <div class="table-responsive">
                    <table class="faults-table">
                        <thead><tr><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡</th><th>Ø§Ù„Ù…Ø¯Ø©</th></tr></thead>
                        <tbody id="active-faults-body"></tbody>
                    </table>
                </div>
                
                <h3 style="margin-bottom:10px; margin-top:30px;">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: #fff3cd; padding: 10px; border-radius: 6px; border: 1px solid #ffeeba;">
                    <label style="margin:0; font-weight:bold;">ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙŠÙ:</label>
                    <select id="fault-archive-station-filter" style="flex:1; max-width:300px;" onchange="appData.faultsLimit=100; renderFaultsLog();">
                        <option value="all">-- Ø¹Ø±Ø¶ ÙƒØ§ÙØ© Ø§Ù„Ù…Ø­Ø·Ø§Øª --</option>
                    </select>
                </div>

                <div class="table-responsive">
                    <table class="faults-table">
                        <thead><tr><th>Ø§Ù„Ù…Ø­Ø·Ø©</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                        <tbody id="history-faults-body"></tbody>
                    </table>
                </div>
                <div class="pagination-controls">
                    <p id="faults-status-text" class="status-text"></p>
                    <button id="load-more-faults-btn" class="btn btn-warning" style="display: none; width: 200px; margin: 0 auto;">âš ï¸ Ø¹Ø±Ø¶ 100 Ø¹Ø·Ù„ Ø¥Ø¶Ø§ÙÙŠ</button>
                </div>
            </div>
        </div>

        <div id="users-screen" class="screen">
            <h2>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <button id="back-to-stations-from-users" class="btn btn-outline">Ø¹ÙˆØ¯Ø©</button>
            <div style="margin: 15px 0; display:flex; justify-content:space-between;">
                <h3>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
                <button id="add-user-btn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="user-form-container" style="display: none; background: #f9f9f9; padding: 15px; margin-top: 15px; border-radius: 8px; border: 1px solid #ddd;">
                <h4 id="user-form-title" style="margin-bottom:15px; color: var(--secondary-color);">Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                <div class="form-group"><input type="text" id="new-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></div>
                <div class="form-group"><input type="text" id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
                <div class="form-group">
                    <select id="new-user-type"></select>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="save-user-btn" class="btn btn-success" style="flex:1">Ø­ÙØ¸</button>
                    <button id="cancel-user-btn" class="btn btn-danger" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
            <div style="margin-bottom: 15px; margin-top: 15px;">
                <input type="text" id="search-user-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø§Ø³Ù…)..." onkeyup="renderUsersManagement()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>
            <div class="table-responsive">
                <table class="users-table">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="history-screen" class="screen">
            <h2>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…</h2>
            <button id="back-to-stations-from-history" class="btn btn-outline">Ø¹ÙˆØ¯Ø©</button>
            <div class="filters-container" style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                <div class="filter-item"><label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><select id="filter-zone" onchange="updateStationFilter()"><option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option></select></div>
                <div class="filter-item"><label>Ø§Ù„Ù…Ø­Ø·Ø©</label><select id="filter-station"><option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª</option></select></div>
                <div class="filter-item"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="filter-date-from"></div>
                <div class="filter-item"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="filter-date-to"></div>
                <div class="filter-item" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-primary" onclick="renderHistoryTable(true)" style="width:100%">Ø¨Ø­Ø« ÙˆØªØµÙÙŠØ©</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="history-table">
                    <thead><tr><th style="width:15%">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th><th style="width:15%">Ø§Ù„Ù…Ø­Ø·Ø©</th><th style="width:15%">Ø§Ù„Ù…Ø´ØºÙ„</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <p id="history-status-text" class="status-text"></p>
                <button id="load-more-history-btn" class="btn btn-primary" style="display: none; width: 200px; margin: 0 auto;">â¬‡ï¸ Ø¹Ø±Ø¶ 100 Ø³Ø¬Ù„ Ø¥Ø¶Ø§ÙÙŠ</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJiiq8qdeRFZkaHnEew-6sisbCRaypJQ8",
            authDomain: "toshka-4db86.firebaseapp.com",
            databaseURL: "https://toshka-4db86-default-rtdb.firebaseio.com",
            projectId: "toshka-4db86",
            storageBucket: "toshka-4db86.firebasestorage.app",
            messagingSenderId: "513322987318",
            appId: "1:513322987318:web:155e963acb3b97bc918d97"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        const faultIcons = {
            "Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ": "âš¡", "Ø§Ù†Ø®ÙØ§Ø¶ Ø¬Ù‡Ø¯": "âš¡ğŸ“‰", "Ø§Ø±ØªÙØ§Ø¹ Ø¬Ù‡Ø¯": "âš¡ğŸ“ˆ",
            "Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ù†Ø³ÙˆØ¨": "ğŸ“‰", "ØªÙˆÙ‚Ù Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±": "âš™ï¸", "Ø§Ù†Ø³Ø¯Ø§Ø¯Ø§Øª": "â–¦", 
            "ØªØ³Ø±ÙŠØ¨ Ù…ÙŠØ§Ù‡": "ğŸ’§", "ÙƒØ³Ø± ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©": "ğŸ› ï¸", "Ø¹Ø¬Ø² ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ØºØ·": "ğŸ”»",
            "Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA": `<svg viewBox="0 0 24 24" width="20" height="20" class="scada-icon-svg" style="color:#d32f2f;" fill="currentColor"><path d="M12 3C7.79 3 3.7 4.41 0.38 7L2.6 9.22C5.35 7.15 8.55 6 12 6C15.45 6 18.65 7.15 21.4 9.22L23.62 7C20.3 4.41 16.21 3 12 3Z" /><path d="M12 8C9.48 8 7.15 8.76 5.18 10.05L7.4 12.27C8.71 11.47 10.28 11 12 11C13.72 11 15.29 11.47 16.6 12.27L18.82 10.05C16.85 8.76 14.52 8 12 8Z" /><path d="M12 13L6 21H18L12 13ZM11 18H13V19.5H11V18ZM11 15.5H13V17.5H11V15.5Z" /></svg>`
        };
        let appData = {
            currentUser: null, currentStation: null, stations: {}, users: {},
            userTypes: {
                admin: { name: "Ù…Ø¯ÙŠØ±", permissions: ['view_all', 'edit_all', 'manage_users', 'add_users', 'view_history'] },
                engineer: { name: "Ù…Ù‡Ù†Ø¯Ø³", permissions: ['view_all', 'edit_all', 'view_history', 'manage_users'] },
                supervisor: { name: "Ù…Ø´Ø±Ù", permissions: ['view_all', 'edit_some', 'manage_users'] },
                operator: { name: "Ù…Ø´ØºÙ„", permissions: ['view_some', 'edit_own'] }
            },
            zones: ['Zone_A', 'Zone_B', 'Zone_C', 'Zone_D', 'Zone_E', 'Zone_F', 'Zone_G', 'Zone_H', 'Zone_I', 'Zone_J', 'Zone_K', 'Zone_L', 'Zone_O1', 'Zone_O2', 'Zone_O3', 'Zone_O4', 'Zone_O5', 'Zone_O2dashO6', 'Zone_O8', 'Zone_R', 'Zone_S'],
            operationHistory: [], faultsLog: [],
            historyLimit: 100, faultsLimit: 100
        };
        const pumpsData = {
            'A01': 4, 'A02': 4, 'A04': 2, 'A06': 5, 'A07': 5, 'A08': 4, 'A09': 5, 'A10': 5, 'A11': 5, 'A12': 5, 'A13': 5, 'A14': 4, 'A15': 4,
            'B01': 5, 'B02': 5, 'B03': 5, 'B04': 5, 'B05': 4, 'B06': 2, 'B07': 4, 'B08': 5, 'B09': 3, 'B10': 5, 'B11': 5, 'B12': 2, 'B13': 5, 'C01': 5, 'C02': 5, 'C03': 5,
            'D01': 3, 'D02': 5, 'D03': 3, 'D04': 5, 'D05': 5, 'D06': 2, 'D07': 3, 'D08': 3, 'D09': 3, 'D10': 5, 'D11': 3, 'D12': 3, 'D13': 3, 'D14': 3, 'D15': 5, 'D16': 4, 'D17': 4, 'D18': 5, 'D19': 5, 'D20': 5,
            'E01': 5, 'E02': 5, 'E03': 5, 'E04': 5, 'E05': 5, 'E06': 5, 'E07': 5, 'E08': 5, 'E09': 5, 'E10': 4, 'E11': 5, 'F01': 5, 'F02': 5, 'G01': 5, 'G02': 5, 'G03': 4, 'H01': 5, 'H02': 5, 'I01': 5, 'J01': 5, 'J02': 5,
            'K01': 5, 'K02': 5, 'K03': 5, 'K04': 5, 'K05': 5, 'K06': 5, 'K07': 5, 'K08': 5, 'K09': 5, 'K10': 3,
            'L01_1': 5, 'L01_2': 5, 'L02': 7, 'L03': 5, 'L04': 6, 'L05': 5, 'L06': 5, 'L07_1': 5, 'L07_2': 4, 'L08': 4, 'L09': 5, 'L10': 7, 'L11': 5, 'L12': 5, 'L13': 5, 'L14_1': 6, 'L14_2': 6, 'L14_3': 6, 'L14_4': 7,
            'O1-1-P1': 4, 'O1-2-P2': 4, 'O1-2-P2-B1': 4, 'O1-3-P3': 4, 'O1-4-P4': 4, 'O1-4-P4-B2': 4, 'O1-5-P5': 4, 'O1-5-P5-B3': 4, 'O1-5-P6': 4, 'O1-5-P7': 4, 'O1-6-P8': 4, 'O1-6-P9': 4, 'O1-6-P9-B4': 4, 'O1-6-P10': 4, 'O1-6-P10-B5': 4, 'O1-7-P11': 4, 'O1-7-P11-B7': 4, 'O1-7-P12': 4, 'O1-7-P12-B6': 4, 'O1-7-P13': 4, 'O1-8-P14': 4, 'O1-8-P15': 4, 'O1-8-P16': 4, 'O1-8-P16-B8': 4,
            'O2-1-P1': 4, 'O2-2-P3': 5, 'O2-2-P3-B2': 5, 'O2-2-P4': 4, 'O2-3-P5': 5, 'O2-3-P6': 4, 'O2-3-P6-B3': 4, 'O2-4-P7': 4, 'O2-4-P8': 4, 'O2-4-P9': 4, 'O2-4-P9-B4': 4, 'O2-5-P10': 4, 'O2-5-P10-B5': 4, 'O2-5-P11': 4, 'O2-5-P12': 4, 'O2-6-P13': 4, 'O2-6-P13-B7': 4, 'O2-6-P14': 5, 'O2-6-P14-B6': 5, 'O2-6-P15': 5, 'O2-7-P17-B8': 4, 'O2-7-P17-B9': 4,
            'O3-1-P1': 5, 'O3-1-P2': 4, 'O3-1-P3': 6, 'O3-2-P4': 6, 'O3-3-P5': 4, 'O3-3-P6': 4, 'O3-4-P7': 4, 'O3-5-P8': 4, 'O3-6-P9': 5, 'O3-6-P10': 6, 'O3-7-P11': 3, 'O3-7-P12': 4, 'O3-7-P13': 4, 'O3-7-P14': 5, 'O3-7-P15': 5, 'O3-7-P16': 6,
            'O4-1-P1': 5, 'O4-1-P2': 5, 'O4-1-P3': 4, 'O4-1-P4': 5, 'O4-1-P5': 4, 'O4-2-P6': 4, 'O4-2-P7': 4, 'O4-2-P8': 5, 'O4-3-P9': 5, 'O4-4-P10': 4, 'O4-5-P11': 4, 'O4-6-P12': 4, 'O4-7-P13': 4, 'O4-8-P14': 4, 'O4-9-P15': 4, 'O4-9-P16': 4, 'O4-9-P17': 4, 'O4-9-P18': 4, 'O4-10-P19': 4, 'O4-10-P20': 5, 'O4-10-P21': 5, 'O4-10-P22': 5,
            'O5-1-P1': 4, 'O5-2-P2': 4, 'O5-3-P4': 5, 'O5-3-P5': 4, 'O5-3-P6': 3, 'O5-4-P7': 3, 'O5-4-P8': 5, 'O5-5-P10': 2, 'O5-5-P9': 5, 'O5-6-P11': 4, 'O5-6-P12': 3, 'O5-7-P13': 5, 'O5-8-P14': 5,
            'O6-1-P1': 4, 'O6-2-P2': 3, 'O6-3-P3': 4, 'O6-3-P4': 5, 'O6-3-P5': 5, 'O6-3-P6': 6, 'O6-3-P7': 6,
            'O8-1-P1': 4, 'O8-2-P2': 6, 'O8-3-P3': 4, 'O8-4-P4': 5, 'O8-5-P5': 5, 'O8-6-P6': 6, 'O8-7-P7': 5, 'O8-8-P8': 4, 'O8-8-P9': 5, 'O8-8-P10': 6, 'O8-8-P11': 5, 'O8-8-P12': 5, 'O8-9-P13': 5, 'O8-10-P14': 4,
            'Lifting-1A': 10, 'Lifting-1B': 10, 'Lifting-2A': 10, 'Lifting-2B': 10,
            'R01': 4, 'R02': 6, 'R03*': 6, 'R03-A': 7, 'R03-B': 5, 'R04': 7, 'R05-A': 7, 'R05-B': 8, 'R05-C': 8, 'R05-D': 6, 'R05-E': 7, 'R05-F': 6, 'R05-G': 7, 'R05-H': 7, 'R05-I': 7, 'R05-J1': 7, 'R05-J2': 7, 'R05-K': 7, 'R06': 7, 'R07': 8, 'R08-A': 7, 'R08-B': 7, 'R08-C': 5, 'R08-D': 6, 'R08-E': 7, 'R08-F1': 7, 'R08-F2': 7, 'R08-F3': 7, 'R09-A': 8, 'R09-B': 8, 'R09-C': 8, 'R10': 7, 'R11': 7, 'R12-A': 6, 'R12-B': 7,
            'Lifting-57S': 6, 'Lifting-8S': 12, 'Lifting-17S': 12,
            'S01-A': 7, 'S01-B': 7, 'S02-A': 6, 'S02-B': 7, 'S03': 6, 'S04': 6, 'S05-A': 6, 'S05-B': 6, 'S06': 6, 'S07-A': 7, 'S07-B': 7, 'S08': 6, 'S09-A': 7, 'S09-B': 7, 'S09-C': 8, 'S09-D': 8, 'S09-E': 6, 'S09-F': 6
        };
        // --- UTILITY: STANDARD DATE TIME ---
        function getStandardDateTime() {
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const y = now.getFullYear();
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            return {
                date: `${d}/${m}/${y}`, 
                time: `${h}:${min}:${s}`, 
                full: `${d}/${m}/${y} ${h}:${min}:${s}`
            };
        }

        // --- UTILITY: PARSE CUSTOM DATE STRING ---
        function parseCustomDate(str) {
            if(!str) return null;
            // Expected format: "DD/MM/YYYY HH:MM:SS"
            const parts = str.split(' ');
            if(parts.length < 2) return null;
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            return new Date(
                parseInt(dateParts[2]), // Year
                parseInt(dateParts[1]) - 1, // Month (0-based)
                parseInt(dateParts[0]), // Day
                parseInt(timeParts[0]), // Hours
                parseInt(timeParts[1]), // Minutes
                parseInt(timeParts[2] || 0) // Seconds
            );
        }

        // --- CORE FUNCTIONS ---
        function loadSystemData() {
            db.ref('stations').on('value', (snapshot) => {
                let data = snapshot.val();
                if (!data) { forceRepairStations(); } 
                else { appData.stations = data; forceRepairStations(); }
                
                if (document.getElementById('stations-screen').classList.contains('active')) {
                    const activeTab = document.querySelector('.nav-tab.active');
                    renderStations(activeTab ? activeTab.dataset.zone : 'all');
                }
                if (document.getElementById('station-screen').classList.contains('active') && appData.currentStation) {
                    showStationDetails(appData.currentStation);
                }
            });
            db.ref('users').on('value', (snapshot) => {
                if (snapshot.val()) appData.users = snapshot.val();
                else db.ref('users').set(appData.users);

                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Ø¯Ø®ÙˆÙ„";
                    loginBtn.style.backgroundColor = ''; 
                    loginBtn.style.color = '';
                    loginBtn.style.cursor = 'pointer';
                    loginBtn.classList.add('btn-primary');
                }
            });
            db.ref('history').limitToLast(20000).on('value', (snapshot) => {
                const val = snapshot.val();
                if(val) appData.operationHistory = Object.values(val).reverse();
                else appData.operationHistory = [];
                if (document.getElementById('history-screen').classList.contains('active')) renderHistoryTable(true);
            });
            db.ref('faults_log').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) appData.faultsLog = Array.isArray(val) ? val : Object.values(val);
                else appData.faultsLog = [];
                if (document.getElementById('faults-log-screen').classList.contains('active')) renderFaultsLog();
            });
        }

        function forceRepairStations() {
            let updates = {};
            let repairCount = 0;
            const nowStd = getStandardDateTime();
            
            Object.keys(pumpsData).forEach(stationName => {
                const exists = appData.stations && appData.stations[stationName];
                if (!exists) {
                    let zone = 'Unknown';
                    appData.zones.forEach(z => { if(stationName.startsWith(z.split('_')[1])) zone = z; });
                    if(stationName.startsWith('A')) zone='Zone_A';
                    
                    const pumpCount = pumpsData[stationName] || 4;
                    updates[stationName] = {
                        name: stationName, zone: zone, status: 'Ù…ØªÙˆÙ‚ÙØ©', pressure: 0, activePumps: 0,
                        voltage: 380, waterFlow: 0, systemMode: 'SCADA', operatorName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
                        lastUpdate: nowStd.full, comments: '',
                        startTime: '', stopTime: '',
                        currentFault: null, secondaryFault: null,
                        pumps: Array(pumpCount).fill().map((_, index) => ({ id: index + 1, status: 'Ù…ØªÙˆÙ‚ÙØ©', suctionPressure: null, dischargePressure: null, frequency: null }))
                    };
                    repairCount++;
                }
            });
            if (repairCount > 0) db.ref('stations').update(updates);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`${screenId}-screen`).classList.add('active');
            window.scrollTo(0, 0);
            
            const userInfoDiv = document.getElementById('header-user-info');
            userInfoDiv.style.display = (screenId === 'login') ? 'none' : 'flex';
            if(screenId === 'stations') {
                const activeTab = document.querySelector('.nav-tab.active');
                renderStations(activeTab ? activeTab.dataset.zone : 'all');
            }
            if(screenId === 'faults-log') {
                appData.faultsLimit = 100;
                autoDeepCleanFaults();
            }
        }

        // --- AUTHENTICATION ---
        document.getElementById('logout-btn').addEventListener('click', () => { appData.currentUser = null; showScreen('login'); });
        document.getElementById('toggle-password-icon').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ”’';
        });
        function checkRememberedUser() {
            const savedUser = localStorage.getItem('toshka_user');
            const savedPass = localStorage.getItem('toshka_pass');
            if (savedUser && savedPass) {
                document.getElementById('username').value = savedUser;
                document.getElementById('password').value = savedPass;
                document.getElementById('remember-me').checked = true;
            }
        }
        document.getElementById('login-btn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const user = appData.users[u];
            const remember = document.getElementById('remember-me').checked;
            if (user && user.password === p && user.active) {
                if (remember) { localStorage.setItem('toshka_user', u); localStorage.setItem('toshka_pass', p); } 
                else { localStorage.removeItem('toshka_user'); localStorage.removeItem('toshka_pass'); }
                appData.currentUser = user;
                document.getElementById('current-user').textContent = `${appData.userTypes[user.type].name}: ${u}`;
                document.getElementById('users-management-btn').style.display = appData.userTypes[user.type].permissions.includes('manage_users') ? 'inline-block' : 'none';
                document.getElementById('history-management-btn').style.display = appData.userTypes[user.type].permissions.includes('view_history') ? 'inline-block' : 'none';
                showScreen('stations');
                renderZonesTabs();
                renderStations('all');
            } else { alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©'); }
        });

        // --- SHIFT CHECK LOGIC (FIXED) ---
        function checkShiftAdherence(lastUpdateStr) {
            if (!lastUpdateStr) return true; // No update ever -> warn

            const lastUpdate = parseCustomDate(lastUpdateStr);
            if (!lastUpdate) return true; // Error parsing -> warn

            const now = new Date();

            // Shift Milestones Today
            const morningShiftDeadline = new Date(now);
            morningShiftDeadline.setHours(7, 30, 0, 0); // 7:30 AM
            
            const morningShiftStart = new Date(now);
            morningShiftStart.setHours(5, 0, 0, 0); // 5:00 AM

            const eveningShiftDeadline = new Date(now);
            eveningShiftDeadline.setHours(19, 30, 0, 0); // 7:30 PM

            const eveningShiftStart = new Date(now);
            eveningShiftStart.setHours(17, 0, 0, 0); // 5:00 PM

            // Logic: Compare lastUpdate with the start of the REQUIRED shift
            // If lastUpdate is OLDER than the required shift start, it means missed update.

            // 1. Early Morning (Dead Zone: 12:00 AM - 7:30 AM)
            if (now < morningShiftDeadline) {
                // Must have updated in Yesterday's Evening Shift
                const yesterdayEveningStart = new Date(now);
                yesterdayEveningStart.setDate(yesterdayEveningStart.getDate() - 1);
                yesterdayEveningStart.setHours(17, 0, 0, 0);

                if (lastUpdate < yesterdayEveningStart) return true; // Missed
            }
            // 2. Day Time (7:30 AM - 7:30 PM)
            else if (now < eveningShiftDeadline) {
                // Must have updated in Today's Morning Shift
                if (lastUpdate < morningShiftStart) return true; // Missed
            }
            // 3. Evening/Night (After 7:30 PM)
            else {
                // Must have updated in Today's Evening Shift
                if (lastUpdate < eveningShiftStart) return true; // Missed
            }

            return false; // No missed update
        }

        // --- DASHBOARD RENDERER ---
        function renderZonesTabs() {
            const c = document.getElementById('zones-tabs');
            c.innerHTML = `<button class="nav-tab active" data-zone="all" onclick="handleTabClick('all', this)">Ø§Ù„ÙƒÙ„</button>`;
            appData.zones.forEach(z => c.innerHTML += `<button class="nav-tab" data-zone="${z}" onclick="handleTabClick('${z}', this)">${z}</button>`);
        }
        window.handleTabClick = (zone, btn) => {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderStations(zone);
        };
        window.renderStations = (zoneFilter = 'all') => {
            const container = document.getElementById('stations-container');
            container.innerHTML = '';
            let allStations = Object.values(appData.stations || {});
            
            if(allStations.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>'; return; }

            const activeCount = allStations.filter(s => s.status === 'Ù†Ø´Ø·Ø©').length;
            const inactiveCount = allStations.filter(s => s.status === 'Ù…ØªÙˆÙ‚ÙØ©' && !s.currentFault).length;
            const faultedStations = allStations.filter(s => s.currentFault || s.secondaryFault);
            document.getElementById('total-stations').textContent = allStations.length;
            document.getElementById('active-stations').textContent = activeCount;
            document.getElementById('inactive-stations').textContent = inactiveCount;

            const tickerContainer = document.getElementById('ticker-container');
            const tickerContent = document.getElementById('ticker-content');
            const alarmBtn = document.getElementById('alarm-btn');
            const alarmCount = document.getElementById('alarm-count');

            if (faultedStations.length > 0) {
                tickerContainer.classList.add('active');
                let tickerHtml = '';
                faultedStations.forEach((s, index) => {
                    if (s.currentFault) {
                        const icon = faultIcons[s.currentFault] || 'âš ï¸';
                        tickerHtml += `<span class="ticker-item">${icon} ${s.name}: ${s.currentFault}</span>`;
                    }
                    if (s.secondaryFault) {
                        const icon = faultIcons[s.secondaryFault] || 'âš ï¸';
                        tickerHtml += `<span class="ticker-item">${icon} ${s.name}: ${s.secondaryFault}</span>`;
                    }
                    if (index < faultedStations.length - 1) {
                        tickerHtml += `<span class="ticker-separator">â€¢</span>`;
                    }
                });
                tickerContent.innerHTML = tickerHtml;
                
                setTimeout(() => {
                    const contentWidth = tickerContent.scrollWidth;
                    const containerWidth = tickerContainer.offsetWidth;
                    const speed = 100;
                    const duration = (contentWidth + containerWidth) / speed;
                    const finalDuration = Math.max(duration, 5); 
                    tickerContent.style.animationDuration = `${finalDuration}s`;
                }, 100);
                alarmBtn.classList.add('flashing');
                alarmCount.style.display = 'flex';
                alarmCount.textContent = faultedStations.length;
            } else {
                tickerContainer.classList.remove('active');
                alarmBtn.classList.remove('flashing');
                alarmCount.style.display = 'none';
            }

            let zonesToRender = zoneFilter === 'all' ? appData.zones : [zoneFilter];
            zonesToRender.forEach(zoneName => {
                const zoneStations = allStations.filter(s => s.zone === zoneName);
                if (zoneStations.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'zone-separator';
                    separator.innerHTML = `<span>${zoneName}</span> <span style="font-size:0.9rem; opacity:0.8;">(${zoneStations.length})</span>`;
                    container.appendChild(separator);
                    
                    const grid = document.createElement('div');
                    grid.className = 'stations-grid';
                    
                    zoneStations.forEach(s => {
                        const isFault = (s.currentFault || s.secondaryFault) ? true : false;
                        const card = document.createElement('div');
                        let cardClass = 'station-card';
                        if (isFault) {
                            cardClass += ' fault-active';
                            if (s.currentFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA' || s.secondaryFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA') cardClass += ' scada-fault';
                        }
                        card.className = cardClass;
                        let faultHtml = '';
                        if(isFault) {
                            if(s.currentFault) {
                                const icon = faultIcons[s.currentFault] || 'âš ï¸';
                                let badgeClass = 'fault-badge';
                                if (s.currentFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA') badgeClass += ' scada-badge';
                                faultHtml += `<div class="${badgeClass}">${icon} ${s.currentFault}</div>`;
                            }
                            if(s.secondaryFault) {
                                const icon = faultIcons[s.secondaryFault] || 'âš ï¸';
                                let badgeClass = 'fault-badge';
                                if (s.secondaryFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA') badgeClass += ' scada-badge';
                                faultHtml += `<div class="${badgeClass}" style="margin-top:2px;">${icon} ${s.secondaryFault}</div>`;
                            }
                        }

                        // Check Shift Update Status
                        let missedUpdateHtml = '';
                        if (checkShiftAdherence(s.lastUpdate)) {
                            missedUpdateHtml = `<span class="missed-update-icon" title="Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯">!</span>`;
                        }

                        card.innerHTML = `
                            <div style="font-weight:bold; color:var(--primary-color)">${missedUpdateHtml}${s.name}</div>
                            <span class="station-status ${s.status === 'Ù†Ø´Ø·Ø©' ? 'status-active' : 'status-inactive'}">${s.status}</span>
                            ${faultHtml}
                            <div style="margin-top:10px; font-size:13px;">
                                <div>Ø§Ù„Ø¶ØºØ·: ${s.pressure} Bar</div>
                                <div>Ø§Ù„Ø¬Ù‡Ø¯: ${s.voltage} V</div>
                                <div style="color:var(--secondary-color);">Ø§Ù„ØªØ¯ÙÙ‚: ${s.waterFlow} L/Sec</div>
                                <div>Ø§Ù„Ù…Ø¶Ø®Ø§Øª: ${s.activePumps}</div>
                            </div>`;
                        card.onclick = () => showStationDetails(s.name);
                        grid.appendChild(card);
                    });
                    container.appendChild(grid);
                }
            });
        };
        // --- STATION DETAILS ---
        function showStationDetails(stationId) {
            const s = appData.stations[stationId];
            if (!s) return;
            appData.currentStation = stationId;
            
            document.getElementById('station-title').textContent = s.name;
            document.getElementById('station-status-value').textContent = s.status;
            document.getElementById('operator-name-value').textContent = s.operatorName;
            document.getElementById('voltage-value').textContent = s.voltage;
            document.getElementById('station-pressure-value').textContent = s.pressure;
            document.getElementById('active-pumps-value').textContent = s.activePumps;
            document.getElementById('water-flow-value').textContent = s.waterFlow;
            document.getElementById('system-mode-value').textContent = s.systemMode;
            // Split Time Display
            document.getElementById('start-time-value').textContent = s.startTime || '-';
            document.getElementById('stop-time-value').textContent = s.stopTime || '-';
            
            document.getElementById('last-update-value').textContent = s.lastUpdate;
            document.getElementById('station-comments-value').textContent = s.comments || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';

            const banner = document.getElementById('station-fault-banner');
            const faultList = document.getElementById('station-fault-list');
            if (s.currentFault || s.secondaryFault) {
                banner.style.display = 'block';
                faultList.innerHTML = '';
                let hasScadaFault = false;
                if(s.currentFault) {
                    if (s.currentFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA') hasScadaFault = true;
                    const descText = s.fault1Desc ? ` <span style="font-weight:normal; color:#d32f2f">(${s.fault1Desc})</span>` : '';
                    faultList.innerHTML += `<li>${s.currentFault}${descText} <span style="font-size:0.8em; color:#666">(${s.faultStartTime || '-'})</span></li>`;
                }
                if(s.secondaryFault) {
                    if (s.secondaryFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA') hasScadaFault = true;
                    const descText = s.fault2Desc ? ` <span style="font-weight:normal; color:#d32f2f">(${s.fault2Desc})</span>` : '';
                    faultList.innerHTML += `<li>${s.secondaryFault}${descText}</li>`;
                }
                if (hasScadaFault) {
                    banner.style.background = '#fff3cd';
                    banner.style.color = '#856404'; banner.style.borderColor = '#ffeeba';
                } else {
                    banner.style.background = '#ffecec';
                    banner.style.color = '#b71c1c'; banner.style.borderColor = '#ffcdd2';
                }
            } else { banner.style.display = 'none';
            }

            const tbody = document.getElementById('pumps-table-body');
            tbody.innerHTML = '';
            s.pumps.forEach(p => {
                let statusColor = p.status==='Ù†Ø´Ø·Ø©'?'green':'red';
                if(p.status === 'Ù…Ø¹Ø·Ù„Ø©') statusColor = 'orange';
                tbody.innerHTML += `<tr><td>${p.id}</td><td style="color:${statusColor}">${p.status}</td><td>${p.suctionPressure||'-'}</td><td>${p.dischargePressure||'-'}</td><td>${p.frequency||'-'}</td></tr>`;
            });
            const canEdit = appData.userTypes[appData.currentUser.type].permissions.some(p => p.startsWith('edit'));
            document.getElementById('edit-station-btn').style.display = canEdit ? 'block' : 'none';
            showScreen('station');
        }

        // --- EDIT MODE & SEPARATE FAULT RESOLUTION ---
        document.getElementById('edit-station-btn').addEventListener('click', () => {
            const s = appData.stations[appData.currentStation];
            document.getElementById('editing-station-name').textContent = `Ù…Ø­Ø·Ø©: ${s.name}`;
            document.getElementById('operator-name').value = appData.currentUser.username;
            
            // Auto-fill Current Time for Manual Input or Use Saved
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            // Pre-fill fields
            document.getElementById('operator-start-time').value = s.startTime || timeString;
            document.getElementById('operator-stop-time').value = s.stopTime || '';

            document.getElementById('operator-pressure').value = s.pressure;
            document.getElementById('operator-water-flow').value = s.waterFlow;
            document.getElementById('operator-voltage').value = s.voltage;
            document.getElementById('operator-system-mode').value = s.systemMode;
            document.getElementById('operator-comments').value = s.comments;
            // Setup Individual Fault Resolution UI
            const faultControl = document.getElementById('active-fault-control');
            const row1 = document.getElementById('fault-row-1');
            const row2 = document.getElementById('fault-row-2');
            
            // Reset Displays
            row1.style.display = 'none';
            row2.style.display = 'none';
            faultControl.style.display = 'none';

            if (s.currentFault || s.secondaryFault) {
                faultControl.style.display = 'block';
                if(s.currentFault) {
                    row1.style.display = 'flex';
                    document.getElementById('txt-fault-1').textContent = s.currentFault;
                }
                if(s.secondaryFault) {
                    row2.style.display = 'flex';
                    document.getElementById('txt-fault-2').textContent = s.secondaryFault;
                }
            }

            // Setup Selectors (New Faults)
            document.getElementById('fault-selector').value = s.currentFault || "";
            document.getElementById('fault-selector-secondary').value = s.secondaryFault || "";
            
            // Setup Description Inputs
            document.getElementById('fault-1-desc').value = s.fault1Desc || "";
            document.getElementById('fault-2-desc').value = s.fault2Desc || "";

            updateFaultExclusions();

            // Pumps
            const c = document.getElementById('pumps-form-container');
            let pumpsHtml = '';
            s.pumps.forEach(p => {
                pumpsHtml += `
                    <div class="pump-control">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <b>Ù…Ø¶Ø®Ø© ${p.id}</b>
                            <select id="p_stat_${p.id}" onchange="togglePumpInputs(${p.id})">
                                <option value="Ù†Ø´Ø·Ø©" ${p.status==='Ù†Ø´Ø·Ø©'?'selected':''}>Ù†Ø´Ø·Ø©</option>
                                <option value="Ù…ØªÙˆÙ‚ÙØ©" ${p.status==='Ù…ØªÙˆÙ‚ÙØ©'?'selected':''}>Ù…ØªÙˆÙ‚ÙØ©</option>
                                <option value="Ù…Ø¹Ø·Ù„Ø©" ${p.status==='Ù…Ø¹Ø·Ù„Ø©'?'selected':''}>Ù…Ø¹Ø·Ù„Ø©</option>
                            </select>
                        </div>
                        <input type="number" placeholder="Ø³Ø­Ø¨" id="p_suc_${p.id}" value="${p.suctionPressure||''}" class="p_inp_${p.id}">
                        <input type="number" placeholder="Ø·Ø±Ø¯" id="p_dis_${p.id}" value="${p.dischargePressure||''}" class="p_inp_${p.id}" style="margin-top:5px">
                        <input type="number" placeholder="ØªØ±Ø¯Ø¯" id="p_freq_${p.id}" value="${p.frequency||''}" class="p_inp_${p.id}" style="margin-top:5px">
                    </div>`;
            });
            c.innerHTML = pumpsHtml;
            s.pumps.forEach(p => { togglePumpInputs(p.id); });
            showScreen('operator');
        });
        window.togglePumpInputs = (id) => {
            const active = document.getElementById(`p_stat_${id}`).value === 'Ù†Ø´Ø·Ø©';
            document.querySelectorAll(`.p_inp_${id}`).forEach(i => {
                i.disabled = !active;
                if(!active) i.style.background = '#eee'; else i.style.background = '#fff';
            });
        };
        
        function updateFaultExclusions() {
            const f1 = document.getElementById('fault-selector');
            const f2 = document.getElementById('fault-selector-secondary');
            Array.from(f2.options).forEach(opt => opt.disabled = false);
            Array.from(f1.options).forEach(opt => opt.disabled = false);
            if(f1.value) {
                const optIn2 = f2.querySelector(`option[value="${f1.value}"]`);
                if(optIn2) optIn2.disabled = true;
            }
            if(f2.value) {
                const optIn1 = f1.querySelector(`option[value="${f2.value}"]`);
                if(optIn1) optIn1.disabled = true;
            }
        }
        document.getElementById('fault-selector').addEventListener('change', updateFaultExclusions);
        document.getElementById('fault-selector-secondary').addEventListener('change', updateFaultExclusions);

        // --- CORE SAVING LOGIC ---
        document.getElementById('save-operator-data').addEventListener('click', () => saveDataInternal({}));
        document.getElementById('btn-resolve-f1').addEventListener('click', () => {
             if(confirm("Ù‡Ù„ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø£ÙˆÙ„ØŸ")) saveDataInternal({ resolveTarget: 'currentFault' });
        });
        document.getElementById('btn-resolve-f2').addEventListener('click', () => {
             if(confirm("Ù‡Ù„ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠØŸ")) saveDataInternal({ resolveTarget: 'secondaryFault' });
        });
        function saveDataInternal(options = {}) {
            try {
                const sName = appData.currentStation;
                if (!sName || !appData.stations[sName]) { alert("Ø®Ø·Ø£: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø·Ø© Ù…Ø­Ø¯Ø¯Ø©!"); return;
                }
                
                const oldData = appData.stations[sName];
                const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
                const safeOldFault1 = (oldData.currentFault && oldData.currentFault !== "undefined") ? oldData.currentFault : null;
                const safeOldFault2 = (oldData.secondaryFault && oldData.secondaryFault !== "undefined") ? oldData.secondaryFault : null;

                let newPressure = parseFloat(getVal('operator-pressure')) || 0;
                let newFlow = parseFloat(getVal('operator-water-flow')) || 0;
                let newVoltage = getVal('operator-voltage');
                const newMode = getVal('operator-system-mode');
                const newOperator = getVal('operator-name');
                const newComments = getVal('operator-comments');
                
                // --- Time Logic ---
                let newStartTime = getVal('operator-start-time');
                let newStopTime = getVal('operator-stop-time');
                
                // Standard System Time
                const nowStd = getStandardDateTime();
                const updateDate = nowStd.date;
                const updateTime = nowStd.time;
                const sysTimeShort = updateTime.substring(0, 5);
                // HH:MM
                const stationFullDateTime = nowStd.full;
                let changesDetails = [];
                let activeCount = 0;
                let currentStatus = 'Ù…ØªÙˆÙ‚ÙØ©';
                // Fault Handling Logic
                let finalFault = safeOldFault1;
                let finalFaultDesc = oldData.fault1Desc || null;

                let finalFaultSec = safeOldFault2;
                let finalFaultSecDesc = oldData.fault2Desc || null;
                let faultStartTime = oldData.faultStartTime || null;
                const nonStoppingFaults = ['Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA', 'Ø¹Ø¬Ø² ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ØºØ·', 'Ø§Ù†Ø³Ø¯Ø§Ø¯Ø§Øª', 'ØªØ³Ø±ÙŠØ¨ Ù…ÙŠØ§Ù‡'];
                let newFaultEntries = [];
                let resolvedFaultEntries = [];

                if (options.resolveTarget === 'currentFault') {
                    // Resolving Fault 1
                    if (safeOldFault1) {
                        changesDetails.push(`âœ… Ø¥ØµÙ„Ø§Ø­: ${safeOldFault1}`);
                        resolvedFaultEntries.push({ station: sName, type: safeOldFault1, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                    }
                    finalFault = null;
                    finalFaultDesc = null; 
                    if (!finalFaultSec) faultStartTime = null;
                } else if (options.resolveTarget === 'secondaryFault') {
                    // Resolving Fault 2
                    if (safeOldFault2) {
                        changesDetails.push(`âœ… Ø¥ØµÙ„Ø§Ø­: ${safeOldFault2}`);
                        resolvedFaultEntries.push({ station: sName, type: safeOldFault2, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                    }
                    finalFaultSec = null;
                    finalFaultSecDesc = null; 
                    if (!finalFault) faultStartTime = null;
                } else {
                    // Normal Save
                    const sel1 = getVal('fault-selector');
                    const selDesc1 = getVal('fault-1-desc');

                    let sel2 = getVal('fault-selector-secondary');
                    let selDesc2 = getVal('fault-2-desc');
                    if (sel1 && sel1 === sel2) sel2 = "";
                    
                    finalFault = sel1 || null;
                    finalFaultDesc = finalFault ? selDesc1 : null; 

                    finalFaultSec = sel2 || null;
                    finalFaultSecDesc = finalFaultSec ? selDesc2 : null;
                    // 1. Primary Fault Changes
                    if (finalFault !== safeOldFault1) {
                        if (finalFault) {
                             changesDetails.push(`âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ 1: ${finalFault}`);
                             newFaultEntries.push({ station: sName, type: finalFault, startTime: stationFullDateTime, endTime: null, active: true });
                             if(!safeOldFault1) faultStartTime = stationFullDateTime;
                        } else {
                             if (safeOldFault1) {
                                 changesDetails.push(`âœ… Ø¥ØµÙ„Ø§Ø­: ${safeOldFault1}`);
                                 resolvedFaultEntries.push({ station: sName, type: safeOldFault1, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                             }
                             if (!finalFaultSec) faultStartTime = null;
                        }
                    }
                    // 2. Secondary Fault Changes
                    if (finalFaultSec !== safeOldFault2) {
                        if (finalFaultSec) {
                             changesDetails.push(`âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ 2: ${finalFaultSec}`);
                             newFaultEntries.push({ station: sName, type: finalFaultSec, startTime: stationFullDateTime, endTime: null, active: true });
                             if (!faultStartTime) faultStartTime = stationFullDateTime;
                        } else {
                             if (safeOldFault2) {
                                 changesDetails.push(`âœ… Ø¥ØµÙ„Ø§Ø­: ${safeOldFault2}`);
                                 resolvedFaultEntries.push({ station: sName, type: safeOldFault2, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                             }
                        }
                    }
                }

                const isCriticalFault = (finalFault && !nonStoppingFaults.includes(finalFault)) || (finalFaultSec && !nonStoppingFaults.includes(finalFaultSec));

                if (isCriticalFault) {
                    currentStatus = 'Ù…ØªÙˆÙ‚ÙØ©';
                    activeCount = 0; newPressure = 0; newFlow = 0;
                    if (finalFault === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ' || finalFaultSec === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ') newVoltage = 0;
                }

                if (!oldData.pumps) oldData.pumps = [];
                const updatedPumps = oldData.pumps.map(p => {
                    const statElem = document.getElementById(`p_stat_${p.id}`);
                    let newStatus = statElem ? statElem.value : p.status;
                    
                    if (isCriticalFault) {
                         if (newStatus === 'Ù†Ø´Ø·Ø©') { newStatus = 'Ù…ØªÙˆÙ‚ÙØ©'; }
                    }
                    
                    if(p.status != newStatus) changesDetails.push(`Ù…Ø¶Ø®Ø© ${p.id}: ${p.status} -> ${newStatus}`);
                    
                    let pumpData = { id: p.id, status: newStatus, suctionPressure: null, dischargePressure: null, frequency: null };
                    
                    if(newStatus === 'Ù†Ø´Ø·Ø©') {
                         activeCount++;
                        pumpData.suctionPressure = getVal(`p_suc_${p.id}`);
                        pumpData.dischargePressure = getVal(`p_dis_${p.id}`);
                        pumpData.frequency = getVal(`p_freq_${p.id}`);
                    }
                    return pumpData;
                });
                
                if (!isCriticalFault) {
                     if (activeCount > 0) {
                         currentStatus = 'Ù†Ø´Ø·Ø©';
                     } else {
                         currentStatus = 'Ù…ØªÙˆÙ‚ÙØ©';
                         newPressure = 0; newFlow = 0;
                     }
                }

                // --- APPLY TIME RULES ---
                if (currentStatus === 'Ù†Ø´Ø·Ø©') {
                    // Rule 1: Active Station has NO stop time
                    newStopTime = '';
                    if (!newStartTime) newStartTime = sysTimeShort;
                } else {
                    // Stopped Station
                    if (isCriticalFault) {
                        // Rule 2b: Fault Stop -> Use System Time as Stop Time
                        newStopTime = sysTimeShort;
                    } else {
                        // Rule 2a: Manual Stop -> Use Input Time (or System if empty)
                        if (!newStopTime) newStopTime = sysTimeShort;
                    }
                }

                if(oldData.pressure != newPressure) changesDetails.push(`Ø§Ù„Ø¶ØºØ·: ${oldData.pressure} -> ${newPressure}`);
                if(oldData.voltage != newVoltage) changesDetails.push(`Ø§Ù„Ø¬Ù‡Ø¯: ${oldData.voltage} -> ${newVoltage}`);
                if(oldData.status != currentStatus) changesDetails.push(`Ø§Ù„Ø­Ø§Ù„Ø©: ${oldData.status} -> ${currentStatus}`);
                if(oldData.startTime != newStartTime) changesDetails.push(`ØªØ´ØºÙŠÙ„: ${oldData.startTime||'-'} -> ${newStartTime}`);
                if(oldData.stopTime != newStopTime) changesDetails.push(`Ø¥ÙŠÙ‚Ø§Ù: ${oldData.stopTime||'-'} -> ${newStopTime}`);
                const changesString = changesDetails.length > 0 ? changesDetails.join(', ') : "ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ";
                const updates = {
                    pressure: newPressure, waterFlow: newFlow, voltage: newVoltage,
                    systemMode: newMode, operatorName: newOperator, comments: newComments,
                    lastUpdate: stationFullDateTime, 
                    startTime: newStartTime, 
                    stopTime: newStopTime,
                    activePumps: activeCount,
                    status: currentStatus, 
                    currentFault: finalFault,
                    fault1Desc: finalFaultDesc,
                    secondaryFault: finalFaultSec,
                    fault2Desc: finalFaultSecDesc,
                    faultStartTime: faultStartTime,
                    pumps: updatedPumps
                };

                db.ref('stations/' + sName).update(updates).then(() => {
                    // History Record
                    const log = { date: updateDate, time: updateTime, station: sName, operator: newOperator, details: changesString };
                    if (appData.operationHistory.length >= 20000) {
                        db.ref('history').orderByKey().limitToFirst(1).once('child_added', (snapshot) => { snapshot.ref.remove(); });
                    }
                    db.ref('history').push(log);

                    if (newFaultEntries.length > 0 || resolvedFaultEntries.length > 0) {
                        db.ref('faults_log').once('value').then(snap => {
                            let rawVal = snap.val();
                            let logs = [];
                            if (rawVal) { 
                                if (Array.isArray(rawVal)) logs = rawVal; else logs = Object.values(rawVal); }
                            newFaultEntries.forEach(newF => {
                                const exists = logs.some(existingF => existingF.active === true && existingF.station === newF.station && existingF.type === newF.type);
                                if (!exists) logs.unshift(newF);
                            });
                            resolvedFaultEntries.forEach(rf => {
                                const index = logs.findIndex(f => f.station === sName && f.type === rf.type && f.active === true);
                                if (index !== -1) { 
                                    logs[index].active = false;
                                    logs[index].endTime = stationFullDateTime;
                                } else { 
                                    logs.unshift(rf);
                                }
                            });
                            if (logs.length > 20000) logs = logs.slice(0, 20000);
                            db.ref('faults_log').set(logs);
                        });
                    }
                    
                    document.getElementById('operator-alert').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!';
                    document.getElementById('operator-alert').className = 'alert alert-success';
                    document.getElementById('operator-alert').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('operator-alert').style.display = 'none';
                        showStationDetails(sName);
                    }, 1000);
                }).catch(err => { alert("Ø®Ø·Ø£ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message); });
            } catch (e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø±Ù…Ø¬ÙŠ: " + e.message);
            }
        }

        // --- FAULT LOG SCREEN & FILTERING ---
        document.getElementById('alarm-btn').addEventListener('click', () => { showScreen('faults-log'); });
        document.getElementById('load-more-faults-btn').addEventListener('click', () => {
            appData.faultsLimit += 100;
            renderFaultsLog();
        });
        window.autoDeepCleanFaults = () => {
            if (!appData.stations || Object.keys(appData.stations).length === 0) return;
            let logs = [];
            if (appData.faultsLog) { logs = Array.isArray(appData.faultsLog) ? appData.faultsLog : Object.values(appData.faultsLog);
            }
            let changesMade = false;
            const nowStd = getStandardDateTime();
            let activeGroups = {};
            logs.forEach((log, index) => {
                if (log.active) {
                    const key = `${log.station}|${log.type}`;
                    if (!activeGroups[key]) activeGroups[key] = [];
                    activeGroups[key].push({ index: index, log: log });
                }
            });
            Object.keys(activeGroups).forEach(key => {
                const group = activeGroups[key];
                const sample = group[0].log;
                const s = appData.stations[sample.station];
                const isReal = s && (s.currentFault === sample.type || s.secondaryFault === sample.type);
                if (!isReal) {
                    group.forEach(item => { logs[item.index].active = false; logs[item.index].endTime = nowStd.full; changesMade = true; });
                } else {
                    if (group.length > 1) {
                        group.sort((a, b) => b.index - a.index);
                        for (let i = 1; i < group.length; i++) { logs[group[i].index].active = false; logs[group[i].index].endTime = nowStd.full; changesMade = true; }
                    }
                }
            });
            let uniqueArchiveMap = new Set();
            let finalLogs = [];
            logs.forEach(log => {
                if (log.active) { finalLogs.push(log); } 
                else {
                    const key = `${log.station}|${log.type}|${log.startTime}`;
                    if (!uniqueArchiveMap.has(key)) { uniqueArchiveMap.add(key); finalLogs.push(log); } else { changesMade = true; }
                }
            });
            if (changesMade) { db.ref('faults_log').set(finalLogs).then(() => { renderFaultsLog(); }); } 
            else { renderFaultsLog();
            }
        };

        window.renderFaultsLog = () => {
            const activeBody = document.getElementById('active-faults-body');
            const historyBody = document.getElementById('history-faults-body');
            const loadMoreBtn = document.getElementById('load-more-faults-btn');
            const statusText = document.getElementById('faults-status-text');
            const filterSelect = document.getElementById('fault-archive-station-filter');
            if (filterSelect.options.length <= 1 && Object.keys(appData.stations).length > 0) {
                const sortedStations = Object.values(appData.stations).sort((a,b) => a.name.localeCompare(b.name));
                sortedStations.forEach(s => { filterSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`; });
            }

            activeBody.innerHTML = '';
            historyBody.innerHTML = '';
            let logs = [];
            if (appData.faultsLog) { logs = Array.isArray(appData.faultsLog) ? appData.faultsLog : Object.values(appData.faultsLog);
            }
            
            const activeFaults = logs.filter(f => f.active);
            const pastFaults = logs.filter(f => !f.active);
            
            if (activeFaults.length === 0) activeBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø·Ø§Ù„ Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
            else activeFaults.forEach(f => {
                const icon = faultIcons[f.type] || 'âš ï¸';
                let style = 'color: var(--danger-color);';
                if (f.type === 'ÙƒØ³Ø± ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©') style = 'color: var(--blue-fault);';
                if (f.type === 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ SCADA') style = 'color: #f39c12;';
                activeBody.innerHTML += `<tr><td><b>${f.station}</b></td><td style="${style} font-weight:bold;">${icon} ${f.type}</td><td>${f.startTime}</td><td>Ù…Ø³ØªÙ…Ø±...</td></tr>`;
            });
            const filterVal = filterSelect.value;
            let filteredPast = pastFaults;
            if (filterVal !== 'all') { filteredPast = pastFaults.filter(f => f.station === filterVal);
            }

            const faultsToShow = filteredPast.slice(0, appData.faultsLimit);
            if (faultsToShow.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="5" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
                loadMoreBtn.style.display = 'none';
                statusText.textContent = '';
            } else {
                faultsToShow.forEach(f => {
                    const icon = faultIcons[f.type] || '';
                    historyBody.innerHTML += `<tr><td>${f.station}</td><td>${icon} ${f.type}</td><td>${f.startTime}</td><td>${f.endTime}</td><td style="color:green">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</td></tr>`;
                });
                if (filteredPast.length > appData.faultsLimit) {
                    loadMoreBtn.style.display = 'inline-block';
                    const remaining = filteredPast.length - appData.faultsLimit;
                    statusText.textContent = `ÙŠØªÙ… Ø¹Ø±Ø¶ ${faultsToShow.length} Ù…Ù† Ø£ØµÙ„ ${filteredPast.length} Ø¹Ø·Ù„ Ù…Ø¤Ø±Ø´Ù (Ù…ØªØ¨Ù‚ÙŠ ${remaining})`;
                } else {
                    loadMoreBtn.style.display = 'none';
                    statusText.textContent = `ØªÙ… Ø¹Ø±Ø¶ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø­Ø¯Ø¯ (${filteredPast.length})`;
                }
            }
        };
        // --- USERS MANAGEMENT ---
        document.getElementById('users-management-btn').addEventListener('click', () => { renderUsersManagement(); showScreen('users'); });
        function renderUsersManagement() {
            const tbody = document.getElementById('users-table-body');
            const searchValue = document.getElementById('search-user-input') ? document.getElementById('search-user-input').value.toLowerCase() : '';
            tbody.innerHTML = '';
            Object.values(appData.users).forEach(u => {
                if (!u.username.toLowerCase().includes(searchValue)) return;
                let showDeleteBtn = false;
                const currentUserType = appData.currentUser.type;
                const showPassword = currentUserType === 'admin';
                if (u.username === appData.currentUser.username) showDeleteBtn = false; 
                else if (currentUserType === 'admin') showDeleteBtn = true; 
                else if (currentUserType === 'supervisor' && u.type === 'operator') showDeleteBtn = true; 
                else if (currentUserType === 'engineer' && (u.type === 'operator' || u.type === 'supervisor')) showDeleteBtn = true; 
                tbody.innerHTML += `<tr><td>${u.username}</td><td>${appData.userTypes[u.type].name}</td><td style="font-family: monospace;">${showPassword ? u.password : '******'}</td><td>${u.active ? 'Ù†Ø´Ø·' : 'x'}</td><td>${showDeleteBtn ? `<button class="btn btn-danger" style="padding:2px 5px;" onclick="deleteUser('${u.username}')">Ø­Ø°Ù</button>` : ''}</td></tr>`;
            });
        }
        window.deleteUser = (u) => { if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) db.ref('users/' + u).remove();
        };
        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('user-form-container').style.display = 'block';
            const typeSelect = document.getElementById('new-user-type');
            const currentUserType = appData.currentUser.type;
            typeSelect.innerHTML = ''; 
            const allOptions = [{ val: 'operator', text: 'Ù…Ø´ØºÙ„' }, { val: 'supervisor', text: 'Ù…Ø´Ø±Ù' }, { val: 'engineer', text: 'Ù…Ù‡Ù†Ø¯Ø³' }, { val: 'admin', text: 'Ù…Ø¯ÙŠØ±' }];
            allOptions.forEach(opt => {
                if (currentUserType === 'admin') typeSelect.innerHTML += `<option value="${opt.val}">${opt.text}</option>`;
                else if (currentUserType === 'engineer') { if (opt.val === 'operator' || opt.val === 'supervisor') typeSelect.innerHTML += `<option value="${opt.val}">${opt.text}</option>`; }
                else if (currentUserType === 'supervisor') { if (opt.val === 'operator') typeSelect.innerHTML += `<option value="${opt.val}">${opt.text}</option>`; }
            });
        });
        document.getElementById('cancel-user-btn').addEventListener('click', () => document.getElementById('user-form-container').style.display = 'none');
        document.getElementById('save-user-btn').addEventListener('click', () => {
            const u = document.getElementById('new-username').value, p = document.getElementById('new-password').value, t = document.getElementById('new-user-type').value;
            if(!u || !p) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');
            if(appData.users[u]) return alert('Ù…ÙˆØ¬ÙˆØ¯');
            db.ref('users/' + u).set({ username: u, password: p, type: t, active: true });
            document.getElementById('user-form-container').style.display = 'none';
        });

        // --- HISTORY SCREEN ---
        document.getElementById('history-management-btn').addEventListener('click', () => { populateHistoryFilters(); renderHistoryTable(true); showScreen('history'); });
        function populateHistoryFilters() {
            const zoneSelect = document.getElementById('filter-zone');
            zoneSelect.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
            appData.zones.forEach(z => zoneSelect.innerHTML += `<option value="${z}">${z}</option>`);
            updateStationFilter();
        }
        window.updateStationFilter = () => {
            const zone = document.getElementById('filter-zone').value;
            const stationSelect = document.getElementById('filter-station');
            stationSelect.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª</option>';
            const allStations = Object.values(appData.stations);
            const stationsToShow = zone === 'all' ? allStations : allStations.filter(s => s.zone === zone);
            stationsToShow.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                stationSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`;
            });
        };

        // --- FIXED DATE PARSER ---
        function parseLogDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // new Date(Year, MonthIndex, Day)
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return null;
        }

        document.getElementById('load-more-history-btn').addEventListener('click', () => {
            appData.historyLimit += 100;
            renderHistoryTable(false);
        });
        window.renderHistoryTable = (reset = false) => {
            const tbody = document.getElementById('history-table-body');
            const loadMoreBtn = document.getElementById('load-more-history-btn');
            const statusText = document.getElementById('history-status-text');

            if (reset) { appData.historyLimit = 100; tbody.innerHTML = '';
            } 
            else { tbody.innerHTML = '';
            }

            const fZone = document.getElementById('filter-zone').value;
            const fStation = document.getElementById('filter-station').value;
            const fDateFromInput = document.getElementById('filter-date-from').value; // YYYY-MM-DD
            const fDateToInput = document.getElementById('filter-date-to').value;
            // YYYY-MM-DD
            
            // Convert inputs to Date objects at Midnight
            const fDateFrom = fDateFromInput ? new Date(fDateFromInput) : null;
            if(fDateFrom) fDateFrom.setHours(0,0,0,0);
            
            const fDateTo = fDateToInput ? new Date(fDateToInput) : null;
            if(fDateTo) fDateTo.setHours(0,0,0,0);
            const filtered = appData.operationHistory.filter(h => {
                let valid = true;
                if(fStation !== 'all' && h.station !== fStation) valid = false;
                if(fZone !== 'all') { 
                    const s = appData.stations[h.station]; 
                    if(!s || s.zone !== fZone) valid = false; 
                }
                if(fDateFrom || fDateTo) {
                    const rowDate = parseLogDate(h.date);
                    if (rowDate) {
                        rowDate.setHours(0,0,0,0);
                        if(fDateFrom && rowDate < fDateFrom) valid = false;
                        if(fDateTo && rowDate > fDateTo) valid = false;
                    }
                }
                return valid;
            });
            const dataToShow = filtered.slice(0, appData.historyLimit);
            if(dataToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
                loadMoreBtn.style.display = 'none';
                statusText.textContent = '';
            } else {
                dataToShow.forEach(h => { 
                    tbody.innerHTML += `<tr><td>${h.date} <br> <small style='color:#666'>${h.time}</small></td><td>${h.station}</td><td>${h.operator}</td><td>${h.details}</td></tr>`; 
                });
                if (filtered.length > appData.historyLimit) {
                    loadMoreBtn.style.display = 'inline-block';
                    const remaining = filtered.length - appData.historyLimit;
                    statusText.textContent = `ÙŠØªÙ… Ø¹Ø±Ø¶ ${dataToShow.length} Ù…Ù† Ø£ØµÙ„ ${filtered.length} Ø³Ø¬Ù„ (Ù…ØªØ¨Ù‚ÙŠ ${remaining})`;
                } else {
                    loadMoreBtn.style.display = 'none';
                    statusText.textContent = `ØªÙ… Ø¹Ø±Ø¶ ÙƒØ§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª (${filtered.length})`;
                }
            }
        };
        // Navigation Back Buttons
        document.getElementById('back-to-stations').addEventListener('click', () => { showScreen('stations'); });
        document.getElementById('back-to-station').addEventListener('click', () => showStationDetails(appData.currentStation));
        document.getElementById('back-to-stations-from-users').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-history').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-faults').addEventListener('click', () => showScreen('stations'));
        // Initial Load
        checkRememberedUser();
        loadSystemData();
    </script>
</body>
            </html>
