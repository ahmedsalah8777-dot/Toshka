d<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ŸÜÿ∏ÿßŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑŸÖŸäÿßŸá ÿßŸÑÿ∞ŸÉŸä (Toshka V1.5)</title>
    <style>
        :root {
            --primary-color: #1a5276;
            --secondary-color: #2e86c1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --consumption-color: #2980b9;
            --light-bg: #f4f6f7;
            --card-bg: #ffffff;
            --header-bg: #eaf2f8;
            --scada-fault-color: #e67e22;
            --blue-fault: #87CEFA;
            --grey-color: #95a5a6;
            --profile-color: #9b59b6;
            --excel-color: #217346;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background-color: var(--light-bg); 
            color: #333; 
            line-height: 1.6; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 10px; 
            flex: 1; 
            width: 100%; 
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑŸáŸàÿßÿ™ŸÅ ÿßŸÑŸÖÿ≠ŸÖŸàŸÑÿ© */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
                margin: 0 auto;
                width: 100%;
            }
            
            .screen {
                margin-left: 2px;
                margin-right: 2px;
                padding-left: 8px;
                padding-right: 8px;
            }
            
            .detail-card, .stat-card, .station-card {
                margin-left: 2px;
                margin-right: 2px;
            }
        }

        /* Header */
        header { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: white; 
            padding: 10px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 20px; 
            font-weight: bold; 
        }
        
        /* Network Status Indicator */
        .network-status { 
            font-size: 0.8rem; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .net-online { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .net-offline { 
            background: #f8d7da; 
            color: #721c24; 
        }
        
        .syncing { 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            100% { 
                transform: rotate(360deg); 
            } 
        }

        /* Ticker Styles */
        .ticker-container { 
            background-color: var(--danger-color); 
            color: white; 
            height: 40px; 
            overflow: hidden; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            display: none; 
            align-items: center; 
            box-shadow: 0 3px 5px rgba(0,0,0,0.1); 
            border: 2px solid #922b21; 
        }
        
        .ticker-container.active { 
            display: flex; 
        }
        
        .ticker-label { 
            background: rgba(0,0,0,0.3); 
            height: 100%; 
            padding: 0 10px; 
            display: flex; 
            align-items: center; 
            font-weight: bold; 
            white-space: nowrap; 
            z-index: 2; 
        }
        
        .ticker-text-wrap { 
            flex: 1; 
            overflow: hidden; 
            white-space: nowrap; 
            position: relative; 
            height: 100%; 
            display: flex; 
            align-items: center; 
        }
        
        .ticker { 
            display: inline-block; 
            white-space: nowrap; 
            padding-right: 100%; 
            animation-name: ticker; 
            animation-timing-function: linear; 
            animation-iteration-count: infinite; 
        }
        
        .ticker-item { 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            padding: 0 2px; 
            font-weight: bold; 
            font-size: 1rem; 
            color: white !important; 
        }
        
        .ticker-separator { 
            display: inline-block; 
            margin: 0 8px; 
            color: rgba(255, 255, 255, 0.8); 
            font-weight: normal; 
        }
        
        @keyframes ticker { 
            0% { 
                transform: translate3d(0, 0, 0); 
            } 
            100% { 
                transform: translate3d(100%, 0, 0); 
            } 
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        .user-info { 
            display: none; 
            align-items: center; 
            gap: 8px; 
            flex-wrap: wrap; 
            justify-content: flex-end; 
        }
        
        @media (max-width: 768px) {
            .user-info {
                gap: 4px;
            }
            
            .user-badge { 
                font-size: 10px !important;
                padding: 3px 6px !important;
            }
            
            .alarm-btn, .profile-btn { 
                font-size: 1.2rem !important;
                margin-left: 5px !important;
                min-width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .alarm-count { 
                top: -2px !important;
                right: -2px !important;
                width: 16px !important;
                height: 16px !important;
                font-size: 9px !important;
            }
        }
        
        .user-badge { 
            background: rgba(255,255,255,0.2); 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 12px; 
            white-space: nowrap; 
        }
        
        .alarm-btn, .profile-btn { 
            background: transparent; 
            border: none; 
            color: white; 
            font-size: 1.4rem; 
            cursor: pointer; 
            position: relative; 
            margin-left: 10px; 
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .alarm-btn.flashing { 
            animation: bell-shake 1s infinite cubic-bezier(.36,.07,.19,.97) both, red-glow 1.5s infinite; 
            color: #ffcccc; 
        }
        
        .alarm-count { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: red; 
            color: white; 
            border-radius: 50%; 
            width: 18px; 
            height: 18px; 
            font-size: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid white; 
        }
        
        @keyframes bell-shake { 
            10%, 90% { 
                transform: translate3d(-1px, 0, 0); 
            } 
            20%, 80% { 
                transform: translate3d(2px, 0, 0); 
            } 
            30%, 50%, 70% { 
                transform: translate3d(-4px, 0, 0); 
            } 
            40%, 60% { 
                transform: translate3d(4px, 0, 0); 
            } 
        }
        
        @keyframes red-glow { 
            0% { 
                text-shadow: 0 0 5px red; 
            } 
            50% { 
                text-shadow: 0 0 20px red; 
            } 
            100% { 
                text-shadow: 0 0 5px red; 
            } 
        }

        /* Shift Warning Icon */
        .missed-update-icon { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 20px; 
            height: 20px; 
            background-color: #e74c3c; 
            color: white; 
            border-radius: 50%; 
            font-size: 14px; 
            font-weight: bold; 
            margin-right: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            animation: pulse-red 2s infinite; 
            vertical-align: middle; 
        }
        
        @keyframes pulse-red { 
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); 
            } 
            70% { 
                transform: scale(1.05); 
                box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); 
            } 
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); 
            } 
        }

        /* UI Components */
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 14px; 
            justify-content: center; 
        }
        
        .btn-sm { 
            padding: 4px 8px; 
            font-size: 12px; 
        }
        
        .btn-primary { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        
        .btn-success { 
            background-color: var(--success-color); 
            color: white; 
        }
        
        .btn-danger { 
            background-color: var(--danger-color); 
            color: white; 
        }
        
        .btn-outline { 
            background-color: transparent; 
            border: 1px solid var(--secondary-color); 
            color: var(--secondary-color); 
        }
        
        .btn-warning { 
            background-color: var(--warning-color); 
            color: white; 
        }
        
        .btn-info { 
            background-color: #17a2b8; 
            color: white; 
        }
        
        .btn-consumption { 
            background-color: var(--consumption-color); 
            color: white; 
        }
        
        .btn-profile { 
            background-color: var(--profile-color); 
            color: white; 
        }
        
        .btn-excel { 
            background-color: var(--excel-color); 
            color: white; 
        }
        
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-2px); 
        }

        .screen { 
            display: none; 
            background: var(--card-bg); 
            border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            padding: 15px; 
            margin-top: 15px; 
            min-height: 500px; 
        }
        
        @media (max-width: 768px) {
            .screen {
                border-radius: 8px;
                padding: 10px;
                margin-left: 2px;
                margin-right: 2px;
                margin-top: 10px;
                min-height: 450px;
            }
        }
        
        .active { 
            display: block; 
            animation: fadeIn 0.4s ease; 
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        h2 { 
            color: var(--primary-color); 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
            font-size: 1.2rem; 
        }
        
        /* Grid System */
        .stations-grid { 
            display: grid; 
            gap: 10px; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        }
        
        .station-details { 
            display: grid; 
            gap: 10px; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            margin-top: 20px; 
        }
        
        .dashboard-stats { 
            display: grid; 
            gap: 15px; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        }

        @media (max-width: 768px) {
            .stations-grid { 
                grid-template-columns: 1fr 1fr !important; 
                gap: 6px; 
            }
            
            .station-card { 
                padding: 6px; 
                font-size: 0.8rem; 
            }
            
            .station-card div { 
                white-space: nowrap; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }
            
            .dashboard-stats { 
                display: flex !important; 
                flex-direction: row; 
                gap: 5px; 
            }
            
            .dashboard-stats .stat-card { 
                flex: 1; 
                padding: 6px; 
                text-align: center; 
                min-width: 0; 
            }
            
            .dashboard-stats .stat-label { 
                font-size: 0.7rem; 
                white-space: nowrap; 
            }
            
            .dashboard-stats .stat-value { 
                font-size: 1rem; 
            }
            
            .station-details {
                gap: 6px;
                grid-template-columns: 1fr 1fr;
            }
            
            .detail-card {
                padding: 8px;
            }
            
            .detail-title {
                font-size: 0.8rem;
            }
            
            .detail-value {
                font-size: 1rem;
            }
        }
        
        .stat-card, .station-card, .detail-card { 
            background: var(--card-bg); 
            border-radius: 8px; 
            padding: 15px; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.05); 
            border: 1px solid #eee; 
        }
        
        .station-card { 
            border-top: 4px solid var(--secondary-color); 
            cursor: pointer; 
            transition: 0.3s; 
            padding: 10px; 
            font-size: 0.95rem; 
            position: relative; 
            overflow: hidden; 
        }
        
        .station-card:active { 
            transform: scale(0.98); 
        }
        
        .station-card.fault-active { 
            border-top-color: var(--danger-color); 
            animation: card-flash 2s infinite; 
            background-color: #fff5f5; 
            border: 1px solid var(--danger-color); 
        }
        
        .station-card.fault-active.scada-fault { 
            border-top-color: var(--scada-fault-color); 
            background-color: #fffaf0; 
            border: 1px solid var(--scada-fault-color); 
        }
        
        @keyframes card-flash { 
            0% { 
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); 
            } 
            70% { 
                box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); 
            } 
            100% { 
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); 
            } 
        }
        
        .fault-badge { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            background: var(--danger-color); 
            color: white; 
            font-size: 0.8rem; 
            padding: 2px 8px; 
            border-radius: 4px; 
            margin-top: 5px; 
            text-align: center; 
            font-weight: bold; 
        }
        
        .fault-badge.scada-badge { 
            background: var(--scada-fault-color); 
        }

        .stat-value { 
            font-size: 24px; 
            font-weight: bold; 
            color: var(--primary-color); 
        }
        
        .detail-title { 
            font-size: 0.9rem; 
            color: #777; 
            margin-bottom: 5px; 
        }
        
        .detail-value { 
            font-size: 1.2rem; 
            font-weight: 600; 
            color: #333; 
            word-break: break-all; 
        }
        
        .detail-value.operator-highlight { 
            color: var(--secondary-color); 
        }

        .table-responsive { 
            overflow-x: auto; 
            margin-top: 15px; 
            border-radius: 8px; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; 
        }
        
        th { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 12px; 
            text-align: right; 
        }
        
        td { 
            padding: 10px 12px; 
            text-align: right; 
            border-bottom: 1px solid #eee; 
            vertical-align: top; 
        }
        
        tr:nth-child(even) { 
            background-color: #f9f9f9; 
        }

        .form-group { 
            margin-bottom: 15px; 
            position: relative; 
        }
        
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            background: #fff; 
        }
        
        .station-status { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
        }
        
        .status-active { 
            background-color: #d4edda; 
            color: #155724; 
        }
        
        .status-inactive { 
            background-color: #f8d7da; 
            color: #721c24; 
        }

        .zone-separator { 
            grid-column: 1 / -1; 
            background-color: var(--header-bg); 
            color: var(--primary-color); 
            padding: 10px 15px; 
            border-radius: 6px; 
            margin-top: 20px; 
            margin-bottom: 10px; 
            font-weight: bold; 
            font-size: 1.1rem; 
            border-right: 5px solid var(--secondary-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .nav-tabs { 
            display: flex; 
            overflow-x: auto; 
            gap: 8px; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #ddd; 
        }
        
        .nav-tab { 
            padding: 8px 16px; 
            border-radius: 20px; 
            background: #eee; 
            cursor: pointer; 
            white-space: nowrap; 
            border:none; 
        }
        
        .nav-tab.active { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        
        .password-container { 
            position: relative; 
        }
        
        .toggle-password { 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            cursor: pointer; 
            color: #666; 
        }
        
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            justify-content: flex-start; 
            margin-bottom: 15px; 
        }
        
        .checkbox-group input { 
            width: auto; 
            margin: 0; 
        }
        
        .pump-controls { 
            display: grid; 
            gap: 15px; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        }
        
        .pump-control { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #e9ecef; 
        }
        
        .alert { 
            padding: 15px; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            display: none; 
        }
        
        .alert-success { 
            background-color: #d4edda; 
            color: #155724; 
        }
        
        .alert-warning { 
            background-color: #fff3cd; 
            color: #856404; 
        }
        
        .signature { 
            text-align: center; 
            margin-top: 30px; 
            font-size: 12px; 
            color: #888; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
            font-weight: bold; 
        }
        
        .login-form { 
            max-width: 400px; 
            margin: 40px auto; 
            text-align: center; 
        }
        
        .pagination-controls { 
            text-align: center; 
            margin-top: 20px; 
            padding-bottom: 20px; 
        }
        
        .pagination-btn { 
            margin: 10px; 
        }
        
        .status-text { 
            font-size: 0.85rem; 
            color: #666; 
            margin-bottom: 10px; 
        }
        
        .scada-icon-svg { 
            vertical-align: text-bottom; 
        }
        
        .fault-row-action { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: white; 
            padding: 8px; 
            border-radius: 4px; 
            margin-bottom: 8px; 
            border-right: 3px solid var(--danger-color); 
        }
        
        .desc-input { 
            margin-top: 5px; 
            font-size: 0.9rem; 
            background: #fff; 
            border: 1px solid #ccc; 
        }

        /* --- INSPECTION SCREEN STYLES (MOBILE OPTIMIZED) --- */
        .section-accordion { 
            margin-bottom: 10px; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid #ddd; 
            background: #fff; 
        }
        
        .section-header-static { 
            background: #eaf2f8; 
            color: var(--primary-color); 
            padding: 12px 15px; 
            font-weight: bold; 
            font-size: 1.1rem; 
            border-bottom: 1px solid #ddd; 
        }
        
        .section-accordion-header { 
            background: linear-gradient(to right, #2c3e50, #34495e); 
            color: white; 
            padding: 15px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            font-size: 1.1rem; 
            border-radius: 8px; 
            transition: all 0.2s; 
        }
        
        .section-accordion-header:active { 
            transform: scale(0.99); 
        }
        
        .section-accordion-header .arrow { 
            transition: transform 0.3s; 
        }
        
        .section-accordion-header.active .arrow { 
            transform: rotate(180deg); 
        }
        
        .section-accordion-body { 
            display: none; 
            padding: 10px; 
            background: #fff; 
        }
        
        .section-accordion-body.open { 
            display: block; 
            animation: fadeIn 0.3s; 
        }
        
        .section-body-static { 
            display: block; 
            padding: 10px; 
            background: #fff; 
        }
        
        .inspection-row { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 8px; 
            padding: 12px; 
            border-bottom: 1px solid #f0f0f0; 
            background: #fff; 
            margin-bottom: 5px; 
            border-radius: 8px; 
            border: 1px solid #eee; 
        }
        
        .inspection-row:last-child { 
            margin-bottom: 0; 
        }
        
        @media (min-width: 768px) { 
            .inspection-row { 
                grid-template-columns: 1fr 180px 1.5fr; 
                align-items: center; 
                gap: 15px; 
            } 
        }
        
        .inspection-label { 
            font-size: 1rem; 
            font-weight: 600; 
            color: var(--secondary-color); 
            margin-bottom: 2px; 
        }
        
        .inspection-status-select { 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 500; 
            width: 100%; 
            border: 1px solid #ccc; 
            appearance: none; 
            -webkit-appearance: none; 
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); 
            background-repeat: no-repeat; 
            background-position: left 10px top 50%; 
            background-size: 12px; 
            padding-left: 30px; 
        }
        
        .inspection-status-select.efficient { 
            color: #155724; 
            border-color: #28a745; 
            background-color: #d4edda; 
        }
        
        .inspection-status-select.fault { 
            color: #856404; 
            border-color: #ffeeba; 
            background-color: #fff3cd; 
        }
        
        .inspection-status-select.broken { 
            color: #721c24; 
            border-color: #f5c6cb; 
            background-color: #f8d7da; 
        }
        
        .inspection-status-select.none { 
            color: #333; 
            border-color: #ccc; 
            background-color: #e2e3e5; 
        }
        
        .inspection-desc-input { 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            width: 100%; 
            font-size: 0.9rem; 
        }
        
        .pump-accordion-item { 
            margin-bottom: 10px; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid transparent; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        
        .pump-accordion-header { 
            padding: 12px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            font-size: 1rem; 
            color: white; 
            transition: background 0.3s; 
        }
        
        .pump-accordion-header .icon-state { 
            font-size: 1.1rem; 
            background: rgba(0,0,0,0.2); 
            width: 25px; 
            height: 25px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .pump-header-green { 
            background: linear-gradient(45deg, #27ae60, #2ecc71); 
        }
        
        .pump-header-yellow { 
            background: linear-gradient(45deg, #f39c12, #f1c40f); 
            color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        .pump-header-red { 
            background: linear-gradient(45deg, #c0392b, #e74c3c); 
        }
        
        .pump-accordion-body { 
            display: none; 
            padding: 10px; 
            background: #fff; 
            border: 1px solid #eee; 
            border-top: none; 
        }
        
        .pump-accordion-body.open { 
            display: block; 
            animation: slideDown 0.3s ease-out; 
        }
        
        @keyframes slideDown { 
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        .pump-section-divider { 
            background-color: #f0f4f8; 
            padding: 8px 10px; 
            font-weight: bold; 
            color: #2c3e50; 
            border-right: 4px solid var(--secondary-color); 
            margin: 15px 0 5px 0; 
            font-size: 0.95rem; 
            border-radius: 2px; 
        }

        #save-inspection-btn { 
            width: 100%; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            padding: 8px; 
            font-size: 0.95rem; 
            border-radius: 20px; 
            margin-bottom: 5px; 
        }

        /* Offline Banner */
        #offline-sync-banner { 
            display: none; 
            background: #fff3cd; 
            border: 1px solid #ffeeba; 
            color: #856404; 
            padding: 10px; 
            text-align: center; 
            margin-bottom: 10px; 
            border-radius: 8px; 
        }

        /* NEW STYLES FOR CONSUMPTION TABLE (V1.5.9 Modified) */
        .cons-cell { 
            text-align: center; 
            font-size: 0.9rem; 
            padding: 8px !important; 
        }
        
        .cons-sub-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px dashed #eee; 
            padding: 4px 0; 
            text-align: right; 
        }
        
        .cons-label { 
            font-size: 0.8rem; 
            color: #555; 
        }
        
        .cons-date-small { 
            display: block; 
            font-size: 0.7rem; 
            color: #888; 
            margin-top: 2px; 
            line-height: 1.2; 
            width: 100%; 
            text-align: left; 
        }
        
        .cons-result { 
            background-color: #e8f6f3; 
            color: var(--primary-color); 
            font-weight: bold; 
            padding: 6px; 
            margin-top: 5px; 
            border-radius: 4px; 
            text-align: center; 
        }
        
        .cons-val-wrapper { 
            text-align: left; 
        }
        
        /* --- USER PROFILES MANAGEMENT STYLES (ENHANCED FOR MOBILE) --- */
        .profile-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (min-width: 992px) {
            .profile-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .profile-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        
        .profile-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .profile-form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .users-profiles-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .users-profiles-table th {
            background-color: var(--profile-color);
            color: white;
            padding: 12px 8px;
            text-align: right;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        .users-profiles-table td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            font-size: 0.85rem;
        }
        
        .users-profiles-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Mobile optimization for tables */
        @media (max-width: 768px) {
            .users-profiles-table {
                display: block;
                width: 100%;
                overflow-x: auto;
            }
            
            .users-profiles-table th,
            .users-profiles-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
                min-width: 100px;
            }
            
            .users-profiles-table th:first-child,
            .users-profiles-table td:first-child {
                position: sticky;
                left: 0;
                background-color: white;
                z-index: 5;
                min-width: 120px;
            }
            
            .users-profiles-table tr:nth-child(even) td:first-child {
                background-color: #f9f9f9;
            }
        }
        
        .profile-search-container {
            position: relative;
            margin: 15px 0;
        }
        
        .profile-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        #search-profile-input {
            padding-right: 15px;
            padding-left: 45px;
            font-size: 0.95rem;
            width: 100%;
        }
        
        .no-profiles-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ddd;
            margin: 20px 0;
        }
        
        .user-profile-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            background-color: var(--secondary-color);
            color: white;
            margin-left: 5px;
        }
        
        .profile-alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .profile-alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .profile-alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .profile-alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Action buttons */
        .delete-profile-btn {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            margin: 0 auto;
        }
        
        .delete-profile-btn:hover {
            background: linear-gradient(135deg, #a93226, #c0392b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(192, 57, 43, 0.3);
        }
        
        /* Mobile action menu */
        .mobile-action-menu {
            position: relative;
            display: none;
        }
        
        @media (max-width: 768px) {
            .desktop-actions {
                display: none !important;
            }
            
            .mobile-action-menu {
                display: block;
            }
            
            .mobile-action-btn {
                background: #f0f0f0;
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 1.2rem;
            }
            
            .mobile-action-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                min-width: 150px;
                z-index: 100;
                display: none;
            }
            
            .mobile-action-dropdown.show {
                display: block;
            }
            
            .mobile-action-item {
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
            }
            
            .mobile-action-item:hover {
                background: #f5f5f5;
            }
            
            .mobile-action-item:last-child {
                border-bottom: none;
            }
            
            .mobile-action-item.delete-action {
                color: #c0392b;
            }
        }

        /* --- USERS MANAGEMENT STYLES (SIMPLIFIED) --- */
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--header-bg);
        }
        
        .user-form-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid var(--secondary-color);
        }
        
        .user-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .user-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .users-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .delete-user-btn {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .delete-user-btn:hover {
            background: linear-gradient(135deg, #a93226, #c0392b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(192, 57, 43, 0.3);
        }
        
        .no-users-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ddd;
            margin: 20px 0;
        }
        
        .users-search-container {
            position: relative;
            margin: 15px 0;
        }
        
        .users-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        #search-user-input {
            padding-right: 15px;
            padding-left: 45px;
            font-size: 0.95rem;
        }
        
        /* NEW STYLES FOR PASSWORD VISIBILITY */
        .password-cell {
            position: relative;
            padding-right: 30px !important;
        }
        
        .toggle-password-cell {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 14px;
            background: none;
            border: none;
            color: #666;
            display: none;
        }
        
        .password-masked {
            font-family: monospace;
            letter-spacing: 2px;
            color: #666;
        }
        
        .password-visible {
            font-family: monospace;
            letter-spacing: 1px;
            color: #333;
        }
        
        .user-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .type-admin { background-color: #d32f2f; color: white; }
        .type-engineer { background-color: #1976d2; color: white; }
        .type-supervisor { background-color: #388e3c; color: white; }
        .type-operator { background-color: #f57c00; color: white; }

        /* NEW: ÿ¨ÿØŸàŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿπ ÿ™ŸÜÿ≥ŸäŸÇ ŸÖÿ≠ÿ≥ŸÜ */
        .users-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .users-data-table thead {
            background: linear-gradient(135deg, var(--profile-color), #8e44ad);
        }
        
        .users-data-table th {
            padding: 14px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        .users-data-table th:first-child {
            border-right: none;
        }
        
        .users-data-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .users-data-table tr:hover {
            background-color: #f5f9ff;
        }
        
        .users-data-table .action-cell {
            min-width: 120px;
        }
        
        /* Pagination styles */
        .pagination-info {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .load-more-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 25px;
            background: linear-gradient(135deg, var(--secondary-color), #3498db);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        .load-more-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
            background: linear-gradient(135deg, #2980b9, var(--secondary-color));
        }
        
        .load-more-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Card for user data screen */
        .user-data-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .user-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--header-bg);
        }
        
        .user-data-title {
            color: var(--profile-color);
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        /* ÿ™ÿµÿØŸäÿ± Excel button */
        .export-excel-btn {
            background: linear-gradient(135deg, var(--excel-color), #2e8b57);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .export-excel-btn:hover {
            background: linear-gradient(135deg, #1e5e3b, var(--excel-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 115, 70, 0.3);
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ */
        .inspection-export-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* ÿπŸÑÿßŸÖÿ© ÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑÿπÿßŸÑŸä */
        .pressure-warning {
            display: inline-block;
            background-color: #ff9800;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 18px;
            margin-right: 5px;
            animation: pulse-orange 2s infinite;
            vertical-align: middle;
        }
        
        @keyframes pulse-orange {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 5px rgba(255, 152, 0, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
        
        /* ÿ™ÿµŸÖŸäŸÖ ÿÆÿßÿµ ŸÑÿµŸÅ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≠ÿßŸÑÿ© ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ */
        .status-change-row {
            background-color: #e8f5e9 !important;
            border-right: 4px solid #4caf50 !important;
            font-weight: bold;
        }
        
        .status-change-row.status-to-inactive {
            background-color: #ffebee !important;
            border-right: 4px solid #f44336 !important;
        }
        
        .status-change-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .status-change-active {
            background-color: #4caf50;
            color: white;
        }
        
        .status-change-inactive {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i>üíß</i> <span>ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸäÿßŸá ÿßŸÑÿ∞ŸÉŸä (Toshka)</span>
                </div>
             
                <div id="network-status-indicator" class="network-status net-online">
                    <span id="net-icon">üü¢</span> <span id="net-text">ŸÖÿ™ÿµŸÑ</span>
                </div>
                <div class="user-info" id="header-user-info">
                    <button id="profile-btn" class="profile-btn" title="ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                        üìã
                    </button>
                    <button id="alarm-btn" class="alarm-btn" title="ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ">
                        üîî
                        <span id="alarm-count" class="alarm-count" style="display:none">0</span>
                    </button>
                    <div class="user-badge" id="current-user">ŸÖÿ±ÿ≠ÿ®ÿßŸã</div>
                    
                    <button id="users-management-btn" class="btn btn-warning" style="display: none;">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</button>
                    <button id="consumptions-btn" class="btn btn-consumption" style="display: none;">‚ö° ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉÿßÿ™</button>
                    <button id="history-management-btn" class="btn btn-info" style="display: none;">ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿπÿßŸÖ</button>
                    <button id="export-inspection-report-btn" class="btn btn-excel" style="display: none;" title="ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ">üìä ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÅÿ≠ÿµ</button>
                    <button id="logout-btn" class="btn btn-danger">ÿÆÿ±Ÿàÿ¨</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="offline-sync-banner">
            ŸäŸàÿ¨ÿØ <b><span id="offline-count">0</span></b> ÿπŸÖŸÑŸäÿßÿ™ ŸÖÿπŸÑŸÇÿ©.
ÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπŸáÿß ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿπŸàÿØÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. ‚è≥
        </div>

        <div id="login-screen" class="screen active">
            <div class="login-form">
                <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                    <input type="text" id="username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                    <div class="password-container">
                        <input type="password" id="password" placeholder="admin123">
                        <span class="toggle-password" id="toggle-password-icon">üëÅÔ∏è</span>
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">ÿ™ÿ∞ŸÉÿ±ŸÜŸä</label>
                </div>
                <button id="login-btn" class="btn" style="width: 100%; background-color: #bdc3c7; color: #fff; cursor: not-allowed;" disabled>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ...</button>
            </div>
            <div class="signature">Implemented by Ahmed Salah Ibrahim 2025 V1.5.9</div>
        </div>

        <div id="stations-screen" class="screen">
            <div id="ticker-container" class="ticker-container">
                <div class="ticker-label">‚ö†Ô∏è</div>
                <div class="ticker-text-wrap">
                    <div id="ticker-content" class="ticker"></div>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card"><div class="stat-label">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</div><div class="stat-value" id="total-stations">0</div></div>
                <div class="stat-card"><div class="stat-label">ÿßŸÑŸÜÿ¥ÿ∑ÿ©</div><div class="stat-value" id="active-stations">0</div></div>
                <div class="stat-card"><div class="stat-label">ÿßŸÑŸÖÿ™ŸàŸÇŸÅÿ©</div><div class="stat-value" id="inactive-stations">0</div></div>
            </div>
            <div id="repair-alert" class="alert alert-success" style="display:none; margin-top:10px;"></div>
            <div class="nav-tabs" id="zones-tabs"></div>
            <div id="stations-container" class="stations-wrapper">
                <div style="text-align:center; padding:20px; color:#666;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™...</div>
            </div>
        </div>

        <div id="station-screen" class="screen">
            <h2 id="station-title">ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</h2>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="back-to-stations" class="btn btn-outline">ÿπŸàÿØÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©</button>
                <button id="view-inspection-btn" class="btn btn-info">üìã ÿπÿ±ÿ∂ ÿßŸÑŸÅÿ≠ÿµ</button>
            </div>
            
            <div id="station-fault-banner" class="alert" style="background: #ffecec; color: #b71c1c; border: 1px solid #ffcdd2; margin-top: 15px; display: none;">
                <div style="margin-bottom: 5px;">‚ö†Ô∏è <b>ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ¨ŸÑÿ© ÿ≠ÿßŸÑŸäÿßŸã:</b></div>
                <ul id="station-fault-list" style="padding-right: 20px; margin: 0;"></ul>
            </div>

            <div class="station-details" style="margin-top: 20px;">
                <div class="detail-card"><div class="detail-title">ÿßŸÑÿ≠ÿßŸÑÿ©</div><div class="detail-value" id="station-status-value">-</div></div>
                <div class="detail-card"><div class="detail-title">ÿßŸÑŸÖÿ¥ÿ∫ŸÑ</div><div class="detail-value operator-highlight" id="operator-name-value">-</div></div>
                <div class="detail-card"><div class="detail-title">ÿßŸÑÿ¨ŸáÿØ ÿßŸÑŸÉŸáÿ±ÿ®Ÿä (V)</div><div class="detail-value" id="voltage-value">-</div></div>
                <div class="detail-card"><div class="detail-title">ÿßŸÑÿ∂ÿ∫ÿ∑ (Bar)</div><div class="detail-value" id="station-pressure-value">-</div></div>
                <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿßŸÜÿ© ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ -->
                <div class="detail-card"><div class="detail-title">ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ (Bar)</div><div class="detail-value" id="max-pressure-value">-</div></div>
                <div class="detail-card"><div class="detail-title">ÿßŸÑŸÖÿ∂ÿÆÿßÿ™ ÿßŸÑÿπÿßŸÖŸÑÿ©</div><div class="detail-value" id="active-pumps-value">-</div></div>
                <div class="detail-card"><div class="detail-title">ÿßŸÑÿ™ÿØŸÅŸÇ (L/Sec)</div><div class="detail-value" id="water-flow-value">-</div></div>
                <div class="detail-card"><div class="detail-title">ÿßŸÑŸÜÿ∏ÿßŸÖ</div><div class="detail-value" id="system-mode-value">-</div></div>
                
                <div style="grid-column: 1 / -1; display: flex; gap: 10px;">
                    <div class="detail-card" style="flex: 1;"><div class="detail-title">ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ</div><div class="detail-value" id="start-time-value" style="color:var(--success-color); font-weight:bold;">-</div></div>
                    <div class="detail-card" style="flex: 1;"><div class="detail-title">ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅ</div><div class="detail-value" id="stop-time-value" style="color:var(--danger-color); font-weight:bold;">-</div></div>
                </div>

                <div style="grid-column: 1 / -1; margin-top:10px; border-top: 1px solid #eee; padding-top:10px;">
                    <h4 style="color:var(--consumption-color); margin-bottom:10px;">üìä ÿ¢ÿÆÿ± ŸÇÿ±ÿßÿ°ÿ© ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ</h4>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <div class="detail-card" style="flex:1; min-width:140px; border-left: 3px solid var(--consumption-color);">
                            <div class="detail-title">ŸÖÿ≠ŸàŸÑ 1 (KW)</div>
                            <div class="detail-value" id="view-cons-t1">-</div>
                        </div>
                        <div class="detail-card" style="flex:1; min-width:140px; border-left: 3px solid var(--consumption-color);">
                            <div class="detail-title">ŸÖÿ≠ŸàŸÑ 2 (KW)</div>
                            <div class="detail-value" id="view-cons-t2">-</div>
                        </div>
                        <div class="detail-card" style="flex:1; min-width:140px; border-left: 3px solid var(--consumption-color);">
                            <div class="detail-title">ŸÖŸäÿßŸá (M3)</div>
                            <div class="detail-value" id="view-cons-m3">-</div>
                        </div>
                    </div>
                    <div style="text-align:left; font-size:0.8rem; color:#888; margin-top:5px;">ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ: <span id="view-cons-date">-</span></div>
                </div>

                <div class="detail-card" style="grid-column: 1 / -1; margin-top:10px;"><div class="detail-title">ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ (System)</div><div class="detail-value" id="last-update-value" style="font-size:0.8rem; color:#666;">-</div></div>
                
                <div class="detail-card" style="grid-column: 1 / -1; background-color: #fffde7;">
                    <div class="detail-title">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ</div>
                    <div class="detail-value" id="station-comments-value" style="font-weight: normal; font-size: 1rem;">-</div>
                </div>
            </div>
            <h3>ÿßŸÑŸÖÿ∂ÿÆÿßÿ™</h3>
            <div class="table-responsive">
                <table class="pumps-table">
                    <thead><tr><th>ÿ±ŸÇŸÖ</th><th>ÿßŸÑÿ≠ÿßŸÑÿ©</th><th>ÿ≥ÿ≠ÿ®</th><th>ÿ∑ÿ±ÿØ</th><th>ÿ™ÿ±ÿØÿØ</th></tr></thead>
                    <tbody id="pumps-table-body"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px;">
                <button id="edit-station-btn" class="btn btn-primary" style="width: 100%;">ÿ™ÿπÿØŸäŸÑ / ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ∑ŸÑ</button>
            </div>
        </div>

        <div id="operator-screen" class="screen">
            <h2>ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ / ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ</h2>
            <h3 id="editing-station-name" style="text-align: center; color: var(--secondary-color); margin-bottom: 20px; border-bottom: none;"></h3>
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
                <button id="back-to-station" class="btn btn-outline">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button id="edit-inspection-btn" class="btn btn-info">üìã ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÅÿ≠ÿµ</button>
            </div>
            <div id="operator-alert" class="alert"></div>

            <div id="active-fault-control" style="background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
                <h4 style="color: #856404; margin-bottom: 10px;">üõë ÿ™ŸÜÿ®ŸäŸá: ÿ£ÿπÿ∑ÿßŸÑ ŸÜÿ¥ÿ∑ÿ©</h4>
                <div id="fault-row-1" class="fault-row-action" style="display:none;">
                    <div><span style="font-weight:bold;">ÿπÿ∑ŸÑ 1:</span> <span id="txt-fault-1"></span></div>
                    <button id="btn-resolve-f1" class="btn btn-success btn-sm">‚úÖ ÿ•ÿµŸÑÿßÿ≠</button>
                </div>
            
                <div id="fault-row-2" class="fault-row-action" style="display:none;">
                    <div><span style="font-weight:bold;">ÿπÿ∑ŸÑ 2:</span> <span id="txt-fault-2"></span></div>
                    <button id="btn-resolve-f2" class="btn btn-success btn-sm">‚úÖ ÿ•ÿµŸÑÿßÿ≠</button>
                </div>
            </div>

            <div class="operator-form">
                <div class="form-section">
                    <h3>ÿ®ŸäÿßŸÜÿßÿ™ ÿπÿßŸÖÿ©</h3>
                    <div class="form-group"><label>ÿßŸÑŸÖÿ¥ÿ∫ŸÑ ÿßŸÑÿ≠ÿßŸÑŸä</label><input type="text" id="operator-name" readonly style="background: #eee;"></div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ üü¢</label>
                            <input type="time" id="operator-start-time" style="direction: ltr;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅ üî¥</label>
                            <input type="time" id="operator-stop-time" style="direction: ltr;">
                        </div>
                    </div>

                    <div class="form-group"><label>ÿßŸÑÿ¨ŸáÿØ ÿßŸÑŸÉŸáÿ±ÿ®Ÿä (V)</label><input type="number" id="operator-voltage"></div>
                    <div class="form-group"><label>ÿßŸÑÿ∂ÿ∫ÿ∑ (Bar)</label><input type="number" id="operator-pressure" step="0.1"></div>
                    <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿßŸÜÿ© ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÖÿ¥ÿ∫ŸÑ -->
                    <div class="form-group"><label>ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ (Bar)</label><input type="number" id="operator-max-pressure" step="0.1" readonly></div>
                    <div class="form-group"><label>ÿßŸÑÿ™ÿØŸÅŸÇ (L/Sec)</label><input type="number" id="operator-water-flow"></div>
                    <div class="form-group">
                        <label>ÿßŸÑŸÜÿ∏ÿßŸÖ</label>
                        <select id="operator-system-mode">
                            <option value="SCADA">SCADA</option><option value="PLC">PLC</option><option value="MIMIC">MIMIC</option><option value="LCP">LCP</option><option value="Marshlling">Marshlling</option><option value="HMI">HMI</option>
                        </select>
                    </div>
                </div>
               

                <div class="form-section">
                    <h3>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ∂ÿÆÿßÿ™</h3>
                    <div id="pumps-form-container" class="pump-controls"></div>
                </div>
                
                <div class="form-section">
                    <div class="form-group" style="border: 2px dashed var(--danger-color); padding: 10px; border-radius: 6px; background: #fff5f5;">
                        <label style="color: var(--danger-color);">‚ö†Ô∏è ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ∑ŸÑ ÿ¨ÿØŸäÿØ</label>
                        <div id="fault-selectors-group">
                            <label style="font-size:0.9rem; margin-top:5px;">ÿπÿ∑ŸÑ ÿ±ŸÇŸÖ (1):</label>
                            <select id="fault-selector" style="border-color: var(--danger-color);">
                                <option value="">-- ÿßŸÑŸÖÿ≠ÿ∑ÿ© ÿ™ÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä --</option>
                                <option value="ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä">ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä ‚ö°</option>
                                <option value="ÿßŸÜÿÆŸÅÿßÿ∂ ÿ¨ŸáÿØ">ÿßŸÜÿÆŸÅÿßÿ∂ ÿ¨ŸáÿØ ‚ö°üìâ</option>
                                <option value="ÿßÿ±ÿ™ŸÅÿßÿπ ÿ¨ŸáÿØ">ÿßÿ±ÿ™ŸÅÿßÿπ ÿ¨ŸáÿØ ‚ö°üìà</option>
                                <option value="ÿßŸÜÿÆŸÅÿßÿ∂ ŸÖŸÜÿ≥Ÿàÿ®">ÿßŸÜÿÆŸÅÿßÿ∂ ŸÖŸÜÿ≥Ÿàÿ® üìâ</option>
                                <option value="ÿ™ŸàŸÇŸÅ ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±">ÿ™ŸàŸÇŸÅ ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ± ÿπŸÜ ÿßŸÑÿπŸÖŸÑ ‚öôÔ∏è</option>
                                <option value="ÿßŸÜÿ≥ÿØÿßÿØÿßÿ™">ÿßŸÜÿ≥ÿØÿßÿØÿßÿ™ ‚ñ¶</option>
                                <option value="ÿ™ÿ≥ÿ±Ÿäÿ® ŸÖŸäÿßŸá">ÿ™ÿ≥ÿ±Ÿäÿ® ŸÖŸäÿßŸá ÿ®ÿßŸÑŸÖÿ≠ÿ∑ÿ© üíß</option>
                                <option value="ŸÉÿ≥ÿ± ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©">ŸÉÿ≥ÿ± ŸÅŸä ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸäÿßŸá üõ†Ô∏è</option>
                                <option value="ÿπÿ¨ÿ≤ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ∂ÿ∫ÿ∑">ÿπÿ¨ÿ≤ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ∂ÿ∫ÿ∑ üîª</option>
                                <option value="ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA">ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA üì°</option>
                            </select>
                            <input type="text" id="fault-1-desc" placeholder="ŸàÿµŸÅ ÿßŸÑÿπÿ∑ŸÑ / ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™..." class="desc-input">

                            <label style="font-size:0.9rem; margin-top:10px;">ÿπÿ∑ŸÑ ÿ±ŸÇŸÖ (2):</label>
                            <select id="fault-selector-secondary" style="border-color: #e67e22;">
                                <option value="">-- ŸÑÿß ŸäŸàÿ¨ÿØ ÿπÿ∑ŸÑ ÿ¢ÿÆÿ± --</option>
                                <option value="ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä">ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä ‚ö°</option>
                                <option value="ÿßŸÜÿÆŸÅÿßÿ∂ ÿ¨ŸáÿØ">ÿßŸÜÿÆŸÅÿßÿ∂ ÿ¨ŸáÿØ ‚ö°üìâ</option>
                                <option value="ÿßÿ±ÿ™ŸÅÿßÿπ ÿ¨ŸáÿØ">ÿßÿ±ÿ™ŸÅÿßÿπ ÿ¨ŸáÿØ ‚ö°üìà</option>
                                <option value="ÿßŸÜÿÆŸÅÿßÿ∂ ŸÖŸÜÿ≥Ÿàÿ®">ÿßŸÜÿÆŸÅÿßÿ∂ ŸÖŸÜÿ≥Ÿàÿ® üìâ</option>
                                <option value="ÿ™ŸàŸÇŸÅ ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±">ÿ™ŸàŸÇŸÅ ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ± ÿπŸÜ ÿßŸÑÿπŸÖŸÑ ‚öôÔ∏è</option>
                                <option value="ÿßŸÜÿ≥ÿØÿßÿØÿßÿ™">ÿßŸÜÿ≥ÿØÿßÿØÿßÿ™ ‚ñ¶</option>
                                <option value="ÿ™ÿ≥ÿ±Ÿäÿ® ŸÖŸäÿßŸá">ÿ™ÿ≥ÿ±Ÿäÿ® ŸÖŸäÿßŸá ÿ®ÿßŸÑŸÖÿ≠ÿ∑ÿ© üíß</option>
                                <option value="ŸÉÿ≥ÿ± ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©">ŸÉÿ≥ÿ± ŸÅŸä ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸäÿßŸá üõ†Ô∏è</option>
                                <option value="ÿπÿ¨ÿ≤ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ∂ÿ∫ÿ∑">ÿπÿ¨ÿ≤ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ∂ÿ∫ÿ∑ üîª</option>
                                <option value="ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA">ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA üì°</option>
                            </select>
                            <input type="text" id="fault-2-desc" placeholder="ŸàÿµŸÅ ÿßŸÑÿπÿ∑ŸÑ / ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™..." class="desc-input">
                        </div>
                    </div>

                    <div class="form-group" style="border: 2px solid var(--consumption-color); padding: 10px; border-radius: 6px; background: #eaf2f8; margin-top: 15px;">
                        <label style="color: var(--consumption-color); font-size: 1.1rem;">‚ö° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßÿ≥ÿ™ŸáŸÑÿßŸÉÿßÿ™ ÿßŸÑŸÖÿ≠ÿ∑ÿ©</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex:1">
                                <label style="font-size: 0.9rem;">ŸÖÿ≠ŸàŸÑ (1) KW</label>
                                <input type="number" id="cons-trans-1" placeholder="KW">
                            </div>
                            <div style="flex:1">
                                <label style="font-size: 0.9rem;">ŸÖÿ≠ŸàŸÑ (2) KW</label>
                                <input type="number" id="cons-trans-2" placeholder="KW">
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.9rem;">ÿßŸÑŸÖŸÜÿµÿ±ŸÅ ŸÖŸÜ ÿßŸÑŸÖŸäÿßŸá (M3)</label>
                            <input type="number" id="cons-water-m3" placeholder="ŸÖÿ™ÿ± ŸÖŸÉÿπÿ®">
                        </div>
                    </div>

                    <div class="form-group"><label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿπÿßŸÖÿ©</label><textarea id="operator-comments" rows="3"></textarea></div>
                    <div class="form-actions"><button id="save-operator-data" class="btn btn-success" style="width: 100%;">ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button></div>
                </div>
            </div>
        </div>

        <div id="inspection-screen" class="screen">
            <h2 id="inspection-title">ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <button id="back-from-inspection" class="btn btn-outline">ÿπŸàÿØÿ©</button>
                <!-- ÿ≤ÿ± ÿ™ÿµÿØŸäÿ± Excel -->
                <button id="export-inspection-excel" class="btn btn-excel" style="display: none;">üìä ÿ™ÿµÿØŸäÿ± Excel</button>
            </div>
            
            <div id="inspection-container"></div>
            
            <div id="inspection-actions" style="margin-top:10px; display:none; position:sticky; bottom:10px; z-index:999;">
                <button id="save-inspection-btn" class="btn btn-success">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿ≠ÿµ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ</button>
            </div>
        </div>

        <!-- ÿ¥ÿßÿ¥ÿ© ÿ¨ÿØŸäÿØÿ©: ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ -->
        <div id="inspection-export-screen" class="screen">
            <h2 style="color: var(--excel-color);">ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ</h2>
            <button id="back-to-stations-from-export" class="btn btn-outline">ÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
            
            <div class="inspection-export-controls">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">üîß ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿµÿØŸäÿ±</h3>
                <div class="export-options">
                    <div class="form-group">
                        <label>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
                        <select id="export-filter-zone">
                            <option value="all">ŸÉŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</label>
                        <select id="export-filter-station">
                            <option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ŸÜŸàÿπ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</label>
                        <select id="export-report-type">
                            <option value="full">ÿ™ŸÇÿ±Ÿäÿ± ŸÉÿßŸÖŸÑ</option>
                            <option value="summary">ŸÖŸÑÿÆÿµ ŸÅŸÇÿ∑</option>
                            <option value="faults">ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ŸÅŸÇÿ∑</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅ</label>
                        <select id="export-file-format">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button id="generate-inspection-report" class="export-excel-btn" style="padding: 12px 30px; font-size: 16px;">
                        üìä ÿ™ŸàŸÑŸäÿØ Ÿàÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                    </button>
                </div>
                
                <div id="export-status" style="margin-top: 15px; display: none; padding: 10px; border-radius: 6px; text-align: center;"></div>
            </div>
            
            <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 10px;">üìã ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</h4>
                <ul style="padding-right: 20px;">
                    <li>ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± Ÿäÿ¥ŸÖŸÑ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ ŸÑŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©</li>
                    <li>ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™ ŸÖŸÅÿµŸÑÿ© ÿ≠ÿ≥ÿ® ÿ≠ÿßŸÑÿ© ŸÉŸÑ ŸÖÿ∂ÿÆÿ©</li>
                    <li>ŸäŸÖŸÉŸÜ ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä Excel ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</li>
                    <li>ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© ŸàÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿØŸàÿ±Ÿäÿ©</li>
                    <li>Ÿäÿ¥ŸÖŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ ŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑ ŸÖÿ≠ÿ∑ÿ©</li>
                </ul>
            </div>
        </div>

        <div id="consumptions-report-screen" class="screen">
            <h2 style="color: var(--consumption-color);">ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿπÿØŸÑÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ</h2>
            <button id="back-to-stations-from-cons" class="btn btn-outline">ÿπŸàÿØÿ©</button>
            <div style="font-size:0.9rem; color:#666; margin-top:5px;">ŸäŸÇŸàŸÖ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ÿ®ÿ∑ÿ±ÿ≠ (ÿ£ŸàŸÑ ŸÇÿ±ÿßÿ°ÿ© ŸÅŸä ŸÅÿ™ÿ±ÿ© "ÿ•ŸÑŸâ" - ÿ£ŸàŸÑ ŸÇÿ±ÿßÿ°ÿ© ŸÅŸä ŸÅÿ™ÿ±ÿ© "ŸÖŸÜ").</div>
            <div class="filters-container" style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; margin-top:10px; display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                <div class="filter-item"><label>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</label><select id="cons-filter-station"><option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option></select></div>
                <div class="filter-item"><label>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ (ÿ®ÿØÿßŸäÿ© ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©)</label><input type="date" id="cons-filter-date-from"></div>
                <div class="filter-item"><label>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ (ÿ®ÿØÿßŸäÿ© ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©)</label><input type="date" id="cons-filter-date-to"></div>
                <div class="filter-item" style="display:flex; align-items:flex-end; gap:5px;">
                    <button class="btn btn-primary" onclick="renderConsumptionsTable()" style="flex:1">ÿ≠ÿ≥ÿßÿ®</button>
                    <button class="btn btn-success" onclick="exportConsumptionsToCSV()" style="flex:1" title="ÿ™ÿµÿØŸäÿ± CSV">CSV üì•</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="history-table" id="consumptions-table-export">
                    <thead>
                        <tr>
                            <th>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</th>
                            <th>ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ŸÖÿ≠ŸàŸÑ 1 (KW)</th>
                            <th>ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ŸÖÿ≠ŸàŸÑ 2 (KW)</th>
                            <th>ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ŸÖŸäÿßŸá (M3)</th>
                        </tr>
                    </thead>
                    <tbody id="consumptions-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="faults-log-screen" class="screen">
            <h2 style="color: var(--danger-color);">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ</h2>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="back-to-stations-from-faults" class="btn btn-outline">ÿπŸàÿØÿ©</button>
            </div>
            
            <div style="margin-top:20px;">
                <h3 style="margin-bottom:10px;">ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäÿßŸã</h3>
                <div class="table-responsive">
                    <table class="faults-table">
                        <thead><tr><th>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</th><th>ÿßŸÑÿπÿ∑ŸÑ</th><th>ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿ°</th><th>ÿßŸÑŸÖÿØÿ©</th></tr></thead>
                        <tbody id="active-faults-body"></tbody>
                    </table>
                </div>
                
                <h3 style="margin-bottom:10px; margin-top:30px;">ÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: #fff3cd; padding: 10px; border-radius: 6px; border: 1px solid #ffeeba;">
                    <label style="margin:0; font-weight:bold;">üîç ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ:</label>
                    <select id="fault-archive-station-filter" style="flex:1; max-width:300px;" onchange="appData.faultsLimit=100; renderFaultsLog();">
                        <option value="all">-- ÿπÿ±ÿ∂ ŸÉÿßŸÅÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ --</option>
                    </select>
                </div>

                <div class="table-responsive">
                    <table class="faults-table">
                        <thead><tr><th>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</th><th>ÿßŸÑÿπÿ∑ŸÑ</th><th>ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿ°</th><th>ŸàŸÇÿ™ ÿßŸÑÿ•ÿµŸÑÿßÿ≠</th><th>ÿßŸÑÿ≠ÿßŸÑÿ©</th></tr></thead>
                        <tbody id="history-faults-body"></tbody>
                    </table>
                </div>

                <div class="pagination-controls">
                    <p id="faults-status-text" class="status-text"></p>
                    <button id="load-more-faults-btn" class="btn btn-warning" style="display: none; width: 200px; margin: 0 auto;">‚ö†Ô∏è ÿπÿ±ÿ∂ 100 ÿπÿ∑ŸÑ ÿ•ÿ∂ÿßŸÅŸä</button>
                </div>
            </div>
        </div>

        <!-- ÿ¥ÿßÿ¥ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
        <div id="user-profile-screen" class="screen">
            <h2 style="color: var(--profile-color);">ÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h2>
            <button id="back-to-stations-from-profile" class="btn btn-outline">ÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
            
            <div class="profile-alert" id="profile-alert"></div>
            
            <div class="profile-container">
                <!-- ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ: ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© -->
                <div class="profile-card">
                    <h3 style="color: var(--profile-color); margin-bottom: 20px;">üìù ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©</h3>
                    <div class="profile-form-grid">
                        <div class="form-group full-width">
                            <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä</label>
                            <input type="text" id="profile-username" readonly style="background: #f0f0f0; font-weight: bold;">
                        </div>
                        
                        <div class="form-group">
                            <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä <span style="color: red;">*</span></label>
                            <input type="text" id="profile-fullname" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
                        </div>
                        
                        <div class="form-group">
                            <label>ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ≠ÿ∑ÿ© <span style="color: red;">*</span></label>
                            <select id="profile-station">
                                <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ÿ∑ÿ© --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ <span style="color: red;">*</span></label>
                            <input type="tel" id="profile-phone" placeholder="ŸÖÿ´ÿßŸÑ: 01012345678">
                        </div>
                        
                        <div class="form-group">
                            <label>ÿ±ŸÇŸÖ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®</label>
                            <input type="tel" id="profile-whatsapp" placeholder="ŸÖÿ´ÿßŸÑ: 01012345678">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                            <input type="email" id="profile-email" placeholder="ŸÖÿ´ÿßŸÑ: user@example.com">
                        </div>
                        
                        <div class="form-group full-width" style="margin-top: 20px;">
                            <button id="save-profile-btn" class="btn btn-profile" style="width: 100%;">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸä: ŸÇÿßÿ¶ŸÖÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ -->
                <div class="profile-card">
                    <h3 style="color: var(--profile-color); margin-bottom: 20px;">üë• ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ</h3>
                    
                    <div class="profile-search-container">
                        <span class="profile-search-icon">üîç</span>
                        <input type="text" id="search-profile-input" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿßŸÑŸÖÿ≠ÿ∑ÿ©)..." style="width: 100%;">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="users-profiles-table">
                            <thead>
                                <tr>
                                    <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                    <th>ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ≠ÿ∑ÿ©</th>
                                    <th>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä</th>
                                    <th>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                    <th>ÿ±ŸÇŸÖ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®</th>
                                    <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                                    <th style="min-width: 120px;">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody id="users-profiles-list">
                                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-profiles-message" class="no-profiles-message" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìã</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÅŸä ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ£Ÿäÿ≥ÿ±</div>
                    </div>
                    
                    <!-- Pagination for user profiles -->
                    <div class="pagination-info" id="profiles-pagination-info"></div>
                    <button id="load-more-profiles-btn" class="load-more-btn" style="display: none;">ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (100)</button>
                </div>
            </div>
        </div>

        <!-- ÿ¥ÿßÿ¥ÿ© ÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
        <div id="users-data-screen" class="screen">
            <div class="user-data-card">
                <div class="user-data-header">
                    <h2 class="user-data-title">ÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h2>
                    <button id="back-to-stations-from-users-data" class="btn btn-outline">ÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
                </div>
                
                <div class="users-search-container">
                    <span class="users-search-icon">üîç</span>
                    <input type="text" id="search-users-data-input" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿßŸÑŸÖÿ≠ÿ∑ÿ© ÿ£Ÿà ÿßŸÑŸáÿßÿ™ŸÅ)..." style="width: 100%;">
                </div>
                
                <div class="table-responsive">
                    <table class="users-data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                <th>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä</th>
                                <th>ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                <th>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</th>
                                <th>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                                <th class="action-cell">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="users-data-table-body">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ -->
                        </tbody>
                    </table>
                </div>
                
                <div id="no-users-data-message" class="no-users-message" style="display: none;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                    <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
                </div>
                
                <!-- Pagination controls -->
                <div class="pagination-info" id="users-data-pagination-info"></div>
                <button id="load-more-users-data-btn" class="load-more-btn">ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (100)</button>
            </div>
        </div>

        <div id="users-screen" class="screen">
            <div class="users-header">
                <h2>ÿ•ÿØÿßÿ±ÿ© ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h2>
                <button id="back-to-stations-from-users" class="btn btn-outline">ÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
            </div>
            
            <div id="user-form-container" class="user-form-card" style="display: none;">
                <h4 id="user-form-title" style="margin-bottom:15px; color: var(--secondary-color);">ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</h4>
                <div class="user-form-grid">
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                        <input type="text" id="new-username" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                    </div>
                    <div class="form-group">
                        <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                        <input type="text" id="new-password" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
                    </div>
                    <div class="form-group">
                        <label>ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                        <select id="new-user-type"></select>
                    </div>
                </div>
                <div class="user-action-buttons">
                    <button id="save-user-btn" class="btn btn-success" style="flex:1">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</button>
                    <button id="cancel-user-btn" class="btn btn-danger" style="flex:1">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
                </div>
            </div>
            
            <div style="margin: 25px 0 15px; display:flex; justify-content:space-between; align-items:center;">
                <h3>ŸÇÿßÿ¶ŸÖÿ© ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h3>
                <button id="add-user-btn" class="btn btn-primary">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</button>
            </div>
            
            <div class="users-search-container">
                <span class="users-search-icon">üîç</span>
                <input type="text" id="search-user-input" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ (ÿßŸÑÿßÿ≥ŸÖ)..." onkeyup="renderUsersManagement()" style="width: 100%;">
            </div>
            
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                            <th>ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                            <th>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</th>
                            <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
            
            <div id="no-users-message" class="no-users-message" style="display: none;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≥ÿ¨ŸÑŸäŸÜ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ" ŸÑÿ®ÿØÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</div>
            </div>
            
            <!-- Pagination for users -->
            <div class="pagination-info" id="users-pagination-info"></div>
            <button id="load-more-users-btn" class="load-more-btn">ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (100)</button>
        </div>

        <div id="history-screen" class="screen">
            <h2>ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿπÿßŸÖ</h2>
            <button id="back-to-stations-from-history" class="btn btn-outline">ÿπŸàÿØÿ©</button>
            <div class="filters-container" style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                <div class="filter-item"><label>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label><select id="filter-zone" onchange="updateStationFilter()"><option value="all">ŸÉŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option></select></div>
                <div class="filter-item"><label>ÿßŸÑŸÖÿ≠ÿ∑ÿ©</label><select id="filter-station"><option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option></select></div>
                <div class="filter-item"><label>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ</label><input type="date" id="filter-date-from"></div>
                <div class="filter-item"><label>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ</label><input type="date" id="filter-date-to"></div>
                
                <div class="filter-item" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-primary" onclick="renderHistoryTable(true)" style="width:100%">ÿ®ÿ≠ÿ´ Ÿàÿ™ÿµŸÅŸäÿ©</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="history-table">
                    <thead><tr><th style="width:12%">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™</th><th style="width:12%">ÿßŸÑŸÖÿ≠ÿ∑ÿ©</th><th style="width:12%">ÿßŸÑŸÖÿ¥ÿ∫ŸÑ</th><th style="width:12%">ÿ™ÿ¥ÿ∫ŸäŸÑ</th><th style="width:12%">ÿ•ŸäŸÇÿßŸÅ</th><th>ÿ™ŸÅÿßÿµŸäŸÑ</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <p id="history-status-text" class="status-text"></p>
                <button id="load-more-history-btn" class="btn btn-primary" style="display: none; width: 200px; margin: 0 auto;">‚¨áÔ∏è ÿπÿ±ÿ∂ 100 ÿ≥ÿ¨ŸÑ ÿ•ÿ∂ÿßŸÅŸä</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿ™ÿ®ÿ© SheetJS ŸÑÿ™ÿµÿØŸäÿ± Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJiiq8qdeRFZkaHnEew-6sisbCRaypJQ8",
            authDomain: "toshka-4db86.firebaseapp.com",
            databaseURL: "https://toshka-4db86-default-rtdb.firebaseio.com",
            projectId: "toshka-4db86",
            storageBucket: "toshka-4db86.firebasestorage.app",
            messagingSenderId: "513322987318",
            appId: "1:513322987318:web:155e963acb3b97bc918d97"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        const faultIcons = {
            "ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä": "‚ö°", "ÿßŸÜÿÆŸÅÿßÿ∂ ÿ¨ŸáÿØ": "‚ö°üìâ", "ÿßÿ±ÿ™ŸÅÿßÿπ ÿ¨ŸáÿØ": "‚ö°üìà",
            "ÿßŸÜÿÆŸÅÿßÿ∂ ŸÖŸÜÿ≥Ÿàÿ®": "üìâ", "ÿ™ŸàŸÇŸÅ ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±": "‚öôÔ∏è", "ÿßŸÜÿ≥ÿØÿßÿØÿßÿ™": "‚ñ¶", 
            "ÿ™ÿ≥ÿ±Ÿäÿ® ŸÖŸäÿßŸá": "üíß", "ŸÉÿ≥ÿ± ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©": "üõ†Ô∏è", "ÿπÿ¨ÿ≤ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ∂ÿ∫ÿ∑": "üîª",
            "ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA": `<svg viewBox="0 0 24 24" width="20" height="20" class="scada-icon-svg" style="color:#d32f2f;" fill="currentColor"><path d="M12 3C7.79 3 3.7 4.41 0.38 7/L2.6 9.22C5.35 7.15 8.55 6 12 6C15.45 6 18.65 7.15 21.4 9.22L23.62 7C20.3 4.41 16.21 3 12 3Z" /><path d="M12 8C9.48 8 7.15 8.76 5.18 10.05/L7.4 12.27C8.71 11.47 10.28 11 12 11C13.72 11 15.29 11.47 16.6 12.27/L18.82 10.05C16.85 8.76 14.52 8 12 8Z" /><path d="M12 13L6 21H18L12 13ZM11 18H13V19.5H11V18ZM11 15.5H13V17.5H11V15.5Z" /></svg>`
        };
        
        const inspectionSchema = {
            prepSystem: { title: "ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±", items: ["ÿßŸÑŸÉŸàŸÖÿ®ÿ±ŸäŸàÿ≥ÿ±", "ÿ∑ŸÑŸÖÿ®ÿ© ÿ™ÿ≠ÿ∂Ÿäÿ± 1", "ÿ∑ŸÑŸÖÿ®ÿ© ÿ™ÿ≠ÿ∂Ÿäÿ± 2", "ÿ™ÿßŸÜŸÉ ÿßŸÑÿ™ÿπŸàŸäÿ∂", "ÿ™ÿßŸÜŸÉ ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±", "ŸÑŸàÿ≠Ÿá ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±"] },
            pumps: {
                title: "ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", isDynamic: true,
                items: [
                    "ŸÖÿ≠ÿ®ÿ≥ ŸÅÿ±ÿßÿ¥Ÿá", "ŸàÿµŸÑŸá ŸÅŸÉ Ÿà ÿ™ÿ±ŸÉŸäÿ®", "ŸàÿµŸÑŸá ŸÖÿ±ŸÜŸá", "ÿπÿØÿßÿØ ÿßŸÑÿ≥ÿ≠ÿ®", "ÿ≠ÿ≥ÿßÿ≥ ÿßŸÑÿ≥ÿ≠ÿ®", // Suction
                    "ÿßŸÑŸÖÿ∂ÿÆŸá", // Pump
                    "ÿπÿØÿßÿØ ÿßŸÑÿ∑ÿ±ÿØ", "ÿ≠ÿ≥ÿßÿ≥ ÿßŸÑÿ∑ÿ±ÿØ", "ŸàÿµŸÑŸá ŸÖÿ±ŸÜŸá", "ÿßŸäÿ± ŸÅŸäŸÜÿ™", "ŸÖÿ≠ÿ®ÿ≥ ÿπÿØŸÖ ÿ±ÿ¨Ÿàÿπ", "ŸàÿµŸÑŸá ŸÅŸÉ Ÿà ÿ™ÿ±ŸÉŸäÿ®", "ŸÖÿ≠ÿ®ÿ≥ ŸÅÿ±ÿßÿ¥Ÿá" // Discharge
                ]
            },
            mainLine: { title: "ÿÆÿ∑ ÿßŸÑÿ∑ÿ±ÿØ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä", items: ["ÿßŸäÿ± ŸÅŸäŸÜÿ™", "ŸÖÿ≠ÿ®ÿ≥ ÿπÿØŸÖ ÿ±ÿ¨Ÿàÿπ", "ŸàÿµŸÑŸá ŸÅŸÉ Ÿà ÿ™ÿ±ŸÉŸäÿ® 1", "ÿßŸÑŸÅŸÑŸàŸÖŸäÿ™ÿ±", "ÿ≠ÿ≥ÿßÿ≥ ÿ∂ÿ∫ÿ∑", "ÿπÿØÿßÿØ ÿ∂ÿ∫ÿ∑", "ŸàÿµŸÑŸá ŸÅŸÉ Ÿà ÿ™ÿ±ŸÉŸäÿ® 2", "ŸÖÿ≠ÿ®ÿ≥ ŸÅÿ±ÿßÿ¥Ÿá", "ŸÖÿ≠ÿ®ÿ≥ ÿØÿ±ŸäŸÜ"] },
            waterHammer: { title: "ŸÖŸÜÿ∏ŸàŸÖÿ© ÿßŸÑÿ∑ÿ±ŸÇ ÿßŸÑŸÖÿßÿ¶Ÿä", items: ["ŸÉŸàŸÖÿ®ÿ±Ÿäÿ≥Ÿàÿ±1", "ŸÉŸàŸÖÿ®ÿ±Ÿäÿ≥Ÿàÿ±2", "ŸÉŸàŸÖÿ®ÿ±Ÿäÿ≥Ÿàÿ±3", "ÿ™ÿßŸÜŸÉ 1", "ÿ™ÿßŸÜŸÉ 2", "ÿ™ÿßŸÜŸÉ 3", "ŸÑŸàÿ≠Ÿá ŸÉŸàŸÜÿ™ÿ±ŸàŸÑ"] },
            submersibles: { title: "ÿßŸÑÿ∫Ÿàÿßÿ∑ÿ≥", items: ["ÿ∑ŸÑŸÖÿ®ÿ© ÿ∫ÿßÿ∑ÿ≥ 1", "ÿ∑ŸÑŸÖÿ®ÿ© ÿ∫ÿßÿ∑ÿ≥ 2"] },
            ac: { title: "ÿ™ŸÉŸäŸäŸÅÿßÿ™ ÿßŸÑŸÖÿ≠ÿ∑Ÿá", items: ["ÿ™ŸÉŸäŸäŸÅ 1", "ÿ™ŸÉŸäŸäŸÅ 2", "ÿ™ŸÉŸäŸäŸÅ 3", "ÿ™ŸÉŸäŸäŸÅ 4", "ÿ™ŸÉŸäŸäŸÅ 5", "ÿ™ŸÉŸäŸäŸÅ 6", "ÿ™ŸÉŸäŸäŸÅ 7", "ÿ™ŸÉŸäŸäŸÅ 8", "9-PLC", "10-PLC"] },
            ventilation: { title: "ÿßŸÑÿ™ŸáŸàŸäÿ©", items: ["ÿ∫ÿ±ŸÅŸá ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", "ÿ∫ÿ±ŸÅŸá ŸÖÿ≠ŸàŸÑ 1", "ÿ∫ÿ±ŸÅŸá ŸÖÿ≠ŸàŸÑ 2", "ÿ∫ÿ±ŸÅŸá ÿ±ŸäŸÜÿ¨"] },
            crane: { title: "ÿßŸÑŸàŸÜÿ¥", items: ["ÿßŸÑŸàŸÜÿ¥"] }
        };
        
        const statusOptions = [
            { val: "efficient", text: "‚úÖ ŸäÿπŸÖŸÑ ÿ®ŸÉŸÅÿßÿ°ÿ©", class: "efficient" },
            { val: "fault", text: "‚ö†Ô∏è ÿπÿ∑ŸÑ / ŸÖŸÑÿßÿ≠ÿ∏ÿ©", class: "fault" },
            { val: "broken", text: "üõë ŸÑÿß ŸäÿπŸÖŸÑ", class: "broken" },
            { val: "none", text: "‚ö™ ŸÑÿß ŸäŸàÿ¨ÿØ", class: "none" }
        ];
        
        const statusTextMap = {
            "efficient": "ŸäÿπŸÖŸÑ ÿ®ŸÉŸÅÿßÿ°ÿ©",
            "fault": "ÿπÿ∑ŸÑ / ŸÖŸÑÿßÿ≠ÿ∏ÿ©",
            "broken": "ŸÑÿß ŸäÿπŸÖŸÑ",
            "none": "ŸÑÿß ŸäŸàÿ¨ÿØ"
        };
        
        // --- USER TYPES & PERMISSIONS DEFINITION ---
        const userTypes = {
            admin: {
                name: "ŸÖÿØŸäÿ±",
                permissions: {
                    view_all: true,
                    edit_all: true,
                    manage_users: true,
                    add_users: true,
                    delete_users: true,
                    view_history: true,
                    view_passwords: true,
                    view_profiles: true,
                    delete_profiles: true,
                    export_inspection: true,
                    can_manage_types: ['admin', 'engineer', 'supervisor', 'operator'],
                    can_add_types: ['admin', 'engineer', 'supervisor', 'operator'],
                    can_delete_types: ['admin', 'engineer', 'supervisor', 'operator']
                }
            },
            engineer: {
                name: "ŸÖŸáŸÜÿØÿ≥",
                permissions: {
                    view_all: true,
                    edit_all: true,
                    manage_users: true,
                    add_users: true,
                    delete_users: true,
                    view_history: true,
                    view_passwords: false,
                    view_profiles: true,
                    delete_profiles: false,
                    export_inspection: true,
                    can_manage_types: ['supervisor', 'operator'],
                    can_add_types: ['supervisor', 'operator'],
                    can_delete_types: ['supervisor', 'operator']
                }
            },
            supervisor: {
                name: "ŸÖÿ¥ÿ±ŸÅ",
                permissions: {
                    view_all: true,
                    edit_some: true,
                    manage_users: true,
                    add_users: true,
                    delete_users: true,
                    view_history: false,
                    view_passwords: false,
                    view_profiles: true,
                    delete_profiles: false,
                    export_inspection: true,
                    can_manage_types: ['operator'],
                    can_add_types: ['operator'],
                    can_delete_types: ['operator']
                }
            },
            operator: {
                name: "ŸÖÿ¥ÿ∫ŸÑ",
                permissions: {
                    view_some: true,
                    edit_own: true,
                    manage_users: false,
                    add_users: false,
                    delete_users: false,
                    view_history: false,
                    view_passwords: false,
                    view_profiles: false,
                    delete_profiles: false,
                    export_inspection: false,
                    can_manage_types: [],
                    can_add_types: [],
                    can_delete_types: []
                }
            }
        };
        
        let appData = {
            currentUser: null, 
            currentStation: null, 
            stations: {}, 
            users: {},
            userProfiles: {},
            userTypes: userTypes,
            zones: ['Zone_A', 'Zone_B', 'Zone_C', 'Zone_D', 'Zone_E', 'Zone_F', 'Zone_G', 'Zone_H', 'Zone_I', 'Zone_J', 'Zone_K', 'Zone_L', 'Zone_O1', 'Zone_O2', 'Zone_O3', 'Zone_O4', 'Zone_O5', 'Zone_O2dashO6', 'Zone_O8', 'Zone_R', 'Zone_S'],
            operationHistory: [], 
            faultsLog: [], 
            consumptionLog: [],
            // Pagination limits
            historyLimit: 100,
            faultsLimit: 100,
            usersLimit: 100,
            usersDataLimit: 100,
            profilesLimit: 100,
            currentUsersPage: 0,
            currentUsersDataPage: 0,
            currentProfilesPage: 0
        };
        
        const pumpsData = {
            'A01': 4, 'A02': 4, 'A04': 2, 'A06': 5, 'A07': 5, 'A08': 4, 'A09': 5, 'A10': 5, 'A11': 5, 'A12': 5, 'A13': 5, 'A14': 4, 'A15': 4,
            'B01': 5, 'B02': 5, 'B03': 5, 'B04': 5, 'B05': 4, 'B06': 2, 'B07': 4, 'B08': 5, 'B09': 3, 'B10': 5, 'B11': 5, 'B12': 2, 'B13': 5, 'C01': 5, 'C02': 5, 'C03': 5,
            'D01': 3, 'D02': 5, 'D03': 3, 'D04': 5, 'D05': 5, 'D06': 2, 'D07': 3, 'D08': 3, 'D09': 3, 'D10': 5, 'D11': 3, 'D12': 3, 'D13': 3, 'D14': 3, 'D15': 5, 'D16': 4, 'D17': 4, 'D18': 5, 'D19': 5, 'D20': 5,
            'E01': 5, 'E02': 5, 'E03': 5, 'E04': 5, 'E05': 5, 'E06': 5, 'E07': 5, 'E08': 5, 'E09': 5, 'E10': 4, 'E11': 5, 'F01': 5, 'F02': 5, 'G01': 5, 'G02': 5, 'G03': 4, 'H01': 5, 'H02': 5, 'I01': 5, 'J01': 5, 'J02': 5,
            'K01': 5, 'K02': 5, 'K03': 5, 'K04': 5, 'K05': 5, 'K06': 5, 'K07': 5, 'K08': 5, 'K09': 5, 'K10': 3,
            'L01_1': 5, 'L01_2': 5, 'L02': 7, 'L03': 5, 'L04': 6, 'L05': 5, 'L06': 5, 'L07_1': 5, 'L07_2': 4, 'L08': 4, 'L09': 5, 'L10': 7, 'L11': 5, 'L12': 5, 'L13': 5, 'L14_1': 6, 'L14_2': 6, 'L14_3': 6, 'L14_4': 7,
            'O1-1-P1': 4, 'O1-2-P2': 4, 'O1-2-P2-B1': 4, 'O1-3-P3': 4, 'O1-4-P4': 4, 'O1-4-P4-B2': 4, 'O1-5-P5': 4, 'O1-5-P5-B3': 4, 'O1-5-P6': 4, 'O1-5-P7': 4, 'O1-6-P8': 4, 'O1-6-P9': 4, 'O1-6-P9-B4': 4, 'O1-6-P10': 4, 'O1-6-P10-B5': 4, 'O1-7-P11': 4, 'O1-7-P11-B7': 4, 'O1-7-P12': 4, 'O1-7-P12-B6': 4, 'O1-7-P13': 4, 'O1-8-P14': 4, 'O1-8-P15': 4, 'O1-8-P16': 4, 'O1-8-P16-B8': 4,
            'O1-9-P17': 5, 'O1-9-P17-B10': 5, // ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© ÿ≠ÿØŸäÿ´ÿßŸã ŸÑŸÖŸÜÿ∑ŸÇÿ© Zone_O1
            'O2-1-P1': 4, 'O2-2-P3': 5, 'O2-2-P3-B2': 5, 'O2-2-P4': 4, 'O2-3-P5': 5, 'O2-3-P6': 4, 'O2-3-P6-B3': 4, 'O2-4-P7': 4, 'O2-4-P8': 4, 'O2-4-P9': 4, 'O2-4-P9-B4': 4, 'O2-5-P10': 4, 'O2-5-P10-B5': 4, 'O2-5-P11': 4, 'O2-5-P12': 4, 'O2-6-P13': 4, 'O2-6-P13-B7': 4, 'O2-6-P14': 5, 'O2-6-P14-B6': 5, 'O2-6-P15': 5, 'O2-7-P17-B8': 4, 'O2-7-P17-B9': 4,
            'O3-1-P1': 5, 'O3-1-P2': 4, 'O3-1-P3': 6, 'O3-2-P4': 6, 'O3-3-P5': 4, 'O3-3-P6': 4, 'O3-4-P7': 4, 'O3-5-P8': 4, 'O3-6-P9': 5, 'O3-6-P10': 6, 'O3-7-P11': 3, 'O3-7-P12': 4, 'O3-7-P13': 4, 'O3-7-P14': 5, 'O3-7-P15': 5, 'O3-7-P16': 6,
            'O4-1-P1': 5, 'O4-1-P2': 5, 'O4-1-P3': 4, 'O4-1-P4': 5, 'O4-1-P5': 4, 'O4-2-P6': 4, 'O4-2-P7': 4, 'O4-2-P8': 5, 'O4-3-P9': 5, 'O4-4-P10': 4, 'O4-5-P11': 4, 'O4-6-P12': 4, 'O4-7-P13': 4, 'O4-8-P14': 4, 'O4-9-P15': 4, 'O4-9-P16': 4, 'O4-9-P17': 4, 'O4-9-P18': 4, 'O4-10-P19': 4, 'O4-10-P20': 5, 'O4-10-P21': 5, 'O4-10-P22': 5,
            'O5-1-P1': 4, 'O5-2-P2': 4, 'O5-3-P4': 5, 'O5-3-P5': 4, 'O5-3-P6': 3, 'O5-4-P7': 3, 'O5-4-P8': 5, 'O5-5-P10': 2, 'O5-5-P9': 5, 'O5-6-P11': 4, 'O5-6-P12': 3, 'O5-7-P13': 5, 'O5-8-P14': 5,
            'O6-1-P1': 4, 'O6-2-P2': 3, 'O6-3-P3': 4, 'O6-3-P4': 5, 'O6-3-P5': 5, 'O6-3-P6': 6, 'O6-3-P7': 6,
            'O8-1-P1': 4, 'O8-2-P2': 6, 'O8-3-P3': 4, 'O8-4-P4': 5, 'O8-5-P5': 5, 'O8-6-P6': 6, 'O8-7-P7': 5, 'O8-8-P8': 4, 'O8-8-P9': 5, 'O8-8-P10': 6, 'O8-8-P11': 5, 'O8-8-P12': 5, 'O8-9-P13': 5, 'O8-10-P14': 4,
            'Lifting-1A': 10, 'Lifting-1B': 10, 'Lifting-2A': 10, 'Lifting-2B': 10,
            'R01': 4, 'R02': 6, 'R03*': 6, 'R03-A': 7, 'R03-B': 5, 'R04': 7, 'R05-A': 7, 'R05-B': 8, 'R05-C': 8, 'R05-D': 6, 'R05-E': 7, 'R05-F': 6, 'R05-G': 7, 'R05-H': 7, 'R05-I': 7, 'R05-J1': 7, 'R05-J2': 7, 'R05-K': 7, 'R06': 7, 'R07': 8, 'R08-A': 7, 'R08-B': 7, 'R08-C': 5, 'R08-D': 6, 'R08-E': 7, 'R08-F1': 7, 'R08-F2': 7, 'R08-F3': 7, 'R08*': 7, // ÿßŸÑŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸÖÿ∂ÿßŸÅÿ© ÿ≠ÿØŸäÿ´ÿßŸã ŸÑŸÖŸÜÿ∑ŸÇÿ© Zone_R
            'R09-A': 8, 'R09-B': 8, 'R09-C': 8, 'R10': 7, 'R11': 7, 'R12-A': 6, 'R12-B': 7,
            'Lifting-57S': 6, 'Lifting-8S': 12, 'Lifting-17S': 12,
            'S01-A': 7, 'S01-B': 7, 'S02-A': 6, 'S02-B': 7, 'S03': 6, 'S04': 6, 'S05-A': 6, 'S05-B': 6, 'S06': 6, 'S07-A': 7, 'S07-B': 7, 'S08': 6, 'S09-A': 7, 'S09-B': 7, 'S09-C': 8, 'S09-D': 8, 'S09-E': 6, 'S09-F': 6
        };
        
        function toEnglishDigits(str) {
            if (!str) return str;
            str = str.trim();
            const arabicNumbers = ["Ÿ†", "Ÿ°", "Ÿ¢", "Ÿ£", "Ÿ§", "Ÿ•", "Ÿ¶", "Ÿß", "Ÿ®", "Ÿ©"];
            return str.replace(/[Ÿ†-Ÿ©]/g, function(w) { return arabicNumbers.indexOf(w); });
        }

        function getStandardDateTime() {
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const y = now.getFullYear();
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            return {
                date: `${d}/${m}/${y}`, 
                time: `${h}:${min}:${s}`, 
                full: `${d}/${m}/${y} ${h}:${min}:${s}`
            };
        }

        function parseCustomDate(str) {
            if(!str) return null;
            str = toEnglishDigits(str);
            const parts = str.split(/\s+/);
            if(parts.length < 2) return null;
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            if(dateParts.length < 3 || timeParts.length < 2) return null;
            const year = parseInt(dateParts[2]);
            const month = parseInt(dateParts[1]) - 1;
            const day = parseInt(dateParts[0]);
            const hour = parseInt(timeParts[0]);
            const min = parseInt(timeParts[1]);
            const sec = timeParts[2] ? parseInt(timeParts[2]) : 0;
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            return new Date(year, month, day, hour, min, sec);
        }

        // --- NETWORK & OFFLINE LOGIC ---
        function updateNetworkStatus() {
            const indicator = document.getElementById('network-status-indicator');
            const icon = document.getElementById('net-icon');
            const text = document.getElementById('net-text');
            const loginBtn = document.getElementById('login-btn');
            if (navigator.onLine) {
                indicator.className = 'network-status net-online';
                icon.textContent = 'üü¢';
                text.textContent = 'ŸÖÿ™ÿµŸÑ';
                processOfflineQueue(); 
                if(loginBtn && appData.users && Object.keys(appData.users).length > 0) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = "ÿØÿÆŸàŸÑ";
                    loginBtn.style.backgroundColor = '';
                    loginBtn.style.color = '';
                    loginBtn.style.cursor = 'pointer';
                    loginBtn.classList.add('btn-primary');
                }
            } else {
                indicator.className = 'network-status net-offline';
                icon.textContent = 'üî¥';
                text.textContent = 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
                if(loginBtn && appData.users && Object.keys(appData.users).length > 0) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ÿØÿÆŸàŸÑ (Offline)';
                    loginBtn.style.backgroundColor = '';
                    loginBtn.style.color = '';
                    loginBtn.style.cursor = 'pointer';
                    loginBtn.classList.add('btn-primary');
                }
            }
        }
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        function addToOfflineQueue(actionType, data) {
            let queue = JSON.parse(localStorage.getItem('toshka_offline_queue') || '[]');
            queue.push({ type: actionType, data: data, timestamp: Date.now() });
            localStorage.setItem('toshka_offline_queue', JSON.stringify(queue));
            updateOfflineBanner();
        }

        function updateOfflineBanner() {
            const queue = JSON.parse(localStorage.getItem('toshka_offline_queue') || '[]');
            const banner = document.getElementById('offline-sync-banner');
            const countSpan = document.getElementById('offline-count');
            
            if (queue.length > 0) {
                banner.style.display = 'block';
                countSpan.textContent = queue.length;
            } else {
                banner.style.display = 'none';
            }
        }

        function processOfflineQueue() {
            if (!navigator.onLine) return;
            let queue = JSON.parse(localStorage.getItem('toshka_offline_queue') || '[]');
            if (queue.length === 0) return;

            const indicator = document.getElementById('network-status-indicator');
            const icon = document.getElementById('net-icon');
            const text = document.getElementById('net-text');
            
            icon.textContent = 'üîÑ';
            icon.classList.add('syncing');
            text.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...';
            const item = queue.shift();
            
            let promise;
            if (item.type === 'update_station') {
                promise = db.ref('stations/' + item.data.stationId).update(item.data.updates)
                    .then(() => {
                        if(item.data.log) db.ref('history').push(item.data.log);
                        if(item.data.consLog) db.ref('consumption_logs').push(item.data.consLog);
                        if(item.data.newFaults) {
                            db.ref('faults_log').once('value').then(snap => {
                                let rawVal = snap.val();
                                let logs = Array.isArray(rawVal) ? rawVal : (rawVal ? Object.values(rawVal) : []);
                                item.data.newFaults.forEach(f => logs.unshift(f));
                                item.data.resolvedFaults.forEach(rf => {
                                    const idx = logs.findIndex(x => x.station === item.data.stationId && x.type === rf.type && x.active);
                                    if(idx !== -1) { 
                                        logs[idx].active = false;
                                        logs[idx].endTime = rf.endTime; 
                                    }
                                });
                                db.ref('faults_log').set(logs);
                            });
                        }
                    });
            } else if (item.type === 'update_inspection') {
                promise = db.ref(`stations/${item.data.stationId}/inspectionData`).update(item.data.inspectionData)
                    .then(() => {
                        if(item.data.log) db.ref('history').push(item.data.log);
                    });
            } else if (item.type === 'update_profile') {
                promise = db.ref('userProfiles/' + item.data.username).set(item.data.profileData)
                    .then(() => {
                        const nowStd = getStandardDateTime();
                        const log = {
                            date: nowStd.date,
                            time: nowStd.time,
                            station: item.data.profileData.station || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                            operator: item.data.username,
                            details: `ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© (ŸÖÿ≤ÿßŸÖŸÜÿ©): ${item.data.profileData.fullname}`
                        };
                        db.ref('history').push(log);
                    });
            } else if (item.type === 'delete_profile') {
                promise = db.ref('userProfiles/' + item.data.username).remove()
                    .then(() => {
                        const nowStd = getStandardDateTime();
                        const log = {
                            date: nowStd.date,
                            time: nowStd.time,
                            station: 'ÿßŸÑŸÜÿ∏ÿßŸÖ',
                            operator: item.data.deletedBy,
                            details: `ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${item.data.username}`
                        };
                        db.ref('history').push(log);
                    });
            }

            if (promise) {
                promise.then(() => {
                    localStorage.setItem('toshka_offline_queue', JSON.stringify(queue));
                    updateOfflineBanner();
                    if (queue.length > 0) {
                        setTimeout(processOfflineQueue, 500); 
                    } else {
                        icon.classList.remove('syncing');
                        updateNetworkStatus();
                        alert("ÿ™ŸÖÿ™ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆÿ≤ŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ");
                    }
                }).catch(err => {
                    console.error("Sync Error", err);
                    updateNetworkStatus();
                });
            }
        }

        // --- CORE FUNCTIONS ---
        function loadSystemData() {
            const cachedStations = localStorage.getItem('toshka_stations_cache');
            if (cachedStations) {
                appData.stations = JSON.parse(cachedStations);
                renderStations('all');
            }
            const cachedUsers = localStorage.getItem('toshka_users_cache');
            if(cachedUsers) {
                appData.users = JSON.parse(cachedUsers);
            }
            const cachedProfiles = localStorage.getItem('toshka_user_profiles_cache');
            if(cachedProfiles) {
                appData.userProfiles = JSON.parse(cachedProfiles);
            }

            db.ref('stations').on('value', (snapshot) => {
                let data = snapshot.val();
                if (!data) { forceRepairStations(); } 
                else { 
                    appData.stations = data; 
                    localStorage.setItem('toshka_stations_cache', JSON.stringify(data)); 
                    forceRepairStations(); 
                }
                
                if (document.getElementById('stations-screen').classList.contains('active')) {
                    const activeTab = document.querySelector('.nav-tab.active');
                    renderStations(activeTab ? activeTab.dataset.zone : 'all');
                }
                if (document.getElementById('station-screen').classList.contains('active') && appData.currentStation) {
                    showStationDetails(appData.currentStation);
                }
                if (document.getElementById('user-profile-screen').classList.contains('active')) {
                    renderUserProfileForm();
                    renderUsersProfilesList();
                }
                if (document.getElementById('users-data-screen').classList.contains('active')) {
                    renderUsersDataManagement();
                }
                if (document.getElementById('inspection-export-screen').classList.contains('active')) {
                    updateExportFilters();
                }
            });
            
            db.ref('users').on('value', (snapshot) => {
                const loginBtn = document.getElementById('login-btn');
                if (snapshot.val()) {
                    appData.users = snapshot.val();
                    localStorage.setItem('toshka_users_cache', JSON.stringify(appData.users)); 
                    
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = "ÿØÿÆŸàŸÑ";
                        loginBtn.style.backgroundColor = '';
                        loginBtn.style.color = '';
                        loginBtn.style.cursor = 'pointer';
                        loginBtn.classList.add('btn-primary');
                    }
                }
                else {
                    const defaultUsers = {
                        admin: { type: 'admin', password: 'admin123', active: true },
                        engineer1: { type: 'engineer', password: 'eng123', active: true },
                        supervisor1: { type: 'supervisor', password: 'sup123', active: true },
                        operator1: { type: 'operator', password: 'op123', active: true }
                    };
                    
                    db.ref('users').set(defaultUsers);
                    appData.users = defaultUsers;
                    localStorage.setItem('toshka_users_cache', JSON.stringify(defaultUsers));
                    
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = "ÿØÿÆŸàŸÑ";
                        loginBtn.style.backgroundColor = '';
                        loginBtn.style.color = '';
                        loginBtn.style.cursor = 'pointer';
                        loginBtn.classList.add('btn-primary');
                    }
                }
            });
            
            db.ref('userProfiles').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appData.userProfiles = data;
                    localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(data));
                } else {
                    appData.userProfiles = {};
                    localStorage.setItem('toshka_user_profiles_cache', JSON.stringify({}));
                }
                
                if (document.getElementById('user-profile-screen').classList.contains('active')) {
                    renderUserProfileForm();
                    renderUsersProfilesList();
                }
                if (document.getElementById('users-data-screen').classList.contains('active')) {
                    renderUsersDataManagement();
                }
            });
            
            db.ref('history').limitToLast(20000).on('value', (snapshot) => {
                const val = snapshot.val();
                if(val) {
                    appData.operationHistory = Object.values(val).reverse();
                    cleanHistoricalData();
                }
                else appData.operationHistory = [];
                if (document.getElementById('history-screen').classList.contains('active')) renderHistoryTable(true);
            });
            
            db.ref('faults_log').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) appData.faultsLog = Array.isArray(val) ? val : Object.values(val);
                else appData.faultsLog = [];
                if (document.getElementById('faults-log-screen').classList.contains('active')) renderFaultsLog();
            });
            
            db.ref('consumption_logs').on('value', (snapshot) => {
                const val = snapshot.val();
                if(val) appData.consumptionLog = Object.values(val);
                else appData.consumptionLog = [];
            });
            
            updateNetworkStatus();
            updateOfflineBanner();
        }

        function forceRepairStations() {
            let updates = {};
            let repairCount = 0;
            const nowStd = getStandardDateTime();
            
            Object.keys(pumpsData).forEach(stationName => {
                const exists = appData.stations && appData.stations[stationName];
                if (!exists) {
                    let zone = 'Unknown';
                    appData.zones.forEach(z => { 
                        if(stationName.startsWith(z.split('_')[1])) zone = z; 
                        else if(stationName.startsWith('O1-')) zone = 'Zone_O1';
                        else if(stationName.startsWith('R')) zone = 'Zone_R';
                    });
                    if(stationName.startsWith('A')) zone='Zone_A';
                    
                    const pumpCount = pumpsData[stationName] || 4;
                    updates[stationName] = {
                        name: stationName, 
                        zone: zone, 
                        status: 'ŸÖÿ™ŸàŸÇŸÅÿ©', 
                        pressure: 0, 
                        maxPressure: 8.0, // ÿ•ÿ∂ÿßŸÅÿ© ŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑
                        activePumps: 0,
                        voltage: 380, 
                        waterFlow: 0, 
                        systemMode: 'SCADA', 
                        operatorName: 'ÿßŸÑŸÜÿ∏ÿßŸÖ',
                        lastUpdate: nowStd.full, 
                        comments: '',
                        startTime: '', 
                        stopTime: '',
                        currentFault: null, 
                        secondaryFault: null,
                        pumps: Array(pumpCount).fill().map((_, index) => ({ 
                            id: index + 1, 
                            status: 'ŸÖÿ™ŸàŸÇŸÅÿ©', 
                            suctionPressure: null, 
                            dischargePressure: null, 
                            frequency: null 
                        })),
                        consumption: { t1: '', t2: '', m3: '', lastUpdate: '' }
                    };
                    repairCount++;
                }
            });
            if (repairCount > 0 && navigator.onLine) db.ref('stations').update(updates);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`${screenId}-screen`).classList.add('active');
            window.scrollTo(0, 0);
            
            const userInfoDiv = document.getElementById('header-user-info');
            userInfoDiv.style.display = (screenId === 'login') ? 'none' : 'flex';
            if(screenId === 'stations') {
                const activeTab = document.querySelector('.nav-tab.active');
                renderStations(activeTab ? activeTab.dataset.zone : 'all');
            }
            if(screenId === 'users') {
                appData.currentUsersPage = 0;
                renderUsersManagement();
            }
            if(screenId === 'users-data') {
                appData.currentUsersDataPage = 0;
                renderUsersDataManagement();
            }
            if(screenId === 'history') {
                renderHistoryTable(true);
            }
            if(screenId === 'faults-log') {
                appData.faultsLimit = 100;
                renderFaultsLog();
            }
            if(screenId === 'user-profile') {
                appData.currentProfilesPage = 0;
                renderUserProfileForm();
                renderUsersProfilesList();
            }
            if(screenId === 'inspection-export') {
                updateExportFilters();
            }
        }

        // --- AUTHENTICATION ---
        document.getElementById('logout-btn').addEventListener('click', () => { 
            appData.currentUser = null; 
            showScreen('login'); 
        });
        
        document.getElementById('toggle-password-icon').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        });
        
        function checkRememberedUser() {
            const savedUser = localStorage.getItem('toshka_user');
            const savedPass = localStorage.getItem('toshka_pass');
            if (savedUser && savedPass) {
                document.getElementById('username').value = savedUser;
                document.getElementById('password').value = savedPass;
                document.getElementById('remember-me').checked = true;
            }
        }
        
        document.getElementById('login-btn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const user = appData.users[u];
            const remember = document.getElementById('remember-me').checked;
            
            if (user && user.password === p && user.active !== false) {
                if (remember) { 
                    localStorage.setItem('toshka_user', u); 
                    localStorage.setItem('toshka_pass', p); 
                } 
                else { 
                    localStorage.removeItem('toshka_user'); 
                    localStorage.removeItem('toshka_pass'); 
                }
                
                appData.currentUser = {
                    username: u,
                    id: u,
                    name: u,
                    type: user.type,
                    permissions: appData.userTypes[user.type].permissions
                };
                
                document.getElementById('current-user').textContent = `${appData.userTypes[user.type].name}: ${u}`;
                
                const userType = user.type;
                const permissions = appData.userTypes[userType].permissions;
                
                document.getElementById('users-management-btn').style.display = permissions.manage_users ? 'inline-block' : 'none';
                document.getElementById('history-management-btn').style.display = permissions.view_history ? 'inline-block' : 'none';
                document.getElementById('export-inspection-report-btn').style.display = permissions.export_inspection ? 'inline-block' : 'none';
                
                if (userType === 'admin' || userType === 'engineer') {
                    document.getElementById('consumptions-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('consumptions-btn').style.display = 'none';
                }

                showScreen('stations');
                renderZonesTabs();
                renderStations('all');
            } else { 
                alert('ÿ®ŸäÿßŸÜÿßÿ™ ÿÆÿßÿ∑ÿ¶ÿ© ÿ£Ÿà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑ'); 
            }
        });

        // --- NAVIGATION & BUTTONS FIXES ---
        document.getElementById('profile-btn').addEventListener('click', () => {
            if (!appData.currentUser) {
                alert('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            showScreen('user-profile');
            renderUserProfileForm();
            renderUsersProfilesList();
        });
        
        document.getElementById('users-management-btn').addEventListener('click', () => {
            if (appData.currentUser && appData.currentUser.permissions.manage_users) {
                showScreen('users');
            } else {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
            }
        });
        
        document.getElementById('history-management-btn').addEventListener('click', () => showScreen('history'));
        document.getElementById('alarm-btn').addEventListener('click', () => showScreen('faults-log'));
        document.getElementById('export-inspection-report-btn').addEventListener('click', () => {
            if (appData.currentUser && appData.currentUser.permissions.export_inspection) {
                showScreen('inspection-export');
            } else {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ');
            }
        });

        document.getElementById('back-to-stations').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-station').addEventListener('click', () => showStationDetails(appData.currentStation));
        document.getElementById('back-to-stations-from-users').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-history').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-faults').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-cons').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-from-inspection').addEventListener('click', () => { showStationDetails(appData.currentStation); });
        document.getElementById('back-to-stations-from-profile').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-users-data').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-export').addEventListener('click', () => showScreen('stations'));

        // New button for user data management
        document.getElementById('profile-btn').addEventListener('dblclick', () => {
            if (appData.currentUser && appData.currentUser.type === 'admin') {
                showScreen('users-data');
            }
        });

        // --- SHIFT CHECK LOGIC ---
        function checkShiftAdherence(lastUpdateStr) {
            if (!lastUpdateStr) return true;
            const lastUpdate = parseCustomDate(lastUpdateStr);
            if (!lastUpdate || isNaN(lastUpdate.getTime())) return true;

            const now = new Date();
            const currentHour = now.getHours();
            let shiftStart = new Date(now);
            shiftStart.setMinutes(0); shiftStart.setSeconds(0); shiftStart.setMilliseconds(0);

            if (currentHour >= 6 && currentHour < 18) {
                shiftStart.setHours(6);
                return lastUpdate < shiftStart;
            } else {
                if (currentHour >= 18) { shiftStart.setHours(18); } 
                else { shiftStart.setDate(shiftStart.getDate() - 1); shiftStart.setHours(18); }
                return lastUpdate < shiftStart;
            }
        }

        // --- DASHBOARD RENDERER ---
        function renderZonesTabs() {
            const c = document.getElementById('zones-tabs');
            c.innerHTML = `<button class="nav-tab active" data-zone="all" onclick="handleTabClick('all', this)">ÿßŸÑŸÉŸÑ</button>`;
            appData.zones.forEach(z => c.innerHTML += `<button class="nav-tab" data-zone="${z}" onclick="handleTabClick('${z}', this)">${z}</button>`);
        }
        
        window.handleTabClick = (zone, btn) => {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderStations(zone);
        };
        
        window.renderStations = (zoneFilter = 'all') => {
            const container = document.getElementById('stations-container');
            container.innerHTML = '';
            let allStations = Object.values(appData.stations || {});
            
            if(allStations.length === 0) { 
                container.innerHTML = '<div style="text-align:center; padding:20px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                return; 
            }

            const activeCount = allStations.filter(s => s.status === 'ŸÜÿ¥ÿ∑ÿ©').length;
            const inactiveCount = allStations.filter(s => s.status === 'ŸÖÿ™ŸàŸÇŸÅÿ©' && !s.currentFault).length;
            const faultedStations = allStations.filter(s => s.currentFault || s.secondaryFault);
            document.getElementById('total-stations').textContent = allStations.length;
            document.getElementById('active-stations').textContent = activeCount;
            document.getElementById('inactive-stations').textContent = inactiveCount;

            const tickerContainer = document.getElementById('ticker-container');
            const tickerContent = document.getElementById('ticker-content');
            const alarmBtn = document.getElementById('alarm-btn');
            const alarmCount = document.getElementById('alarm-count');

            if (faultedStations.length > 0) {
                tickerContainer.classList.add('active');
                let tickerHtml = '';
                faultedStations.forEach((s, index) => {
                    if (s.currentFault) {
                        const icon = faultIcons[s.currentFault] || '‚ö†Ô∏è';
                        tickerHtml += `<span class="ticker-item">${icon} ${s.name}: ${s.currentFault}</span>`;
                    }
                    if (s.secondaryFault) {
                        const icon = faultIcons[s.secondaryFault] || '‚ö†Ô∏è';
                        tickerHtml += `<span class="ticker-item">${icon} ${s.name}: ${s.secondaryFault}</span>`;
                    }
                    if (index < faultedStations.length - 1) { tickerHtml += `<span class="ticker-separator">‚Ä¢</span>`; }
                });
                tickerContent.innerHTML = tickerHtml;
                
                setTimeout(() => {
                    const contentWidth = tickerContent.scrollWidth;
                    const containerWidth = tickerContainer.offsetWidth;
                    const speed = 100;
                    const duration = (contentWidth + containerWidth) / speed;
                    const finalDuration = Math.max(duration, 5); 
                    tickerContent.style.animationDuration = `${finalDuration}s`;
                }, 100);
                alarmBtn.classList.add('flashing');
                alarmCount.style.display = 'flex';
                alarmCount.textContent = faultedStations.length;
            } else {
                tickerContainer.classList.remove('active');
                alarmBtn.classList.remove('flashing');
                alarmCount.style.display = 'none';
            }

            let zonesToRender = zoneFilter === 'all' ? appData.zones : [zoneFilter];
            zonesToRender.forEach(zoneName => {
                const zoneStations = allStations.filter(s => s.zone === zoneName);
                if (zoneStations.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'zone-separator';
                    separator.innerHTML = `<span>${zoneName}</span> <span style="font-size:0.9rem; opacity:0.8;">(${zoneStations.length})</span>`;
                    container.appendChild(separator);
                    
                    const grid = document.createElement('div');
                    grid.className = 'stations-grid';
                    
                    zoneStations.forEach(s => {
                        const isFault = (s.currentFault || s.secondaryFault) ? true : false;
                        let cardClass = 'station-card';
                        if (isFault) {
                            cardClass += ' fault-active';
                            if (s.currentFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA' || s.secondaryFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA') cardClass += ' scada-fault';
                        }
                        const card = document.createElement('div');
                        card.className = cardClass;
                        let faultHtml = '';
                        if(isFault) {
                            if(s.currentFault) {
                                const icon = faultIcons[s.currentFault] || '‚ö†Ô∏è';
                                let badgeClass = 'fault-badge';
                                if (s.currentFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA') badgeClass += ' scada-badge';
                                faultHtml += `<div class="${badgeClass}">${icon} ${s.currentFault}</div>`;
                            }
                            if(s.secondaryFault) {
                                const icon = faultIcons[s.secondaryFault] || '‚ö†Ô∏è';
                                let badgeClass = 'fault-badge';
                                if (s.secondaryFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA') badgeClass += ' scada-badge';
                                faultHtml += `<div class="${badgeClass}" style="margin-top:2px;">${icon} ${s.secondaryFault}</div>`;
                            }
                        }

                        let missedUpdateHtml = '';
                        if (checkShiftAdherence(s.lastUpdate)) { 
                            missedUpdateHtml = `<span class="missed-update-icon" title="ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ÿßŸÑŸÖŸàÿπÿØ">!</span>`;
                        }

                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑÿπÿßŸÑŸä Ÿàÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ÿ™ŸÜÿ®ŸäŸá
                        let pressureWarningHtml = '';
                        const currentPressure = parseFloat(s.pressure) || 0;
                        const maxPressure = parseFloat(s.maxPressure) || 8.0;
                        
                        if (currentPressure > maxPressure) {
                            pressureWarningHtml = `<span class="pressure-warning" title="ÿßŸÑÿ∂ÿ∫ÿ∑ ÿ£ÿπŸÑŸâ ŸÖŸÜ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá (${maxPressure} Bar)">!</span>`;
                        }

                        card.innerHTML = `
                            <div style="font-weight:bold; color:var(--primary-color)">${missedUpdateHtml}${s.name}</div>
                            <span class="station-status ${s.status === 'ŸÜÿ¥ÿ∑ÿ©' ? 'status-active' : 'status-inactive'}">${s.status}</span>
                            ${faultHtml}
                            <div style="margin-top:10px; font-size:13px;">
                                <div>ÿßŸÑÿ∂ÿ∫ÿ∑: ${pressureWarningHtml}${s.pressure} Bar</div>
                                <div>ÿßŸÑÿ¨ŸáÿØ: ${s.voltage} V</div>
                                <div style="color:var(--secondary-color);">ÿßŸÑÿ™ÿØŸÅŸÇ: ${s.waterFlow} L/Sec</div>
                                <div>ÿßŸÑŸÖÿ∂ÿÆÿßÿ™: ${s.activePumps}</div>
                            </div>`;
                        card.onclick = () => showStationDetails(s.name);
                        grid.appendChild(card);
                    });
                    container.appendChild(grid);
                }
            });
        };

        // --- STATION DETAILS ---
        function showStationDetails(stationId) {
            const s = appData.stations[stationId];
            if (!s) return;
            appData.currentStation = stationId;
            
            document.getElementById('station-title').textContent = s.name;
            document.getElementById('station-status-value').textContent = s.status;
            document.getElementById('operator-name-value').textContent = s.operatorName;
            document.getElementById('voltage-value').textContent = s.voltage;
            document.getElementById('station-pressure-value').textContent = s.pressure;
            // ÿ•ÿ∂ÿßŸÅÿ© ÿπÿ±ÿ∂ ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ŸÅŸä ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            document.getElementById('max-pressure-value').textContent = s.maxPressure || '8.0';
            document.getElementById('active-pumps-value').textContent = s.activePumps;
            document.getElementById('water-flow-value').textContent = s.waterFlow;
            document.getElementById('system-mode-value').textContent = s.systemMode;
            document.getElementById('start-time-value').textContent = s.startTime || '-';
            document.getElementById('stop-time-value').textContent = s.stopTime || '-';
            
            document.getElementById('last-update-value').textContent = s.lastUpdate;
            document.getElementById('station-comments-value').textContent = s.comments || 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™';

            const cons = s.consumption || {};
            document.getElementById('view-cons-t1').textContent = cons.t1 || '-';
            document.getElementById('view-cons-t2').textContent = cons.t2 || '-';
            document.getElementById('view-cons-m3').textContent = cons.m3 || '-';
            document.getElementById('view-cons-date').textContent = cons.lastUpdate || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ';

            const banner = document.getElementById('station-fault-banner');
            const faultList = document.getElementById('station-fault-list');
            if (s.currentFault || s.secondaryFault) {
                banner.style.display = 'block';
                faultList.innerHTML = '';
                let hasScadaFault = false;
                if(s.currentFault) {
                    if (s.currentFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA') hasScadaFault = true;
                    const descText = s.fault1Desc ? ` <span style="font-weight:normal; color:#d32f2f">(${s.fault1Desc})</span>` : '';
                    faultList.innerHTML += `<li>${s.currentFault}${descText} <span style="font-size:0.8em; color:#666">(${s.faultStartTime || '-'})</span></li>`;
                }
                if(s.secondaryFault) {
                    if (s.secondaryFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA') hasScadaFault = true;
                    const descText = s.fault2Desc ? ` <span style="font-weight:normal; color:#d32f2f">(${s.fault2Desc})</span>` : '';
                    faultList.innerHTML += `<li>${s.secondaryFault}${descText}</li>`;
                }
                if (hasScadaFault) { 
                    banner.style.background = '#fff3cd';
                    banner.style.color = '#856404'; 
                    banner.style.borderColor = '#ffeeba'; 
                } 
                else { 
                    banner.style.background = '#ffecec';
                    banner.style.color = '#b71c1c'; 
                    banner.style.borderColor = '#ffcdd2'; 
                }
            } else { 
                banner.style.display = 'none';
            }

            const tbody = document.getElementById('pumps-table-body');
            tbody.innerHTML = '';
            s.pumps.forEach(p => {
                let statusColor = p.status==='ŸÜÿ¥ÿ∑ÿ©'?'green':'red';
                if(p.status === 'ŸÖÿπÿ∑ŸÑÿ©') statusColor = 'orange';
                tbody.innerHTML += `<tr><td>${p.id}</td><td style="color:${statusColor}">${p.status}</td><td>${p.suctionPressure||'-'}</td><td>${p.dischargePressure||'-'}</td><td>${p.frequency||'-'}</td></tr>`;
            });
            
            const canEdit = appData.currentUser && (
                appData.currentUser.permissions.edit_all || 
                appData.currentUser.permissions.edit_some || 
                appData.currentUser.permissions.edit_own
            );
            document.getElementById('edit-station-btn').style.display = canEdit ? 'block' : 'none';
            showScreen('station');
        }

        // --- EDIT MODE & FAULT RESOLUTION ---
        document.getElementById('edit-station-btn').addEventListener('click', () => {
            const s = appData.stations[appData.currentStation];
            document.getElementById('editing-station-name').textContent = `ŸÖÿ≠ÿ∑ÿ©: ${s.name}`;
            
            let currentOperatorName = 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ';
            if (appData.currentUser) {
                currentOperatorName = appData.currentUser.username || 
                                     appData.currentUser.name || 
                                     appData.currentUser.id || 
                                     'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ';
            }
            document.getElementById('operator-name').value = currentOperatorName;
            
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('operator-start-time').value = s.startTime || timeString;
            document.getElementById('operator-stop-time').value = s.stopTime || '';
            document.getElementById('operator-pressure').value = s.pressure;
            document.getElementById('operator-water-flow').value = s.waterFlow;
            document.getElementById('operator-voltage').value = s.voltage;
            document.getElementById('operator-system-mode').value = s.systemMode;
            document.getElementById('operator-comments').value = s.comments;
            
            // ÿ™ÿπŸäŸäŸÜ ŸÇŸäŸÖÿ© ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ŸÅŸä ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖÿ¥ÿ∫ŸÑ
            document.getElementById('operator-max-pressure').value = s.maxPressure || '8.0';
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            const currentUser = appData.currentUser;
            const canEditMaxPressure = currentUser && (
                currentUser.type === 'admin' || 
                currentUser.type === 'engineer' || 
                currentUser.type === 'supervisor'
            );
            
            if (canEditMaxPressure) {
                document.getElementById('operator-max-pressure').readOnly = false;
                document.getElementById('operator-max-pressure').style.background = '#fff';
            } else {
                document.getElementById('operator-max-pressure').readOnly = true;
                document.getElementById('operator-max-pressure').style.background = '#eee';
            }

            const cons = s.consumption || {};
            document.getElementById('cons-trans-1').value = cons.t1 || '';
            document.getElementById('cons-trans-2').value = cons.t2 || '';
            document.getElementById('cons-water-m3').value = cons.m3 || '';

            const faultControl = document.getElementById('active-fault-control');
            const row1 = document.getElementById('fault-row-1');
            const row2 = document.getElementById('fault-row-2');
            
            row1.style.display = 'none'; row2.style.display = 'none'; faultControl.style.display = 'none';
            if (s.currentFault || s.secondaryFault) {
                faultControl.style.display = 'block';
                if(s.currentFault) { row1.style.display = 'flex'; document.getElementById('txt-fault-1').textContent = s.currentFault; }
                if(s.secondaryFault) { row2.style.display = 'flex'; document.getElementById('txt-fault-2').textContent = s.secondaryFault; }
            }

            document.getElementById('fault-selector').value = s.currentFault || "";
            document.getElementById('fault-selector-secondary').value = s.secondaryFault || "";
            document.getElementById('fault-1-desc').value = s.fault1Desc || "";
            document.getElementById('fault-2-desc').value = s.fault2Desc || "";

            updateFaultExclusions();
            const c = document.getElementById('pumps-form-container');
            let pumpsHtml = '';
            s.pumps.forEach(p => {
                pumpsHtml += `
                    <div class="pump-control">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <b>ŸÖÿ∂ÿÆÿ© ${p.id}</b>
                            <select id="p_stat_${p.id}" onchange="togglePumpInputs(${p.id})">
                                <option value="ŸÜÿ¥ÿ∑ÿ©" ${p.status==='ŸÜÿ¥ÿ∑ÿ©'?'selected':''}>ŸÜÿ¥ÿ∑ÿ©</option>
                                <option value="ŸÖÿ™ŸàŸÇŸÅÿ©" ${p.status==='ŸÖÿ™ŸàŸÇŸÅÿ©'?'selected':''}>ŸÖÿ™ŸàŸÇŸÅÿ©</option>
                                <option value="ŸÖÿπÿ∑ŸÑÿ©" ${p.status==='ŸÖÿπÿ∑ŸÑÿ©'?'selected':''}>ŸÖÿπÿ∑ŸÑÿ©</option>
                            </select>
                        </div>
                        <input type="number" placeholder="ÿ≥ÿ≠ÿ®" id="p_suc_${p.id}" value="${p.suctionPressure||''}" class="p_inp_${p.id}">
                        <input type="number" placeholder="ÿ∑ÿ±ÿØ" id="p_dis_${p.id}" value="${p.dischargePressure||''}" class="p_inp_${p.id}" style="margin-top:5px">
                        <input type="number" placeholder="ÿ™ÿ±ÿØÿØ" id="p_freq_${p.id}" value="${p.frequency||''}" class="p_inp_${p.id}" style="margin-top:5px">
                    </div>`;
            });
            c.innerHTML = pumpsHtml;
            s.pumps.forEach(p => { togglePumpInputs(p.id); });
            showScreen('operator');
        });
        
        window.togglePumpInputs = (id) => {
            const active = document.getElementById(`p_stat_${id}`).value === 'ŸÜÿ¥ÿ∑ÿ©';
            document.querySelectorAll(`.p_inp_${id}`).forEach(i => {
                i.disabled = !active;
                if(!active) i.style.background = '#eee'; else i.style.background = '#fff';
            });
        };
        
        function updateFaultExclusions() {
            const f1 = document.getElementById('fault-selector');
            const f2 = document.getElementById('fault-selector-secondary');
            Array.from(f2.options).forEach(opt => opt.disabled = false);
            Array.from(f1.options).forEach(opt => opt.disabled = false);
            if(f1.value) { 
                const optIn2 = f2.querySelector(`option[value="${f1.value}"]`);
                if(optIn2) optIn2.disabled = true; 
            }
            if(f2.value) { 
                const optIn1 = f1.querySelector(`option[value="${f2.value}"]`);
                if(optIn1) optIn1.disabled = true; 
            }
        }
        
        document.getElementById('fault-selector').addEventListener('change', updateFaultExclusions);
        document.getElementById('fault-selector-secondary').addEventListener('change', updateFaultExclusions);

        document.getElementById('save-operator-data').addEventListener('click', () => saveDataInternal({}));
        document.getElementById('btn-resolve-f1').addEventListener('click', () => { if(confirm("ŸáŸÑ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ£ŸàŸÑÿü")) saveDataInternal({ resolveTarget: 'currentFault' }); });
        document.getElementById('btn-resolve-f2').addEventListener('click', () => { if(confirm("ŸáŸÑ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ´ÿßŸÜŸäÿü")) saveDataInternal({ resolveTarget: 'secondaryFault' }); });
        
        function saveDataInternal(options = {}) {
            try {
                const sName = appData.currentStation;
                if (!sName || !appData.stations[sName]) { 
                    alert("ÿÆÿ∑ÿ£: ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿ∑ÿ© ŸÖÿ≠ÿØÿØÿ©!"); 
                    return; 
                }
                
                const oldData = appData.stations[sName];
                const getVal = (id) => { 
                    const el = document.getElementById(id); 
                    return el ? el.value : ''; 
                };
                
                const safeOldFault1 = (oldData.currentFault && oldData.currentFault !== "undefined") ? oldData.currentFault : null;
                const safeOldFault2 = (oldData.secondaryFault && oldData.secondaryFault !== "undefined") ? oldData.secondaryFault : null;

                let newOperator = '';
                if (appData.currentUser) {
                    newOperator = appData.currentUser.username || 
                                     appData.currentUser.id || 
                                     appData.currentUser.name || 
                                     'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ';
                } else {
                    newOperator = getVal('operator-name') || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ';
                }
                
                if (!newOperator || newOperator.trim() === '' || newOperator === 'undefined') {
                    newOperator = 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ';
                }
                
                let newPressure = parseFloat(getVal('operator-pressure')) || 0;
                let newFlow = parseFloat(getVal('operator-water-flow')) || 0;
                let newVoltage = getVal('operator-voltage');
                const newMode = getVal('operator-system-mode');
                const newComments = getVal('operator-comments');
                
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇŸäŸÖÿ© ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑
                let newMaxPressure = parseFloat(getVal('operator-max-pressure')) || 8.0;
                
                let consTrans1 = getVal('cons-trans-1');
                let consTrans2 = getVal('cons-trans-2');
                let consWater = getVal('cons-water-m3');

                let newStartTime = getVal('operator-start-time');
                let newStopTime = getVal('operator-stop-time');
                
                const nowStd = getStandardDateTime();
                const updateDate = nowStd.date;
                const updateTime = nowStd.time;
                const sysTimeShort = updateTime.substring(0, 5);
                const stationFullDateTime = nowStd.full;
                let changesDetails = [];
                let activeCount = 0;
                let currentStatus = 'ŸÖÿ™ŸàŸÇŸÅÿ©';
                
                let finalFault = safeOldFault1;
                let finalFaultDesc = oldData.fault1Desc || null;
                let finalFaultSec = safeOldFault2;
                let finalFaultSecDesc = oldData.fault2Desc || null;
                let faultStartTime = oldData.faultStartTime || null;
                const nonStoppingFaults = ['ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ SCADA', 'ÿπÿ¨ÿ≤ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ∂ÿ∫ÿ∑', 'ÿßŸÜÿ≥ÿØÿßÿØÿßÿ™', 'ÿ™ÿ≥ÿ±Ÿäÿ® ŸÖŸäÿßŸá'];
                let newFaultEntries = [];
                let resolvedFaultEntries = [];
                
                if (options.resolveTarget === 'currentFault') {
                    if (safeOldFault1) { 
                        changesDetails.push(`‚úÖ ÿ•ÿµŸÑÿßÿ≠: ${safeOldFault1}`);
                        resolvedFaultEntries.push({ station: sName, type: safeOldFault1, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                    }
                    finalFault = null;
                    finalFaultDesc = null; 
                    if (!finalFaultSec) faultStartTime = null;
                } else if (options.resolveTarget === 'secondaryFault') {
                    if (safeOldFault2) { 
                        changesDetails.push(`‚úÖ ÿ•ÿµŸÑÿßÿ≠: ${safeOldFault2}`);
                        resolvedFaultEntries.push({ station: sName, type: safeOldFault2, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                    }
                    finalFaultSec = null;
                    finalFaultSecDesc = null; 
                    if (!finalFault) faultStartTime = null;
                } else {
                    const sel1 = getVal('fault-selector');
                    const selDesc1 = getVal('fault-1-desc');
                    let sel2 = getVal('fault-selector-secondary');
                    let selDesc2 = getVal('fault-2-desc');
                    if (sel1 && sel1 === sel2) sel2 = "";
                    finalFault = sel1 || null; 
                    finalFaultDesc = finalFault ? selDesc1 : null; 
                    finalFaultSec = sel2 || null; 
                    finalFaultSecDesc = finalFaultSec ? selDesc2 : null;
                    
                    if (finalFault !== safeOldFault1) {
                        if (finalFault) { 
                            changesDetails.push(`‚ö†Ô∏è ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ∑ŸÑ 1: ${finalFault}`);
                            newFaultEntries.push({ station: sName, type: finalFault, startTime: stationFullDateTime, endTime: null, active: true }); 
                            if(!safeOldFault1) faultStartTime = stationFullDateTime;
                        } 
                        else { 
                            if (safeOldFault1) { 
                                changesDetails.push(`‚úÖ ÿ•ÿµŸÑÿßÿ≠: ${safeOldFault1}`);
                                resolvedFaultEntries.push({ station: sName, type: safeOldFault1, startTime: faultStartTime, endTime: stationFullDateTime, active: false }); 
                            } 
                            if (!finalFaultSec) faultStartTime = null;
                        }
                    }
                    if (finalFaultSec !== safeOldFault2) {
                        if (finalFaultSec) { 
                            changesDetails.push(`‚ö†Ô∏è ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ∑ŸÑ 2: ${finalFaultSec}`);
                            newFaultEntries.push({ station: sName, type: finalFaultSec, startTime: stationFullDateTime, endTime: null, active: true }); 
                            if (!faultStartTime) faultStartTime = stationFullDateTime;
                        } 
                        else { 
                            if (safeOldFault2) { 
                                changesDetails.push(`‚úÖ ÿ•ÿµŸÑÿßÿ≠: ${safeOldFault2}`);
                                resolvedFaultEntries.push({ station: sName, type: safeOldFault2, startTime: stationFullDateTime, endTime: stationFullDateTime, active: false });
                            } 
                        }
                    }
                }

                const isCriticalFault = (finalFault && !nonStoppingFaults.includes(finalFault)) || (finalFaultSec && !nonStoppingFaults.includes(finalFaultSec));
                if (isCriticalFault) { 
                    currentStatus = 'ŸÖÿ™ŸàŸÇŸÅÿ©'; 
                    activeCount = 0; 
                    newPressure = 0; 
                    newFlow = 0;
                    if (finalFault === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä' || finalFaultSec === 'ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸáÿ±ÿ®Ÿä') newVoltage = 0;
                }
                
                if (!oldData.pumps) oldData.pumps = [];
                const updatedPumps = oldData.pumps.map(p => {
                    const statElem = document.getElementById(`p_stat_${p.id}`);
                    let newStatus = statElem ? statElem.value : p.status;
                    if (isCriticalFault && newStatus === 'ŸÜÿ¥ÿ∑ÿ©') newStatus = 'ŸÖÿ™ŸàŸÇŸÅÿ©';
                    if(p.status != newStatus) changesDetails.push(`ŸÖÿ∂ÿÆÿ© ${p.id}: ${p.status} -> ${newStatus}`);
                    let pumpData = { 
                        id: p.id, 
                        status: newStatus, 
                        suctionPressure: null, 
                        dischargePressure: null, 
                        frequency: null 
                    };
                    if(newStatus === 'ŸÜÿ¥ÿ∑ÿ©') { 
                        activeCount++; 
                        pumpData.suctionPressure = getVal(`p_suc_${p.id}`); 
                        pumpData.dischargePressure = getVal(`p_dis_${p.id}`); 
                        pumpData.frequency = getVal(`p_freq_${p.id}`); 
                    }
                    return pumpData;
                });
                
                if (!isCriticalFault) { 
                    if (activeCount > 0) currentStatus = 'ŸÜÿ¥ÿ∑ÿ©'; 
                    else { 
                        currentStatus = 'ŸÖÿ™ŸàŸÇŸÅÿ©'; 
                        newPressure = 0;
                        newFlow = 0; 
                    } 
                }
                // ÿ™ÿ≠ÿØŸäÿØ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ŸàÿßŸÑÿ•ŸäŸÇÿßŸÅ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ© ÿ®ÿ¥ŸÉŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä
const oldStatus = oldData.status;
const oldStartTime = oldData.startTime || '';
const oldStopTime = oldData.stopTime || '';

// ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿ™Ÿä ÿ£ÿØÿÆŸÑŸáÿß ÿßŸÑŸÖÿ¥ÿ∫ŸÑ
const enteredStartTime = getVal('operator-start-time');
const enteredStopTime = getVal('operator-stop-time');

// ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÖÿ≠ÿ∑ÿ© ŸÉÿßŸÜÿ™ ŸÖÿ™ŸàŸÇŸÅÿ© Ÿàÿ£ÿµÿ®ÿ≠ÿ™ ŸÜÿ¥ÿ∑ÿ©
if (oldStatus === 'ŸÖÿ™ŸàŸÇŸÅÿ©' && currentStatus === 'ŸÜÿ¥ÿ∑ÿ©') {
    // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ∫Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ∫ŸÑ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÇÿ™ ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿßŸÑŸä
    if (!enteredStartTime || enteredStartTime === oldStartTime) {
        newStartTime = sysTimeShort;
        changesDetails.push(`‚è∞ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä: ${sysTimeShort}`);
    } else {
        newStartTime = enteredStartTime;
    }
    // ŸÖÿ≠ÿ∑ÿ© ÿ£ÿµÿ®ÿ≠ÿ™ ŸÜÿ¥ÿ∑ÿ©ÿå ŸÑÿß ŸäŸàÿ¨ÿØ ŸàŸÇÿ™ ÿ•ŸäŸÇÿßŸÅ
    newStopTime = '';
}
// ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÖÿ≠ÿ∑ÿ© ŸÉÿßŸÜÿ™ ŸÜÿ¥ÿ∑ÿ© Ÿàÿ£ÿµÿ®ÿ≠ÿ™ ŸÖÿ™ŸàŸÇŸÅÿ©
else if (oldStatus === 'ŸÜÿ¥ÿ∑ÿ©' && currentStatus === 'ŸÖÿ™ŸàŸÇŸÅÿ©') {
    // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ∫Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ∫ŸÑ ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÇÿ™ ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿßŸÑŸä
    if (!enteredStopTime || enteredStopTime === oldStopTime) {
        newStopTime = sysTimeShort;
        changesDetails.push(`‚è∞ ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä: ${sysTimeShort}`);
    } else {
        newStopTime = enteredStopTime;
    }
    // ŸÖÿ≠ÿ∑ÿ© ÿ£ÿµÿ®ÿ≠ÿ™ ŸÖÿ™ŸàŸÇŸÅÿ©ÿå ÿßÿ®ŸÇ ÿπŸÑŸâ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÇÿØŸäŸÖ ŸÖÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ±Ÿá
    if (!enteredStartTime || enteredStartTime === oldStartTime) {
        newStartTime = oldStartTime;
    } else {
        newStartTime = enteredStartTime;
    }
}
// ÿ•ÿ∞ÿß ÿ∏ŸÑÿ™ ÿßŸÑŸÖÿ≠ÿ∑ÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿßŸÑÿ©
else {
    // ÿ•ÿ∞ÿß ÿ®ŸÇŸäÿ™ ŸÜÿ¥ÿ∑ÿ©
    if (currentStatus === 'ŸÜÿ¥ÿ∑ÿ©') {
        newStopTime = '';
        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑÿå ÿßÿ®ŸÇ ÿπŸÑŸâ ÿßŸÑŸÇÿØŸäŸÖ
        if (!enteredStartTime || enteredStartTime === oldStartTime) {
            newStartTime = oldStartTime;
        } else {
            newStartTime = enteredStartTime;
        }
    }
    // ÿ•ÿ∞ÿß ÿ®ŸÇŸäÿ™ ŸÖÿ™ŸàŸÇŸÅÿ©
    else {
        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅÿå ÿßÿ®ŸÇ ÿπŸÑŸâ ÿßŸÑŸÇÿØŸäŸÖ
        if (!enteredStopTime || enteredStopTime === oldStopTime) {
            newStopTime = oldStopTime;
        } else {
            newStopTime = enteredStopTime;
        }
        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑÿå ÿßÿ®ŸÇ ÿπŸÑŸâ ÿßŸÑŸÇÿØŸäŸÖ
        if (!enteredStartTime || enteredStartTime === oldStartTime) {
            newStartTime = oldStartTime;
        } else {
            newStartTime = enteredStartTime;
        }
    }
}

// ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿπÿ∑ŸÑ ÿ≠ÿ±ÿ¨ÿå ÿßÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®
if (isCriticalFault) {
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿπÿ∑ŸÑ ÿ≠ÿ±ÿ¨ Ÿàÿ™ŸàŸÇŸÅÿ™ ÿßŸÑŸÖÿ≠ÿ∑ÿ©ÿå ÿ∂ÿπ ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
    if (oldStatus === 'ŸÜÿ¥ÿ∑ÿ©' && currentStatus === 'ŸÖÿ™ŸàŸÇŸÅÿ©') {
        newStopTime = sysTimeShort;
        changesDetails.push(`‚è∞ ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅ ÿ®ÿ≥ÿ®ÿ® ÿßŸÑÿπÿ∑ŸÑ: ${sysTimeShort}`);
    }
}

                if(oldData.pressure != newPressure) changesDetails.push(`ÿßŸÑÿ∂ÿ∫ÿ∑: ${oldData.pressure} -> ${newPressure}`);
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑
                if(oldData.maxPressure != newMaxPressure) {
                    changesDetails.push(`ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑: ${oldData.maxPressure || '8.0'} -> ${newMaxPressure}`);
                }
                
                let consumptionLogData = null;
                const oldCons = oldData.consumption || {};
                if (consTrans1 || consTrans2 || consWater) {
                    if (consTrans1 != oldCons.t1 || consTrans2 != oldCons.t2 || consWater != oldCons.m3) {
                        changesDetails.push('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉÿßÿ™');
                    }
                    consumptionLogData = {
                        date: updateDate, 
                        time: updateTime, 
                        station: sName,
                        t1: consTrans1, 
                        t2: consTrans2, 
                        m3: consWater,
                        operator: newOperator
                    };
                }

                if (oldData.operatorName !== newOperator) {
                    changesDetails.push(`ÿßŸÑŸÖÿ¥ÿ∫ŸÑ: ${oldData.operatorName || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸëŸÅ'} -> ${newOperator}`);
                }
                
                const changesString = changesDetails.length > 0 ? changesDetails.join(', ') : "ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä";
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸàŸÇŸäÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ŸàÿßŸÑÿ•ŸäŸÇÿßŸÅ ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ¨ŸÑ
                const logDetails = [];
                if (changesString !== "ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä") {
                    logDetails.push(changesString);
                }
                if (newStartTime && oldData.startTime !== newStartTime) {
                    logDetails.push(`ŸàŸÇÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ: ${oldData.startTime || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} -> ${newStartTime}`);
                }
                if (newStopTime && oldData.stopTime !== newStopTime) {
                    logDetails.push(`ŸàŸÇÿ™ ÿßŸÑÿ•ŸäŸÇÿßŸÅ: ${oldData.stopTime || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} -> ${newStopTime}`);
                }
                
                const finalLogDetails = logDetails.length > 0 ? logDetails.join(', ') : "ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä";
                
                const log = { 
                    date: updateDate, 
                    time: updateTime, 
                    station: sName, 
                    operator: newOperator,
                    details: finalLogDetails,
                    startTime: newStartTime || oldData.startTime || '',
                    stopTime: newStopTime || oldData.stopTime || ''
                };
                
                const updates = {
                    pressure: newPressure, 
                    waterFlow: newFlow, 
                    voltage: newVoltage,
                    systemMode: newMode, 
                    operatorName: newOperator,
                    comments: newComments,
                    lastUpdate: stationFullDateTime, 
                    startTime: newStartTime, 
                    stopTime: newStopTime, 
                    activePumps: activeCount,
                    status: currentStatus, 
                    currentFault: finalFault, 
                    fault1Desc: finalFaultDesc,
                    secondaryFault: finalFaultSec, 
                    fault2Desc: finalFaultSecDesc,
                    faultStartTime: faultStartTime,
                    pumps: updatedPumps,
                    maxPressure: newMaxPressure, // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´
                    consumption: { 
                        t1: consTrans1, 
                        t2: consTrans2, 
                        m3: consWater, 
                        lastUpdate: stationFullDateTime 
                    }
                };
                
                Object.assign(appData.stations[sName], updates);
                localStorage.setItem('toshka_stations_cache', JSON.stringify(appData.stations));
                
                if (navigator.onLine) {
                    db.ref('stations/' + sName).update(updates).then(() => {
                        if (appData.operationHistory.length >= 20000) db.ref('history').orderByKey().limitToFirst(1).once('child_added', (snapshot) => { snapshot.ref.remove(); });
                        db.ref('history').push(log);
                        if(consumptionLogData) db.ref('consumption_logs').push(consumptionLogData);
                        if (newFaultEntries.length > 0 || resolvedFaultEntries.length > 0) {
                            db.ref('faults_log').once('value').then(snap => {
                                let rawVal = snap.val(); 
                                let logs = []; 
                                if (rawVal) { 
                                    if (Array.isArray(rawVal)) logs = rawVal; 
                                    else logs = Object.values(rawVal); 
                                }
                                newFaultEntries.forEach(newF => { 
                                    const exists = logs.some(existingF => existingF.active === true && existingF.station === newF.station && existingF.type === newF.type); 
                                    if (!exists) logs.unshift(newF);
                                });
                                resolvedFaultEntries.forEach(rf => { 
                                    const index = logs.findIndex(f => f.station === sName && f.type === rf.type && f.active === true); 
                                    if (index !== -1) { 
                                        logs[index].active = false; 
                                        logs[index].endTime = stationFullDateTime; 
                                    } else { 
                                        logs.unshift(rf); 
                                    } 
                                });
                                if (logs.length > 20000) logs = logs.slice(0, 20000); 
                                db.ref('faults_log').set(logs);
                            });
                        }
                        showSuccessFeedback(sName);
                    }).catch(err => { alert("ÿÆÿ∑ÿ£ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: " + err.message); });
                } else {
                    addToOfflineQueue('update_station', { 
                        stationId: sName, 
                        updates: updates, 
                        log: log, 
                        consLog: consumptionLogData, 
                        newFaults: newFaultEntries, 
                        resolvedFaults: resolvedFaultEntries 
                    });
                    showSuccessFeedback(sName, true);
                }
            } catch (e) { 
                console.error(e);
                alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿ±ŸÖÿ¨Ÿä: " + e.message); 
            }
        }

        function showSuccessFeedback(sName, isOffline = false) {
            const alertDiv = document.getElementById('operator-alert');
            alertDiv.textContent = isOffline ? 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ¨Ÿáÿßÿ≤ (ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ) ‚è≥' : 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©! ‚úÖ';
            alertDiv.className = isOffline ? 'alert alert-warning' : 'alert alert-success';
            alertDiv.style.display = 'block';
            setTimeout(() => { 
                alertDiv.style.display = 'none'; 
                showStationDetails(sName); 
            }, 1500);
        }

        function cleanHistoricalData() {
            if (appData.operationHistory && appData.operationHistory.length > 0) {
                appData.operationHistory = appData.operationHistory.map(log => {
                    if (!log.operator || log.operator === 'undefined') {
                        return { ...log, operator: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ' };
                    }
                    return log;
                });
            }
        }

        // --- MOBILE OPTIMIZED INSPECTION LOGIC ---
        function renderInspection(mode = 'view') {
            const container = document.getElementById('inspection-container');
            container.innerHTML = '';
            const sName = appData.currentStation;
            const sData = appData.stations[sName];
            if(!sData) return;
            const insData = sData.inspectionData || {};
            const isEdit = (mode === 'edit');
            const saveBtn = document.getElementById('inspection-actions');
            saveBtn.style.display = isEdit ? 'block' : 'none';
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ≤ÿ± ÿ™ÿµÿØŸäÿ± Excel ŸÅŸÇÿ∑ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂ ŸàŸÑŸäÿ≥ ÿßŸÑÿ™ÿπÿØŸäŸÑ
            const exportBtn = document.getElementById('export-inspection-excel');
            exportBtn.style.display = (mode === 'view' && sData.inspectionData) ? 'block' : 'none';
            
            Object.keys(inspectionSchema).forEach((key) => {
                const schema = inspectionSchema[key];
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-accordion';
                let title = schema.title;
                if (key === 'pumps') { 
                    const totalPumps = sData.pumps ? sData.pumps.length : 4; 
                    title += ` (${totalPumps})`; 
                }
                const headerDiv = document.createElement('div');
                if (isEdit) { 
                    headerDiv.className = 'section-header-static'; 
                    headerDiv.innerHTML = `<span>${title}</span>`; 
                } 
                else {
                    headerDiv.className = 'section-accordion-header'; 
                    headerDiv.innerHTML = `<span>${title}</span> <span class="arrow">‚ñº</span>`;
                    headerDiv.onclick = function() { 
                        const body = this.nextElementSibling; 
                        body.classList.toggle('open'); 
                        this.classList.toggle('active'); 
                    };
                }
                const bodyDiv = document.createElement('div');
                if (isEdit) bodyDiv.className = 'section-body-static'; 
                else { 
                    bodyDiv.className = 'section-accordion-body'; 
                    bodyDiv.id = `section-body-${key}`;
                }
                
                if (key === 'pumps') {
                    const totalPumps = sData.pumps ? sData.pumps.length : 4; 
                    const pumpsInsData = insData.pumps || {};
                    for (let i = 1; i <= totalPumps; i++) {
                        const pData = pumpsInsData[i] || {};
                        let headerClass = 'pump-header-green'; 
                        let icon = '‚úÖ'; 
                        const criticalIndices = [1, 5, 10, 11, 12];
                        let isRed = false; 
                        let isYellow = false;
                        schema.items.forEach((item, idx) => { 
                            const status = pData[idx] ? pData[idx].status : 'efficient'; 
                            if (criticalIndices.includes(idx)) { 
                                if (status === 'broken') isRed = true; 
                            } 
                            if (status === 'fault') isYellow = true; 
                        });
                        if (isRed) { 
                            headerClass = 'pump-header-red'; 
                            icon = 'üõë'; 
                        } else if (isYellow) { 
                            headerClass = 'pump-header-yellow'; 
                            icon = '‚ö†Ô∏è';
                        }
                        const pumpItemDiv = document.createElement('div');
                        pumpItemDiv.className = 'pump-accordion-item';
                        const pumpHeaderDiv = document.createElement('div'); 
                        pumpHeaderDiv.className = `pump-accordion-header ${headerClass}`; 
                        pumpHeaderDiv.innerHTML = `<span>ŸÖÿ∂ÿÆÿ© ÿ±ŸÇŸÖ ${i}</span> <span class="icon-state">${icon}</span>`;
                        pumpHeaderDiv.onclick = (e) => { 
                            e.stopPropagation(); 
                            togglePumpAccordion(i); 
                        };
                        const pumpBodyDiv = document.createElement('div'); 
                        pumpBodyDiv.className = 'pump-accordion-body'; 
                        pumpBodyDiv.id = `pump-body-${i}`;
                        schema.items.forEach((item, idx) => {
                            if (idx === 0) { 
                                const subHeader = document.createElement('div'); 
                                subHeader.className = 'pump-section-divider'; 
                                subHeader.textContent = '1- ÿÆÿ∑ ÿßŸÑÿ≥ÿ≠ÿ®'; 
                                pumpBodyDiv.appendChild(subHeader); 
                            } 
                            else if (idx === 5) { 
                                const subHeader = document.createElement('div'); 
                                subHeader.className = 'pump-section-divider'; 
                                subHeader.textContent = '2- ÿßŸÑŸÖÿ∂ÿÆÿ©'; 
                                pumpBodyDiv.appendChild(subHeader); 
                            } 
                            else if (idx === 6) { 
                                const subHeader = document.createElement('div'); 
                                subHeader.className = 'pump-section-divider'; 
                                subHeader.textContent = '3- ÿÆÿ∑ ÿßŸÑÿ∑ÿ±ÿØ'; 
                                pumpBodyDiv.appendChild(subHeader); 
                            }
                            pumpBodyDiv.appendChild(createInspectionRow(idx, item, pData[idx] || {}, `pumps_${i}`, isEdit));
                        });
                        pumpItemDiv.appendChild(pumpHeaderDiv); 
                        pumpItemDiv.appendChild(pumpBodyDiv); 
                        bodyDiv.appendChild(pumpItemDiv);
                    }
                } else {
                    const sectionData = insData[key] || {};
                    schema.items.forEach((item, idx) => { 
                        bodyDiv.appendChild(createInspectionRow(idx, item, sectionData[idx] || {}, key, isEdit)); 
                    });
                }
                sectionDiv.appendChild(headerDiv); 
                sectionDiv.appendChild(bodyDiv); 
                container.appendChild(sectionDiv);
            });
        }

        function createInspectionRow(itemKey, label, dataObj, prefix, isEdit) {
            const row = document.createElement('div');
            row.className = 'inspection-row';
            const savedStatus = dataObj && dataObj.status ? dataObj.status : 'efficient'; 
            const savedDesc = dataObj && dataObj.desc ? dataObj.desc : ''; 
            const inputId = `${prefix}_${itemKey}`;
            let optionsHtml = '';
            statusOptions.forEach(opt => { 
                const isSel = savedStatus === opt.val ? 'selected' : ''; 
                optionsHtml += `<option value="${opt.val}" ${isSel}>${opt.text}</option>`; 
            });
            let selectHtml = `<select class="inspection-status-select ${savedStatus}" id="stat_${inputId}" ${isEdit ? '' : 'disabled'} onchange="updateInspectionColor(this)">${optionsHtml}</select>`;
            let descHtml = `<input type="text" class="inspection-desc-input" id="desc_${inputId}" value="${savedDesc}" placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™..." ${isEdit ? '' : 'readonly'}>`;
            row.innerHTML = `<div class="inspection-label">${label}</div><div>${selectHtml}</div><div>${descHtml}</div>`; 
            return row;
        }
        
        window.togglePumpAccordion = (id) => { 
            const target = document.getElementById(`pump-body-${id}`);
            const allPumpBodies = document.querySelectorAll('.pump-accordion-body'); 
            allPumpBodies.forEach(b => { 
                if(b !== target) b.classList.remove('open'); 
            }); 
            target.classList.toggle('open'); 
        };
        
        window.updateInspectionColor = (selectElem) => { 
            selectElem.classList.remove('efficient', 'fault', 'broken', 'none'); 
            selectElem.classList.add(selectElem.value); 
        };
        
        document.getElementById('save-inspection-btn').addEventListener('click', () => {
            const sName = appData.currentStation; 
            if(!sName) return;
            const oldInsData = (appData.stations[sName].inspectionData) || {}; 
            let newInsData = JSON.parse(JSON.stringify(oldInsData));
            
            Object.keys(inspectionSchema).forEach(key => {
                if (key === 'pumps') return; 
                if (!newInsData[key]) newInsData[key] = {};
                inspectionSchema[key].items.forEach((item, idx) => { 
                    const statEl = document.getElementById(`stat_${key}_${idx}`); 
                    const descEl = document.getElementById(`desc_${key}_${idx}`); 
                    if (statEl) { 
                        newInsData[key][idx] = { 
                            status: statEl.value, 
                            desc: descEl.value 
                        }; 
                    } 
                });
            });
            
            if (!newInsData.pumps) newInsData.pumps = {}; 
            const totalPumps = appData.stations[sName].pumps ? appData.stations[sName].pumps.length : 4;
            for(let i=1; i<=totalPumps; i++) {
                if (!newInsData.pumps[i]) newInsData.pumps[i] = {};
                inspectionSchema.pumps.items.forEach((item, idx) => { 
                    const prefix = `pumps_${i}`; 
                    const statEl = document.getElementById(`stat_${prefix}_${idx}`); 
                    const descEl = document.getElementById(`desc_${prefix}_${idx}`); 
                    if (statEl) { 
                        newInsData.pumps[i][idx] = { 
                            status: statEl.value, 
                            desc: descEl.value 
                        }; 
                    } 
                });
            }
            
            const nowStd = getStandardDateTime();
            const log = { 
                date: nowStd.date, 
                time: nowStd.time, 
                station: sName, 
                operator: appData.currentUser ? (appData.currentUser.username || appData.currentUser.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ') : 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ',
                details: `ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ` 
            };
            
            if (!appData.stations[sName].inspectionData) appData.stations[sName].inspectionData = {}; 
            appData.stations[sName].inspectionData = newInsData; 
            localStorage.setItem('toshka_stations_cache', JSON.stringify(appData.stations));
            
            if (navigator.onLine) { 
                db.ref(`stations/${sName}/inspectionData`).update(newInsData).then(() => { 
                    db.ref('history').push(log); 
                    alert("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ"); 
                    renderInspection('edit'); 
                });
            } 
            else { 
                addToOfflineQueue('update_inspection', { 
                    stationId: sName, 
                    inspectionData: newInsData, 
                    log: log 
                });
                alert("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿ≠ÿµ ŸÅŸä ÿßŸÑÿ¨Ÿáÿßÿ≤ (Offline) Ÿàÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπŸá ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ ‚è≥"); 
                renderInspection('edit');
            }
        });
        
        document.getElementById('view-inspection-btn').addEventListener('click', () => { 
            renderInspection('view'); 
            document.getElementById('inspection-title').textContent = `ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÅÿ≠ÿµ: ${appData.stations[appData.currentStation].name}`; 
            showScreen('inspection'); 
        });
        
        document.getElementById('edit-inspection-btn').addEventListener('click', () => { 
            renderInspection('edit'); 
            document.getElementById('inspection-title').textContent = `ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÅÿ≠ÿµ: ${appData.stations[appData.currentStation].name}`; 
            showScreen('inspection'); 
        });

        // --- ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ÿ•ŸÑŸâ Excel ---
        document.getElementById('export-inspection-excel').addEventListener('click', function() {
            const sName = appData.currentStation;
            const sData = appData.stations[sName];
            
            if (!sData || !sData.inspectionData) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅÿ≠ÿµ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ≠ÿ∑ÿ©');
                return;
            }
            
            exportSingleStationInspection(sName, sData);
        });
        
        function exportSingleStationInspection(stationName, stationData) {
            const inspectionData = stationData.inspectionData || {};
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ar-EG', { hour12: false });
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±
            let data = [];
            
            // ÿ±ÿ£ÿ≥ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
            data.push(["ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©", stationName]);
            data.push(["ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±", `${dateStr} ${timeStr}`]);
            data.push(["ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©", stationData.lastUpdate || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"]);
            data.push(["ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©", stationData.status || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"]);
            data.push(["ÿßŸÑŸÖÿ¥ÿ∫ŸÑ", stationData.operatorName || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"]);
            data.push([]); // ÿ≥ÿ∑ÿ± ŸÅÿßÿ±ÿ∫
            
            // ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
            data.push(["ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©", "", "", ""]);
            data.push(["ÿßŸÑÿ¨ŸáÿØ ÿßŸÑŸÉŸáÿ±ÿ®Ÿä", `${stationData.voltage || 0} V`, "ÿßŸÑÿ∂ÿ∫ÿ∑", `${stationData.pressure || 0} Bar`]);
            data.push(["ÿßŸÑÿ™ÿØŸÅŸÇ", `${stationData.waterFlow || 0} L/Sec`, "ÿßŸÑŸÜÿ∏ÿßŸÖ", stationData.systemMode || "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ"]);
            data.push(["ÿßŸÑŸÖÿ∂ÿÆÿßÿ™ ÿßŸÑÿπÿßŸÖŸÑÿ©", stationData.activePumps || 0, "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", stationData.pumps ? stationData.pumps.length : 0]);
            data.push(["ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ŸÖÿ≥ŸÖŸàÿ≠", `${stationData.maxPressure || 8.0} Bar`, "", ""]);
            data.push([]);
            
            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ
            data.push(["ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ", "", "", ""]);
            data.push(["ÿßŸÑŸÇÿ≥ŸÖ", "ÿßŸÑŸÖŸÉŸàŸÜ", "ÿßŸÑÿ≠ÿßŸÑÿ©", "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™"]);
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ ŸÖŸÜ ŸÉŸÑ ŸÇÿ≥ŸÖ
            Object.keys(inspectionSchema).forEach(key => {
                if (key === 'pumps') return; // ÿ≥ŸÜÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™ ŸÑÿßÿ≠ŸÇÿßŸã
                
                const schema = inspectionSchema[key];
                const sectionData = inspectionData[key] || {};
                
                data.push([schema.title, "", "", ""]);
                
                schema.items.forEach((item, idx) => {
                    const itemData = sectionData[idx] || {};
                    const status = statusTextMap[itemData.status] || "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";
                    const desc = itemData.desc || "";
                    data.push(["", item, status, desc]);
                });
                
                data.push([]);
            });
            
            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™
            if (inspectionData.pumps && stationData.pumps) {
                data.push(["ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", "", "", ""]);
                
                for (let i = 1; i <= stationData.pumps.length; i++) {
                    const pumpData = inspectionData.pumps[i] || {};
                    data.push([`ŸÖÿ∂ÿÆÿ© ÿ±ŸÇŸÖ ${i}`, "", "", ""]);
                    
                    // ÿ™ÿ≠ÿØŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ∂ÿÆÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    let pumpStatus = "‚úÖ ŸäÿπŸÖŸÑ ÿ®ŸÉŸÅÿßÿ°ÿ©";
                    const criticalIndices = [1, 5, 10, 11, 12];
                    let hasCriticalFault = false;
                    let hasFault = false;
                    
                    inspectionSchema.pumps.items.forEach((item, idx) => {
                        const itemData = pumpData[idx] || {};
                        if (itemData.status === 'broken' && criticalIndices.includes(idx)) {
                            hasCriticalFault = true;
                        } else if (itemData.status === 'fault') {
                            hasFault = true;
                        }
                    });
                    
                    if (hasCriticalFault) {
                        pumpStatus = "üõë ŸÑÿß ŸäÿπŸÖŸÑ (ÿπÿ∑ŸÑ ÿ≠ÿ±ÿ¨)";
                    } else if (hasFault) {
                        pumpStatus = "‚ö†Ô∏è Ÿäÿ≠ÿ™ÿßÿ¨ ÿµŸäÿßŸÜÿ©";
                    }
                    
                    data.push(["", "ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©", pumpStatus, ""]);
                    
                    // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ŸÉŸÑ ŸÖŸÉŸàŸÜ ŸÅŸä ÿßŸÑŸÖÿ∂ÿÆÿ©
                    inspectionSchema.pumps.items.forEach((item, idx) => {
                        const itemData = pumpData[idx] || {};
                        const status = statusTextMap[itemData.status] || "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";
                        const desc = itemData.desc || "";
                        data.push(["", item, status, desc]);
                    });
                    
                    data.push([]);
                }
            }
            
            // ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ¨ŸÑÿ©
            if (stationData.currentFault || stationData.secondaryFault) {
                data.push(["ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ¨ŸÑÿ©", "", "", ""]);
                if (stationData.currentFault) {
                    data.push(["", "ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä", stationData.currentFault, stationData.fault1Desc || ""]);
                }
                if (stationData.secondaryFault) {
                    data.push(["", "ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ´ÿßŸÜŸàŸä", stationData.secondaryFault, stationData.fault2Desc || ""]);
                }
                data.push([]);
            }
            
            // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
            if (stationData.comments) {
                data.push(["ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ", "", "", ""]);
                data.push(["", stationData.comments, "", ""]);
            }
            
            // ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿ±ŸÇÿ© ÿßŸÑÿπŸÖŸÑ
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿπŸÖÿØÿ©
            const wscols = [
                { wch: 20 }, // ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ£ŸàŸÑ
                { wch: 25 }, // ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ´ÿßŸÜŸä
                { wch: 20 }, // ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ´ÿßŸÑÿ´
                { wch: 40 }  // ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ±ÿßÿ®ÿπ
            ];
            ws['!cols'] = wscols;
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿµŸÜŸÅ
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ");
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ
            const fileName = `ÿ™ŸÇÿ±Ÿäÿ±_ŸÅÿ≠ÿµ_${stationName}_${dateStr}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ŸÑŸÑŸÖÿ≠ÿ∑ÿ© ${stationName} ÿ®ŸÜÿ¨ÿßÿ≠!`);
        }
        
        // --- ÿ¥ÿßÿ¥ÿ© ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ---
        function updateExportFilters() {
            const zoneSelect = document.getElementById('export-filter-zone');
            const stationSelect = document.getElementById('export-filter-station');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
            if (zoneSelect.options.length <= 1) {
                zoneSelect.innerHTML = '<option value="all">ŸÉŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';
                appData.zones.forEach(z => zoneSelect.innerHTML += `<option value="${z}">${z}</option>`);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™
            stationSelect.innerHTML = '<option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option>';
            const sortedStations = Object.values(appData.stations).sort((a, b) => a.name.localeCompare(b.name));
            sortedStations.forEach(station => {
                stationSelect.innerHTML += `<option value="${station.name}">${station.name}</option>`;
            });
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿØÿ´ ÿ™ÿ∫ŸäŸäÿ± ŸÑŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™
            zoneSelect.onchange = function() {
                const selectedZone = this.value;
                stationSelect.innerHTML = '<option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option>';
                
                let filteredStations = sortedStations;
                if (selectedZone !== 'all') {
                    filteredStations = sortedStations.filter(s => s.zone === selectedZone);
                }
                
                filteredStations.forEach(station => {
                    stationSelect.innerHTML += `<option value="${station.name}">${station.name}</option>`;
                });
            };
        }
        
        document.getElementById('generate-inspection-report').addEventListener('click', function() {
            const zoneFilter = document.getElementById('export-filter-zone').value;
            const stationFilter = document.getElementById('export-filter-station').value;
            const reportType = document.getElementById('export-report-type').value;
            const fileFormat = document.getElementById('export-file-format').value;
            
            const exportStatus = document.getElementById('export-status');
            exportStatus.style.display = 'block';
            exportStatus.innerHTML = '<div style="color: var(--excel-color);">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±...</div>';
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™
            let stationsToExport = Object.values(appData.stations);
            
            if (zoneFilter !== 'all') {
                stationsToExport = stationsToExport.filter(s => s.zone === zoneFilter);
            }
            
            if (stationFilter !== 'all') {
                stationsToExport = stationsToExport.filter(s => s.name === stationFilter);
            }
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑÿØŸäŸáÿß ÿ®ŸäÿßŸÜÿßÿ™ ŸÅÿ≠ÿµ
            stationsToExport = stationsToExport.filter(s => s.inspectionData);
            
            if (stationsToExport.length === 0) {
                exportStatus.innerHTML = '<div style="color: var(--danger-color);">‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿ∑ÿßÿ™ ÿ®ÿ®ŸäÿßŸÜÿßÿ™ ŸÅÿ≠ÿµ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑŸÅŸÑÿ™ÿ±</div>';
                return;
            }
            
            setTimeout(() => {
                if (fileFormat === 'excel') {
                    exportInspectionReportExcel(stationsToExport, reportType);
                } else {
                    exportInspectionReportCSV(stationsToExport, reportType);
                }
                
                exportStatus.innerHTML = `<div style="color: var(--success-color);">‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${stationsToExport.length} ŸÖÿ≠ÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!</div>`;
            }, 1000);
        });
        
        function exportInspectionReportExcel(stations, reportType) {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ar-EG', { hour12: false });
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿµŸÜŸÅ ÿ¨ÿØŸäÿØ
            const wb = XLSX.utils.book_new();
            
            if (reportType === 'summary') {
                // Ÿàÿ±ŸÇÿ© ÿßŸÑŸÖŸÑÿÆÿµ
                let summaryData = [
                    ["ŸÖŸÑÿÆÿµ ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ"],
                    [`ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${dateStr} ${timeStr}`],
                    [`ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™: ${stations.length}`],
                    [],
                    ["ÿßŸÑŸÖÿ≠ÿ∑ÿ©", "ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©", "ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©", "ÿßŸÑŸÖÿ¥ÿ∫ŸÑ", "ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´", "ÿπÿØÿØ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", "ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑", "ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ≠ÿµ"]
                ];
                
                stations.forEach(station => {
                    const hasInspection = station.inspectionData ? "‚úÖ ŸÖŸàÿ¨ŸàÿØ" : "‚ùå ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ";
                    const pumpCount = station.pumps ? station.pumps.length : 0;
                    summaryData.push([
                        station.name,
                        station.zone,
                        station.status,
                        station.operatorName,
                        station.lastUpdate,
                        pumpCount,
                        station.maxPressure || "8.0",
                        hasInspection
                    ]);
                });
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                const summaryCols = [
                    { wch: 15 }, { wch: 15 }, { wch: 15 }, 
                    { wch: 20 }, { wch: 20 }, { wch: 15 }, 
                    { wch: 15 }, { wch: 15 }
                ];
                wsSummary['!cols'] = summaryCols;
                XLSX.utils.book_append_sheet(wb, wsSummary, "ŸÖŸÑÿÆÿµ");
                
                // ÿ•ÿ∂ÿßŸÅÿ© Ÿàÿ±ŸÇÿ© ŸÑŸÉŸÑ ŸÖÿ≠ÿ∑ÿ©
                stations.forEach((station, index) => {
                    if (index < 10) { // ÿ≠ÿØ ÿ£ŸÇÿµŸâ 10 ÿ£Ÿàÿ±ÿßŸÇ
                        const stationData = generateStationInspectionData(station, reportType);
                        const wsStation = XLSX.utils.aoa_to_sheet(stationData);
                        const stationCols = [
                            { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 40 }
                        ];
                        wsStation['!cols'] = stationCols;
                        // ÿ™ŸÇÿµŸäÿ± ÿßÿ≥ŸÖ ÿßŸÑŸàÿ±ŸÇÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∑ŸàŸäŸÑÿßŸã
                        const sheetName = station.name.length > 31 ? station.name.substring(0, 31) : station.name;
                        XLSX.utils.book_append_sheet(wb, wsStation, sheetName);
                    }
                });
                
            } else if (reportType === 'faults') {
                // ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ŸÅŸÇÿ∑
                let faultsData = [
                    ["ÿ™ŸÇÿ±Ÿäÿ± ÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™"],
                    [`ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${dateStr} ${timeStr}`],
                    [],
                    ["ÿßŸÑŸÖÿ≠ÿ∑ÿ©", "ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©", "ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä", "ŸàÿµŸÅ ÿßŸÑÿπÿ∑ŸÑ", "ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ´ÿßŸÜŸàŸä", "ŸàÿµŸÅ ÿßŸÑÿπÿ∑ŸÑ", "ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑÿπÿ∑ŸÑ", "ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©", "ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≠ÿßŸÑŸä", "ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑"]
                ];
                
                stations.forEach(station => {
                    if (station.currentFault || station.secondaryFault) {
                        faultsData.push([
                            station.name,
                            station.zone,
                            station.currentFault || "",
                            station.fault1Desc || "",
                            station.secondaryFault || "",
                            station.fault2Desc || "",
                            station.faultStartTime || "",
                            station.status,
                            station.pressure || "0",
                            station.maxPressure || "8.0"
                        ]);
                    }
                });
                
                const wsFaults = XLSX.utils.aoa_to_sheet(faultsData);
                const faultsCols = [
                    { wch: 15 }, { wch: 15 }, { wch: 25 }, 
                    { wch: 30 }, { wch: 25 }, { wch: 30 }, 
                    { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
                ];
                wsFaults['!cols'] = faultsCols;
                XLSX.utils.book_append_sheet(wb, wsFaults, "ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ");
                
            } else {
                // ÿ™ŸÇÿ±Ÿäÿ± ŸÉÿßŸÖŸÑ - Ÿàÿ±ŸÇÿ© Ÿàÿßÿ≠ÿØÿ© ŸÑŸÉŸÑ ŸÖÿ≠ÿ∑ÿ©
                stations.forEach((station, index) => {
                    if (index < 15) { // ÿ≠ÿØ ÿ£ŸÇÿµŸâ 15 ŸÖÿ≠ÿ∑ÿ© ŸÅŸä ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸÑ
                        const stationData = generateStationInspectionData(station, reportType);
                        const wsStation = XLSX.utils.aoa_to_sheet(stationData);
                        const stationCols = [
                            { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 40 }
                        ];
                        wsStation['!cols'] = stationCols;
                        // ÿ™ŸÇÿµŸäÿ± ÿßÿ≥ŸÖ ÿßŸÑŸàÿ±ŸÇÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∑ŸàŸäŸÑÿßŸã
                        const sheetName = station.name.length > 31 ? station.name.substring(0, 31) : station.name;
                        XLSX.utils.book_append_sheet(wb, wsStation, sheetName);
                    }
                });
            }
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ
            const fileName = `ÿ™ŸÇÿ±Ÿäÿ±_ŸÅÿ≠ÿµ_${reportType}_${dateStr}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function exportInspectionReportCSV(stations, reportType) {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            if (reportType === 'summary') {
                csvContent += "ÿßŸÑŸÖÿ≠ÿ∑ÿ©,ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©,ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©,ÿßŸÑŸÖÿ¥ÿ∫ŸÑ,ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´,ÿπÿØÿØ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™,ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑,ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ≠ÿµ\n";
                
                stations.forEach(station => {
                    const hasInspection = station.inspectionData ? "ŸÖŸàÿ¨ŸàÿØ" : "ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ";
                    const pumpCount = station.pumps ? station.pumps.length : 0;
                    csvContent += `"${station.name}","${station.zone}","${station.status}","${station.operatorName}","${station.lastUpdate}",${pumpCount},"${station.maxPressure || '8.0'}","${hasInspection}"\n`;
                });
                
            } else if (reportType === 'faults') {
                csvContent += "ÿßŸÑŸÖÿ≠ÿ∑ÿ©,ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©,ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä,ŸàÿµŸÅ ÿßŸÑÿπÿ∑ŸÑ,ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ´ÿßŸÜŸàŸä,ŸàÿµŸÅ ÿßŸÑÿπÿ∑ŸÑ,ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑÿπÿ∑ŸÑ,ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©,ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≠ÿßŸÑŸä,ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑\n";
                
                stations.forEach(station => {
                    if (station.currentFault || station.secondaryFault) {
                        csvContent += `"${station.name}","${station.zone}","${station.currentFault || ''}","${station.fault1Desc || ''}","${station.secondaryFault || ''}","${station.fault2Desc || ''}","${station.faultStartTime || ''}","${station.status}","${station.pressure || '0'}","${station.maxPressure || '8.0'}"\n`;
                    }
                });
                
            } else {
                // ÿ™ŸÇÿ±Ÿäÿ± ŸÉÿßŸÖŸÑ
                csvContent += "ÿßŸÑŸÖÿ≠ÿ∑ÿ©,ÿßŸÑŸÇÿ≥ŸÖ,ÿßŸÑŸÖŸÉŸàŸÜ,ÿßŸÑÿ≠ÿßŸÑÿ©,ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™\n";
                
                stations.forEach(station => {
                    const inspectionData = station.inspectionData || {};
                    
                    Object.keys(inspectionSchema).forEach(key => {
                        if (key === 'pumps') return;
                        
                        const schema = inspectionSchema[key];
                        const sectionData = inspectionData[key] || {};
                        
                        schema.items.forEach((item, idx) => {
                            const itemData = sectionData[idx] || {};
                            const status = statusTextMap[itemData.status] || "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";
                            const desc = itemData.desc || "";
                            csvContent += `"${station.name}","${schema.title}","${item}","${status}","${desc}"\n`;
                        });
                    });
                    
                    // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™
                    if (inspectionData.pumps && station.pumps) {
                        for (let i = 1; i <= station.pumps.length; i++) {
                            const pumpData = inspectionData.pumps[i] || {};
                            
                            inspectionSchema.pumps.items.forEach((item, idx) => {
                                const itemData = pumpData[idx] || {};
                                const status = statusTextMap[itemData.status] || "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";
                                const desc = itemData.desc || "";
                                csvContent += `"${station.name}","ŸÖÿ∂ÿÆÿ© ${i}","${item}","${status}","${desc}"\n`;
                            });
                        }
                    }
                });
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ÿ™ŸÇÿ±Ÿäÿ±_ŸÅÿ≠ÿµ_${reportType}_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function generateStationInspectionData(station, reportType) {
            const inspectionData = station.inspectionData || {};
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ar-EG', { hour12: false });
            
            let data = [];
            
            // ÿ±ÿ£ÿ≥ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
            data.push(["ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©", station.name]);
            data.push(["ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©", station.zone]);
            data.push(["ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±", `${dateStr} ${timeStr}`]);
            data.push(["ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©", station.lastUpdate || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"]);
            data.push(["ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©", station.status || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"]);
            data.push(["ÿßŸÑŸÖÿ¥ÿ∫ŸÑ", station.operatorName || "ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±"]);
            data.push(["ÿßŸÇÿµŸâ ÿ∂ÿ∫ÿ∑ ŸÖÿ≥ŸÖŸàÿ≠", station.maxPressure || "8.0"]);
            data.push([]);
            
            if (reportType === 'full') {
                // ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
                data.push(["ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©", "", "", ""]);
                data.push(["ÿßŸÑÿ¨ŸáÿØ ÿßŸÑŸÉŸáÿ±ÿ®Ÿä", `${station.voltage || 0} V`, "ÿßŸÑÿ∂ÿ∫ÿ∑", `${station.pressure || 0} Bar`]);
                data.push(["ÿßŸÑÿ™ÿØŸÅŸÇ", `${station.waterFlow || 0} L/Sec`, "ÿßŸÑŸÜÿ∏ÿßŸÖ", station.systemMode || "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ"]);
                data.push(["ÿßŸÑŸÖÿ∂ÿÆÿßÿ™ ÿßŸÑÿπÿßŸÖŸÑÿ©", station.activePumps || 0, "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", station.pumps ? station.pumps.length : 0]);
                data.push([]);
                
                // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ
                data.push(["ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ¥ÿßŸÖŸÑ", "", "", ""]);
                data.push(["ÿßŸÑŸÇÿ≥ŸÖ", "ÿßŸÑŸÖŸÉŸàŸÜ", "ÿßŸÑÿ≠ÿßŸÑÿ©", "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™"]);
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ≠ÿµ ŸÖŸÜ ŸÉŸÑ ŸÇÿ≥ŸÖ
                Object.keys(inspectionSchema).forEach(key => {
                    if (key === 'pumps') return;
                    
                    const schema = inspectionSchema[key];
                    const sectionData = inspectionData[key] || {};
                    
                    data.push([schema.title, "", "", ""]);
                    
                    schema.items.forEach((item, idx) => {
                        const itemData = sectionData[idx] || {};
                        const status = statusTextMap[itemData.status] || "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";
                        const desc = itemData.desc || "";
                        data.push(["", item, status, desc]);
                    });
                    
                    data.push([]);
                });
                
                // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™
                if (inspectionData.pumps && station.pumps) {
                    data.push(["ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∂ÿÆÿßÿ™", "", "", ""]);
                    
                    for (let i = 1; i <= station.pumps.length; i++) {
                        const pumpData = inspectionData.pumps[i] || {};
                        data.push([`ŸÖÿ∂ÿÆÿ© ÿ±ŸÇŸÖ ${i}`, "", "", ""]);
                        
                        // ÿ™ÿ≠ÿØŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ∂ÿÆÿ©
                        let pumpStatus = "‚úÖ ŸäÿπŸÖŸÑ ÿ®ŸÉŸÅÿßÿ°ÿ©";
                        const criticalIndices = [1, 5, 10, 11, 12];
                        let hasCriticalFault = false;
                        let hasFault = false;
                        
                        inspectionSchema.pumps.items.forEach((item, idx) => {
                            const itemData = pumpData[idx] || {};
                            if (itemData.status === 'broken' && criticalIndices.includes(idx)) {
                                hasCriticalFault = true;
                            } else if (itemData.status === 'fault') {
                                hasFault = true;
                            }
                        });
                        
                        if (hasCriticalFault) {
                            pumpStatus = "üõë ŸÑÿß ŸäÿπŸÖŸÑ (ÿπÿ∑ŸÑ ÿ≠ÿ±ÿ¨)";
                        } else if (hasFault) {
                            pumpStatus = "‚ö†Ô∏è Ÿäÿ≠ÿ™ÿßÿ¨ ÿµŸäÿßŸÜÿ©";
                        }
                        
                        data.push(["", "ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©", pumpStatus, ""]);
                        
                        inspectionSchema.pumps.items.forEach((item, idx) => {
                            const itemData = pumpData[idx] || {};
                            const status = statusTextMap[itemData.status] || "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ";
                            const desc = itemData.desc || "";
                            data.push(["", item, status, desc]);
                        });
                        
                        data.push([]);
                    }
                }
                
                // ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ¨ŸÑÿ©
                if (station.currentFault || station.secondaryFault) {
                    data.push(["ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ¨ŸÑÿ©", "", "", ""]);
                    if (station.currentFault) {
                        data.push(["", "ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä", station.currentFault, station.fault1Desc || ""]);
                    }
                    if (station.secondaryFault) {
                        data.push(["", "ÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ´ÿßŸÜŸàŸä", station.secondaryFault, station.fault2Desc || ""]);
                    }
                    data.push([]);
                }
                
                // ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
                if (station.comments) {
                    data.push(["ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ", "", "", ""]);
                    data.push(["", station.comments, "", ""]);
                }
            }
            
            return data;
        }

        // --- USER PROFILE FUNCTIONS (ENHANCED FOR MOBILE) ---
        function renderUserProfileForm() {
            const currentUser = appData.currentUser;
            if (!currentUser) return;
            
            const username = currentUser.username;
            document.getElementById('profile-username').value = username;
            
            const userProfile = appData.userProfiles[username] || {};
            
            document.getElementById('profile-fullname').value = userProfile.fullname || '';
            document.getElementById('profile-phone').value = userProfile.phone || '';
            document.getElementById('profile-whatsapp').value = userProfile.whatsapp || '';
            document.getElementById('profile-email').value = userProfile.email || '';
            
            const stationSelect = document.getElementById('profile-station');
            stationSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ÿ∑ÿ© --</option>';
            
            const sortedStations = Object.values(appData.stations).sort((a, b) => a.name.localeCompare(b.name));
            sortedStations.forEach(station => {
                const selected = (userProfile.station === station.name) ? 'selected' : '';
                stationSelect.innerHTML += `<option value="${station.name}" ${selected}>${station.name}</option>`;
            });
            
            if (!userProfile.station && appData.currentStation) {
                stationSelect.value = appData.currentStation;
            }
        }
        
        function renderUsersProfilesList() {
            const currentUser = appData.currentUser;
            if (!currentUser) return;
            
            const tbody = document.getElementById('users-profiles-list');
            const searchInput = document.getElementById('search-profile-input').value.toLowerCase();
            const noProfilesMessage = document.getElementById('no-profiles-message');
            const loadMoreBtn = document.getElementById('load-more-profiles-btn');
            const paginationInfo = document.getElementById('profiles-pagination-info');
            
            tbody.innerHTML = '';
            
            const canViewAllProfiles = currentUser.permissions.view_profiles;
            const canDeleteProfiles = currentUser.permissions.delete_profiles;
            
            let filteredProfiles = Object.keys(appData.userProfiles).filter(username => {
                const profile = appData.userProfiles[username];
                
                if (!canViewAllProfiles && username !== currentUser.username) {
                    return false;
                }
                
                if (searchInput) {
                    const fullname = (profile.fullname || '').toLowerCase();
                    const station = (profile.station || '').toLowerCase();
                    const phone = (profile.phone || '').toLowerCase();
                    
                    if (!fullname.includes(searchInput) && 
                        !station.includes(searchInput) && 
                        !phone.includes(searchInput) &&
                        !username.toLowerCase().includes(searchInput)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            const totalProfiles = filteredProfiles.length;
            const startIndex = appData.currentProfilesPage * appData.profilesLimit;
            const endIndex = startIndex + appData.profilesLimit;
            const displayedProfiles = filteredProfiles.slice(startIndex, endIndex);
            
            if (displayedProfiles.length === 0) {
                tbody.style.display = 'none';
                loadMoreBtn.style.display = 'none';
                noProfilesMessage.style.display = 'block';
                
                if (searchInput) {
                    noProfilesMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÄ "${searchInput}"</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">ÿ¨ÿ±ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿµÿ∑ŸÑÿ≠ÿßÿ™ ÿ®ÿ≠ÿ´ ÿ£ÿÆÿ±Ÿâ</div>
                    `;
                } else if (!canViewAllProfiles) {
                    noProfilesMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìã</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ¥ÿÆÿµŸäÿ© ŸÖÿ≥ÿ¨ŸÑÿ© ŸÑŸÉ</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÅŸä ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ£Ÿäÿ≥ÿ±</div>
                    `;
                } else {
                    noProfilesMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìã</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">ŸäŸÖŸÉŸÜ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ŸáŸÖ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÅŸä ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ£Ÿäÿ≥ÿ±</div>
                    `;
                }
                return;
            }
            
            tbody.style.display = '';
            noProfilesMessage.style.display = 'none';
            
            displayedProfiles.forEach((username, index) => {
                const profile = appData.userProfiles[username];
                const userType = appData.users[username] ? appData.users[username].type : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                const userTypeName = appData.userTypes[userType] ? appData.userTypes[userType].name : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                
                const isCurrentUser = (username === currentUser.username);
                const canDeleteThisProfile = canDeleteProfiles && !isCurrentUser && currentUser.type === 'admin';
                
                // Mobile action menu
                let mobileActionMenu = '';
                if (canDeleteThisProfile && window.innerWidth <= 768) {
                    mobileActionMenu = `
                        <div class="mobile-action-menu">
                            <button class="mobile-action-btn" onclick="toggleMobileActions('${username}')">‚ãØ</button>
                            <div class="mobile-action-dropdown" id="mobile-actions-${username}">
                                <div class="mobile-action-item delete-action" onclick="deleteUserProfile('${username}')">
                                    üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                let rowHTML = `
                    <tr>
                        <td>
                            ${username}
                            ${isCurrentUser ? ' <span class="user-profile-badge">ÿ£ŸÜÿ™</span>' : ''}
                            <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">${userTypeName}</div>
                        </td>
                        <td>${profile.station || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        <td>${profile.fullname || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td>${profile.phone || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td>${profile.whatsapp || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td>${profile.email || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td>
                            <div class="desktop-actions" style="display: flex; justify-content: center;">
                                ${canDeleteThisProfile ? 
                                    `<button class="delete-profile-btn" onclick="deleteUserProfile('${username}')" title="ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                                        üóëÔ∏è ÿ≠ÿ∞ŸÅ
                                    </button>` : 
                                    '<span style="color:#888; font-size:0.8rem;">-</span>'
                                }
                            </div>
                            ${mobileActionMenu}
                        </td>
                    </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
            
            // Update pagination info
            const showingTo = Math.min(startIndex + displayedProfiles.length, totalProfiles);
            paginationInfo.textContent = `ÿπÿ±ÿ∂ ${startIndex + 1} ÿ•ŸÑŸâ ${showingTo} ŸÖŸÜ ÿ£ÿµŸÑ ${totalProfiles} ŸÖÿ≥ÿ™ÿÆÿØŸÖ`;
            
            // Show/hide load more button
            if (endIndex < totalProfiles) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (${Math.min(appData.profilesLimit, totalProfiles - endIndex)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Mobile actions toggle function
        window.toggleMobileActions = function(username) {
            const dropdown = document.getElementById(`mobile-actions-${username}`);
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            document.querySelectorAll('.mobile-action-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
        };
        
        // Close mobile dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.mobile-action-menu')) {
                document.querySelectorAll('.mobile-action-dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });
        
        // Load more profiles button handler
        document.getElementById('load-more-profiles-btn').addEventListener('click', function() {
            appData.currentProfilesPage++;
            renderUsersProfilesList();
            // Scroll to bottom of table
            document.querySelector('.users-profiles-table').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
        
        function saveUserProfile() {
            const currentUser = appData.currentUser;
            if (!currentUser) {
                showProfileAlert('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            const username = currentUser.username;
            const fullname = document.getElementById('profile-fullname').value.trim();
            const station = document.getElementById('profile-station').value;
            const phone = document.getElementById('profile-phone').value.trim();
            const whatsapp = document.getElementById('profile-whatsapp').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            
            if (!fullname) {
                showProfileAlert('ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä ŸÖÿ∑ŸÑŸàÿ®', 'error');
                document.getElementById('profile-fullname').focus();
                return;
            }
            
            if (!station) {
                showProfileAlert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≠ÿ∑ÿ©', 'error');
                document.getElementById('profile-station').focus();
                return;
            }
            
            if (!phone) {
                showProfileAlert('ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÖÿ∑ŸÑŸàÿ®', 'error');
                document.getElementById('profile-phone').focus();
                return;
            }
            
            const phoneRegex = /^01[0-9]{9}$/;
            if (!phoneRegex.test(phone)) {
                showProfileAlert('ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠. Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖÿßŸã ŸàŸäÿ®ÿØÿ£ ÿ®ŸÄ 01', 'error');
                document.getElementById('profile-phone').focus();
                return;
            }
            
            if (whatsapp && !phoneRegex.test(whatsapp)) {
                showProfileAlert('ÿ±ŸÇŸÖ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠. Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 11 ÿ±ŸÇŸÖÿßŸã ŸàŸäÿ®ÿØÿ£ ÿ®ŸÄ 01', 'error');
                document.getElementById('profile-whatsapp').focus();
                return;
            }
            
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showProfileAlert('ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠', 'error');
                    document.getElementById('profile-email').focus();
                    return;
                }
            }
            
            const nowStd = getStandardDateTime();
            const profileData = {
                username: username,
                fullname: fullname,
                station: station,
                phone: phone,
                whatsapp: whatsapp || '',
                email: email || '',
                lastUpdate: nowStd.full,
                userType: currentUser.type
            };
            
            if (navigator.onLine) {
                db.ref('userProfiles/' + username).set(profileData)
                    .then(() => {
                        showProfileAlert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ', 'success');
                        
                        appData.userProfiles[username] = profileData;
                        localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(appData.userProfiles));
                        
                        renderUsersProfilesList();
                        
                        const log = {
                            date: nowStd.date,
                            time: nowStd.time,
                            station: station,
                            operator: username,
                            details: `ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${fullname}`
                        };
                        db.ref('history').push(log);
                    })
                    .catch(err => {
                        console.error('Error saving profile:', err);
                        showProfileAlert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + err.message, 'error');
                    });
            } else {
                appData.userProfiles[username] = profileData;
                localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(appData.userProfiles));
                
                addToOfflineQueue('update_profile', {
                    username: username,
                    profileData: profileData
                });
                
                showProfileAlert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ¨Ÿáÿßÿ≤ (ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ) ‚è≥', 'warning');
                renderUsersProfilesList();
            }
        }
        
        function deleteUserProfile(username) {
            const currentUser = appData.currentUser;
            
            if (!currentUser || currentUser.type !== 'admin') {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            if (username === currentUser.username) {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑÿ¥ÿÆÿµŸäÿ©');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username}"ÿü\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.`)) {
                if (navigator.onLine) {
                    db.ref('userProfiles/' + username).remove()
                        .then(() => {
                            showProfileAlert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ', 'success');
                            renderUsersProfilesList();
                            
                            const nowStd = getStandardDateTime();
                            const log = {
                                date: nowStd.date,
                                time: nowStd.time,
                                station: 'ÿßŸÑŸÜÿ∏ÿßŸÖ',
                                operator: currentUser.username,
                                details: `ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${username}`
                            };
                            db.ref('history').push(log);
                        })
                        .catch(err => {
                            console.error('Error deleting profile:', err);
                            showProfileAlert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + err.message, 'error');
                        });
                } else {
                    addToOfflineQueue('delete_profile', {
                        username: username,
                        deletedBy: currentUser.username
                    });
                    
                    delete appData.userProfiles[username];
                    localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(appData.userProfiles));
                    
                    showProfileAlert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ¨Ÿáÿßÿ≤ (ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ) ‚è≥', 'warning');
                    renderUsersProfilesList();
                }
            }
        }
        
        window.deleteUserProfile = deleteUserProfile;
        
        function showProfileAlert(message, type = 'info') {
            const alertDiv = document.getElementById('profile-alert');
            alertDiv.textContent = message;
            alertDiv.className = 'profile-alert';
            
            switch(type) {
                case 'success':
                    alertDiv.classList.add('profile-alert-success');
                    break;
                case 'warning':
                    alertDiv.classList.add('profile-alert-warning');
                    break;
                case 'error':
                    alertDiv.classList.add('profile-alert-error');
                    break;
            }
            
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        document.getElementById('save-profile-btn').addEventListener('click', saveUserProfile);
        document.getElementById('search-profile-input').addEventListener('keyup', function() {
            appData.currentProfilesPage = 0;
            renderUsersProfilesList();
        });

        // --- USERS DATA MANAGEMENT (ÿ¥ÿßÿ¥ÿ© ÿ¨ÿØŸäÿØÿ© ŸÑÿ•ÿØÿßÿ±ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ) ---
        function renderUsersDataManagement() {
            const currentUser = appData.currentUser;
            if (!currentUser || currentUser.type !== 'admin') {
                alert('Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿØŸäÿ±ÿßŸã ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑÿ¥ÿßÿ¥ÿ©');
                showScreen('stations');
                return;
            }
            
            const tbody = document.getElementById('users-data-table-body');
            const searchInput = document.getElementById('search-users-data-input').value.toLowerCase();
            const noUsersDataMessage = document.getElementById('no-users-data-message');
            const loadMoreBtn = document.getElementById('load-more-users-data-btn');
            const paginationInfo = document.getElementById('users-data-pagination-info');
            
            tbody.innerHTML = '';
            
            // Combine user accounts with their profiles
            let combinedUsers = [];
            Object.keys(appData.users).forEach(username => {
                const userAccount = appData.users[username];
                const userProfile = appData.userProfiles[username] || {};
                
                combinedUsers.push({
                    username: username,
                    account: userAccount,
                    profile: userProfile
                });
            });
            
            // Filter by search
            let filteredUsers = combinedUsers.filter(user => {
                if (searchInput) {
                    const username = user.username.toLowerCase();
                    const fullname = (user.profile.fullname || '').toLowerCase();
                    const station = (user.profile.station || '').toLowerCase();
                    const phone = (user.profile.phone || '').toLowerCase();
                    const userType = appData.userTypes[user.account.type].name.toLowerCase();
                    
                    if (!username.includes(searchInput) && 
                        !fullname.includes(searchInput) && 
                        !station.includes(searchInput) &&
                        !phone.includes(searchInput) &&
                        !userType.includes(searchInput)) {
                        return false;
                    }
                }
                return true;
            });
            
            // Sort by username
            filteredUsers.sort((a, b) => a.username.localeCompare(b.username));
            
            const totalUsers = filteredUsers.length;
            const startIndex = appData.currentUsersDataPage * appData.usersDataLimit;
            const endIndex = startIndex + appData.usersDataLimit;
            const displayedUsers = filteredUsers.slice(startIndex, endIndex);
            
            if (displayedUsers.length === 0) {
                tbody.style.display = 'none';
                loadMoreBtn.style.display = 'none';
                noUsersDataMessage.style.display = 'block';
                
                if (searchInput) {
                    noUsersDataMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÄ "${searchInput}"</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">ÿ¨ÿ±ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿµÿ∑ŸÑÿ≠ÿßÿ™ ÿ®ÿ≠ÿ´ ÿ£ÿÆÿ±Ÿâ</div>
                    `;
                } else {
                    noUsersDataMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
                    `;
                }
                return;
            }
            
            tbody.style.display = '';
            noUsersDataMessage.style.display = 'none';
            
            displayedUsers.forEach((user, index) => {
                const account = user.account;
                const profile = user.profile;
                const userTypeName = appData.userTypes[account.type].name;
                const typeClass = `type-${account.type}`;
                const isCurrentUser = (user.username === currentUser.username);
                const rowNum = startIndex + index + 1;
                
                let rowHTML = `
                    <tr>
                        <td>${rowNum}</td>
                        <td style="font-weight: bold;">
                            ${user.username}
                            ${isCurrentUser ? ' <span style="color:#1976d2; font-size:0.8rem;">(ÿ£ŸÜÿ™)</span>' : ''}
                        </td>
                        <td>${profile.fullname || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td><span class="user-type-badge ${typeClass}">${userTypeName}</span></td>
                        <td>${profile.station || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                        <td>${profile.phone || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td>${profile.email || 'ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ'}</td>
                        <td class="action-cell">
                            ${!isCurrentUser ? 
                                `<button class="delete-user-btn" onclick="deleteUserFromDataScreen('${user.username}')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                                    üóëÔ∏è ÿ≠ÿ∞ŸÅ
                                </button>` : 
                                '<span style="color:#888; font-size:0.8rem;">-</span>'
                            }
                        </td>
                    </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
            
            // Update pagination info
            const showingTo = Math.min(startIndex + displayedUsers.length, totalUsers);
            paginationInfo.textContent = `ÿπÿ±ÿ∂ ${startIndex + 1} ÿ•ŸÑŸâ ${showingTo} ŸÖŸÜ ÿ£ÿµŸÑ ${totalUsers} ŸÖÿ≥ÿ™ÿÆÿØŸÖ`;
            
            // Show/hide load more button
            if (endIndex < totalUsers) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (${Math.min(appData.usersDataLimit, totalUsers - endIndex)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Load more users data button handler
        document.getElementById('load-more-users-data-btn').addEventListener('click', function() {
            appData.currentUsersDataPage++;
            renderUsersDataManagement();
            // Scroll to bottom of table
            document.querySelector('.users-data-table').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
        
        window.deleteUserFromDataScreen = function(username) {
            const currentUser = appData.currentUser;
            
            if (!currentUser || currentUser.type !== 'admin') {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            if (username === 'admin') {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä (admin)');
                return;
            }
            
            if (username === currentUser.username) {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßŸÑÿÆÿßÿµ ÿ£ÿ´ŸÜÿßÿ° ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username}"ÿü\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿ≥ŸäŸÖÿ≥ÿ≠ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ®ŸäÿßŸÜÿßÿ™Ÿá ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.`)) {
                // Delete user account
                db.ref('users/' + username).remove()
                    .then(() => {
                        // Delete user profile if exists
                        return db.ref('userProfiles/' + username).remove();
                    })
                    .then(() => {
                        alert('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ®ŸäÿßŸÜÿßÿ™Ÿá ÿ®ŸÜÿ¨ÿßÿ≠');
                        renderUsersDataManagement();
                    })
                    .catch(err => {
                        alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + err.message);
                    });
            }
        };
        
        // Search in users data screen
        document.getElementById('search-users-data-input').addEventListener('keyup', function() {
            appData.currentUsersDataPage = 0;
            renderUsersDataManagement();
        });

        // --- USERS MANAGEMENT (SIMPLIFIED - ÿ®ÿØŸàŸÜ ÿπŸÖŸàÿØ ÿßŸÑÿ≠ÿßŸÑÿ©) ---
        function renderUsersManagement() {
            const tbody = document.getElementById('users-table-body');
            const search = document.getElementById('search-user-input').value.toLowerCase();
            const noUsersMessage = document.getElementById('no-users-message');
            const currentUser = appData.currentUser;
            const loadMoreBtn = document.getElementById('load-more-users-btn');
            const paginationInfo = document.getElementById('users-pagination-info');
            
            tbody.innerHTML = '';
            
            let filteredUsers = Object.keys(appData.users).filter(uName => {
                if (search && !uName.toLowerCase().includes(search)) return false;
                return true;
            });
            
            const totalUsers = filteredUsers.length;
            const startIndex = appData.currentUsersPage * appData.usersLimit;
            const endIndex = startIndex + appData.usersLimit;
            const displayedUsers = filteredUsers.slice(startIndex, endIndex);
            
            if (displayedUsers.length === 0) {
                tbody.style.display = 'none';
                loadMoreBtn.style.display = 'none';
                noUsersMessage.style.display = 'block';
                if (search) {
                    noUsersMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                        <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÄ "${search}"</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">ÿ¨ÿ±ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿµÿ∑ŸÑÿ≠ÿßÿ™ ÿ®ÿ≠ÿ´ ÿ£ÿÆÿ±Ÿâ</div>
                    `;
                }
                return;
            }
            
            tbody.style.display = '';
            noUsersMessage.style.display = 'none';
            
            displayedUsers.forEach((uName, index) => {
                const user = appData.users[uName];
                const typeName = appData.userTypes[user.type].name;
                const typeClass = `type-${user.type}`;
                const isCurrentUser = (currentUser && currentUser.username === uName);
                const isActive = user.active !== false;
                const rowNum = startIndex + index + 1;
                
                const canDelete = currentUser && 
                                 currentUser.permissions.delete_users && 
                                 currentUser.permissions.can_delete_types.includes(user.type) &&
                                 !isCurrentUser;
                
                const canSeePassword = currentUser && 
                                      currentUser.permissions.view_passwords;
                
                let rowHTML = `
                    <tr>
                        <td style="font-weight: bold;">
                            ${uName}
                            ${isCurrentUser ? ' <span style="color:#1976d2; font-size:0.8rem;">(ÿ£ŸÜÿ™)</span>' : ''}
                        </td>
                        <td><span class="user-type-badge ${typeClass}">${typeName}</span></td>
                        <td class="password-cell" id="password-cell-${uName}">
                            ${canSeePassword ? 
                                `<span class="password-visible">${user.password}</span>` : 
                                `<span class="password-masked">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>`
                            }
                            ${canSeePassword ? 
                                `<button class="toggle-password-cell" onclick="togglePasswordVisibility('${uName}')" title="ÿ•ÿÆŸÅÿßÿ°">üëÅÔ∏è</button>` : 
                                ''
                            }
                        </td>
                        <td>
                            ${canDelete ? 
                                `<button class="delete-user-btn" onclick="deleteUser('${uName}')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                                    üóëÔ∏è ÿ≠ÿ∞ŸÅ
                                </button>` : 
                                ''
                            }
                        </td>
                    </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
            
            // Update pagination info
            const showingTo = Math.min(startIndex + displayedUsers.length, totalUsers);
            paginationInfo.textContent = `ÿπÿ±ÿ∂ ${startIndex + 1} ÿ•ŸÑŸâ ${showingTo} ŸÖŸÜ ÿ£ÿµŸÑ ${totalUsers} ŸÖÿ≥ÿ™ÿÆÿØŸÖ`;
            
            // Show/hide load more button
            if (endIndex < totalUsers) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (${Math.min(appData.usersLimit, totalUsers - endIndex)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        window.togglePasswordVisibility = function(username) {
            const cell = document.getElementById(`password-cell-${username}`);
            const user = appData.users[username];
            const span = cell.querySelector('span');
            const button = cell.querySelector('button');
            
            if (span.classList.contains('password-masked')) {
                span.classList.remove('password-masked');
                span.classList.add('password-visible');
                span.textContent = user.password;
                button.title = "ÿ•ÿÆŸÅÿßÿ°";
                button.textContent = "üîí";
            } else {
                span.classList.remove('password-visible');
                span.classList.add('password-masked');
                span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                button.title = "ÿ•ÿ∏Ÿáÿßÿ±";
                button.textContent = "üëÅÔ∏è";
            }
        };

        window.deleteUser = function(username) {
            const currentUser = appData.currentUser;
            const targetUser = appData.users[username];
            
            if (!currentUser || !currentUser.permissions.delete_users) {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            if (!currentUser.permissions.can_delete_types.includes(targetUser.type)) {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            if (username === 'admin') {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä (admin)');
                return;
            }
            
            if (username === currentUser.username) {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßŸÑÿÆÿßÿµ ÿ£ÿ´ŸÜÿßÿ° ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ');
                return;
            }
            
            if (confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${username}"ÿü\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.`)) {
                db.ref('users/' + username).remove()
                    .then(() => {
                        alert('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
                        appData.currentUsersPage = 0; // Reset to first page
                        renderUsersManagement();
                    })
                    .catch(err => {
                        alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + err.message);
                    });
            }
        };

        // Load more users button handler
        document.getElementById('load-more-users-btn').addEventListener('click', function() {
            appData.currentUsersPage++;
            renderUsersManagement();
            // Scroll to bottom of table
            document.querySelector('.users-table').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });

        document.getElementById('add-user-btn').addEventListener('click', () => {
            const currentUser = appData.currentUser;
            
            if (!currentUser || !currentUser.permissions.add_users) {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            document.getElementById('user-form-container').style.display = 'block';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            
            const sel = document.getElementById('new-user-type');
            sel.innerHTML = '';
            
            currentUser.permissions.can_add_types.forEach(k => {
                sel.innerHTML += `<option value="${k}">${appData.userTypes[k].name}</option>`;
            });
            
            if (sel.options.length === 0) {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£Ÿä ŸÜŸàÿπ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                document.getElementById('user-form-container').style.display = 'none';
            }
        });

        document.getElementById('cancel-user-btn').addEventListener('click', () => {
            document.getElementById('user-form-container').style.display = 'none';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
        });

        document.getElementById('save-user-btn').addEventListener('click', () => {
            const currentUser = appData.currentUser;
            
            if (!currentUser || !currentUser.permissions.add_users) {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            const name = document.getElementById('new-username').value.trim();
            const pass = document.getElementById('new-password').value.trim();
            const type = document.getElementById('new-user-type').value;
            
            if (!currentUser.permissions.can_add_types.includes(type)) {
                alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            
            if(!name) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                document.getElementById('new-username').focus();
                return;
            }
            
            if(!pass) {
                alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
                document.getElementById('new-password').focus();
                return;
            }
            
            if(name.toLowerCase() === 'admin') {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßÿ≥ŸÖ "admin" ŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ');
                return;
            }
            
            if(appData.users[name]) {
                alert('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ');
                return;
            }
            
            db.ref('users/' + name).set({
                type: type,
                password: pass,
                active: true
            }).then(() => {
                alert('‚úÖ ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
                document.getElementById('user-form-container').style.display = 'none';
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                appData.currentUsersPage = 0; // Reset to first page
                renderUsersManagement();
            }).catch(err => {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + err.message);
            });
        });

        // Search in users management
        document.getElementById('search-user-input').addEventListener('keyup', function() {
            appData.currentUsersPage = 0;
            renderUsersManagement();
        });

        // --- CONSUMPTION REPORT LOGIC ---
        document.getElementById('consumptions-btn').addEventListener('click', () => {
            const filterSelect = document.getElementById('cons-filter-station');
            if (filterSelect.options.length <= 1) {
                const sorted = Object.values(appData.stations).sort((a,b) => a.name.localeCompare(b.name));
                sorted.forEach(s => filterSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`);
            }
            const today = new Date();
            const firstDayThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            document.getElementById('cons-filter-date-to').valueAsDate = firstDayThisMonth;
            document.getElementById('cons-filter-date-from').valueAsDate = firstDayLastMonth;
            renderConsumptionsTable();
            showScreen('consumptions-report');
        });

window.renderConsumptionsTable = function() {
    const stationFilter = document.getElementById('cons-filter-station').value;
    const dateFrom = document.getElementById('cons-filter-date-from').value;
    const dateTo = document.getElementById('cons-filter-date-to').value;
    const tbody = document.getElementById('consumptions-table-body');
    
    if (!dateFrom || !dateTo) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ©');
        return;
    }
    
    tbody.innerHTML = '';
    
    let filteredConsumptions = appData.consumptionLog || [];
    
    // ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≠ÿ∑ÿ©
    if (stationFilter !== 'all') {
        filteredConsumptions = filteredConsumptions.filter(c => c.station === stationFilter);
    }
    
    // ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
    filteredConsumptions = filteredConsumptions.filter(c => {
        const logDate = c.date; // ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ: DD/MM/YYYY
        const [d, m, y] = logDate.split('/');
        const logDateISO = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return logDateISO >= dateFrom && logDateISO <= dateTo;
    });
    
    if (filteredConsumptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©</td></tr>';
        return;
    }
    
    // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≠ÿ∑ÿ©
    const stationsData = {};
    
    filteredConsumptions.forEach(log => {
        if (!stationsData[log.station]) {
            stationsData[log.station] = [];
        }
        stationsData[log.station].push(log);
    });
    
    // ŸÖÿπÿßŸÑÿ¨ÿ© ŸÉŸÑ ŸÖÿ≠ÿ∑ÿ©
    Object.keys(stationsData).forEach(stationName => {
        const stationLogs = stationsData[stationName];
        
        // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ™ÿµÿßÿπÿØŸäÿßŸã
        stationLogs.sort((a, b) => {
            const dateA = parseCustomDate(`${a.date} ${a.time}`);
            const dateB = parseCustomDate(`${b.date} ${b.time}`);
            return dateA - dateB;
        });
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸàŸÑ ŸÇÿ±ÿßÿ°ÿ© ŸÅŸä ŸÅÿ™ÿ±ÿ© "ŸÖŸÜ" Ÿàÿ£ŸàŸÑ ŸÇÿ±ÿßÿ°ÿ© ŸÅŸä ŸÅÿ™ÿ±ÿ© "ÿ•ŸÑŸâ"
        let fromReading = null;
        let toReading = null;
        
        // ÿ™ÿ≠ŸàŸäŸÑ ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿØÿÆŸÑÿßÿ™ ÿ•ŸÑŸâ Date objects ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ©
        const fromDate = new Date(dateFrom);
        const toDate = new Date(dateTo);
        
        stationLogs.forEach(log => {
            const logDateStr = log.date; // DD/MM/YYYY
            const [d, m, y] = logDateStr.split('/');
            const logDate = new Date(`${y}-${m}-${d}`);
            
            if (logDate.getTime() === fromDate.getTime() && !fromReading) {
                fromReading = log;
            }
            if (logDate.getTime() === toDate.getTime() && !toReading) {
                toReading = log;
            }
        });
        
        if (!fromReading || !toReading) {
            // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ŸÇÿ±ÿßÿ°ÿßÿ™ ŸÅŸä ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ≠ÿØÿØÿ©ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸàŸÑ Ÿàÿ¢ÿÆÿ± ŸÇÿ±ÿßÿ°ÿ© ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ©
            fromReading = stationLogs[0];
            toReading = stationLogs[stationLogs.length - 1];
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ
        const consumptionT1 = (parseFloat(toReading.t1) || 0) - (parseFloat(fromReading.t1) || 0);
        const consumptionT2 = (parseFloat(toReading.t2) || 0) - (parseFloat(fromReading.t2) || 0);
        const consumptionM3 = (parseFloat(toReading.m3) || 0) - (parseFloat(fromReading.m3) || 0);
        
        // ÿ™ŸÜÿ≥ŸäŸÇ ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑŸÇÿ±ÿßÿ°ÿßÿ™
        const fromDateFormatted = fromReading.date;
        const fromTimeFormatted = fromReading.time.substring(0, 5);
        const toDateFormatted = toReading.date;
        const toTimeFormatted = toReading.time.substring(0, 5);
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿµŸÅ ÿ¨ÿØŸäÿØ ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${stationName}</td>
            <td class="cons-cell">
                <div class="cons-sub-item">
                    <span class="cons-label">ÿ≥ÿßÿ®ŸÇ:</span>
                    <span>${parseFloat(fromReading.t1) || 0}</span>
                </div>
                <div class="cons-sub-item">
                    <span class="cons-label">ÿ≠ÿßŸÑŸä:</span>
                    <span>${parseFloat(toReading.t1) || 0}</span>
                </div>
                <div class="cons-result">${consumptionT1.toFixed(2)}</div>
                <div class="cons-date-small">
                    ${fromDateFormatted} ${fromTimeFormatted} ‚Üí ${toDateFormatted} ${toTimeFormatted}
                </div>
            </td>
            <td class="cons-cell">
                <div class="cons-sub-item">
                    <span class="cons-label">ÿ≥ÿßÿ®ŸÇ:</span>
                    <span>${parseFloat(fromReading.t2) || 0}</span>
                </div>
                <div class="cons-sub-item">
                    <span class="cons-label">ÿ≠ÿßŸÑŸä:</span>
                    <span>${parseFloat(toReading.t2) || 0}</span>
                </div>
                <div class="cons-result">${consumptionT2.toFixed(2)}</div>
                <div class="cons-date-small">
                    ${fromDateFormatted} ${fromTimeFormatted} ‚Üí ${toDateFormatted} ${toTimeFormatted}
                </div>
            </td>
            <td class="cons-cell">
                <div class="cons-sub-item">
                    <span class="cons-label">ÿ≥ÿßÿ®ŸÇ:</span>
                    <span>${parseFloat(fromReading.m3) || 0}</span>
                </div>
                <div class="cons-sub-item">
                    <span class="cons-label">ÿ≠ÿßŸÑŸä:</span>
                    <span>${parseFloat(toReading.m3) || 0}</span>
                </div>
                <div class="cons-result">${consumptionM3.toFixed(2)}</div>
                <div class="cons-date-small">
                    ${fromDateFormatted} ${fromTimeFormatted} ‚Üí ${toDateFormatted} ${toTimeFormatted}
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
};

window.exportConsumptionsToCSV = function() {
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜŸÅÿ≥ ŸÖŸÜÿ∑ŸÇ renderConsumptionsTable ŸÑÿ¨ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    const stationFilter = document.getElementById('cons-filter-station').value;
    const dateFrom = document.getElementById('cons-filter-date-from').value;
    const dateTo = document.getElementById('cons-filter-date-to').value;
    
    if (!dateFrom || !dateTo) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ© ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    let filteredConsumptions = appData.consumptionLog || [];
    
    // ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≠ÿ∑ÿ©
    if (stationFilter !== 'all') {
        filteredConsumptions = filteredConsumptions.filter(c => c.station === stationFilter);
    }
    
    // ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
    filteredConsumptions = filteredConsumptions.filter(c => {
        const logDate = c.date;
        const [d, m, y] = logDate.split('/');
        const logDateISO = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return logDateISO >= dateFrom && logDateISO <= dateTo;
    });
    
    if (filteredConsumptions.length === 0) {
        alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
        return;
    }
    
    // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≠ÿ∑ÿ©
    const stationsData = {};
    filteredConsumptions.forEach(log => {
        if (!stationsData[log.station]) {
            stationsData[log.station] = [];
        }
        stationsData[log.station].push(log);
    });
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≠ÿ™ŸàŸâ CSV
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM ŸÑŸÑÿØÿπŸÖ ÿßŸÑÿπÿ±ÿ®Ÿä
    
    // ÿ±ÿ£ÿ≥ CSV
    csvContent += "ÿßŸÑŸÖÿ≠ÿ∑ÿ©,ŸÜŸàÿπ ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ,ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©,ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©,ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©,ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©,ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ,Ÿàÿ≠ÿØÿ© ÿßŸÑŸÇŸäÿßÿ≥\n";
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÉŸÑ ŸÖÿ≠ÿ∑ÿ©
    Object.keys(stationsData).forEach(stationName => {
        const stationLogs = stationsData[stationName];
        
        // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        stationLogs.sort((a, b) => {
            const dateA = parseCustomDate(`${a.date} ${a.time}`);
            const dateB = parseCustomDate(`${b.date} ${b.time}`);
            return dateA - dateB;
        });
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ±ÿßÿ°ÿßÿ™
        const fromDate = new Date(dateFrom);
        const toDate = new Date(dateTo);
        
        let fromReading = null;
        let toReading = null;
        
        stationLogs.forEach(log => {
            const logDateStr = log.date;
            const [d, m, y] = logDateStr.split('/');
            const logDate = new Date(`${y}-${m}-${d}`);
            
            if (logDate.getTime() === fromDate.getTime() && !fromReading) {
                fromReading = log;
            }
            if (logDate.getTime() === toDate.getTime() && !toReading) {
                toReading = log;
            }
        });
        
        if (!fromReading || !toReading) {
            fromReading = stationLogs[0];
            toReading = stationLogs[stationLogs.length - 1];
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ
        const consumptionT1 = (parseFloat(toReading.t1) || 0) - (parseFloat(fromReading.t1) || 0);
        const consumptionT2 = (parseFloat(toReading.t2) || 0) - (parseFloat(fromReading.t2) || 0);
        const consumptionM3 = (parseFloat(toReading.m3) || 0) - (parseFloat(fromReading.m3) || 0);
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅŸàŸÅ CSV
        csvContent += `"${stationName}","ŸÖÿ≠ŸàŸÑ 1 (KW)","${parseFloat(fromReading.t1) || 0}","${fromReading.date} ${fromReading.time.substring(0, 5)}","${parseFloat(toReading.t1) || 0}","${toReading.date} ${toReading.time.substring(0, 5)}","${consumptionT1.toFixed(2)}","KW"\n`;
        csvContent += `"${stationName}","ŸÖÿ≠ŸàŸÑ 2 (KW)","${parseFloat(fromReading.t2) || 0}","${fromReading.date} ${fromReading.time.substring(0, 5)}","${parseFloat(toReading.t2) || 0}","${toReading.date} ${toReading.time.substring(0, 5)}","${consumptionT2.toFixed(2)}","KW"\n`;
        csvContent += `"${stationName}","ÿßŸÑŸÖŸäÿßŸá (M3)","${parseFloat(fromReading.m3) || 0}","${fromReading.date} ${fromReading.time.substring(0, 5)}","${parseFloat(toReading.m3) || 0}","${toReading.date} ${toReading.time.substring(0, 5)}","${consumptionM3.toFixed(2)}","M3"\n`;
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ∑ÿ± ŸÅÿßÿ±ÿ∫ ÿ®ŸäŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™
        csvContent += "\n";
    });
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿÆÿµ
    csvContent += "\n";
    csvContent += "ŸÖŸÑÿÆÿµ ÿßŸÑŸÅÿ™ÿ±ÿ©\n";
    csvContent += `ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©,${dateFrom}\n`;
    csvContent += `ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜŸáÿßŸäÿ©,${dateTo}\n`;
    csvContent += `ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™,${Object.keys(stationsData).length}\n`;
    csvContent += `ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±,${new Date().toLocaleDateString('ar-EG')}\n`;
    csvContent += `ŸàŸÇÿ™ ÿßŸÑÿ™ÿµÿØŸäÿ±,${new Date().toLocaleTimeString('ar-EG')}\n`;
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿßÿ≥ÿ™ŸáŸÑÿßŸÉ_${dateFrom}_ÿ•ŸÑŸâ_${dateTo}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${Object.keys(stationsData).length} ŸÖÿ≠ÿ∑ÿ© ÿ•ŸÑŸâ ŸÖŸÑŸÅ CSV`);
};

        // --- FAULTS & HISTORY LOGIC ---
        function renderHistoryTable(applyFilters = false) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            let data = [...appData.operationHistory];
            
            if (applyFilters) {
                const fZone = document.getElementById('filter-zone').value;
                const fStation = document.getElementById('filter-station').value;
                const fDateFrom = document.getElementById('filter-date-from').value;
                const fDateTo = document.getElementById('filter-date-to').value;
                
                // Filter by zone
                const zoneSelect = document.getElementById('filter-zone');
                if (zoneSelect.options.length <= 1) {
                    zoneSelect.innerHTML = '<option value="all">ŸÉŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';
                    appData.zones.forEach(z => zoneSelect.innerHTML += `<option value="${z}">${z}</option>`);
                }
                
                if (fZone !== 'all') {
                    const zoneStations = Object.values(appData.stations).filter(s => s.zone === fZone).map(s => s.name);
                    data = data.filter(d => zoneStations.includes(d.station));
                }
                
                // Update station filter based on selected zone
                const stationSelect = document.getElementById('filter-station');
                stationSelect.innerHTML = '<option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option>';
                
                let filteredStations = Object.values(appData.stations);
                if (fZone !== 'all') {
                    filteredStations = filteredStations.filter(s => s.zone === fZone);
                }
                
                filteredStations.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                    stationSelect.innerHTML += `<option value="${s.name}" ${fStation === s.name ? 'selected' : ''}>${s.name}</option>`;
                });
                
                if (fStation !== 'all') {
                    data = data.filter(d => d.station === fStation);
                }
                
                if (fDateFrom) {
                    data = data.filter(d => {
                        const logDate = parseCustomDate(d.date + ' ' + d.time);
                        return logDate && logDate >= new Date(fDateFrom);
                    });
                }
                
                if (fDateTo) {
                    const toDate = new Date(fDateTo);
                    toDate.setHours(23,59,59);
                    data = data.filter(d => {
                        const logDate = parseCustomDate(d.date + ' ' + d.time);
                        return logDate && logDate <= toDate;
                    });
                }
            }
            
            data.forEach(log => {
                if (!log.operator || log.operator === 'undefined') {
                    log.operator = 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ';
                }
            });
            
            const viewData = data.slice(0, appData.historyLimit);
            viewData.forEach(log => {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≥ÿ¨ŸÑ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿ©
                let rowClass = '';
                let statusChangeHtml = '';
                
                if (log.details && (log.details.includes('ŸÜÿ¥ÿ∑ÿ© -> ŸÖÿ™ŸàŸÇŸÅÿ©') || log.details.includes('ŸÖÿ™ŸàŸÇŸÅÿ© -> ŸÜÿ¥ÿ∑ÿ©'))) {
                    rowClass = 'status-change-row';
                    
                    if (log.details.includes('ŸÜÿ¥ÿ∑ÿ© -> ŸÖÿ™ŸàŸÇŸÅÿ©')) {
                        rowClass += ' status-to-inactive';
                        statusChangeHtml = `<span class="status-change-badge status-change-inactive">üî¥ ÿ™ŸàŸÇŸÅ</span> `;
                    } else if (log.details.includes('ŸÖÿ™ŸàŸÇŸÅÿ© -> ŸÜÿ¥ÿ∑ÿ©')) {
                        statusChangeHtml = `<span class="status-change-badge status-change-active">üü¢ ÿ™ÿ¥ÿ∫ŸäŸÑ</span> `;
                    }
                }
                
                // ÿπÿ±ÿ∂ ÿ™ŸàŸÇŸäÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ŸàÿßŸÑÿ•ŸäŸÇÿßŸÅ
                const startTimeHtml = log.startTime ? 
                    `<div style="color:#27ae60; font-weight:bold;">${log.startTime}</div>` : 
                    '<div style="color:#888; font-size:0.9rem;">-</div>';
                
                const stopTimeHtml = log.stopTime ? 
                    `<div style="color:#c0392b; font-weight:bold;">${log.stopTime}</div>` : 
                    '<div style="color:#888; font-size:0.9rem;">-</div>';
                
                tbody.innerHTML += `<tr class="${rowClass}">
                    <td>
                        <div style="font-weight:bold">${log.date}</div>
                        <div style="font-size:0.85rem; color:#666">${log.time}</div>
                    </td>
                    <td>${log.station}</td>
                    <td>${log.operator}</td>
                    <td>${startTimeHtml}</td>
                    <td>${stopTimeHtml}</td>
                    <td>${statusChangeHtml}${log.details}</td>
                </tr>`;
            });
            
            document.getElementById('history-status-text').textContent = `ÿπÿ±ÿ∂ ${viewData.length} ŸÖŸÜ ÿ£ÿµŸÑ ${data.length}`;
            
            const loadMoreBtn = document.getElementById('load-more-history-btn');
            if (viewData.length < data.length) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Load more history button handler
        document.getElementById('load-more-history-btn').addEventListener('click', function() {
            appData.historyLimit += 100;
            renderHistoryTable(true);
        });
        
        function renderFaultsLog() {
            const activeBody = document.getElementById('active-faults-body');
            const historyBody = document.getElementById('history-faults-body');
            const fStation = document.getElementById('fault-archive-station-filter').value;
            const loadMoreBtn = document.getElementById('load-more-faults-btn');
            
            activeBody.innerHTML = '';
            historyBody.innerHTML = '';
            
            const activeFaults = appData.faultsLog.filter(f => f.active);
            activeFaults.forEach(f => {
                const icon = faultIcons[f.type] || '‚ö†Ô∏è'; 
                activeBody.innerHTML += `<tr>
                    <td>${f.station}</td>
                    <td style="color:var(--danger-color); font-weight:bold">${icon} ${f.type}</td>
                    <td>${f.startTime}</td>
                    <td>ŸÖÿ≥ÿ™ŸÖÿ±</td>
                </tr>`;
            });
            
            if(activeFaults.length === 0) activeBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:green">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿπÿ∑ÿßŸÑ ŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäÿßŸã</td></tr>`;
            
            let histFaults = appData.faultsLog.filter(f => !f.active);
            if (fStation !== 'all') histFaults = histFaults.filter(f => f.station === fStation);
            
            const totalFaults = histFaults.length;
            const displayedFaults = histFaults.slice(0, appData.faultsLimit);
            
            displayedFaults.forEach(f => {
                const icon = faultIcons[f.type] || '‚ö†Ô∏è';
                historyBody.innerHTML += `<tr>
                    <td>${f.station}</td>
                    <td>${icon} ${f.type}</td>
                    <td>${f.startTime || '-'}</td>
                    <td>${f.endTime || '-'}</td>
                    <td style="color:green">ÿ™ŸÖ ÿßŸÑÿ•ÿµŸÑÿßÿ≠</td>
                </tr>`;
            });
            
            document.getElementById('faults-status-text').textContent = `ÿπÿ±ÿ∂ ${displayedFaults.length} ŸÖŸÜ ÿ£ÿµŸÑ ${totalFaults} ÿπÿ∑ŸÑ`;
            
            if (displayedFaults.length < totalFaults) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `ÿπÿ±ÿ∂ 100 ÿπÿ∑ŸÑ ÿ•ÿ∂ÿßŸÅŸä (ÿ•ÿ¨ŸÖÿßŸÑŸä ${Math.min(appData.faultsLimit + 100, totalFaults)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
            
            const filterSel = document.getElementById('fault-archive-station-filter');
            if (filterSel.options.length <= 1) {
                const sorted = Object.values(appData.stations).sort((a,b) => a.name.localeCompare(b.name));
                sorted.forEach(s => filterSel.innerHTML += `<option value="${s.name}">${s.name}</option>`);
            }
        }

        // Load more faults button handler
        document.getElementById('load-more-faults-btn').addEventListener('click', function() {
            appData.faultsLimit += 100;
            renderFaultsLog();
        });

        function updateStationFilter() {
            const z = document.getElementById('filter-zone').value;
            const s = document.getElementById('filter-station');
            s.innerHTML = '<option value="all">ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</option>';
            const list = Object.values(appData.stations).filter(st => z === 'all' || st.zone === z);
            list.sort((a,b) => a.name.localeCompare(b.name)).forEach(st => s.innerHTML += `<option value="${st.name}">${st.name}</option>`);
        }

        // Initial Load
        checkRememberedUser();
        loadSystemData();
    </script>
</body>
</html>
