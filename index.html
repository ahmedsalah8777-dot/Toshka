<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام تشغيل محطات المياه الذكي (Toshka V1.5)</title>
    <style>
        :root {
            --primary-color: #1a5276;
            --secondary-color: #2e86c1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --consumption-color: #2980b9;
            --light-bg: #f4f6f7;
            --card-bg: #ffffff;
            --header-bg: #eaf2f8;
            --scada-fault-color: #e67e22;
            --blue-fault: #87CEFA;
            --grey-color: #95a5a6;
            --profile-color: #9b59b6;
            --excel-color: #217346;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background-color: var(--light-bg); 
            color: #333; 
            line-height: 1.6; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 10px; 
            flex: 1; 
            width: 100%; 
        }

        /* تحسينات للهواتف المحمولة */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
                margin: 0 auto;
                width: 100%;
            }
            
            .screen {
                margin-left: 2px;
                margin-right: 2px;
                padding-left: 8px;
                padding-right: 8px;
            }
            
            .detail-card, .stat-card, .station-card {
                margin-left: 2px;
                margin-right: 2px;
            }
        }

        /* Header */
        header { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: white; 
            padding: 10px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 7px; 
            font-size: 20px; 
            font-weight: bold; 
        }
        
        /* Network Status Indicator */
        .network-status { 
            font-size: 0.8rem; 
            padding: 2px 6px; 
            border-radius: 12px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .net-online { 
            background: #d4edda; 
            color: #155724; 
        }
        
        .net-offline { 
            background: #f8d7da; 
            color: #721c24; 
        }
.net-weak {
    background: #fff3cd; /* خلفية صفراء */
    color: #856404;      /* نص بني داكن */
    border: 1px solid #ffeeba;
}
        
        .syncing { 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            100% { 
                transform: rotate(360deg); 
            } 
        }

        /* Ticker Styles */
        .ticker-container { 
            background-color: var(--danger-color); 
            color: white; 
            height: 40px; 
            overflow: hidden; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            display: none; 
            align-items: center; 
            box-shadow: 0 3px 5px rgba(0,0,0,0.1); 
            border: 2px solid #922b21; 
        }
        
        .ticker-container.active { 
            display: flex; 
        }
        
        .ticker-label { 
            background: rgba(0,0,0,0.3); 
            height: 100%; 
            padding: 0 10px; 
            display: flex; 
            align-items: center; 
            font-weight: bold; 
            white-space: nowrap; 
            z-index: 2; 
        }
        
        .ticker-text-wrap { 
            flex: 1; 
            overflow: hidden; 
            white-space: nowrap; 
            position: relative; 
            height: 100%; 
            display: flex; 
            align-items: center; 
        }
        
        .ticker { 
            display: inline-block; 
            white-space: nowrap; 
            padding-right: 100%; 
            animation-name: ticker; 
            animation-timing-function: linear; 
            animation-iteration-count: infinite; 
        }
        
        .ticker-item { 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            padding: 0 2px; 
            font-weight: bold; 
            font-size: 1rem; 
            color: white !important; 
        }
        
        .ticker-separator { 
            display: inline-block; 
            margin: 0 8px; 
            color: rgba(255, 255, 255, 0.8); 
            font-weight: normal; 
        }
        
        @keyframes ticker { 
            0% { 
                transform: translate3d(0, 0, 0); 
            } 
            100% { 
                transform: translate3d(100%, 0, 0); 
            } 
        }

        /* تحسينات أيقونة المستخدم للموبايل */
        .user-info { 
            display: none; 
            align-items: center; 
            gap: 8px; 
            flex-wrap: wrap; 
            justify-content: flex-end; 
        }
        
        @media (max-width: 768px) {
            .user-info {
                gap: 4px;
            }
            
            .user-badge { 
                font-size: 10px !important;
                padding: 3px 6px !important;
            }
            
            .alarm-btn, .profile-btn { 
                font-size: 1.2rem !important;
                margin-left: 5px !important;
                min-width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .alarm-count { 
                top: -2px !important;
                right: -2px !important;
                width: 16px !important;
                height: 16px !important;
                font-size: 9px !important;
            }
        }
        
        .user-badge { 
            background: rgba(255,255,255,0.2); 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 12px; 
            white-space: nowrap; 
        }
        
        .alarm-btn, .profile-btn { 
            background: transparent; 
            border: none; 
            color: white; 
            font-size: 1.4rem; 
            cursor: pointer; 
            position: relative; 
            margin-left: 10px; 
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .alarm-btn.flashing { 
            animation: bell-shake 1s infinite cubic-bezier(.36,.07,.19,.97) both, red-glow 1.5s infinite; 
            color: #ffcccc; 
        }
        
        .alarm-count { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: red; 
            color: white; 
            border-radius: 50%; 
            width: 18px; 
            height: 18px; 
            font-size: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid white; 
        }
        
        @keyframes bell-shake { 
            10%, 90% { 
                transform: translate3d(-1px, 0, 0); 
            } 
            20%, 80% { 
                transform: translate3d(2px, 0, 0); 
            } 
            30%, 50%, 70% { 
                transform: translate3d(-4px, 0, 0); 
            } 
            40%, 60% { 
                transform: translate3d(4px, 0, 0); 
            } 
        }
        
        @keyframes red-glow { 
            0% { 
                text-shadow: 0 0 5px red; 
            } 
            50% { 
                text-shadow: 0 0 20px red; 
            } 
            100% { 
                text-shadow: 0 0 5px red; 
            } 
        }

        /* Shift Warning Icon */
        .missed-update-icon { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 20px; 
            height: 20px; 
            background-color: #e74c3c; 
            color: white; 
            border-radius: 50%; 
            font-size: 14px; 
            font-weight: bold; 
            margin-right: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            animation: pulse-red 2s infinite; 
            vertical-align: middle; 
        }
        
        @keyframes pulse-red { 
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); 
            } 
            70% { 
                transform: scale(1.05); 
                box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); 
            } 
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); 
            } 
        }

        /* UI Components */
        .btn { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 14px; 
            justify-content: center; 
        }
        
        .btn-sm { 
            padding: 4px 8px; 
            font-size: 12px; 
        }
        
        .btn-primary { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        
        .btn-success { 
            background-color: var(--success-color); 
            color: white; 
        }
        
        .btn-danger { 
            background-color: var(--danger-color); 
            color: white; 
        }
        
        .btn-outline { 
            background-color: transparent; 
            border: 1px solid var(--secondary-color); 
            color: var(--secondary-color); 
        }
        
        .btn-warning { 
            background-color: var(--warning-color); 
            color: white; 
        }
        
        .btn-info { 
            background-color: #17a2b8; 
            color: white; 
        }
        
        .btn-consumption { 
            background-color: var(--consumption-color); 
            color: white; 
        }
        
        .btn-profile { 
            background-color: var(--profile-color); 
            color: white; 
        }
        
        .btn-excel { 
            background-color: var(--excel-color); 
            color: white; 
        }
        
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-2px); 
        }

        .screen { 
            display: none; 
            background: var(--card-bg); 
            border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            padding: 15px; 
            margin-top: 15px; 
            min-height: 500px; 
        }
        
        @media (max-width: 768px) {
            .screen {
                border-radius: 8px;
                padding: 10px;
                margin-left: 2px;
                margin-right: 2px;
                margin-top: 10px;
                min-height: 450px;
            }
        }
        
        .active { 
            display: block; 
            animation: fadeIn 0.4s ease; 
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        h2 { 
            color: var(--primary-color); 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
            font-size: 1.2rem; 
        }
        
        /* Grid System */
        .stations-grid { 
            display: grid; 
            gap: 10px; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        }
        
        .station-details { 
            display: grid; 
            gap: 10px; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            margin-top: 20px; 
        }
        
        .dashboard-stats { 
            display: grid; 
            gap: 15px; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        }

        @media (max-width: 768px) {
            .stations-grid { 
                grid-template-columns: 1fr 1fr !important; 
                gap: 6px; 
            }
            
            .station-card { 
                padding: 6px; 
                font-size: 0.8rem; 
            }
            
            .station-card div { 
                white-space: nowrap; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }
            
            .dashboard-stats { 
                display: flex !important; 
                flex-direction: row; 
                gap: 5px; 
            }
            
            .dashboard-stats .stat-card { 
                flex: 1; 
                padding: 6px; 
                text-align: center; 
                min-width: 0; 
            }
            
            .dashboard-stats .stat-label { 
                font-size: 0.7rem; 
                white-space: nowrap; 
            }
            
            .dashboard-stats .stat-value { 
                font-size: 1rem; 
            }
            
            .station-details {
                gap: 6px;
                grid-template-columns: 1fr 1fr;
            }
            
            .detail-card {
                padding: 8px;
            }
            
            .detail-title {
                font-size: 0.8rem;
            }
            
            .detail-value {
                font-size: 1rem;
            }
        }
        
        .stat-card, .station-card, .detail-card { 
            background: var(--card-bg); 
            border-radius: 8px; 
            padding: 15px; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.05); 
            border: 1px solid #eee; 
        }
        
        .station-card { 
            border-top: 4px solid var(--secondary-color); 
            cursor: pointer; 
            transition: 0.3s; 
            padding: 10px; 
            font-size: 0.95rem; 
            position: relative; 
            overflow: hidden; 
        }
        
        .station-card:active { 
            transform: scale(0.98); 
        }
        
        .station-card.fault-active { 
            border-top-color: var(--danger-color); 
            animation: card-flash 2s infinite; 
            background-color: #fff5f5; 
            border: 1px solid var(--danger-color); 
        }
        
        .station-card.fault-active.scada-fault { 
            border-top-color: var(--scada-fault-color); 
            background-color: #fffaf0; 
            border: 1px solid var(--scada-fault-color); 
        }
        
        @keyframes card-flash { 
            0% { 
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); 
            } 
            70% { 
                box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); 
            } 
            100% { 
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); 
            } 
        }
        
        .fault-badge { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            background: var(--danger-color); 
            color: white; 
            font-size: 0.8rem; 
            padding: 2px 8px; 
            border-radius: 4px; 
            margin-top: 5px; 
            text-align: center; 
            font-weight: bold; 
        }
        
        .fault-badge.scada-badge { 
            background: var(--scada-fault-color); 
        }

        .stat-value { 
            font-size: 24px; 
            font-weight: bold; 
            color: var(--primary-color); 
        }
        
        .detail-title { 
            font-size: 0.9rem; 
            color: #777; 
            margin-bottom: 5px; 
        }
        
        .detail-value { 
            font-size: 1.2rem; 
            font-weight: 600; 
            color: #333; 
            word-break: break-all; 
        }
        
        .detail-value.operator-highlight { 
            color: var(--secondary-color); 
        }

        .table-responsive { 
            overflow-x: auto; 
            margin-top: 15px; 
            border-radius: 8px; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; 
        }
        
        th { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 12px; 
            text-align: right; 
        }
        
        td { 
            padding: 10px 12px; 
            text-align: right; 
            border-bottom: 1px solid #eee; 
            vertical-align: top; 
        }
        
        tr:nth-child(even) { 
            background-color: #f9f9f9; 
        }

        .form-group { 
            margin-bottom: 15px; 
            position: relative; 
        }
        
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            background: #fff; 
        }
        
        .station-status { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
        }
        
        .status-active { 
            background-color: #d4edda; 
            color: #155724; 
        }
        
        .status-inactive { 
            background-color: #f8d7da; 
            color: #721c24; 
        }

        .zone-separator { 
            grid-column: 1 / -1; 
            background-color: var(--header-bg); 
            color: var(--primary-color); 
            padding: 10px 15px; 
            border-radius: 6px; 
            margin-top: 20px; 
            margin-bottom: 10px; 
            font-weight: bold; 
            font-size: 1.1rem; 
            border-right: 5px solid var(--secondary-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .nav-tabs { 
            display: flex; 
            overflow-x: auto; 
            gap: 8px; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #ddd; 
        }
        
        .nav-tab { 
            padding: 8px 16px; 
            border-radius: 20px; 
            background: #eee; 
            cursor: pointer; 
            white-space: nowrap; 
            border:none; 
        }
        
        .nav-tab.active { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        
        .password-container { 
            position: relative; 
        }
        
        .toggle-password { 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            cursor: pointer; 
            color: #666; 
        }
        
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            justify-content: flex-start; 
            margin-bottom: 15px; 
        }
        
        .checkbox-group input { 
            width: auto; 
            margin: 0; 
        }
        
        .pump-controls { 
            display: grid; 
            gap: 15px; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        }
        
        .pump-control { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #e9ecef; 
        }
        
        .alert { 
            padding: 15px; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            display: none; 
        }
        
        .alert-success { 
            background-color: #d4edda; 
            color: #155724; 
        }
        
        .alert-warning { 
            background-color: #fff3cd; 
            color: #856404; 
        }
        
        .signature { 
            text-align: center; 
            margin-top: 30px; 
            font-size: 12px; 
            color: #888; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
            font-weight: bold; 
        }
        
        .login-form { 
            max-width: 400px; 
            margin: 40px auto; 
            text-align: center; 
        }
        
        .pagination-controls { 
            text-align: center; 
            margin-top: 20px; 
            padding-bottom: 20px; 
        }
        
        .pagination-btn { 
            margin: 10px; 
        }
        
        .status-text { 
            font-size: 0.85rem; 
            color: #666; 
            margin-bottom: 10px; 
        }
        
        .scada-icon-svg { 
            vertical-align: text-bottom; 
        }
        
        .fault-row-action { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: white; 
            padding: 8px; 
            border-radius: 4px; 
            margin-bottom: 8px; 
            border-right: 3px solid var(--danger-color); 
        }
        
        .desc-input { 
            margin-top: 5px; 
            font-size: 0.9rem; 
            background: #fff; 
            border: 1px solid #ccc; 
        }

        /* --- INSPECTION SCREEN STYLES (MOBILE OPTIMIZED) --- */
        .section-accordion { 
            margin-bottom: 10px; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid #ddd; 
            background: #fff; 
        }
        
        .section-header-static { 
            background: #eaf2f8; 
            color: var(--primary-color); 
            padding: 12px 15px; 
            font-weight: bold; 
            font-size: 1.1rem; 
            border-bottom: 1px solid #ddd; 
        }
        
        .section-accordion-header { 
            background: linear-gradient(to right, #2c3e50, #34495e); 
            color: white; 
            padding: 15px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            font-size: 1.1rem; 
            border-radius: 8px; 
            transition: all 0.2s; 
        }
        
        .section-accordion-header:active { 
            transform: scale(0.99); 
        }
        
        .section-accordion-header .arrow { 
            transition: transform 0.3s; 
        }
        
        .section-accordion-header.active .arrow { 
            transform: rotate(180deg); 
        }
        
        .section-accordion-body { 
            display: none; 
            padding: 10px; 
            background: #fff; 
        }
        
        .section-accordion-body.open { 
            display: block; 
            animation: fadeIn 0.3s; 
        }
        
        .section-body-static { 
            display: block; 
            padding: 10px; 
            background: #fff; 
        }
        
        .inspection-row { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 8px; 
            padding: 12px; 
            border-bottom: 1px solid #f0f0f0; 
            background: #fff; 
            margin-bottom: 5px; 
            border-radius: 8px; 
            border: 1px solid #eee; 
        }
        
        .inspection-row:last-child { 
            margin-bottom: 0; 
        }
        
        @media (min-width: 768px) { 
            .inspection-row { 
                grid-template-columns: 1fr 180px 1.5fr; 
                align-items: center; 
                gap: 15px; 
            } 
        }
        
        .inspection-label { 
            font-size: 1rem; 
            font-weight: 600; 
            color: var(--secondary-color); 
            margin-bottom: 2px; 
        }
        
        .inspection-status-select { 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 500; 
            width: 100%; 
            border: 1px solid #ccc; 
            appearance: none; 
            -webkit-appearance: none; 
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); 
            background-repeat: no-repeat; 
            background-position: left 10px top 50%; 
            background-size: 12px; 
            padding-left: 30px; 
        }
        
        .inspection-status-select.efficient { 
            color: #155724; 
            border-color: #28a745; 
            background-color: #d4edda; 
        }
        
        .inspection-status-select.fault { 
            color: #856404; 
            border-color: #ffeeba; 
            background-color: #fff3cd; 
        }
        
        .inspection-status-select.broken { 
            color: #721c24; 
            border-color: #f5c6cb; 
            background-color: #f8d7da; 
        }
        
        .inspection-status-select.none { 
            color: #333; 
            border-color: #ccc; 
            background-color: #e2e3e5; 
        }
        
        .inspection-desc-input { 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            width: 100%; 
            font-size: 0.9rem; 
        }
        
        .pump-accordion-item { 
            margin-bottom: 10px; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid transparent; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        
        .pump-accordion-header { 
            padding: 12px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold; 
            font-size: 1rem; 
            color: white; 
            transition: background 0.3s; 
        }
        
        .pump-accordion-header .icon-state { 
            font-size: 1.1rem; 
            background: rgba(0,0,0,0.2); 
            width: 25px; 
            height: 25px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .pump-header-green { 
            background: linear-gradient(45deg, #27ae60, #2ecc71); 
        }
        
        .pump-header-yellow { 
            background: linear-gradient(45deg, #f39c12, #f1c40f); 
            color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        
        .pump-header-red { 
            background: linear-gradient(45deg, #c0392b, #e74c3c); 
        }
        
        .pump-accordion-body { 
            display: none; 
            padding: 10px; 
            background: #fff; 
            border: 1px solid #eee; 
            border-top: none; 
        }
        
        .pump-accordion-body.open { 
            display: block; 
            animation: slideDown 0.3s ease-out; 
        }
        
        @keyframes slideDown { 
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        .pump-section-divider { 
            background-color: #f0f4f8; 
            padding: 8px 10px; 
            font-weight: bold; 
            color: #2c3e50; 
            border-right: 4px solid var(--secondary-color); 
            margin: 15px 0 5px 0; 
            font-size: 0.95rem; 
            border-radius: 2px; 
        }

        #save-inspection-btn { 
            width: 100%; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            padding: 8px; 
            font-size: 0.95rem; 
            border-radius: 20px; 
            margin-bottom: 5px; 
        }

        /* Offline Banner */
        #offline-sync-banner { 
            display: none; 
            background: #fff3cd; 
            border: 1px solid #ffeeba; 
            color: #856404; 
            padding: 10px; 
            text-align: center; 
            margin-bottom: 10px; 
            border-radius: 8px; 
        }

        /* NEW STYLES FOR CONSUMPTION TABLE (V1.5.9 Modified) */
        .cons-cell { 
            text-align: center; 
            font-size: 0.9rem; 
            padding: 8px !important; 
        }
        
        .cons-sub-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px dashed #eee; 
            padding: 4px 0; 
            text-align: right; 
        }
        
        .cons-label { 
            font-size: 0.8rem; 
            color: #555; 
        }
        
        .cons-date-small { 
            display: block; 
            font-size: 0.7rem; 
            color: #888; 
            margin-top: 2px; 
            line-height: 1.2; 
            width: 100%; 
            text-align: left; 
        }
        
        .cons-result { 
            background-color: #e8f6f3; 
            color: var(--primary-color); 
            font-weight: bold; 
            padding: 6px; 
            margin-top: 5px; 
            border-radius: 4px; 
            text-align: center; 
        }
        
        .cons-val-wrapper { 
            text-align: left; 
        }
        
        /* --- USER PROFILES MANAGEMENT STYLES (ENHANCED FOR MOBILE) --- */
        .profile-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (min-width: 992px) {
            .profile-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .profile-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        
        .profile-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .profile-form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .users-profiles-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .users-profiles-table th {
            background-color: var(--profile-color);
            color: white;
            padding: 12px 8px;
            text-align: right;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        .users-profiles-table td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            font-size: 0.85rem;
        }
        
        .users-profiles-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Mobile optimization for tables */
        @media (max-width: 768px) {
            .users-profiles-table {
                display: block;
                width: 100%;
                overflow-x: auto;
            }
            
            .users-profiles-table th,
            .users-profiles-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
                min-width: 100px;
            }
            
            .users-profiles-table th:first-child,
            .users-profiles-table td:first-child {
                position: sticky;
                left: 0;
                background-color: white;
                z-index: 5;
                min-width: 120px;
            }
            
            .users-profiles-table tr:nth-child(even) td:first-child {
                background-color: #f9f9f9;
            }
        }
        
        .profile-search-container {
            position: relative;
            margin: 15px 0;
        }
        
        .profile-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        #search-profile-input {
            padding-right: 15px;
            padding-left: 45px;
            font-size: 0.95rem;
            width: 100%;
        }
        
        .no-profiles-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ddd;
            margin: 20px 0;
        }
        
        .user-profile-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            background-color: var(--secondary-color);
            color: white;
            margin-left: 5px;
        }
        
        .profile-alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .profile-alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .profile-alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .profile-alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Action buttons */
        .delete-profile-btn {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            margin: 0 auto;
        }
        
        .delete-profile-btn:hover {
            background: linear-gradient(135deg, #a93226, #c0392b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(192, 57, 43, 0.3);
        }
        
        /* Mobile action menu */
        .mobile-action-menu {
            position: relative;
            display: none;
        }
        
        @media (max-width: 768px) {
            .desktop-actions {
                display: none !important;
            }
            
            .mobile-action-menu {
                display: block;
            }
            
            .mobile-action-btn {
                background: #f0f0f0;
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 1.2rem;
            }
            
            .mobile-action-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                min-width: 150px;
                z-index: 100;
                display: none;
            }
            
            .mobile-action-dropdown.show {
                display: block;
            }
            
            .mobile-action-item {
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
            }
            
            .mobile-action-item:hover {
                background: #f5f5f5;
            }
            
            .mobile-action-item:last-child {
                border-bottom: none;
            }
            
            .mobile-action-item.delete-action {
                color: #c0392b;
            }
        }

        /* --- USERS MANAGEMENT STYLES (SIMPLIFIED) --- */
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--header-bg);
        }
        
        .user-form-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid var(--secondary-color);
        }
        
        .user-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .user-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .users-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .delete-user-btn {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .delete-user-btn:hover {
            background: linear-gradient(135deg, #a93226, #c0392b);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(192, 57, 43, 0.3);
        }
        
        .no-users-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ddd;
            margin: 20px 0;
        }
        
        .users-search-container {
            position: relative;
            margin: 15px 0;
        }
        
        .users-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        #search-user-input {
            padding-right: 15px;
            padding-left: 45px;
            font-size: 0.95rem;
        }
        
        /* NEW STYLES FOR PASSWORD VISIBILITY */
        .password-cell {
            position: relative;
            padding-right: 30px !important;
        }
        
        .toggle-password-cell {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 14px;
            background: none;
            border: none;
            color: #666;
            display: none;
        }
        
        .password-masked {
            font-family: monospace;
            letter-spacing: 2px;
            color: #666;
        }
        
        .password-visible {
            font-family: monospace;
            letter-spacing: 1px;
            color: #333;
        }
        
        .user-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .type-admin { background-color: #d32f2f; color: white; }
        .type-engineer { background-color: #1976d2; color: white; }
        .type-supervisor { background-color: #388e3c; color: white; }
        .type-operator { background-color: #f57c00; color: white; }

        /* NEW: جدول بيانات المستخدمين مع تنسيق محسن */
        .users-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .users-data-table thead {
            background: linear-gradient(135deg, var(--profile-color), #8e44ad);
        }
        
        .users-data-table th {
            padding: 14px 12px;
            font-weight: 600;
            font-size: 0.95rem;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        .users-data-table th:first-child {
            border-right: none;
        }
        
        .users-data-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .users-data-table tr:hover {
            background-color: #f5f9ff;
        }
        
        .users-data-table .action-cell {
            min-width: 120px;
        }
        
        /* Pagination styles */
        .pagination-info {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .load-more-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 25px;
            background: linear-gradient(135deg, var(--secondary-color), #3498db);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        .load-more-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
            background: linear-gradient(135deg, #2980b9, var(--secondary-color));
        }
        
        .load-more-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Card for user data screen */
        .user-data-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .user-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--header-bg);
        }
        
        .user-data-title {
            color: var(--profile-color);
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        /* تصدير Excel button */
        .export-excel-btn {
            background: linear-gradient(135deg, var(--excel-color), #2e8b57);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .export-excel-btn:hover {
            background: linear-gradient(135deg, #1e5e3b, var(--excel-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 115, 70, 0.3);
        }
        
        /* شاشة تصدير تقرير الفحص */
        .inspection-export-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* علامة تنبيه الضغط العالي */
        .pressure-warning {
            display: inline-block;
            background-color: #ff9800;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 18px;
            margin-right: 5px;
            animation: pulse-orange 2s infinite;
            vertical-align: middle;
        }
        
        @keyframes pulse-orange {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 5px rgba(255, 152, 0, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
        
        /* تصميم خاص لصف تغيير الحالة في السجل */
        .status-change-row {
            background-color: #e8f5e9 !important;
            border-right: 4px solid #4caf50 !important;
            font-weight: bold;
        }
        
        .status-change-row.status-to-inactive {
            background-color: #ffebee !important;
            border-right: 4px solid #f44336 !important;
        }
        
        .status-change-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .status-change-active {
            background-color: #4caf50;
            color: white;
        }
        
        .status-change-inactive {
            background-color: #f44336;
            color: white;
        }
/* تنسيقات القائمة العائمة وزر القائمة - انسخ هذا الجزء */
.menu-btn { 
    background: transparent; border: none; color: white; 
    font-size: 1.4rem; cursor: pointer; margin-left: 10px;
    min-width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
}
.menu-btn:hover { background: rgba(255, 255, 255, 0.1); }

.floating-menu {
    position: fixed; top: 60px; right: 10px;
    background: white; border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 2000; display: none; flex-direction: column;
    min-width: 200px; overflow: hidden;
}
.floating-menu.active { display: flex; animation: fadeInUp 0.3s ease; }

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.menu-item {
    padding: 12px 15px; border-bottom: 1px solid #eee;
    display: flex; align-items: center; gap: 10px;
    cursor: pointer; background: none; border: none;
    width: 100%; text-align: right; font-size: 1rem; color: #333;
    font-family: inherit;
}
.menu-item:hover { background: #f5f5f5; }
.menu-item.logout { color: #c0392b; border-top: 2px solid #eee; }
/* =========================================
   تنسيقات شاشة الحاسبة (جديد)
   ========================================= */
#calculator-screen .section-card {
    background: white;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    border: 1px solid #eee;
}

#calculator-screen .machine-card {
    background: #fff;
    border: 1px solid #e1e8ed;
    border-right: 5px solid #3498db;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    transition: all 0.3s ease;
}

#calculator-screen .input-group { flex-grow: 1; }
#calculator-screen input[type="number"] { width: 100%; box-sizing: border-box; }

#calculator-screen .btn-add { background-color: #3498db; color: white; width: 100%; margin-bottom: 15px; }
#calculator-screen .btn-calc { background-color: #27ae60; color: white; width: 100%; font-size: 16px; padding: 12px; }
#calculator-screen .btn-delete { background-color: #e74c3c; color: white; padding: 5px 10px; font-size: 14px; }

#calculator-screen .grand-total-box {
    background: #2c3e50;
    color: white; padding: 15px;
    border-radius: 10px; margin-top: 20px; display: none;
}
#calculator-screen .total-row {
    display: flex; justify-content: space-between; margin-bottom: 8px;
    border-bottom: 1px solid #34495e; padding-bottom: 5px; font-size: 0.9rem;
}
#calculator-screen .highlight { color: #f1c40f; font-weight: bold; }

/* تنسيق المحولات */
#calculator-screen .tool-selector {
    width: 100%; padding: 10px;
    border: 2px solid #3498db; border-radius: 8px;
    margin-bottom: 15px; background-color: #f8fbff;
}
#calculator-screen .converter-box {
    background: #fdfdfd; border: 1px solid #eee;
    padding: 15px; border-radius: 10px; display: none;
    animation: fadeIn 0.5s;
}
#calculator-screen .converter-box.active { display: block; }
#flowConverter { border-top: 4px solid #e67e22; }
#powerConverter { border-top: 4px solid #8e44ad; }
#calculator-screen .converter-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
#calculator-screen .unit-select { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
#calculator-screen .result-display {
    background: #e9ecef; padding: 10px; border-radius: 6px;
    text-align: center; font-size: 1.2em; font-weight: bold;
}
/* --- تنسيقات شاشة البلاغات وأوامر الشغل (جديد) --- */
.fault-reporting-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
.work-order-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; display: inline-block; margin: 1px; }
.dept-mech { background-color: #e67e22; } /* ميكانيكا */
.dept-elec { background-color: #f1c40f; color: #333; } /* كهرباء */
.dept-ic { background-color: #9b59b6; } /* I&C */
.dept-net { background-color: #3498db; } /* شبكات */
.dept-hvac { background-color: #1abc9c; } /* تكييف */
.dept-civil { background-color: #7f8c8d; } /* تجهيزات */

/* تنسيق النوافذ المنبثقة (Modals) */
.custom-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
.custom-modal.show { display: flex; animation: fadeIn 0.3s; }
.modal-content { background-color: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
.modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }
.close-modal { cursor: pointer; font-size: 1.5rem; color: #aaa; }
.close-modal:hover { color: #000; }
.dept-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
.dept-option { display: flex; align-items: center; gap: 5px; background: #f9f9f9; padding: 8px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; }
.dept-option:hover { background: #eaf2f8; }

/* تنسيق الجداول الجديدة */
.reports-table th { background-color: #2c3e50; font-size: 0.9rem; }
.reports-table td { font-size: 0.9rem; vertical-align: middle; }
.action-btn-group { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
/* =========================================
   تنسيقات شاشة معلومات الطوارئ
   ========================================= */
.emergency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

@media (max-width: 768px) {
    .emergency-grid {
        grid-template-columns: 1fr;
    }
}

.emergency-item {
    background: linear-gradient(135deg, #fff, #f8f9fa);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.emergency-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-color: var(--secondary-color);
}

.emergency-item::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
    border-radius: 0 12px 12px 0;
}

.emergency-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 12px;
    margin-bottom: 15px;
    font-size: 1.5rem;
}

.emergency-item:nth-child(1) .emergency-icon { background-color: #e3f2fd; color: #1976d2; }
.emergency-item:nth-child(2) .emergency-icon { background-color: #fff3e0; color: #f57c00; }
.emergency-item:nth-child(3) .emergency-icon { background-color: #fce4ec; color: #c2185b; }
.emergency-item:nth-child(4) .emergency-icon { background-color: #e8f5e9; color: #388e3c; }

.emergency-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.emergency-number {
    font-size: 1.3rem;
    font-weight: 800;
    color: var(--primary-color);
    margin: 10px 0;
    direction: ltr;
    text-align: center;
    background: #f8f9fa;
    padding: 8px;
    border-radius: 8px;
    border: 2px dashed #ddd;
}

.emergency-desc {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-top: 10px;
}

.emergency-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #dee2e6;
}

.emergency-form-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
}

.emergency-form-item h5 {
    color: var(--primary-color);
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
    font-size: 1rem;
}

.emergency-form-item .form-group {
    margin-bottom: 12px;
}

.emergency-form-item .form-group label {
    font-size: 0.85rem;
    color: #555;
    margin-bottom: 5px;
    display: block;
}

.emergency-form-item .form-group input {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: border 0.3s;
}

.emergency-form-item .form-group input:focus {
    border-color: var(--secondary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(46, 134, 193, 0.1);
}

.emergency-delete-btn {
    background: #fff5f5;
    color: #e74c3c;
    border: 1px solid #ffcdd2;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
    transition: all 0.3s;
}

.emergency-delete-btn:hover {
    background: #ffebee;
    transform: translateY(-1px);
}

/* تنسيقات الصورة الكاملة */
#emergency-image-modal .modal-content {
    background: rgba(0, 0, 0, 0.9) !important;
    padding: 0 !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

#emergency-image-fullscreen {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
}

/* مؤشر التحميل */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--secondary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* رسائل الحالة */
.emergency-alert {
    padding: 12px 15px;
    border-radius: 8px;
    margin: 10px 0;
    display: none;
    animation: fadeIn 0.3s;
}

.emergency-alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.emergency-alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.emergency-alert-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}
/* تنسيق زر الإضافة الجديد */
#add-new-member-template button {
    transition: all 0.3s ease;
}

#add-new-member-template button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

#add-new-member-template {
    cursor: pointer;
    transition: all 0.3s ease;
}

#add-new-member-template:hover {
    border-color: #2980b9;
    background: #eaf2f8;
}
/* تنسيقات إضافية لزر الحذف */
#btn-delete-history {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    border: none;
    border-radius: 6px;
    padding: 0 15px;
    font-weight: bold;
    transition: all 0.3s ease;
}

#btn-delete-history:hover {
    background: linear-gradient(135deg, #a93226, #c0392b);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(192, 57, 43, 0.3);
}

/* تنسيقات زر الحذف في النافذة المنبثقة */
#btn-confirm-delete {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    border: none;
    padding: 12px;
    font-size: 1rem;
    font-weight: bold;
}

#btn-confirm-delete:hover {
    background: linear-gradient(135deg, #a93226, #c0392b);
}

/* تنسيقات أزرار العد السريع */
.btn-outline.btn-sm {
    padding: 5px 10px;
    font-size: 0.8rem;
    border: 1px solid #ddd;
}

.btn-outline.btn-sm:hover {
    border-color: var(--primary-color);
    background-color: #f0f7ff;
}

/* تنسيق حقل العدد */
#delete-count {
    border: 2px solid var(--danger-color);
    border-radius: 6px;
    padding: 10px;
    background-color: #fff5f5;
    color: #c0392b;
}
    </style>
</head>
<body>
<header>
    <div class="container">
        <div class="header-content">
            <div class="logo">
                <i>💧</i> <span>نظام المياه الذكي (Toshka)</span>
            </div>
            
            <div id="network-status-indicator" class="network-status net-online">
                <span id="net-icon">🟢</span> <span id="net-text">متصل</span>
            </div>
            
            <div class="user-info" id="header-user-info">
                <button id="menu-btn" class="menu-btn" title="القائمة">☰</button>
                
                <button id="alarm-btn" class="alarm-btn" title="سجل الأعطال">
                    🔔 <span id="alarm-count" class="alarm-count" style="display:none">0</span>
                </button>
                
                <div class="user-badge" id="current-user">مرحباً</div>
            </div>
        </div>
    </div>
</header>

<div id="floating-menu" class="floating-menu">
    <button id="users-management-btn" class="menu-item" style="display: none;">👥 المستخدمين</button>
    <button id="consumptions-btn" class="menu-item" style="display: none;">⚡ الاستهلاكات</button>
    <button id="history-management-btn" class="menu-item" style="display: none;">📜 السجل العام</button>
    <button id="export-inspection-report-btn" class="menu-item" style="display: none;">📊 تصدير الفحص</button>
<button id="fault-reporting-btn" class="menu-item">📢 بلاغات الأعطال</button>
<button id="work-orders-btn" class="menu-item" style="display: none;">🛠️ أوامر الشغل</button>
<button id="calculator-btn" class="menu-item">🧮 الحاسبة</button>
<button id="emergency-info-btn" class="menu-item">🚨 معلومات الطوارئ</button>
    <button id="profile-btn" class="menu-item">📋 بياناتي الشخصية</button>
    <button id="logout-btn" class="menu-item logout">👋 خروج</button>
</div>

    <div class="container">
        <div id="offline-sync-banner">
            يوجد <b><span id="offline-count">0</span></b> عمليات معلقة.
سيتم رفعها تلقائياً عند عودة الإنترنت. ⏳
        </div>

        <div id="login-screen" class="screen active">
            <div class="login-form">
                <h2>تسجيل الدخول</h2>
                <div class="form-group">
                    <label>اسم المستخدم</label>
                    <input type="text" id="username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <div class="password-container">
                        <input type="password" id="password" placeholder="admin123">
                        <span class="toggle-password" id="toggle-password-icon">👁️</span>
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">تذكرني</label>
                </div>
                <button id="login-btn" class="btn" style="width: 100%; background-color: #bdc3c7; color: #fff; cursor: not-allowed;" disabled>جاري الاتصال بالنظام...</button>
            </div>
            <div class="signature">Implemented by Ahmed Salah Ibrahim 2025 V1.5.9</div>
        </div>

        <div id="stations-screen" class="screen">
            <div id="ticker-container" class="ticker-container">
                <div class="ticker-label">⚠️</div>
                <div class="ticker-text-wrap">
                    <div id="ticker-content" class="ticker"></div>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card"><div class="stat-label">الإجمالي</div><div class="stat-value" id="total-stations">0</div></div>
                <div class="stat-card"><div class="stat-label">النشطة</div><div class="stat-value" id="active-stations">0</div></div>
                <div class="stat-card"><div class="stat-label">المتوقفة</div><div class="stat-value" id="inactive-stations">0</div></div>
            </div>
            <div id="repair-alert" class="alert alert-success" style="display:none; margin-top:10px;"></div>
            <div class="nav-tabs" id="zones-tabs"></div>
            <div id="stations-container" class="stations-wrapper">
                <div style="text-align:center; padding:20px; color:#666;">جاري تحميل البيانات ومزامنة المحطات...</div>
            </div>
        </div>

        <div id="station-screen" class="screen">
            <h2 id="station-title">التفاصيل</h2>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="back-to-stations" class="btn btn-outline">عودة للقائمة</button>
                <button id="view-inspection-btn" class="btn btn-info">📋 عرض الفحص</button>
            </div>
            
            <div id="station-fault-banner" class="alert" style="background: #ffecec; color: #b71c1c; border: 1px solid #ffcdd2; margin-top: 15px; display: none;">
                <div style="margin-bottom: 5px;">⚠️ <b>الأعطال المسجلة حالياً:</b></div>
                <ul id="station-fault-list" style="padding-right: 20px; margin: 0;"></ul>
            </div>

            <div class="station-details" style="margin-top: 20px;">
                <div class="detail-card"><div class="detail-title">الحالة</div><div class="detail-value" id="station-status-value">-</div></div>
                <div class="detail-card"><div class="detail-title">المشغل</div><div class="detail-value operator-highlight" id="operator-name-value">-</div></div>
                <div class="detail-card"><div class="detail-title">الجهد الكهربي (V)</div><div class="detail-value" id="voltage-value">-</div></div>
                <div class="detail-card"><div class="detail-title">الضغط (Bar)</div><div class="detail-value" id="station-pressure-value">-</div></div>
                <!-- إضافة خانة اقصى ضغط -->
                <div class="detail-card"><div class="detail-title">اقصى ضغط (Bar)</div><div class="detail-value" id="max-pressure-value">-</div></div>
                <div class="detail-card"><div class="detail-title">المضخات العاملة</div><div class="detail-value" id="active-pumps-value">-</div></div>
                <div class="detail-card"><div class="detail-title">التدفق (L/Sec)</div><div class="detail-value" id="water-flow-value">-</div></div>
                <div class="detail-card"><div class="detail-title">النظام</div><div class="detail-value" id="system-mode-value">-</div></div>
                
                <div style="grid-column: 1 / -1; display: flex; gap: 10px;">
                    <div class="detail-card" style="flex: 1;"><div class="detail-title">وقت بدء التشغيل</div><div class="detail-value" id="start-time-value" style="color:var(--success-color); font-weight:bold;">-</div></div>
                    <div class="detail-card" style="flex: 1;"><div class="detail-title">وقت الإيقاف</div><div class="detail-value" id="stop-time-value" style="color:var(--danger-color); font-weight:bold;">-</div></div>
                </div>

                <div style="grid-column: 1 / -1; margin-top:10px; border-top: 1px solid #eee; padding-top:10px;">
                    <h4 style="color:var(--consumption-color); margin-bottom:10px;">📊 آخر قراءة استهلاك</h4>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <div class="detail-card" style="flex:1; min-width:140px; border-left: 3px solid var(--consumption-color);">
                            <div class="detail-title">محول 1 (KW)</div>
                            <div class="detail-value" id="view-cons-t1">-</div>
                        </div>
                        <div class="detail-card" style="flex:1; min-width:140px; border-left: 3px solid var(--consumption-color);">
                            <div class="detail-title">محول 2 (KW)</div>
                            <div class="detail-value" id="view-cons-t2">-</div>
                        </div>
                        <div class="detail-card" style="flex:1; min-width:140px; border-left: 3px solid var(--consumption-color);">
                            <div class="detail-title">مياه (M3)</div>
                            <div class="detail-value" id="view-cons-m3">-</div>
                        </div>
                    </div>
                    <div style="text-align:left; font-size:0.8rem; color:#888; margin-top:5px;">تاريخ آخر تحديث للاستهلاك: <span id="view-cons-date">-</span></div>
                </div>

                <div class="detail-card" style="grid-column: 1 / -1; margin-top:10px;"><div class="detail-title">آخر تحديث (System)</div><div class="detail-value" id="last-update-value" style="font-size:0.8rem; color:#666;">-</div></div>
                
                <div class="detail-card" style="grid-column: 1 / -1; background-color: #fffde7;">
                    <div class="detail-title">ملاحظات التشغيل</div>
                    <div class="detail-value" id="station-comments-value" style="font-weight: normal; font-size: 1rem;">-</div>
                </div>
            </div>
            <h3>المضخات</h3>
            <div class="table-responsive">
                <table class="pumps-table">
                    <thead><tr><th>رقم</th><th>الحالة</th><th>سحب</th><th>طرد</th><th>تردد</th></tr></thead>
                    <tbody id="pumps-table-body"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px;">
                <button id="edit-station-btn" class="btn btn-primary" style="width: 100%;">تعديل / تسجيل عطل</button>
            </div>
        </div>

        <div id="operator-screen" class="screen">
            <h2>تحديث بيانات / إدارة الأعطال</h2>
            <h3 id="editing-station-name" style="text-align: center; color: var(--secondary-color); margin-bottom: 20px; border-bottom: none;"></h3>
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
                <button id="back-to-station" class="btn btn-outline">إلغاء</button>
                <button id="edit-inspection-btn" class="btn btn-info">📋 شاشة الفحص</button>
            </div>
            <div id="operator-alert" class="alert"></div>

            <div id="active-fault-control" style="background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
                <h4 style="color: #856404; margin-bottom: 10px;">🛑 تنبيه: أعطال نشطة</h4>
                <div id="fault-row-1" class="fault-row-action" style="display:none;">
                    <div><span style="font-weight:bold;">عطل 1:</span> <span id="txt-fault-1"></span></div>
                    <button id="btn-resolve-f1" class="btn btn-success btn-sm">✅ إصلاح</button>
                </div>
            
                <div id="fault-row-2" class="fault-row-action" style="display:none;">
                    <div><span style="font-weight:bold;">عطل 2:</span> <span id="txt-fault-2"></span></div>
                    <button id="btn-resolve-f2" class="btn btn-success btn-sm">✅ إصلاح</button>
                </div>
            </div>

            <div class="operator-form">
                <div class="form-section">
                    <h3>بيانات عامة</h3>
                    <div class="form-group"><label>المشغل الحالي</label><input type="text" id="operator-name" readonly style="background: #eee;"></div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>وقت التشغيل 🟢</label>
                            <input type="time" id="operator-start-time" style="direction: ltr;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>وقت الإيقاف 🔴</label>
                            <input type="time" id="operator-stop-time" style="direction: ltr;">
                        </div>
                    </div>

                    <div class="form-group"><label>الجهد الكهربي (V)</label><input type="number" id="operator-voltage"></div>
                    <div class="form-group"><label>الضغط (Bar)</label><input type="number" id="operator-pressure" step="0.1"></div>
                    <!-- إضافة خانة اقصى ضغط للمشغل -->
                    <div class="form-group"><label>اقصى ضغط (Bar)</label><input type="number" id="operator-max-pressure" step="0.1" readonly></div>
                    <div class="form-group"><label>التدفق (L/Sec)</label><input type="number" id="operator-water-flow"></div>
                    <div class="form-group">
                        <label>النظام</label>
                        <select id="operator-system-mode">
                            <option value="SCADA">SCADA</option><option value="PLC">PLC</option><option value="MIMIC">MIMIC</option><option value="LCP">LCP</option><option value="Marshalling">Marshalling</option><option value="HMI">HMI</option>
                        </select>
                    </div>
                </div>
               

                <div class="form-section">
                    <h3>حالة المضخات</h3>
                    <div id="pumps-form-container" class="pump-controls"></div>
                </div>
                
                <div class="form-section">
                    <div class="form-group" style="border: 2px dashed var(--danger-color); padding: 10px; border-radius: 6px; background: #fff5f5;">
                        <label style="color: var(--danger-color);">⚠️ تسجيل عطل جديد</label>
                        <div id="fault-selectors-group">
                            <label style="font-size:0.9rem; margin-top:5px;">عطل رقم (1):</label>
                            <select id="fault-selector" style="border-color: var(--danger-color);">
                                <option value="">-- المحطة تعمل بشكل طبيعي --</option>
                                <option value="انقطاع التيار الكهربي">انقطاع التيار الكهربي ⚡</option>
                                <option value="انخفاض جهد">انخفاض جهد ⚡📉</option>
                                <option value="ارتفاع جهد">ارتفاع جهد ⚡📈</option>
                                <option value="انخفاض منسوب">انخفاض منسوب 📉</option>
                                <option value="توقف منظومة التحضير">توقف منظومة التحضير عن العمل ⚙️</option>
                                <option value="انسدادات">انسدادات ▦</option>
                                <option value="تسريب مياه">تسريب مياه بالمحطة 💧</option>
                                <option value="كسر في الشبكة">كسر في شبكة المياه 🛠️</option>
                                <option value="عجز تحقيق الضغط">عجز تحقيق الضغط 🔻</option>
                                <option value="انقطاع الاتصال SCADA">انقطاع الاتصال SCADA 📡</option>
                            </select>
                            <input type="text" id="fault-1-desc" placeholder="وصف العطل / ملاحظات..." class="desc-input">

                            <label style="font-size:0.9rem; margin-top:10px;">عطل رقم (2):</label>
                            <select id="fault-selector-secondary" style="border-color: #e67e22;">
                                <option value="">-- لا يوجد عطل آخر --</option>
                                <option value="انقطاع التيار الكهربي">انقطاع التيار الكهربي ⚡</option>
                                <option value="انخفاض جهد">انخفاض جهد ⚡📉</option>
                                <option value="ارتفاع جهد">ارتفاع جهد ⚡📈</option>
                                <option value="انخفاض منسوب">انخفاض منسوب 📉</option>
                                <option value="توقف منظومة التحضير">توقف منظومة التحضير عن العمل ⚙️</option>
                                <option value="انسدادات">انسدادات ▦</option>
                                <option value="تسريب مياه">تسريب مياه بالمحطة 💧</option>
                                <option value="كسر في الشبكة">كسر في شبكة المياه 🛠️</option>
                                <option value="عجز تحقيق الضغط">عجز تحقيق الضغط 🔻</option>
                                <option value="انقطاع الاتصال SCADA">انقطاع الاتصال SCADA 📡</option>
                            </select>
                            <input type="text" id="fault-2-desc" placeholder="وصف العطل / ملاحظات..." class="desc-input">
                        </div>
                    </div>

                    <div class="form-group" style="border: 2px solid var(--consumption-color); padding: 10px; border-radius: 6px; background: #eaf2f8; margin-top: 15px;">
                        <label style="color: var(--consumption-color); font-size: 1.1rem;">⚡ تسجيل استهلاكات المحطة</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex:1">
                                <label style="font-size: 0.9rem;">محول (1) KW</label>
                                <input type="number" id="cons-trans-1" placeholder="KW">
                            </div>
                            <div style="flex:1">
                                <label style="font-size: 0.9rem;">محول (2) KW</label>
                                <input type="number" id="cons-trans-2" placeholder="KW">
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.9rem;">المنصرف من المياه (M3)</label>
                            <input type="number" id="cons-water-m3" placeholder="متر مكعب">
                        </div>
                    </div>

                    <div class="form-group"><label>ملاحظات عامة</label><textarea id="operator-comments" rows="3"></textarea></div>
                    <div class="form-actions"><button id="save-operator-data" class="btn btn-success" style="width: 100%;">حفظ البيانات</button></div>
                </div>
            </div>
        </div>

        <div id="inspection-screen" class="screen">
            <h2 id="inspection-title">شاشة الفحص الشامل</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <button id="back-from-inspection" class="btn btn-outline">عودة</button>
                <!-- زر تصدير Excel -->
                <button id="export-inspection-excel" class="btn btn-excel" style="display: none;">📊 تصدير Excel</button>
            </div>
            
            <div id="inspection-container"></div>
            
            <div id="inspection-actions" style="margin-top:10px; display:none; position:sticky; bottom:10px; z-index:999;">
                <button id="save-inspection-btn" class="btn btn-success">💾 حفظ الفحص بالكامل</button>
            </div>
        </div>

        <!-- شاشة جديدة: تصدير تقرير الفحص -->
        <div id="inspection-export-screen" class="screen">
            <h2 style="color: var(--excel-color);">تصدير تقرير الفحص الشامل</h2>
            <button id="back-to-stations-from-export" class="btn btn-outline">عودة للرئيسية</button>
            
            <div class="inspection-export-controls">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">🔧 إعدادات التصدير</h3>
                <div class="export-options">
                    <div class="form-group">
                        <label>المنطقة</label>
                        <select id="export-filter-zone">
                            <option value="all">كل المناطق</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>المحطة</label>
                        <select id="export-filter-station">
                            <option value="all">كل المحطات</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>نوع التقرير</label>
                        <select id="export-report-type">
                            <option value="full">تقرير كامل</option>
                            <option value="summary">ملخص فقط</option>
                            <option value="faults">الأعطال فقط</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>تنسيق الملف</label>
                        <select id="export-file-format">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button id="generate-inspection-report" class="export-excel-btn" style="padding: 12px 30px; font-size: 16px;">
                        📊 توليد وتصدير التقرير
                    </button>
                </div>
                
                <div id="export-status" style="margin-top: 15px; display: none; padding: 10px; border-radius: 6px; text-align: center;"></div>
            </div>
            
            <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 10px;">📋 معلومات التقرير</h4>
                <ul style="padding-right: 20px;">
                    <li>التقرير يشمل جميع بيانات الفحص للمحطات المحددة</li>
                    <li>بيانات المضخات مفصلة حسب حالة كل مضخة</li>
                    <li>يمكن تصفية البيانات في Excel باستخدام الفلاتر</li>
                    <li>التقرير مناسب للطباعة والمراجعة الدورية</li>
                    <li>يشمل التاريخ والوقت لتحديث كل محطة</li>
                </ul>
            </div>
        </div>

        <div id="consumptions-report-screen" class="screen">
            <h2 style="color: var(--consumption-color);">تقرير معدلات الاستهلاك</h2>
            <button id="back-to-stations-from-cons" class="btn btn-outline">عودة</button>
            <div style="font-size:0.9rem; color:#666; margin-top:5px;">يقوم التقرير بحساب الاستهلاك بطرح (أول قراءة في فترة "إلى" - أول قراءة في فترة "من").</div>
            <div class="filters-container" style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; margin-top:10px; display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
    <div class="filter-item">
        <label>المنطقة</label>
        <select id="cons-filter-zone" onchange="updateConsStationFilter()">
            <option value="all">كل المناطق</option>
        </select>
    </div>
    
    <div class="filter-item">
        <label>المحطة</label>
        <select id="cons-filter-station">
            <option value="all">كل المحطات</option>
        </select>
    </div>

    <div class="filter-item"><label>من تاريخ</label><input type="date" id="cons-filter-date-from"></div>
    <div class="filter-item"><label>إلى تاريخ</label><input type="date" id="cons-filter-date-to"></div>
    
    <div class="filter-item" style="display:flex; align-items:flex-end; gap:5px;">
        <button class="btn btn-primary" onclick="renderConsumptionsTable()" style="flex:1">حساب</button>
        <button class="btn btn-excel" onclick="exportConsumptionsToExcel()" style="flex:1" title="تصدير Excel">Excel 📥</button>
    </div>
</div>
            
            <div class="table-responsive">
                <table class="history-table" id="consumptions-table-export">
                    <thead>
                        <tr>
                            <th>المحطة</th>
                            <th>استهلاك محول 1 (KW)</th>
                            <th>استهلاك محول 2 (KW)</th>
                            <th>استهلاك مياه (M3)</th>
                        </tr>
                    </thead>
                    <tbody id="consumptions-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="faults-log-screen" class="screen">
            <h2 style="color: var(--danger-color);">سجل الأعطال</h2>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="back-to-stations-from-faults" class="btn btn-outline">عودة</button>
            </div>
            
            <div style="margin-top:20px;">
                <h3 style="margin-bottom:10px;">الأعطال النشطة حالياً</h3>
                <div class="table-responsive">
                    <table class="faults-table">
                        <thead><tr><th>المحطة</th><th>العطل</th><th>وقت البدء</th><th>المدة</th></tr></thead>
                        <tbody id="active-faults-body"></tbody>
                    </table>
                </div>
                
                <h3 style="margin-bottom:10px; margin-top:30px;">أرشيف الأعطال السابقة</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: #fff3cd; padding: 10px; border-radius: 6px; border: 1px solid #ffeeba;">
                    <label style="margin:0; font-weight:bold;">🔍 تصفية الأرشيف:</label>
                    <select id="fault-archive-station-filter" style="flex:1; max-width:300px;" onchange="appData.faultsLimit=100; renderFaultsLog();">
                        <option value="all">-- عرض كافة المحطات --</option>
                    </select>
                </div>

                <div class="table-responsive">
                    <table class="faults-table">
                        <thead><tr><th>المحطة</th><th>العطل</th><th>وقت البدء</th><th>وقت الإصلاح</th><th>الحالة</th></tr></thead>
                        <tbody id="history-faults-body"></tbody>
                    </table>
                </div>

                <div class="pagination-controls">
                    <p id="faults-status-text" class="status-text"></p>
                    <button id="load-more-faults-btn" class="btn btn-warning" style="display: none; width: 200px; margin: 0 auto;">⚠️ عرض 100 عطل إضافي</button>
                </div>
            </div>
        </div>

        <!-- شاشة بيانات المستخدم الجديدة -->
        <div id="user-profile-screen" class="screen">
            <h2 style="color: var(--profile-color);">إدارة بيانات المستخدمين</h2>
            <button id="back-to-stations-from-profile" class="btn btn-outline">عودة للرئيسية</button>
            
            <div class="profile-alert" id="profile-alert"></div>
            
            <div class="profile-container">
                <!-- القسم الأول: تسجيل البيانات الشخصية -->
                <div class="profile-card">
                    <h3 style="color: var(--profile-color); margin-bottom: 20px;">📝 تسجيل البيانات الشخصية</h3>
                    <div class="profile-form-grid">
                        <div class="form-group full-width">
                            <label>اسم المستخدم الحالي</label>
                            <input type="text" id="profile-username" readonly style="background: #f0f0f0; font-weight: bold;">
                        </div>
                        
                        <div class="form-group">
                            <label>الاسم الثلاثي <span style="color: red;">*</span></label>
                            <input type="text" id="profile-fullname" placeholder="الاسم الكامل">
                        </div>
                        
                        <div class="form-group">
                            <label>رقم المحطة <span style="color: red;">*</span></label>
                            <select id="profile-station">
                                <option value="">-- اختر المحطة --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>رقم الهاتف <span style="color: red;">*</span></label>
                            <input type="tel" id="profile-phone" placeholder="مثال: 01012345678">
                        </div>
                        
                        <div class="form-group">
                            <label>رقم الواتساب</label>
                            <input type="tel" id="profile-whatsapp" placeholder="مثال: 01012345678">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="profile-email" placeholder="مثال: user@example.com">
                        </div>
                        
                        <div class="form-group full-width" style="margin-top: 20px;">
                            <button id="save-profile-btn" class="btn btn-profile" style="width: 100%;">💾 حفظ البيانات الشخصية</button>
                        </div>
                    </div>
                </div>
                
                <!-- القسم الثاني: قائمة بيانات المستخدمين المسجلين -->
                <div class="profile-card">
                    <h3 style="color: var(--profile-color); margin-bottom: 20px;">👥 بيانات المستخدمين المسجلين</h3>
                    
                    <div class="profile-search-container">
                        <span class="profile-search-icon">🔍</span>
                        <input type="text" id="search-profile-input" placeholder="البحث عن مستخدم (الاسم أو المحطة)..." style="width: 100%;">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="users-profiles-table">
                            <thead>
                                <tr>
                                    <th>اسم المستخدم</th>
                                    <th>رقم المحطة</th>
                                    <th>الاسم الثلاثي</th>
                                    <th>رقم الهاتف</th>
                                    <th>رقم الواتساب</th>
                                    <th>البريد الإلكتروني</th>
                                    <th style="min-width: 120px;">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="users-profiles-list">
                                <!-- سيتم ملؤها بالبيانات من JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-profiles-message" class="no-profiles-message" style="display: none;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">📋</div>
                        <div>لا توجد بيانات مستخدمين مسجلة في النظام</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">يمكنك تسجيل بياناتك الشخصية في القسم الأيسر</div>
                    </div>
                    
                    <!-- Pagination for user profiles -->
                    <div class="pagination-info" id="profiles-pagination-info"></div>
                    <button id="load-more-profiles-btn" class="load-more-btn" style="display: none;">عرض المزيد من البيانات (100)</button>
                </div>
            </div>
        </div>

        <!-- شاشة إدارة بيانات المستخدمين -->
        <div id="users-data-screen" class="screen">
            <div class="user-data-card">
                <div class="user-data-header">
                    <h2 class="user-data-title">إدارة بيانات المستخدمين</h2>
                    <button id="back-to-stations-from-users-data" class="btn btn-outline">عودة للرئيسية</button>
                </div>
                
                <div class="users-search-container">
                    <span class="users-search-icon">🔍</span>
                    <input type="text" id="search-users-data-input" placeholder="البحث عن مستخدم (الاسم أو المحطة أو الهاتف)..." style="width: 100%;">
                </div>
                
                <div class="table-responsive">
                    <table class="users-data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم المستخدم</th>
                                <th>الاسم الثلاثي</th>
                                <th>نوع المستخدم</th>
                                <th>المحطة</th>
                                <th>رقم الهاتف</th>
                                <th>البريد الإلكتروني</th>
                                <th class="action-cell">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="users-data-table-body">
                            <!-- سيتم ملؤها بالبيانات -->
                        </tbody>
                    </table>
                </div>
                
                <div id="no-users-data-message" class="no-users-message" style="display: none;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">👥</div>
                    <div>لا توجد بيانات مستخدمين مسجلة في النظام</div>
                </div>
                
                <!-- Pagination controls -->
                <div class="pagination-info" id="users-data-pagination-info"></div>
                <button id="load-more-users-data-btn" class="load-more-btn">عرض المزيد من المستخدمين (100)</button>
            </div>
        </div>

        <div id="users-screen" class="screen">
            <div class="users-header">
                <h2>إدارة حسابات المستخدمين</h2>
                <button id="back-to-stations-from-users" class="btn btn-outline">عودة للرئيسية</button>
            </div>
            
            <div id="user-form-container" class="user-form-card" style="display: none;">
                <h4 id="user-form-title" style="margin-bottom:15px; color: var(--secondary-color);">مستخدم جديد</h4>
                <div class="user-form-grid">
                    <div class="form-group">
                        <label>اسم المستخدم</label>
                        <input type="text" id="new-username" placeholder="أدخل اسم المستخدم">
                    </div>
                    <div class="form-group">
                        <label>كلمة المرور</label>
                        <input type="text" id="new-password" placeholder="أدخل كلمة المرور">
                    </div>
                    <div class="form-group">
                        <label>نوع المستخدم</label>
                        <select id="new-user-type"></select>
                    </div>
                </div>
                <div class="user-action-buttons">
                    <button id="save-user-btn" class="btn btn-success" style="flex:1">💾 حفظ المستخدم</button>
                    <button id="cancel-user-btn" class="btn btn-danger" style="flex:1">❌ إلغاء</button>
                </div>
            </div>
            
            <div style="margin: 25px 0 15px; display:flex; justify-content:space-between; align-items:center;">
                <h3>قائمة حسابات المستخدمين</h3>
                <button id="add-user-btn" class="btn btn-primary">➕ إضافة مستخدم جديد</button>
            </div>
            
            <div class="users-search-container">
                <span class="users-search-icon">🔍</span>
                <input type="text" id="search-user-input" placeholder="البحث عن مستخدم (الاسم)..." onkeyup="renderUsersManagement()" style="width: 100%;">
            </div>
            
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>اسم المستخدم</th>
                            <th>نوع المستخدم</th>
                            <th>كلمة المرور</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
            
            <div id="no-users-message" class="no-users-message" style="display: none;">
                <div style="font-size: 2rem; margin-bottom: 10px;">👥</div>
                <div>لا توجد مستخدمين مسجلين في النظام</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">اضغط على زر "إضافة مستخدم جديد" لبدء إضافة المستخدمين</div>
            </div>
            
            <!-- Pagination for users -->
            <div class="pagination-info" id="users-pagination-info"></div>
            <button id="load-more-users-btn" class="load-more-btn">عرض المزيد من المستخدمين (100)</button>
        </div>

        <div id="history-screen" class="screen">
            <h2>سجل العمليات العام</h2>
            <button id="back-to-stations-from-history" class="btn btn-outline">عودة</button>
            <div class="filters-container" style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
    <div class="filter-item"><label>المنطقة</label><select id="filter-zone" onchange="updateStationFilter()"><option value="all">كل المناطق</option></select></div>
    <div class="filter-item"><label>المحطة</label><select id="filter-station"><option value="all">كل المحطات</option></select></div>
    <div class="filter-item"><label>من تاريخ</label><input type="date" id="filter-date-from"></div>
    <div class="filter-item"><label>إلى تاريخ</label><input type="date" id="filter-date-to"></div>
    
    <div class="filter-item" style="display:flex; align-items:flex-end;">
        <button class="btn btn-primary" onclick="renderHistoryTable(true)" style="width:100%">بحث وتصفية 🔍</button>
    </div>

    <div class="filter-item" style="display:flex; align-items:flex-end; gap: 5px;">
        <select id="history-export-format" style="height: 38px; border: 1px solid var(--excel-color);">
            <option value="xlsx">Excel (.xlsx)</option>
            <option value="csv">CSV (.csv)</option>
        </select>
        <button id="btn-export-history" class="btn btn-success" style="background-color: var(--excel-color); color: white; height: 38px; display: flex; align-items: center; justify-content: center;">
            تصدير 📥
        </button>
    </div>
<div class="filter-item" style="display:flex; align-items:flex-end; gap: 5px;">
    <button id="btn-delete-history" class="btn btn-danger" style="height: 38px; display: flex; align-items: center; justify-content: center; display: none;">
        🗑️ حذف السجلات
    </button>
</div>
</div>
            
            <div class="table-responsive">
                <table class="history-table">
                    <thead><tr><th style="width:12%">التاريخ والوقت</th><th style="width:12%">المحطة</th><th style="width:12%">المشغل</th><th style="width:12%">تشغيل</th><th style="width:12%">إيقاف</th><th>تفاصيل</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <p id="history-status-text" class="status-text"></p>
                <button id="load-more-history-btn" class="btn btn-primary" style="display: none; width: 200px; margin: 0 auto;">⬇️ عرض 100 سجل إضافي</button>
            </div>
        </div>
<div id="calculator-screen" class="screen">
    <h2 style="color: #2980b9;">🧮 حاسبة الري والمحولات</h2>
    <button id="back-to-stations-from-calc" class="btn btn-outline">عودة للرئيسية</button>

    <div class="section-card" style="margin-top: 15px;">
        <h3 style="font-size: 1.1rem; color: #2c3e50;"><i class="fas fa-water"></i> حساب مقننات الري</h3>
        
        <div id="machinesList"></div>

        <button class="btn btn-add" onclick="addMachineCalc()">
            ➕ إضافة جهاز جديد
        </button>

        <button class="btn btn-calc" onclick="calculateAllCalc()">
            🔢 احسب المشروع بالكامل
        </button>
        
        <p class="note" style="text-align:center; color:#777; font-size:0.8rem;">* يتم الحساب بناءً على طول برج قياسي <strong>55 متر</strong>.</p>

        <div id="grandTotalBox" class="grand-total-box">
            <h4 style="margin-top:0; text-align:center; color:#ecf0f1; border-bottom:1px solid #555; padding-bottom:5px;">ملخص المشروع</h4>
            <div class="total-row"><span>عدد الأجهزة:</span> <span id="calcTotalMachines">0</span></div>
            <div class="total-row"><span>إجمالي المساحة:</span> <span><span id="calcTotalFeddan" class="highlight">0</span> فدان</span></div>
            <div class="total-row"><span>إجمالي احتياج المضخة:</span> <span><span id="calcTotalM3" class="highlight">0</span> م³/س</span></div>
            <div class="total-row"><span>إجمالي التدفق:</span> <span><span id="calcTotalLPS" class="highlight">0</span> لتر/ث</span></div>
        </div>
    </div>

    <div class="section-card">
        <h3 style="font-size: 1.1rem; color: #2c3e50;"><i class="fas fa-exchange-alt"></i> أدوات التحويل الهندسية</h3>
        
        <label for="toolSelect" style="font-weight:bold; display:block; margin-bottom:5px;">اختر نوع المحول:</label>
        <select id="toolSelect" class="tool-selector" onchange="switchToolCalc()">
            <option value="none" disabled selected>-- اختر الأداة المطلوبة --</option>
            <option value="flow">محول التدفق (Volumetric Flow)</option>
            <option value="power">محول القدرة (Power)</option>
        </select>

        <div id="flowConverter" class="converter-box">
            <h4 style="color:#e67e22; margin-top:0;">💧 محول التدفق</h4>
            <div class="converter-row">
                <input type="number" id="flowInput" placeholder="أدخل القيمة" oninput="convertFlowCalc()">
            </div>
            <div class="converter-row">
                <span class="conv-label">من:</span>
                <select id="flowFrom" class="unit-select" onchange="convertFlowCalc()">
                    <option value="m3h">متر مكعب/ساعة (m³/h)</option>
                    <option value="ls">لتر/ثانية (L/s)</option>
                    <option value="gpm">جالون/دقيقة (US GPM)</option>
                </select>
            </div>
            <div class="converter-row">
                <span class="conv-label">إلى:</span>
                <select id="flowTo" class="unit-select" onchange="convertFlowCalc()">
                    <option value="ls">لتر/ثانية (L/s)</option>
                    <option value="m3h">متر مكعب/ساعة (m³/h)</option>
                    <option value="gpm">جالون/دقيقة (US GPM)</option>
                </select>
            </div>
            <div class="result-display" id="flowResult" style="color: #d35400;">0</div>
        </div>

        <div id="powerConverter" class="converter-box">
            <h4 style="color:#8e44ad; margin-top:0;">⚡ محول القدرة</h4>
            <div class="converter-row">
                <input type="number" id="powerInput" placeholder="أدخل القيمة" oninput="convertPowerCalc()">
            </div>
            <div class="converter-row">
                <span class="conv-label">من:</span>
                <select id="powerFrom" class="unit-select" onchange="convertPowerCalc()">
                    <option value="hp">حصان (HP)</option>
                    <option value="kw">كيلوواط (kW)</option>
                </select>
            </div>
            <div class="converter-row">
                <span class="conv-label">إلى:</span>
                <select id="powerTo" class="unit-select" onchange="convertPowerCalc()">
                    <option value="kw">كيلوواط (kW)</option>
                    <option value="hp">حصان (HP)</option>
                </select>
            </div>
            <div class="result-display" id="powerResult" style="color: #8e44ad;">0</div>
        </div>
    </div>
</div>
    </div>
<div id="fault-reporting-screen" class="screen">
    <h2 style="color: #c0392b;">📢 تسجيل ومتابعة البلاغات</h2>
    <button id="back-to-stations-from-reports" class="btn btn-outline">عودة للرئيسية</button>
    
    <div class="user-data-card" style="border-top: 4px solid #c0392b;">
        <h3 style="margin-bottom: 15px; color: #333;">تسجيل بلاغ جديد</h3>
        <div class="fault-reporting-grid">
            <div class="form-group"><label>مقدم البلاغ</label><input type="text" id="report-reporter" readonly style="background:#eee;"></div>
            <div class="form-group"><label>المنطقة</label><select id="report-zone" onchange="updateReportStations()"><option value="">اختر المنطقة</option></select></div>
            <div class="form-group"><label>المحطة</label><select id="report-station" onchange="updateReportComponents()"><option value="">اختر المحطة</option></select></div>
            <div class="form-group"><label>تحديد المكون/العطل</label><select id="report-component"><option value="">حدد مكان العطل</option></select></div>
        </div>
        <div class="form-group">
            <label>وصف العطل بالتفصيل</label>
            <textarea id="report-desc" rows="3" placeholder="اكتب وصفاً دقيقاً للمشكلة..."></textarea>
        </div>
        <button id="btn-send-report" class="btn btn-danger" style="width: 100%;">🚀 إرسال البلاغ</button>
    </div>

    <div style="margin-top: 30px;">
        <h3>📋 جدول متابعة البلاغات</h3>
        <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
            <select id="filter-report-zone" onchange="renderFaultReportsTable()"><option value="all">كل المناطق</option></select>
            <select id="filter-report-status" onchange="renderFaultReportsTable()">
                <option value="all">كل الحالات</option>
                <option value="pending">انتظار التأكيد</option>
                <option value="confirmed">تم تأكيد المشرف</option>
            </select>
            <button class="btn btn-excel" onclick="exportReportsTable()">تصدير Excel 📥</button>
        </div>

        <div class="table-responsive">
            <table class="reports-table">
                <thead>
                    <tr>
                        <th>التاريخ</th><th>الموقع</th><th>المبلغ</th><th>العطل</th><th>الوصف</th><th>الحالة</th><th>إجراءات المشرف</th><th>إجراءات الإدارة</th>
                    </tr>
                </thead>
                <tbody id="fault-reports-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="work-orders-screen" class="screen">
    <h2 style="color: #2980b9;">🛠️ إدارة أوامر الشغل</h2>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="back-to-stations-from-orders" class="btn btn-outline">عودة للرئيسية</button>
        <button id="btn-go-to-archive" class="btn btn-success">📂 أرشيف الإصلاحات</button>
    </div>

    <div style="margin-top: 20px;">
        <h3 style="color: #e67e22;">⚡ أوامر شغل جارية (تحت الإصلاح)</h3>
        
        <div class="filters-container" style="background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
            <select id="wo-filter-zone" class="form-control">
                <option value="">كل المناطق</option>
            </select>
            <input type="text" id="wo-filter-fault" placeholder="بحث في العطل/الوصف">
            <select id="wo-filter-dept" class="form-control">
                <option value="">كل الأقسام</option>
                <option value="ميكانيكا">ميكانيكا</option>
                <option value="كهرباء">كهرباء</option>
                <option value="I&C">تحكم (I&C)</option>
                <option value="شبكات">شبكات</option>
                <option value="تكييف">تكييف</option>
                <option value="تجهيزات">تجهيزات</option>
            </select>
            <input type="number" id="wo-filter-duration" placeholder="الحد الأدنى للمدة (يوم)">
            
            <button class="btn btn-primary" onclick="resetActiveLimit(); renderWorkOrdersTables()" style="grid-column: span 1;">بحث 🔍</button>
            <button class="btn btn-excel" onclick="exportActiveWorkOrders()" style="grid-column: span 1;">Excel 📥</button>
        </div>

        <div class="table-responsive">
            <table class="reports-table">
                <thead>
                    <tr>
                        <th>تاريخ الاستلام</th><th>الموقع</th><th>الأقسام المختصة</th><th>العطل</th><th>الوصف</th><th>الصادر عنه</th><th>المدة</th><th>الإجراء</th>
                    </tr>
                </thead>
                <tbody id="active-work-orders-body"></tbody>
            </table>
        </div>
        <button id="load-more-active-wo" class="btn btn-outline btn-sm" style="width: 100%; margin-top: 10px; display: none;" onclick="loadMoreActiveOrders()">⬇️ عرض 100 صف إضافي</button>
    </div>
</div>
<div id="archive-work-orders-screen" class="screen">
    <h2 style="color: #27ae60;">✅ أرشيف الإصلاحات (تم الإغلاق)</h2>
    <button id="back-from-archive" class="btn btn-outline">عودة لإدارة الأوامر</button>

    <div style="margin-top: 20px;">
        <div class="filters-container" style="margin-bottom: 10px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <label>بحث وتصفية الأرشيف:</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                <input type="text" id="archive-search" placeholder="بحث (المحطة، العطل، القائم بالإصلاح)..." onkeyup="resetArchiveLimit(); renderWorkOrdersTables()" style="flex: 1; min-width: 200px; padding: 8px;">
                <button class="btn btn-excel" onclick="exportWorkOrdersArchive()">تصدير الأرشيف Excel 📥</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="reports-table">
                <thead>
                    <tr>
                        <th>تواريخ</th><th>المدة</th><th>الموقع</th><th>القسم</th><th>العطل</th><th>الإصلاح وقطع الغيار</th><th>القائم بالإصلاح</th>
                    </tr>
                </thead>
                <tbody id="archive-work-orders-body"></tbody>
            </table>
        </div>
        <button id="load-more-archive-wo" class="btn btn-outline btn-sm" style="width: 100%; margin-top: 10px; display: none;" onclick="loadMoreArchiveOrders()">⬇️ عرض 100 صف إضافي</button>
    </div>
</div>
<div id="modal-dept-select" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header"><span>تحويل لأمر شغل</span><span class="close-modal" onclick="closeModal('modal-dept-select')">&times;</span></div>
        <p>يرجى تحديد الأقسام المختصة بهذا العطل:</p>
        <div class="dept-checkbox-group">
            <label class="dept-option"><input type="checkbox" value="ميكانيكا"> ميكانيكا ⚙️</label>
            <label class="dept-option"><input type="checkbox" value="كهرباء"> كهرباء ⚡</label>
            <label class="dept-option"><input type="checkbox" value="I&C"> تحكم (I&C) 🖥️</label>
            <label class="dept-option"><input type="checkbox" value="شبكات"> شبكات 💧</label>
            <label class="dept-option"><input type="checkbox" value="تكييف"> تكييف ❄️</label>
            <label class="dept-option"><input type="checkbox" value="تجهيزات"> تجهيزات 🏗️</label>
        </div>
        <button id="btn-confirm-work-order" class="btn btn-primary" style="width: 100%;">إصدار أمر الشغل</button>
    </div>
</div>

<div id="modal-fix-details" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header"><span>إتمام الإصلاح</span><span class="close-modal" onclick="closeModal('modal-fix-details')">&times;</span></div>
        <div class="form-group">
            <label>وصف عملية الإصلاح <span style="color:red">*</span></label>
            <textarea id="fix-desc" rows="3" class="input-field"></textarea>
        </div>
        <div class="form-group">
            <label>قطع الغيار المستخدمة (إن وجد)</label>
            <textarea id="fix-parts" rows="2" class="input-field" placeholder="اذكر قطع الغيار والكميات..."></textarea>
        </div>
        <button id="btn-confirm-fix" class="btn btn-success" style="width: 100%;">تأكيد وإغلاق الأمر ✅</button>
    </div>
</div>
<!-- نافذة منبثقة لحذف السجلات -->
<div id="modal-delete-history" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>🗑️ حذف السجلات القديمة</span>
            <span class="close-modal" onclick="closeModal('modal-delete-history')">&times;</span>
        </div>
        
        <div style="padding: 15px;">
            <p style="margin-bottom: 15px; color: #666;">
                يمكنك حذف أقدم السجلات من قاعدة البيانات. هذا الإجراء لا يمكن التراجع عنه.
            </p>
            
            <div class="form-group">
                <label>عدد السجلات المراد حذفها</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="setDeleteCount(10)">10</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="setDeleteCount(50)">50</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="setDeleteCount(100)">100</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="setDeleteCount(500)">500</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="setDeleteCount(1000)">1000</button>
                </div>
                <input type="number" id="delete-count" min="1" max="10000" value="100" 
                       style="text-align: center; font-size: 1.2rem; font-weight: bold;">
            </div>
            
            <div class="form-group">
                <label>الحد الأدنى للتاريخ (اختياري)</label>
                <input type="date" id="delete-before-date" style="width: 100%;">
            </div>
            
            <div class="alert alert-warning" style="display: block; margin: 15px 0; padding: 10px;">
                <div style="font-weight: bold; margin-bottom: 5px;">⚠️ تحذير هام:</div>
                <div style="font-size: 0.9rem;">
                    سيتم حذف <span id="delete-count-preview">100</span> سجل من أقدم السجلات.
                    هذا الإجراء <strong style="color: #c0392b;">لا يمكن التراجع عنه</strong>.
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-confirm-delete" class="btn btn-danger" style="flex: 1;">
                    🗑️ تأكيد الحذف
                </button>
                <button onclick="closeModal('modal-delete-history')" class="btn btn-outline" style="flex: 1;">
                    ❌ إلغاء
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modal-freeze" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="freeze-modal-title">❄️ تجميد أمر الشغل</span>
            <span class="close-modal" onclick="closeModal('modal-freeze')">&times;</span>
        </div>
        
        <div class="form-group">
            <label>سبب تجميد عملية الإصلاح <span style="color:red">*</span></label>
            <textarea id="freeze-reason-input" rows="3" class="input-field" placeholder="اكتب سبب توقف/تجميد العمل..."></textarea>
        </div>
        
        <div class="form-group">
            <label>قام بالتجميد</label>
            <input type="text" id="freeze-user-input" readonly style="background: #eee; font-weight: bold;">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button id="btn-save-freeze" class="btn btn-warning" style="flex: 1;">💾 حفظ التجميد</button>
            <button id="btn-resolve-from-freeze" class="btn btn-success" style="flex: 1; display: none;">✅ تم الإصلاح</button>
        </div>
    </div>
</div>
<!-- شاشة معلومات الطوارئ الجديدة -->
<div id="emergency-info-screen" class="screen">
    <div class="user-data-card">
        <div class="user-data-header">
            <h2 class="user-data-title">🚨 معلومات الطوارئ</h2>
            <button id="back-to-stations-from-emergency" class="btn btn-outline">عودة للرئيسية</button>
        </div>
        
        <!-- منطقة عرض صورة المعلومات -->
        <div class="section-card" style="margin-bottom: 25px;">
            <h3 style="color: #e74c3c; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                📸 معلومات الطوارئ المصورة
                <span class="user-profile-badge" style="background-color: #e74c3c;">مهم</span>
            </h3>
            
            <div id="emergency-image-container" style="text-align: center; margin: 20px 0;">
                <div id="no-emergency-image" class="no-users-message" style="display: block;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🖼️</div>
                    <div>لا توجد صورة معلومات طوارئ مرفوعة</div>
                    <div style="font-size: 0.9rem; margin-top: 10px; color: #666;">
                        قم برفع صورة تحتوي على معلومات الطوارئ
                    </div>
                </div>
                
                <div id="emergency-image-wrapper" style="display: none;">
                    <img id="emergency-image-display" src="" alt="معلومات الطوارئ" 
                         style="max-width: 100%; max-height: 500px; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
                         onclick="toggleEmergencyImageFullscreen()">
                    <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">انقر على الصورة لتكبيرها</p>
                </div>
                
                <!-- النافذة المنبثقة لعرض الصورة بحجم كامل -->
                <div id="emergency-image-modal" class="custom-modal">
                    <div class="modal-content" style="max-width: 95%; max-height: 95%; background: transparent; box-shadow: none;">
                        <div style="position: absolute; top: 15px; right: 15px; z-index: 1000;">
                            <button onclick="closeEmergencyImageModal()" style="background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        <img id="emergency-image-fullscreen" src="" alt="معلومات الطوارئ" 
                             style="width: 100%; height: auto; max-height: 90vh; border-radius: 8px; cursor: pointer;"
                             onclick="closeEmergencyImageModal()">
                    </div>
                </div>
            </div>
            
            <!-- أزرار التحكم (للمدير فقط) -->
            <div id="emergency-image-controls" style="display: none; text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">🛠️ تحكم المدير</h4>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button id="upload-emergency-image-btn" class="btn btn-primary" style="flex: 1; min-width: 150px;">
                        📤 رفع صورة جديدة
                    </button>
                    <button id="delete-emergency-image-btn" class="btn btn-danger" style="flex: 1; min-width: 150px;">
                        🗑️ حذف الصورة الحالية
                    </button>
                </div>
                <p style="color: #666; font-size: 0.85rem; margin-top: 15px;">
                    ⚠️ سيتم عرض الصورة لجميع المستخدمين فور رفعها
                </p>
            </div>
            
            <!-- حقل رفع الملف المخفي -->
            <input type="file" id="emergency-image-input" accept="image/*" style="display: none;">
        </div>
        
        <!-- الخدمات العامة -->
        <div class="section-card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #3498db; display: flex; align-items: center; gap: 8px;">
                    📞 الخدمات العامة
                    <span class="user-profile-badge">ضروري</span>
                </h3>
                <button id="edit-public-services-btn" class="btn btn-outline btn-sm" style="display: none;">
                    ✏️ تعديل
                </button>
            </div>
            
            <div id="public-services-view">
                <div class="emergency-grid">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <div id="public-services-edit" style="display: none;">
                <div class="emergency-form">
                    <div id="public-services-form-container">
                        <!-- سيتم ملؤها بشكل ديناميكي -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="save-public-services-btn" class="btn btn-success" style="flex: 1;">💾 حفظ التغييرات</button>
                        <button id="cancel-public-services-btn" class="btn btn-outline" style="flex: 1;">❌ إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- أعضاء فريق الطوارئ -->
        <div class="section-card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2ecc71; display: flex; align-items: center; gap: 8px;">
                    👥 أعضاء فريق الطوارئ
                    <span class="user-profile-badge" style="background-color: #2ecc71;">فريق</span>
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button id="add-emergency-team-btn" class="btn btn-primary btn-sm" style="display: none;">➕ إضافة عضو</button>
                    <button id="edit-emergency-team-btn" class="btn btn-outline btn-sm" style="display: none;">✏️ تعديل</button>
                </div>
            </div>
            
            <div id="emergency-team-view">
                <div class="emergency-grid">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <div id="emergency-team-edit" style="display: none;">
                <div class="emergency-form">
                    <div id="emergency-team-form-container">
                        <!-- سيتم ملؤها بشكل ديناميكي -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="save-emergency-team-btn" class="btn btn-success" style="flex: 1;">💾 حفظ التغييرات</button>
                        <button id="cancel-emergency-team-btn" class="btn btn-outline" style="flex: 1;">❌ إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- العيادة -->
        <div class="section-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #9b59b6; display: flex; align-items: center; gap: 8px;">
                    🏥 العيادة
                    <span class="user-profile-badge" style="background-color: #9b59b6;">صحة</span>
                </h3>
                <button id="edit-clinic-info-btn" class="btn btn-outline btn-sm" style="display: none;">
                    ✏️ تعديل
                </button>
            </div>
            
            <div id="clinic-info-view">
                <div class="emergency-grid">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <div id="clinic-info-edit" style="display: none;">
                <div class="emergency-form">
                    <div id="clinic-info-form-container">
                        <!-- سيتم ملؤها بشكل ديناميكي -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="save-clinic-info-btn" class="btn btn-success" style="flex: 1;">💾 حفظ التغييرات</button>
                        <button id="cancel-clinic-info-btn" class="btn btn-outline" style="flex: 1;">❌ إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- إضافة مكتبة SheetJS لتصدير Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // --- CONFIG & INIT ---
// --- منطق القائمة العائمة (أضفه في بداية السكربت أو بعد المتغيرات) ---
document.getElementById('menu-btn').addEventListener('click', function(e) {
    document.getElementById('floating-menu').classList.toggle('active');
    e.stopPropagation();
});

document.addEventListener('click', function(e) {
    const menu = document.getElementById('floating-menu');
    const btn = document.getElementById('menu-btn');
    if (menu.classList.contains('active') && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('active');
    }
});

document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', () => document.getElementById('floating-menu').classList.remove('active'));
});
        const firebaseConfig = {
            apiKey: "AIzaSyAJiiq8qdeRFZkaHnEew-6sisbCRaypJQ8",
            authDomain: "toshka-4db86.firebaseapp.com",
            databaseURL: "https://toshka-4db86-default-rtdb.firebaseio.com",
            projectId: "toshka-4db86",
            storageBucket: "toshka-4db86.firebasestorage.app",
            messagingSenderId: "513322987318",
            appId: "1:513322987318:web:155e963acb3b97bc918d97"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        const faultIcons = {
            "انقطاع التيار الكهربي": "⚡", "انخفاض جهد": "⚡📉", "ارتفاع جهد": "⚡📈",
            "انخفاض منسوب": "📉", "توقف منظومة التحضير": "⚙️", "انسدادات": "▦", 
            "تسريب مياه": "💧", "كسر في الشبكة": "🛠️", "عجز تحقيق الضغط": "🔻",
            "انقطاع الاتصال SCADA": `<svg viewBox="0 0 24 24" width="20" height="20" class="scada-icon-svg" style="color:#d32f2f;" fill="currentColor"><path d="M12 3C7.79 3 3.7 4.41 0.38 7/L2.6 9.22C5.35 7.15 8.55 6 12 6C15.45 6 18.65 7.15 21.4 9.22L23.62 7C20.3 4.41 16.21 3 12 3Z" /><path d="M12 8C9.48 8 7.15 8.76 5.18 10.05/L7.4 12.27C8.71 11.47 10.28 11 12 11C13.72 11 15.29 11.47 16.6 12.27/L18.82 10.05C16.85 8.76 14.52 8 12 8Z" /><path d="M12 13L6 21H18L12 13ZM11 18H13V19.5H11V18ZM11 15.5H13V17.5H11V15.5Z" /></svg>`
        };
        
        const inspectionSchema = {
            prepSystem: { title: "منظومة التحضير", items: ["الكومبريوسر", "طلمبة تحضير 1", "طلمبة تحضير 2", "تانك التعويض", "تانك التحضير", "لوحه التحضير"] },
            pumps: {
                title: "المضخات", isDynamic: true,
                items: [
                    "محبس فراشه", "وصله فك و تركيب", "وصله مرنه", "عداد السحب", "حساس السحب", // Suction
                    "المضخه", // Pump
                    "عداد الطرد", "حساس الطرد", "وصله مرنه", "اير فينت", "محبس عدم رجوع", "وصله فك و تركيب", "محبس فراشه" // Discharge
                ]
            },
            mainLine: { title: "خط الطرد الرئيسي", items: ["اير فينت", "محبس عدم رجوع", "وصله فك و تركيب 1", "الفلوميتر", "حساس ضغط", "عداد ضغط", "وصله فك و تركيب 2", "محبس فراشه", "محبس درين"] },
            waterHammer: { title: "منظومة الطرق المائي", items: ["كومبريسور1", "كومبريسور2", "كومبريسور3", "تانك 1", "تانك 2", "تانك 3", "لوحه كونترول"] },
            submersibles: { title: "الغواطس", items: ["طلمبة غاطس 1", "طلمبة غاطس 2"] },
            ac: { title: "تكييفات المحطه", items: ["تكييف 1", "تكييف 2", "تكييف 3", "تكييف 4", "تكييف 5", "تكييف 6", "تكييف 7", "تكييف 8", "9-PLC", "10-PLC"] },
            ventilation: { title: "التهوية", items: ["غرفه المضخات", "غرفه محول 1", "غرفه محول 2", "غرفه رينج"] },
            crane: { title: "الونش", items: ["الونش"] }
        };
        
        const statusOptions = [
            { val: "efficient", text: "✅ يعمل بكفاءة", class: "efficient" },
            { val: "fault", text: "⚠️ عطل / ملاحظة", class: "fault" },
            { val: "broken", text: "🛑 لا يعمل", class: "broken" },
            { val: "none", text: "⚪ لا يوجد", class: "none" }
        ];
        
        const statusTextMap = {
            "efficient": "يعمل بكفاءة",
            "fault": "عطل / ملاحظة",
            "broken": "لا يعمل",
            "none": "لا يوجد"
        };
        
        // --- USER TYPES & PERMISSIONS DEFINITION ---
        const userTypes = {
            admin: {
                name: "مدير",
                permissions: {
                    view_all: true,
                    edit_all: true,
                    manage_users: true,
                    add_users: true,
                    delete_users: true,
                    view_history: true,
                    view_passwords: true,
                    view_profiles: true,
                    delete_profiles: true,
                    export_inspection: true,
                    can_manage_types: ['admin', 'engineer', 'supervisor', 'operator'],
                    can_add_types: ['admin', 'engineer', 'supervisor', 'operator'],
                    can_delete_types: ['admin', 'engineer', 'supervisor', 'operator']
                }
            },
            engineer: {
                name: "مهندس",
                permissions: {
                    view_all: true,
                    edit_all: true,
                    manage_users: true,
                    add_users: true,
                    delete_users: true,
                    view_history: true,
                    view_passwords: false,
                    view_profiles: true,
                    delete_profiles: false,
                    export_inspection: true,
                    can_manage_types: ['supervisor', 'operator'],
                    can_add_types: ['supervisor', 'operator'],
                    can_delete_types: ['supervisor', 'operator']
                }
            },
            supervisor: {
                name: "مشرف",
                permissions: {
                    view_all: true,
                    edit_some: true,
                    manage_users: true,
                    add_users: true,
                    delete_users: true,
                    view_history: false,
                    view_passwords: false,
                    view_profiles: true,
                    delete_profiles: false,
                    export_inspection: true,
                    can_manage_types: ['operator'],
                    can_add_types: ['operator'],
                    can_delete_types: ['operator']
                }
            },
            operator: {
                name: "مشغل",
                permissions: {
                    view_some: true,
                    edit_own: true,
                    manage_users: false,
                    add_users: false,
                    delete_users: false,
                    view_history: false,
                    view_passwords: false,
                    view_profiles: false,
                    delete_profiles: false,
                    export_inspection: false,
                    can_manage_types: [],
                    can_add_types: [],
                    can_delete_types: []
                }
            }
        };
        
        let appData = {
            currentUser: null, 
            currentStation: null, 
            currentZone: 'all',
            stations: {}, 
            users: {},
            userProfiles: {},
            userTypes: userTypes,
            zones: ['Zone_A', 'Zone_B', 'Zone_C', 'Zone_D', 'Zone_E', 'Zone_F', 'Zone_G', 'Zone_H', 'Zone_I', 'Zone_J', 'Zone_K', 'Zone_L', 'Zone_O1', 'Zone_O2', 'Zone_O3', 'Zone_O4', 'Zone_O5', 'Zone_O2dashO6', 'Zone_O8', 'Zone_R', 'Zone_S'],
            operationHistory: [], 
            faultsLog: [], 
            consumptionLog: [],
            // Pagination limits
            historyLimit: 100,
            faultsLimit: 100,
            usersLimit: 100,
            usersDataLimit: 100,
            profilesLimit: 100,
            currentUsersPage: 0,
            currentUsersDataPage: 0,
            currentProfilesPage: 0
        };
        
        const pumpsData = {
            'A01': 4, 'A02': 4, 'A04': 2, 'A06': 5, 'A07': 5, 'A08': 4, 'A09': 5, 'A10': 5, 'A11': 5, 'A12': 5, 'A13': 5, 'A14': 4, 'A15': 4,
            'B01': 5, 'B02': 5, 'B03': 5, 'B04': 5, 'B05': 4, 'B06': 2, 'B07': 4, 'B08': 5, 'B09': 3, 'B10': 5, 'B11': 5, 'B12': 2, 'B13': 5, 'C01': 5, 'C02': 5, 'C03': 5,
            'D01': 3, 'D02': 5, 'D03': 3, 'D04': 5, 'D05': 5, 'D06': 2, 'D07': 3, 'D08': 3, 'D09': 3, 'D10': 5, 'D11': 3, 'D12': 3, 'D13': 3, 'D14': 3, 'D15': 5, 'D16': 4, 'D17': 4, 'D18': 5, 'D19': 5, 'D20': 5,
            'E01': 5, 'E02': 5, 'E03': 5, 'E04': 5, 'E05': 5, 'E06': 5, 'E07': 5, 'E08': 5, 'E09': 5, 'E10': 4, 'E11': 5, 'F01': 5, 'F02': 5, 'G01': 5, 'G02': 5, 'G03': 4, 'H01': 5, 'H02': 5, 'I01': 5, 'J01': 5, 'J02': 5,
            'K01': 5, 'K02': 5, 'K03': 5, 'K04': 5, 'K05': 5, 'K06': 5, 'K07': 5, 'K08': 5, 'K09': 5, 'K10': 3,
            'L01_1': 5, 'L01_2': 5, 'L02': 7, 'L03': 5, 'L04': 6, 'L05': 5, 'L06': 5, 'L07_1': 5, 'L07_2': 4, 'L08': 4, 'L09': 5, 'L10': 7, 'L11': 5, 'L12': 5, 'L13': 5, 'L14_1': 6, 'L14_2': 6, 'L14_3': 6, 'L14_4': 7,
            'O1-1-P1': 4, 'O1-2-P2': 4, 'O1-2-P2-B1': 4, 'O1-3-P3': 4, 'O1-4-P4': 4, 'O1-4-P4-B2': 4, 'O1-5-P5': 4, 'O1-5-P5-B3': 4, 'O1-5-P6': 4, 'O1-5-P7': 4, 'O1-6-P8': 4, 'O1-6-P9': 4, 'O1-6-P9-B4': 4, 'O1-6-P10': 4, 'O1-6-P10-B5': 4, 'O1-7-P11': 4, 'O1-7-P11-B7': 4, 'O1-7-P12': 4, 'O1-7-P12-B6': 4, 'O1-7-P13': 4, 'O1-8-P14': 4, 'O1-8-P15': 4, 'O1-8-P16': 4, 'O1-8-P16-B8': 4,
            'O1-8-P15-B9': 4, 'O1-9-P17': 5, 'O1-9-P17-B10': 5,
            'O2-1-P1': 4, 'O2-2-P3': 5, 'O2-2-P3-B2': 5, 'O2-2-P4': 4, 'O2-3-P5': 5, 'O2-3-P6': 4, 'O2-3-P6-B3': 4, 'O2-4-P7': 4, 'O2-4-P8': 4, 'O2-4-P9': 4, 'O2-4-P9-B4': 4, 'O2-5-P10': 4, 'O2-5-P10-B5': 4, 'O2-5-P11': 4, 'O2-5-P12': 4, 'O2-6-P13': 4, 'O2-6-P13-B7': 4, 'O2-6-P14': 5, 'O2-6-P14-B6': 5, 'O2-6-P15': 5, 'O2-7-P17-B8': 4, 'O2-7-P17-B9': 4,
            'O3-1-P1': 5, 'O3-1-P2': 4, 'O3-1-P3': 6, 'O3-2-P4': 6, 'O3-3-P5': 4, 'O3-3-P6': 4, 'O3-4-P7': 4, 'O3-5-P8': 4, 'O3-6-P9': 5, 'O3-6-P10': 6, 'O3-7-P11': 3, 'O3-7-P12': 4, 'O3-7-P13': 4, 'O3-7-P14': 5, 'O3-7-P15': 5, 'O3-7-P16': 6,
            'O4-1-P1': 5, 'O4-1-P2': 5, 'O4-1-P3': 4, 'O4-1-P4': 5, 'O4-1-P5': 4, 'O4-2-P6': 4, 'O4-2-P7': 4, 'O4-2-P8': 5, 'O4-3-P9': 5, 'O4-4-P10': 4, 'O4-5-P11': 4, 'O4-6-P12': 4, 'O4-7-P13': 4, 'O4-8-P14': 4, 'O4-9-P15': 4, 'O4-9-P16': 4, 'O4-9-P17': 4, 'O4-9-P18': 4, 'O4-10-P19': 4, 'O4-10-P20': 5, 'O4-10-P21': 5, 'O4-10-P22': 5,
            'O5-1-P1': 4, 'O5-2-P2': 4, 'O5-3-P4': 5, 'O5-3-P5': 4, 'O5-3-P6': 3, 'O5-4-P7': 3, 'O5-4-P8': 5, 'O5-5-P10': 2, 'O5-5-P9': 5, 'O5-6-P11': 4, 'O5-6-P12': 3, 'O5-7-P13': 5, 'O5-8-P14': 5,
            'O6-1-P1': 4, 'O6-2-P2': 3, 'O6-3-P3': 4, 'O6-3-P4': 5, 'O6-3-P5': 5, 'O6-3-P6': 6, 'O6-3-P7': 6,
            'O8-1-P1': 4, 'O8-2-P2': 6, 'O8-3-P3': 4, 'O8-4-P4': 5, 'O8-5-P5': 5, 'O8-6-P6': 6, 'O8-7-P7': 5, 'O8-8-P8': 4, 'O8-8-P9': 5, 'O8-8-P10': 6, 'O8-8-P11': 5, 'O8-8-P12': 5, 'O8-9-P13': 5, 'O8-10-P14': 4,
            'Lifting-1A': 10, 'Lifting-1B': 10, 'Lifting-2A': 10, 'Lifting-2B': 10,
            'R01': 4, 'R02': 6, 'R03*': 6, 'R03-A': 7, 'R03-B': 5, 'R04': 7, 'R05-A': 7, 'R05-B': 8, 'R05-C': 8, 'R05-D': 6, 'R05-E': 7, 'R05-F': 6, 'R05-G': 7, 'R05-H': 7, 'R05-I': 7, 'R05-J1': 7, 'R05-J2': 7, 'R05-K': 7, 'R06': 7, 'R07': 8, 'R08-A': 7, 'R08-B': 7, 'R08-C': 5, 'R08-D': 6, 'R08-E': 7, 'R08-F1': 7, 'R08-F2': 7, 'R08-F3': 7, 'R08G': 7, 'R08*': 7, // المحطة المضافة حديثاً لمنطقة Zone_R
            'R09-A': 8, 'R09-B': 8, 'R09-C': 8, 'R10': 7, 'R11': 7, 'R12-A': 6, 'R12-B': 7,
            'Lifting-57S': 6, 'Lifting-8S': 12, 'Lifting-17S': 12,
            'S01-A': 7, 'S01-B': 7, 'S02-A': 6, 'S02-B': 7, 'S03': 6, 'S04': 6, 'S05-A': 6, 'S05-B': 6, 'S06': 6, 'S07-A': 7, 'S07-B': 7, 'S08': 6, 'S09-A': 7, 'S09-B': 7, 'S09-C': 8, 'S09-D': 8, 'S09-E': 6, 'S09-F': 6
        };
        
        function toEnglishDigits(str) {
            if (!str) return str;
            str = str.trim();
            const arabicNumbers = ["٠", "١", "٢", "٣", "٤", "٥", "٦", "٧", "٨", "٩"];
            return str.replace(/[٠-٩]/g, function(w) { return arabicNumbers.indexOf(w); });
        }

        function getStandardDateTime() {
            const now = new Date();
            const d = String(now.getDate()).padStart(2, '0');
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const y = now.getFullYear();
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            return {
                date: `${d}/${m}/${y}`, 
                time: `${h}:${min}:${s}`, 
                full: `${d}/${m}/${y} ${h}:${min}:${s}`
            };
        }

        function parseCustomDate(str) {
            if(!str) return null;
            str = toEnglishDigits(str);
            const parts = str.split(/\s+/);
            if(parts.length < 2) return null;
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            if(dateParts.length < 3 || timeParts.length < 2) return null;
            const year = parseInt(dateParts[2]);
            const month = parseInt(dateParts[1]) - 1;
            const day = parseInt(dateParts[0]);
            const hour = parseInt(timeParts[0]);
            const min = parseInt(timeParts[1]);
            const sec = timeParts[2] ? parseInt(timeParts[2]) : 0;
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            return new Date(year, month, day, hour, min, sec);
        }
// --- تعديل: متغير لتخزين حالة الاتصال الحقيقي بالسيرفر ---
// ============================================================
// بداية كود مراقبة الشبكة الجديد (استبدل الكود القديم بهذا)
// ============================================================
// ============================================================
// منطق مراقبة الشبكة الجديد (مع التصحيح الذاتي)
// ============================================================
let isFirebaseConnected = false;
let isWeakSignal = false; 

// 1. مراقبة حالة الاتصال مع سيرفرات جوجل
db.ref(".info/connected").on("value", (snap) => {
    if (snap.val() === true) {
        isFirebaseConnected = true;
        tryRecoverConnection(); // محاولة استعادة الوضع الطبيعي فوراً
    } else {
        isFirebaseConnected = false;
        updateNetworkStatus();
    }
});

// 2. مراقبة حالة المتصفح (للاستجابة السريعة عند عودة الواي فاي)
window.addEventListener('online', () => {
    console.log("Browser Online event detected");
    tryRecoverConnection();
});
window.addEventListener('offline', updateNetworkStatus);

// 3. الفحص الدوري (الحل السحري): يفحص كل 5 ثواني
// إذا كانت العلامة برتقالية (ضعيفة) والنت موجود، يقوم بالمزامنة وتحويلها للأخضر
setInterval(() => {
    if (isWeakSignal && navigator.onLine && isFirebaseConnected) {
        console.log("Auto-recovering form Weak Signal...");
        tryRecoverConnection();
    }
}, 5000);

// دالة لمحاولة استعادة الاتصال ورفع البيانات
function tryRecoverConnection() {
    // إذا كان النظام مسجل كإشارة ضعيفة، نعيده لمتصل (أخضر)
    if (isWeakSignal) {
        isWeakSignal = false;
    }
    
    // تحديث الأيقونة والنصوص
    updateNetworkStatus();
    
    // تشغيل طابور البيانات المعلقة (التزامن)
    // نتأكد أن دالة processOfflineQueue موجودة قبل استدعائها
    if (typeof processOfflineQueue === 'function') {
        processOfflineQueue(); 
    }
}

function updateNetworkStatus() {
    const indicator = document.getElementById('network-status-indicator');
    const icon = document.getElementById('net-icon');
    const text = document.getElementById('net-text');
    const loginBtn = document.getElementById('login-btn');
    
    // منطق تحديد الحالة في الشريط العلوي
    if (isWeakSignal) {
        // حالة: إشارة ضعيفة (تم اكتشافها بواسطة التايم أوت)
        indicator.className = 'network-status net-weak';
        icon.textContent = '🟠';
        text.textContent = 'إشارة ضعيفة';
    } else if (navigator.onLine && isFirebaseConnected) {
        // حالة: متصل بقوة
        indicator.className = 'network-status net-online';
        icon.textContent = '🟢';
        text.textContent = 'متصل';
    } else {
        // حالة: غير متصل
        indicator.className = 'network-status net-offline';
        icon.textContent = '🔴';
        text.textContent = 'غير متصل';
    }

    // منطق زر الدخول
    if(loginBtn) {
        const hasUsers = appData.users && Object.keys(appData.users).length > 0;
        if (hasUsers) {
            loginBtn.disabled = false;
            loginBtn.style.cursor = 'pointer';
            loginBtn.classList.add('btn-primary');
            if (navigator.onLine && isFirebaseConnected && !isWeakSignal) {
                loginBtn.textContent = "دخول";
                loginBtn.style.backgroundColor = ''; 
            } else {
                loginBtn.textContent = "دخول (Offline)";
                loginBtn.style.backgroundColor = '#7f8c8d'; 
            }
        } else {
            loginBtn.disabled = true;
            if (navigator.onLine) loginBtn.textContent = "جاري تحميل البيانات...";
            else {
                loginBtn.textContent = "تنبيه: يلزم إنترنت لأول تشغيل";
                loginBtn.style.backgroundColor = '#c0392b';
            }
        }
    }
}
// --- بيانات الطوارئ الافتراضية ---
const defaultEmergencyData = {
    publicServices: [
        { id: 1, name: "الاسعاف", number: "123", icon: "🚑", description: "خدمة الإسعاف والطوارئ الطبية" },
        { id: 2, name: "ادارة الدفاع المدني و الحريق", number: "180", icon: "🚒", description: "إدارة الدفاع المدني والإطفاء" },
        { id: 3, name: "الشرطه", number: "122", icon: "👮", description: "الشرطة والأمن العام" }
    ],
    emergencyTeam: [
        { id: 1, name: "م.محمد القباني", number: "01011896040", icon: "👨‍💼", role: "مهندس" },
        { id: 2, name: "أ. اسلام زكريا علام", number: "01029272924", icon: "👨‍💼", role: "أستاذ" },
        { id: 3, name: "محمد عبد الحميد مدثر", number: "01143045043", icon: "👨‍💼", role: "فريق طوارئ" },
        { id: 4, name: "محمد شريف السيد", number: "01101595082", icon: "👨‍💼", role: "فريق طوارئ" }
    ],
    clinicInfo: [
        { id: 1, name: "ممرض العيادة", number: "011471110254", icon: "👨‍⚕️", role: "ممرض" },
        { id: 2, name: "العيادة", number: "01508205785", icon: "🏥", role: "رقم العيادة الرئيسي" }
    ],
    emergencyImage: null
};

let emergencyData = { ...defaultEmergencyData };

// --- إضافة زر القائمة ---
document.getElementById('emergency-info-btn').addEventListener('click', () => {
    if (!appData.currentUser) {
        alert('يجب تسجيل الدخول أولاً');
        return;
    }
    showScreen('emergency-info');
    loadEmergencyData();
});

// --- دالة تحميل بيانات الطوارئ ---
function loadEmergencyData() {
    // محاولة تحميل البيانات من Firebase
    db.ref('emergencyData').once('value').then(snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            emergencyData = {
                publicServices: data.publicServices || defaultEmergencyData.publicServices,
                emergencyTeam: data.emergencyTeam || defaultEmergencyData.emergencyTeam,
                clinicInfo: data.clinicInfo || defaultEmergencyData.clinicInfo,
                emergencyImage: data.emergencyImage || null
            };
        }
        renderEmergencyData();
    }).catch(error => {
        console.error('Error loading emergency data:', error);
        emergencyData = { ...defaultEmergencyData };
        renderEmergencyData();
    });
}

// --- دالة عرض بيانات الطوارئ ---
function renderEmergencyData() {
    renderPublicServices();
    renderEmergencyTeam();
    renderClinicInfo();
    renderEmergencyImage();
    setupAdminControls();
}

// --- عرض الخدمات العامة ---
function renderPublicServices() {
    const container = document.querySelector('#public-services-view .emergency-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    emergencyData.publicServices.forEach(service => {
        const item = document.createElement('div');
        item.className = 'emergency-item';
        item.innerHTML = `
            <div class="emergency-icon">${service.icon}</div>
            <div class="emergency-title">${service.name}</div>
            <div class="emergency-number">${service.number}</div>
            <div class="emergency-desc">${service.description}</div>
        `;
        container.appendChild(item);
    });
    
    // تعبئة نموذج التعديل
    const formContainer = document.getElementById('public-services-form-container');
    if (formContainer) {
        formContainer.innerHTML = '';
        emergencyData.publicServices.forEach(service => {
            const formItem = document.createElement('div');
            formItem.className = 'emergency-form-item';
            formItem.innerHTML = `
                <h5>${service.icon} ${service.name}</h5>
                <div class="form-group">
                    <label>اسم الخدمة</label>
                    <input type="text" class="service-name" value="${service.name}" placeholder="اسم الخدمة">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" class="service-number" value="${service.number}" placeholder="رقم الهاتف">
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <input type="text" class="service-desc" value="${service.description}" placeholder="وصف الخدمة">
                </div>
                <button class="emergency-delete-btn" onclick="deletePublicService(${service.id})">
                    🗑️ حذف هذه الخدمة
                </button>
            `;
            formContainer.appendChild(formItem);
        });
    }
}

// --- عرض فريق الطوارئ ---
// --- عرض فريق الطوارئ (محدثة) ---
function renderEmergencyTeam() {
    const container = document.querySelector('#emergency-team-view .emergency-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    emergencyData.emergencyTeam.forEach(member => {
        const item = document.createElement('div');
        item.className = 'emergency-item';
        item.innerHTML = `
            <div class="emergency-icon">${member.icon}</div>
            <div class="emergency-title">${member.name}</div>
            <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">
                <span style="background: #e8f5e9; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                    ${member.role}
                </span>
            </div>
            <div class="emergency-number">${formatPhoneNumber(member.number)}</div>
            <div style="margin-top: 10px;">
                <a href="tel:${member.number}" class="btn btn-sm" 
                   style="background: #27ae60; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-right: 5px;">
                   📞 اتصال
                </a>
                <a href="https://wa.me/${member.number.replace(/^0/, '+20')}" target="_blank" class="btn btn-sm"
                   style="background: #25D366; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; display: inline-block;">
                   💬 واتساب
                </a>
            </div>
        `;
        container.appendChild(item);
    });
    
    // تعبئة نموذج التعديل
    const formContainer = document.getElementById('emergency-team-form-container');
    if (formContainer) {
        formContainer.innerHTML = '';
        emergencyData.emergencyTeam.forEach(member => {
            const formItem = document.createElement('div');
            formItem.className = 'emergency-form-item';
            formItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h5 style="margin: 0;">${member.icon} العضو #${member.id}</h5>
                    <button onclick="deleteEmergencyTeamMember(${member.id})" 
                            class="emergency-delete-btn" style="margin: 0; padding: 4px 8px;">
                        🗑️ حذف
                    </button>
                </div>
                <div class="form-group">
                    <label>اسم العضو <span style="color: red;">*</span></label>
                    <input type="text" class="team-name" value="${member.name}" placeholder="اسم العضو" required>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف <span style="color: red;">*</span></label>
                    <input type="tel" class="team-number" value="${member.number}" placeholder="رقم الهاتف" required>
                </div>
                <div class="form-group">
                    <label>الدور/الوظيفة</label>
                    <input type="text" class="team-role" value="${member.role}" placeholder="الدور أو الوظيفة">
                </div>
            `;
            formContainer.appendChild(formItem);
        });
        
        // إضافة عنصر فارغ في النهاية لإضافة أعضاء جدد
        const addNewTemplate = document.createElement('div');
        addNewTemplate.id = 'add-new-member-template';
        addNewTemplate.style.textAlign = 'center';
        addNewTemplate.style.marginTop = '20px';
        addNewTemplate.style.padding = '15px';
        addNewTemplate.style.border = '2px dashed #3498db';
        addNewTemplate.style.borderRadius = '8px';
        addNewTemplate.style.background = '#f8f9fa';
        addNewTemplate.innerHTML = `
            <div style="color: #3498db; font-size: 2rem; margin-bottom: 10px;">👤</div>
            <div style="color: #2c3e50; font-weight: bold; margin-bottom: 10px;">إضافة عضو جديد لفريق الطوارئ</div>
            <button onclick="addEmergencyTeamMember()" 
                    class="btn btn-primary" 
                    style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 10px 20px;">
                ➕ إضافة عضو جديد
            </button>
            <p style="color: #666; font-size: 0.85rem; margin-top: 10px;">انقر لإضافة عضو جديد للفريق</p>
        `;
        formContainer.appendChild(addNewTemplate);
    }
}

// --- دالة مساعدة لتنسيق رقم الهاتف ---
function formatPhoneNumber(phone) {
    if (!phone) return '';
    
    // إزالة جميع الأحرف غير الرقمية
    let cleanNumber = phone.replace(/\D/g, '');
    
    // إذا بدأ بـ 0 نضيف +20
    if (cleanNumber.startsWith('0')) {
        cleanNumber = '+20' + cleanNumber.substring(1);
    }
    // إذا بدأ بـ 20 نضيف +
    else if (cleanNumber.startsWith('20')) {
        cleanNumber = '+' + cleanNumber;
    }
    // إذا كان طوله 10 أرقام (بدون مفتاح الدولة)
    else if (cleanNumber.length === 10) {
        cleanNumber = '+20' + cleanNumber;
    }
    
    // تنسيق الرقم: +20 XXX XXX XXXX
    if (cleanNumber.length === 13 && cleanNumber.startsWith('+20')) {
        return cleanNumber.replace(/(\+20)(\d{3})(\d{3})(\d{4})/, '$1 $2 $3 $4');
    }
    
    return cleanNumber;
}

// --- عرض معلومات العيادة ---
function renderClinicInfo() {
    const container = document.querySelector('#clinic-info-view .emergency-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    emergencyData.clinicInfo.forEach(item => {
        const element = document.createElement('div');
        element.className = 'emergency-item';
        element.innerHTML = `
            <div class="emergency-icon">${item.icon}</div>
            <div class="emergency-title">${item.name}</div>
            <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">${item.role}</div>
            <div class="emergency-number">${item.number}</div>
        `;
        container.appendChild(element);
    });
    
    // تعبئة نموذج التعديل
    const formContainer = document.getElementById('clinic-info-form-container');
    if (formContainer) {
        formContainer.innerHTML = '';
        emergencyData.clinicInfo.forEach(item => {
            const formItem = document.createElement('div');
            formItem.className = 'emergency-form-item';
            formItem.innerHTML = `
                <h5>${item.icon} ${item.name}</h5>
                <div class="form-group">
                    <label>الاسم</label>
                    <input type="text" class="clinic-name" value="${item.name}" placeholder="الاسم">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" class="clinic-number" value="${item.number}" placeholder="رقم الهاتف">
                </div>
                <div class="form-group">
                    <label>الدور/الوظيفة</label>
                    <input type="text" class="clinic-role" value="${item.role}" placeholder="الدور أو الوظيفة">
                </div>
                <button class="emergency-delete-btn" onclick="deleteClinicInfo(${item.id})">
                    🗑️ حذف هذا العنصر
                </button>
            `;
            formContainer.appendChild(formItem);
        });
    }
}

// --- عرض صورة الطوارئ ---
function renderEmergencyImage() {
    const imageWrapper = document.getElementById('emergency-image-wrapper');
    const noImageMsg = document.getElementById('no-emergency-image');
    const imageDisplay = document.getElementById('emergency-image-display');
    const fullscreenImage = document.getElementById('emergency-image-fullscreen');
    
    if (emergencyData.emergencyImage) {
        imageWrapper.style.display = 'block';
        noImageMsg.style.display = 'none';
        imageDisplay.src = emergencyData.emergencyImage;
        fullscreenImage.src = emergencyData.emergencyImage;
    } else {
        imageWrapper.style.display = 'none';
        noImageMsg.style.display = 'block';
    }
}

// --- إعداد عناصر التحكم للمدير ---
function setupAdminControls() {
    const isAdmin = appData.currentUser && appData.currentUser.type === 'admin';
    
    // إظهار/إخفاء أزرار التحكم
    const adminControls = [
        'emergency-image-controls',
        'edit-public-services-btn',
        'add-emergency-team-btn',
        'edit-emergency-team-btn',
        'edit-clinic-info-btn'
    ];
    
    adminControls.forEach(controlId => {
        const element = document.getElementById(controlId);
        if (element) {
            element.style.display = isAdmin ? 'flex' : 'none';
        }
    });
    
    // إضافة مستمعي الأحداث
    setupEventListeners();
}

// --- إعداد مستمعي الأحداث ---
function setupEventListeners() {
    // رجوع للرئيسية
    document.getElementById('back-to-stations-from-emergency').addEventListener('click', () => showScreen('stations'));
    
    // تحميل الصورة
    document.getElementById('upload-emergency-image-btn').addEventListener('click', () => {
        document.getElementById('emergency-image-input').click();
    });
    
    document.getElementById('emergency-image-input').addEventListener('change', uploadEmergencyImage);
    
    // حذف الصورة
    document.getElementById('delete-emergency-image-btn').addEventListener('click', deleteEmergencyImage);
    
    // الخدمات العامة
    document.getElementById('edit-public-services-btn').addEventListener('click', () => {
        document.getElementById('public-services-view').style.display = 'none';
        document.getElementById('public-services-edit').style.display = 'block';
    });
    
    document.getElementById('save-public-services-btn').addEventListener('click', savePublicServices);
    document.getElementById('cancel-public-services-btn').addEventListener('click', () => {
        document.getElementById('public-services-edit').style.display = 'none';
        document.getElementById('public-services-view').style.display = 'block';
        renderPublicServices();
    });
    
    // فريق الطوارئ
    document.getElementById('edit-emergency-team-btn').addEventListener('click', () => {
        document.getElementById('emergency-team-view').style.display = 'none';
        document.getElementById('emergency-team-edit').style.display = 'block';
    });
    
   document.getElementById('add-emergency-team-btn').addEventListener('click', function() {
    // الانتقال لوضع التعديل أولاً إذا لم يكن فعالاً
    if (document.getElementById('emergency-team-edit').style.display !== 'block') {
        document.getElementById('emergency-team-view').style.display = 'none';
        document.getElementById('emergency-team-edit').style.display = 'block';
    }
    
    // إضافة عضو جديد بعد الانتقال لوضع التعديل
    setTimeout(() => {
        addEmergencyTeamMember();
    }, 100);
});
    document.getElementById('save-emergency-team-btn').addEventListener('click', saveEmergencyTeam);
    document.getElementById('cancel-emergency-team-btn').addEventListener('click', () => {
        document.getElementById('emergency-team-edit').style.display = 'none';
        document.getElementById('emergency-team-view').style.display = 'block';
        renderEmergencyTeam();
    });
    
    // العيادة
    document.getElementById('edit-clinic-info-btn').addEventListener('click', () => {
        document.getElementById('clinic-info-view').style.display = 'none';
        document.getElementById('clinic-info-edit').style.display = 'block';
    });
    
    document.getElementById('save-clinic-info-btn').addEventListener('click', saveClinicInfo);
    document.getElementById('cancel-clinic-info-btn').addEventListener('click', () => {
        document.getElementById('clinic-info-edit').style.display = 'none';
        document.getElementById('clinic-info-view').style.display = 'block';
        renderClinicInfo();
    });
}

// --- رفع صورة الطوارئ ---
function uploadEmergencyImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // التحقق من نوع الملف
    if (!file.type.startsWith('image/')) {
        showEmergencyAlert('يرجى اختيار ملف صورة فقط', 'error');
        return;
    }
    
    // التحقق من حجم الملف (5MB كحد أقصى)
    if (file.size > 5 * 1024 * 1024) {
        showEmergencyAlert('حجم الصورة يجب أن يكون أقل من 5 ميجابايت', 'error');
        return;
    }
    
    const uploadBtn = document.getElementById('upload-emergency-image-btn');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<span class="loading-spinner"></span> جاري الرفع...';
    uploadBtn.disabled = true;
    
    // قراءة الصورة وتحويلها إلى base64
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        
        // حفظ الصورة في Firebase
        db.ref('emergencyData/emergencyImage').set(imageData)
            .then(() => {
                emergencyData.emergencyImage = imageData;
                renderEmergencyImage();
                showEmergencyAlert('تم رفع الصورة بنجاح!', 'success');
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error uploading image:', error);
                showEmergencyAlert('فشل رفع الصورة. حاول مرة أخرى.', 'error');
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            });
    };
    
    reader.onerror = function() {
        showEmergencyAlert('حدث خطأ أثناء قراءة الملف', 'error');
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
    };
    
    reader.readAsDataURL(file);
    
    // مسح قيمة input الملف
    event.target.value = '';
}

// --- حذف صورة الطوارئ ---
function deleteEmergencyImage() {
    if (!confirm('هل أنت متأكد من حذف صورة المعلومات؟')) return;
    
    const deleteBtn = document.getElementById('delete-emergency-image-btn');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<span class="loading-spinner"></span> جاري الحذف...';
    deleteBtn.disabled = true;
    
    db.ref('emergencyData/emergencyImage').remove()
        .then(() => {
            emergencyData.emergencyImage = null;
            renderEmergencyImage();
            showEmergencyAlert('تم حذف الصورة بنجاح', 'success');
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error deleting image:', error);
            showEmergencyAlert('فشل حذف الصورة', 'error');
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        });
}

// --- عرض/إخفاء الصورة كاملة الشاشة ---
window.toggleEmergencyImageFullscreen = function() {
    const modal = document.getElementById('emergency-image-modal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
};

window.closeEmergencyImageModal = function() {
    const modal = document.getElementById('emergency-image-modal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
};

// --- حفظ الخدمات العامة ---
function savePublicServices() {
    const formItems = document.querySelectorAll('#public-services-form-container .emergency-form-item');
    const updatedServices = [];
    
    formItems.forEach((item, index) => {
        const name = item.querySelector('.service-name').value.trim();
        const number = item.querySelector('.service-number').value.trim();
        const desc = item.querySelector('.service-desc').value.trim();
        
        if (name && number) {
            updatedServices.push({
                id: index + 1,
                name: name,
                number: number,
                icon: emergencyData.publicServices[index]?.icon || '📞',
                description: desc || 'خدمة عامة'
            });
        }
    });
    
    // التحقق من وجود خدمات
    if (updatedServices.length === 0) {
        showEmergencyAlert('يجب إدخال بيانات الخدمات العامة', 'warning');
        return;
    }
    
    const saveBtn = document.getElementById('save-public-services-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="loading-spinner"></span> جاري الحفظ...';
    saveBtn.disabled = true;
    
    db.ref('emergencyData/publicServices').set(updatedServices)
        .then(() => {
            emergencyData.publicServices = updatedServices;
            document.getElementById('public-services-edit').style.display = 'none';
            document.getElementById('public-services-view').style.display = 'block';
            renderPublicServices();
            showEmergencyAlert('تم حفظ الخدمات العامة بنجاح', 'success');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error saving public services:', error);
            showEmergencyAlert('فشل حفظ البيانات', 'error');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
}

// --- حذف خدمة عامة ---
window.deletePublicService = function(id) {
    if (!confirm('هل أنت متأكد من حذف هذه الخدمة؟')) return;
    
    const filteredServices = emergencyData.publicServices.filter(service => service.id !== id);
    
    // تحديث المعرفات
    const updatedServices = filteredServices.map((service, index) => ({
        ...service,
        id: index + 1
    }));
    
    emergencyData.publicServices = updatedServices;
    renderPublicServices();
    showEmergencyAlert('تم حذف الخدمة', 'warning');
};

// --- حفظ فريق الطوارئ (محدثة) ---
function saveEmergencyTeam() {
    const formItems = document.querySelectorAll('#emergency-team-form-container .emergency-form-item');
    if (formItems.length === 0) {
        showEmergencyAlert('لا توجد بيانات لحفظها', 'warning');
        return;
    }
    
    // التحقق من صحة البيانات
    let isValid = true;
    const validationErrors = [];
    
    formItems.forEach((item, index) => {
        const name = item.querySelector('.team-name')?.value.trim() || '';
        const number = item.querySelector('.team-number')?.value.trim() || '';
        const role = item.querySelector('.team-role')?.value.trim() || 'عضو فريق طوارئ';
        
        // التحقق من البيانات المطلوبة
        if (!name) {
            validationErrors.push(`الاسم مطلوب للعضو #${index + 1}`);
            isValid = false;
        }
        if (!number) {
            validationErrors.push(`رقم الهاتف مطلوب للعضو #${index + 1}`);
            isValid = false;
        }
        
        // التحقق من تنسيق رقم الهاتف (اختياري)
        if (number && !/^[0-9+]{10,15}$/.test(number.replace(/\s/g, ''))) {
            validationErrors.push(`تنسيق رقم الهاتف غير صحيح للعضو #${index + 1}`);
            isValid = false;
        }
    });
    
    if (!isValid) {
        const errorMsg = validationErrors.join('\n');
        showEmergencyAlert(`الرجاء تصحيح الأخطاء:\n${errorMsg}`, 'error');
        return;
    }
    
    // تجميع البيانات الصحيحة
    const updatedTeam = [];
    let nextId = 1;
    
    formItems.forEach((item) => {
        const name = item.querySelector('.team-name')?.value.trim() || '';
        const number = item.querySelector('.team-number')?.value.trim() || '';
        const role = item.querySelector('.team-role')?.value.trim() || 'عضو فريق طوارئ';
        
        if (name && number) {
            updatedTeam.push({
                id: nextId++,
                name: name,
                number: number,
                icon: '👨‍💼', // أيقونة افتراضية
                role: role
            });
        }
    });
    
    // التحقق من وجود أعضاء على الأقل
    if (updatedTeam.length === 0) {
        showEmergencyAlert('يجب إدخال بيانات صحيحة لعضو واحد على الأقل', 'warning');
        return;
    }
    
    // حفظ البيانات
    const saveBtn = document.getElementById('save-emergency-team-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="loading-spinner"></span> جاري الحفظ...';
    saveBtn.disabled = true;
    
    db.ref('emergencyData/emergencyTeam').set(updatedTeam)
        .then(() => {
            emergencyData.emergencyTeam = updatedTeam;
            
            // العودة لوضع العرض
            document.getElementById('emergency-team-edit').style.display = 'none';
            document.getElementById('emergency-team-view').style.display = 'block';
            
            // إعادة عرض البيانات
            renderEmergencyTeam();
            
            // إظهار رسالة نجاح
            showEmergencyAlert(`تم حفظ بيانات الفريق بنجاح (${updatedTeam.length} عضو)`, 'success');
            
            // إعادة تعيين الزر
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error saving emergency team:', error);
            showEmergencyAlert('فشل حفظ البيانات: ' + error.message, 'error');
            
            // إعادة تعيين الزر
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
}

// --- إضافة عضو جديد لفريق الطوارئ (مصحح) ---
function addEmergencyTeamMember() {
    // الانتقال لوضع التعديل أولاً إذا لم يكن فعالاً
    if (document.getElementById('emergency-team-edit').style.display !== 'block') {
        document.getElementById('emergency-team-view').style.display = 'none';
        document.getElementById('emergency-team-edit').style.display = 'block';
    }
    
    const formContainer = document.getElementById('emergency-team-form-container');
    if (!formContainer) return;
    
    // حساب معرف جديد
    const currentItems = formContainer.querySelectorAll('.emergency-form-item');
    const newId = currentItems.length + 1;
    
    // إنشاء عنصر النموذج الجديد
    const newItem = document.createElement('div');
    newItem.className = 'emergency-form-item';
    newItem.dataset.tempId = `temp_${Date.now()}`; // معرف مؤقت فريد
    newItem.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h5 style="margin: 0;">👤 عضو جديد #${newId}</h5>
            <button onclick="removeTempTeamMember('${newItem.dataset.tempId}')" 
                    class="emergency-delete-btn" style="margin: 0; padding: 4px 8px;">
                حذف
            </button>
        </div>
        <div class="form-group">
            <label>اسم العضو <span style="color: red;">*</span></label>
            <input type="text" class="team-name" placeholder="مثال: أحمد محمد" required>
        </div>
        <div class="form-group">
            <label>رقم الهاتف <span style="color: red;">*</span></label>
            <input type="tel" class="team-number" placeholder="مثال: 01012345678" required>
        </div>
        <div class="form-group">
            <label>الدور/الوظيفة</label>
            <input type="text" class="team-role" placeholder="مثال: مهندس أو مشرف">
        </div>
    `;
    
    formContainer.appendChild(newItem);
    
    // تمرير للمحتوى الجديد
    setTimeout(() => {
        newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        newItem.querySelector('.team-name').focus();
    }, 100);
    
    showEmergencyAlert('تمت إضافة خانة جديدة للعضو، قم بتعبئتها ثم اضغط حفظ', 'warning');
}

// --- دالة مساعدة لحذف العضو المؤقت ---
window.removeTempTeamMember = function(tempId) {
    const element = document.querySelector(`.emergency-form-item[data-temp-id="${tempId}"]`);
    if (element) {
        element.remove();
        showEmergencyAlert('تم إزالة العضو الجديد', 'warning');
    }
};
// --- حذف عضو من فريق الطوارئ (محدثة) ---
window.deleteEmergencyTeamMember = function(id) {
    if (!confirm('هل أنت متأكد من حذف هذا العضو من فريق الطوارئ؟')) return;
    
    // إذا كان في وضع التعديل، احذف من القائمة مباشرة
    if (document.getElementById('emergency-team-edit').style.display === 'block') {
        const formItems = document.querySelectorAll('#emergency-team-form-container .emergency-form-item');
        
        // البحث عن العنصر بحسب المحتوى
        formItems.forEach(item => {
            const nameInput = item.querySelector('.team-name');
            if (nameInput && nameInput.value.includes(id.toString())) {
                item.remove();
                showEmergencyAlert('تم حذف العضو من القائمة', 'warning');
                return;
            }
        });
        
        // إذا لم نجد بالاسم، نجرب بالرقم التسلسلي
        if (formItems.length >= id) {
            formItems[id - 1]?.remove();
            showEmergencyAlert('تم حذف العضو من القائمة', 'warning');
        }
    } else {
        // إذا كان في وضع العرض، احذف من البيانات المخزنة
        const filteredTeam = emergencyData.emergencyTeam.filter(member => member.id !== id);
        
        // تحديث المعرفات
        const updatedTeam = filteredTeam.map((member, index) => ({
            ...member,
            id: index + 1
        }));
        
        // تحديث Firebase
        db.ref('emergencyData/emergencyTeam').set(updatedTeam)
            .then(() => {
                emergencyData.emergencyTeam = updatedTeam;
                renderEmergencyTeam();
                showEmergencyAlert('تم حذف العضو من قاعدة البيانات', 'success');
            })
            .catch(error => {
                console.error('Error deleting team member:', error);
                showEmergencyAlert('فشل حذف العضو', 'error');
            });
    }
};

// --- حفظ معلومات العيادة ---
function saveClinicInfo() {
    const formItems = document.querySelectorAll('#clinic-info-form-container .emergency-form-item');
    const updatedClinicInfo = [];
    
    formItems.forEach((item, index) => {
        const name = item.querySelector('.clinic-name').value.trim();
        const number = item.querySelector('.clinic-number').value.trim();
        const role = item.querySelector('.clinic-role').value.trim();
        
        if (name && number) {
            updatedClinicInfo.push({
                id: index + 1,
                name: name,
                number: number,
                icon: emergencyData.clinicInfo[index]?.icon || '🏥',
                role: role || 'معلومات العيادة'
            });
        }
    });
    
    // التحقق من وجود معلومات
    if (updatedClinicInfo.length === 0) {
        showEmergencyAlert('يجب إدخال بيانات العيادة', 'warning');
        return;
    }
    
    const saveBtn = document.getElementById('save-clinic-info-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="loading-spinner"></span> جاري الحفظ...';
    saveBtn.disabled = true;
    
    db.ref('emergencyData/clinicInfo').set(updatedClinicInfo)
        .then(() => {
            emergencyData.clinicInfo = updatedClinicInfo;
            document.getElementById('clinic-info-edit').style.display = 'none';
            document.getElementById('clinic-info-view').style.display = 'block';
            renderClinicInfo();
            showEmergencyAlert('تم حفظ معلومات العيادة بنجاح', 'success');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error saving clinic info:', error);
            showEmergencyAlert('فشل حفظ البيانات', 'error');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
}

// --- حذف معلومات العيادة ---
window.deleteClinicInfo = function(id) {
    if (!confirm('هل أنت متأكد من حذف هذا العنصر؟')) return;
    
    const filteredClinic = emergencyData.clinicInfo.filter(item => item.id !== id);
    
    // تحديث المعرفات
    const updatedClinic = filteredClinic.map((item, index) => ({
        ...item,
        id: index + 1
    }));
    
    emergencyData.clinicInfo = updatedClinic;
    renderClinicInfo();
    showEmergencyAlert('تم حذف العنصر', 'warning');
};

// --- عرض رسائل الحالة ---
function showEmergencyAlert(message, type = 'info') {
    // إزالة أي رسائل سابقة
    const existingAlerts = document.querySelectorAll('.emergency-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `emergency-alert emergency-alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';
    
    // إضافة الرسالة في أعلى الصفحة
    const screen = document.getElementById('emergency-info-screen');
    const firstChild = screen.querySelector('.user-data-card');
    if (firstChild) {
        screen.insertBefore(alertDiv, firstChild);
    }
    
    // إزالة الرسالة تلقائياً بعد 5 ثواني
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.opacity = '0';
            alertDiv.style.transition = 'opacity 0.5s';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 500);
        }
    }, 5000);
}

// --- إضافة مستمع حدث للخروج من الصورة الكاملة بالضغط على ESC ---
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeEmergencyImageModal();
    }
});

// --- إضافة مستمع حدث للنافذة المنبثقة للصورة ---
document.getElementById('emergency-image-modal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeEmergencyImageModal();
    }
});

// --- تحديث دالة showScreen لدعم شاشة الطوارئ ---
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(`${screenId}-screen`).classList.add('active');
    window.scrollTo(0, 0);
    
    const userInfoDiv = document.getElementById('header-user-info');
    userInfoDiv.style.display = (screenId === 'login') ? 'none' : 'flex';
    
    // التعامل مع شاشة الطوارئ
    if(screenId === 'emergency-info') {
        loadEmergencyData();
    }
    // ... باقي الشاشات الموجودة سابقاً
}
        function loadSystemData() {
            const cachedStations = localStorage.getItem('toshka_stations_cache');
            if (cachedStations) {
                appData.stations = JSON.parse(cachedStations);
                renderStations('all');
            }
            const cachedUsers = localStorage.getItem('toshka_users_cache');
            if(cachedUsers) {
                appData.users = JSON.parse(cachedUsers);
            }
            const cachedProfiles = localStorage.getItem('toshka_user_profiles_cache');
            if(cachedProfiles) {
                appData.userProfiles = JSON.parse(cachedProfiles);
            }

            db.ref('stations').on('value', (snapshot) => {
                let data = snapshot.val();
                if (!data) { forceRepairStations(); } 
                else { 
                    appData.stations = data; 
                    localStorage.setItem('toshka_stations_cache', JSON.stringify(data)); 
                    forceRepairStations(); 
                }
                
                if (document.getElementById('stations-screen').classList.contains('active')) {
                    const activeTab = document.querySelector('.nav-tab.active');
                    renderStations(activeTab ? activeTab.dataset.zone : 'all');
                }
                if (document.getElementById('station-screen').classList.contains('active') && appData.currentStation) {
                    showStationDetails(appData.currentStation);
                }
                if (document.getElementById('user-profile-screen').classList.contains('active')) {
                    renderUserProfileForm();
                    renderUsersProfilesList();
                }
                if (document.getElementById('users-data-screen').classList.contains('active')) {
                    renderUsersDataManagement();
                }
                if (document.getElementById('inspection-export-screen').classList.contains('active')) {
                    updateExportFilters();
                }
            });
            
            db.ref('users').on('value', (snapshot) => {
                const loginBtn = document.getElementById('login-btn');
                if (snapshot.val()) {
                    appData.users = snapshot.val();
                    localStorage.setItem('toshka_users_cache', JSON.stringify(appData.users)); 
                    
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = "دخول";
                        loginBtn.style.backgroundColor = '';
                        loginBtn.style.color = '';
                        loginBtn.style.cursor = 'pointer';
                        loginBtn.classList.add('btn-primary');
                    }
                }
                else {
                    const defaultUsers = {
                        admin: { type: 'admin', password: 'admin123', active: true },
                        engineer1: { type: 'engineer', password: 'eng123', active: true },
                        supervisor1: { type: 'supervisor', password: 'sup123', active: true },
                        operator1: { type: 'operator', password: 'op123', active: true }
                    };
                    
                    db.ref('users').set(defaultUsers);
                    appData.users = defaultUsers;
                    localStorage.setItem('toshka_users_cache', JSON.stringify(defaultUsers));
                    
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = "دخول";
                        loginBtn.style.backgroundColor = '';
                        loginBtn.style.color = '';
                        loginBtn.style.cursor = 'pointer';
                        loginBtn.classList.add('btn-primary');
                    }
                }
            });
            
            db.ref('userProfiles').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appData.userProfiles = data;
                    localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(data));
                } else {
                    appData.userProfiles = {};
                    localStorage.setItem('toshka_user_profiles_cache', JSON.stringify({}));
                }
                
                if (document.getElementById('user-profile-screen').classList.contains('active')) {
                    renderUserProfileForm();
                    renderUsersProfilesList();
                }
                if (document.getElementById('users-data-screen').classList.contains('active')) {
                    renderUsersDataManagement();
                }
            });
            
            db.ref('history').limitToLast(200000).on('value', (snapshot) => {
                const val = snapshot.val();
                if(val) {
                    appData.operationHistory = Object.values(val).reverse();
                    cleanHistoricalData();
                }
                else appData.operationHistory = [];
                if (document.getElementById('history-screen').classList.contains('active')) renderHistoryTable(true);
            });
            
            db.ref('faults_log').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) appData.faultsLog = Array.isArray(val) ? val : Object.values(val);
                else appData.faultsLog = [];
                if (document.getElementById('faults-log-screen').classList.contains('active')) renderFaultsLog();
            });
            
            db.ref('consumption_logs').on('value', (snapshot) => {
                const val = snapshot.val();
                if(val) appData.consumptionLog = Object.values(val);
                else appData.consumptionLog = [];
            });
db.ref('emergencyData').on('value', (snapshot) => {
    if (snapshot.exists()) {
        const data = snapshot.val();
        emergencyData = {
            publicServices: data.publicServices || defaultEmergencyData.publicServices,
            emergencyTeam: data.emergencyTeam || defaultEmergencyData.emergencyTeam,
            clinicInfo: data.clinicInfo || defaultEmergencyData.clinicInfo,
            emergencyImage: data.emergencyImage || null
        };
        
        // تحديث الواجهة إذا كانت شاشة الطوارئ مفتوحة
        if (document.getElementById('emergency-info-screen').classList.contains('active')) {
            renderEmergencyData();
        }
    }
});
            
            updateNetworkStatus();
            updateOfflineBanner();
        }

        function forceRepairStations() {
            let updates = {};
            let repairCount = 0;
            const nowStd = getStandardDateTime();
            
            Object.keys(pumpsData).forEach(stationName => {
                const exists = appData.stations && appData.stations[stationName];
                if (!exists) {
                    let zone = 'Unknown';
                    appData.zones.forEach(z => { 
                        if(stationName.startsWith(z.split('_')[1])) zone = z; 
                        else if(stationName.startsWith('O1-')) zone = 'Zone_O1';
                        else if(stationName.startsWith('R')) zone = 'Zone_R';
                    });
                    if(stationName.startsWith('A')) zone='Zone_A';
                    
                    const pumpCount = pumpsData[stationName] || 4;
                    updates[stationName] = {
                        name: stationName, 
                        zone: zone, 
                        status: 'متوقفة', 
                        pressure: 0, 
                        maxPressure: 8.0, // إضافة قيمة افتراضية لاقصى ضغط
                        activePumps: 0,
                        voltage: 380, 
                        waterFlow: 0, 
                        systemMode: 'SCADA', 
                        operatorName: 'النظام',
                        lastUpdate: nowStd.full, 
                        comments: '',
                        startTime: '', 
                        stopTime: '',
                        currentFault: null, 
                        secondaryFault: null,
                        pumps: Array(pumpCount).fill().map((_, index) => ({ 
                            id: index + 1, 
                            status: 'متوقفة', 
                            suctionPressure: null, 
                            dischargePressure: null, 
                            frequency: null 
                        })),
                        consumption: { t1: '', t2: '', m3: '', lastUpdate: '' }
                    };
                    repairCount++;
                }
            });
            if (repairCount > 0 && navigator.onLine) db.ref('stations').update(updates);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`${screenId}-screen`).classList.add('active');
            window.scrollTo(0, 0);
            
            const userInfoDiv = document.getElementById('header-user-info');
            userInfoDiv.style.display = (screenId === 'login') ? 'none' : 'flex';
            if(screenId === 'stations') {
                const activeTab = document.querySelector('.nav-tab.active');
                renderStations(activeTab ? activeTab.dataset.zone : 'all');
            }
            if(screenId === 'users') {
                appData.currentUsersPage = 0;
                renderUsersManagement();
            }
            if(screenId === 'users-data') {
                appData.currentUsersDataPage = 0;
                renderUsersDataManagement();
            }
            if(screenId === 'history') {
                renderHistoryTable(true);
            }
            if(screenId === 'faults-log') {
                appData.faultsLimit = 100;
                renderFaultsLog();
            }
            if(screenId === 'user-profile') {
                appData.currentProfilesPage = 0;
                renderUserProfileForm();
                renderUsersProfilesList();
            }
            if(screenId === 'inspection-export') {
                updateExportFilters();
            }
        }

        // --- AUTHENTICATION ---
        document.getElementById('logout-btn').addEventListener('click', () => { 
            appData.currentUser = null; 
            showScreen('login'); 
        });
        
        document.getElementById('toggle-password-icon').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? '👁️' : '🔒';
        });
        
        function checkRememberedUser() {
            const savedUser = localStorage.getItem('toshka_user');
            const savedPass = localStorage.getItem('toshka_pass');
            if (savedUser && savedPass) {
                document.getElementById('username').value = savedUser;
                document.getElementById('password').value = savedPass;
                document.getElementById('remember-me').checked = true;
            }
        }
        
        document.getElementById('login-btn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const user = appData.users[u];
            const remember = document.getElementById('remember-me').checked;
            
            if (user && user.password === p && user.active !== false) {
                if (remember) { 
                    localStorage.setItem('toshka_user', u); 
                    localStorage.setItem('toshka_pass', p); 
                } 
                else { 
                    localStorage.removeItem('toshka_user'); 
                    localStorage.removeItem('toshka_pass'); 
                }
                
                appData.currentUser = {
                    username: u,
                    id: u,
                    name: u,
                    type: user.type,
                    permissions: appData.userTypes[user.type].permissions
                };
                
                document.getElementById('current-user').textContent = `${appData.userTypes[user.type].name}: ${u}`;
                
                const userType = user.type;
                const permissions = appData.userTypes[userType].permissions;
                
                document.getElementById('users-management-btn').style.display = permissions.manage_users ? 'inline-block' : 'none';
                document.getElementById('history-management-btn').style.display = permissions.view_history ? 'inline-block' : 'none';
                document.getElementById('export-inspection-report-btn').style.display = permissions.export_inspection ? 'inline-block' : 'none';
                
                if (userType === 'admin' || userType === 'engineer') {
                    document.getElementById('consumptions-btn').style.display = 'inline-block';
document.getElementById('work-orders-btn').style.display = 'flex';
                } else {
                    document.getElementById('consumptions-btn').style.display = 'none';
document.getElementById('work-orders-btn').style.display = 'none';
                }

                showScreen('stations');
                renderZonesTabs();
                renderStations('all');
            } else { 
                alert('بيانات خاطئة أو المستخدم غير مفعل'); 
            }
        });

        // --- NAVIGATION & BUTTONS FIXES ---
        document.getElementById('profile-btn').addEventListener('click', () => {
            if (!appData.currentUser) {
                alert('يجب تسجيل الدخول أولاً');
                return;
            }
            
            showScreen('user-profile');
            renderUserProfileForm();
            renderUsersProfilesList();
        });
        
        document.getElementById('users-management-btn').addEventListener('click', () => {
            if (appData.currentUser && appData.currentUser.permissions.manage_users) {
                showScreen('users');
            } else {
                alert('ليس لديك صلاحية للوصول إلى إدارة المستخدمين');
            }
        });
        
        document.getElementById('history-management-btn').addEventListener('click', () => showScreen('history'));
        document.getElementById('alarm-btn').addEventListener('click', () => showScreen('faults-log'));
        document.getElementById('export-inspection-report-btn').addEventListener('click', () => {
            if (appData.currentUser && appData.currentUser.permissions.export_inspection) {
                showScreen('inspection-export');
            } else {
                alert('ليس لديك صلاحية لتصدير تقارير الفحص');
            }
        });

        document.getElementById('back-to-stations').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-station').addEventListener('click', () => showStationDetails(appData.currentStation));
        document.getElementById('back-to-stations-from-users').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-history').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-faults').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-cons').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-from-inspection').addEventListener('click', () => { showStationDetails(appData.currentStation); });
        document.getElementById('back-to-stations-from-profile').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-users-data').addEventListener('click', () => showScreen('stations'));
        document.getElementById('back-to-stations-from-export').addEventListener('click', () => showScreen('stations'));

        // New button for user data management
        document.getElementById('profile-btn').addEventListener('dblclick', () => {
            if (appData.currentUser && appData.currentUser.type === 'admin') {
                showScreen('users-data');
            }
        });

        // --- SHIFT CHECK LOGIC ---
        function checkShiftAdherence(lastUpdateStr) {
            if (!lastUpdateStr) return true;
            const lastUpdate = parseCustomDate(lastUpdateStr);
            if (!lastUpdate || isNaN(lastUpdate.getTime())) return true;

            const now = new Date();
            const currentHour = now.getHours();
            let shiftStart = new Date(now);
            shiftStart.setMinutes(0); shiftStart.setSeconds(0); shiftStart.setMilliseconds(0);

            if (currentHour >= 6 && currentHour < 18) {
                shiftStart.setHours(6);
                return lastUpdate < shiftStart;
            } else {
                if (currentHour >= 18) { shiftStart.setHours(18); } 
                else { shiftStart.setDate(shiftStart.getDate() - 1); shiftStart.setHours(18); }
                return lastUpdate < shiftStart;
            }
        }

        // --- DASHBOARD RENDERER ---
        function renderZonesTabs() {
    const c = document.getElementById('zones-tabs');
    c.innerHTML = '';
    
    // التأكد من وجود قيمة افتراضية
    if (!appData.currentZone) appData.currentZone = 'all';

    // رسم زر الكل
    const allActive = appData.currentZone === 'all' ? 'active' : '';
    c.innerHTML += `<button class="nav-tab ${allActive}" data-zone="all" onclick="handleTabClick('all', this)">الكل</button>`;
    
    // رسم باقي المناطق
    appData.zones.forEach(z => {
        const isActive = appData.currentZone === z ? 'active' : '';
        c.innerHTML += `<button class="nav-tab ${isActive}" data-zone="${z}" onclick="handleTabClick('${z}', this)">${z}</button>`;
    });
}

window.handleTabClick = (zone, btn) => {
    // إزالة التنشيط من جميع الأزرار
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    // تنشيط الزر المضغوط
    btn.classList.add('active');
    // حفظ المنطقة في الذاكرة
    appData.currentZone = zone;
    // عرض المحطات
    renderStations(zone);
};
        
        window.renderStations = (zoneFilter = 'all') => {
    const container = document.getElementById('stations-container');
    container.innerHTML = '';
    
    // 1. جلب كل المحطات كقائمة
    const allStations = Object.values(appData.stations || {});
    
    if(allStations.length === 0) { 
        container.innerHTML = '<div style="text-align:center; padding:20px;">جاري تحميل البيانات...</div>';
        return; 
    }

    // 2. إنشاء قائمة مخصصة للإحصائيات (تتأثر بالفلتر)
    let stationsForStats = allStations;
    
    if (zoneFilter !== 'all') {
        // إذا لم يكن الفلتر "الكل"، نأخذ فقط محطات المنطقة المختارة
        stationsForStats = allStations.filter(s => s.zone === zoneFilter);
    }

    // 3. حساب الإحصائيات بناءً على القائمة المفلترة (stationsForStats)
    const totalCount = stationsForStats.length;
    const activeCount = stationsForStats.filter(s => s.status === 'نشطة').length;
    // حساب المتوقفة: هي الفرق بين الإجمالي والنشطة (لتشمل المعطلة والمتوقفة يدوياً)
    const inactiveCount = totalCount - activeCount;

    // 4. تحديث الأرقام في الشاشة
    document.getElementById('total-stations').textContent = totalCount;
    document.getElementById('active-stations').textContent = activeCount;
    document.getElementById('inactive-stations').textContent = inactiveCount;

    // --- منطق شريط الأخبار (Ticker) ---
    // ملاحظة: يُفضل أن يعرض الشريط الأعطال في كل النظام (allStations) للتنبيه،
    // لكن إذا أردته مفلتراً أيضاً، استبدل allStations بـ stationsForStats في السطر التالي.
// 1. تحديد المحطات التي بها أعطال (من أجل شريط الأخبار)
    const faultedStations = allStations.filter(s => s.currentFault || s.secondaryFault);

    // 2. حساب إجمالي عدد الأعطال الفعلي (الرئيسي + الثانوي) لتصحيح العداد
    let totalActiveFaults = 0;
    allStations.forEach(s => {
        if (s.currentFault) totalActiveFaults++;
        if (s.secondaryFault) totalActiveFaults++;
    });

    const tickerContainer = document.getElementById('ticker-container');
    const tickerContent = document.getElementById('ticker-content');
    const alarmBtn = document.getElementById('alarm-btn');
    const alarmCount = document.getElementById('alarm-count');

    // نستخدم إجمالي الأعطال (totalActiveFaults) للتحقق بدلاً من عدد المحطات
    if (totalActiveFaults > 0) {
        tickerContainer.classList.add('active');
        let tickerHtml = '';
        
        // حلقة التكرار لشريط الأخبار تبقى كما هي تعتمد على المحطات
        faultedStations.forEach((s, index) => {
            if (s.currentFault) {
                const icon = faultIcons[s.currentFault] || '⚠️';
                tickerHtml += `<span class="ticker-item">${icon} ${s.name}: ${s.currentFault}</span>`;
            }
            if (s.secondaryFault) {
                const icon = faultIcons[s.secondaryFault] || '⚠️';
                // فاصل صغير إذا كان هناك عطلين في نفس المحطة
                if(s.currentFault) tickerHtml += `<span class="ticker-separator">|</span>`;
                tickerHtml += `<span class="ticker-item">${icon} ${s.name}: ${s.secondaryFault}</span>`;
            }
            if (index < faultedStations.length - 1) { tickerHtml += `<span class="ticker-separator">•</span>`; }
        });
        tickerContent.innerHTML = tickerHtml;
        
        // ضبط سرعة الأنيميشن
        setTimeout(() => {
            const contentWidth = tickerContent.scrollWidth;
            const containerWidth = tickerContainer.offsetWidth;
            const speed = 100; 
            const duration = (contentWidth + containerWidth) / speed;
            const finalDuration = Math.max(duration, 5); 
            tickerContent.style.animationDuration = `${finalDuration}s`;
        }, 100);

        alarmBtn.classList.add('flashing');
        alarmCount.style.display = 'flex';
        
        // ✅ التصحيح الجوهري: وضع الرقم الإجمالي للأعطال بدلاً من عدد المحطات
        alarmCount.textContent = totalActiveFaults; 

    } else {
        tickerContainer.classList.remove('active');
        alarmBtn.classList.remove('flashing');
        alarmCount.style.display = 'none';
        alarmCount.textContent = '0';
    }

    // --- رسم بطاقات المحطات ---
    // نستخدم stationsForStats مباشرة لأنها مفلترة بالفعل وجاهزة للعرض
    
    // تجميع المحطات حسب المنطقة للعرض (في حال كان الفلتر "الكل"، سيتم تجميعها)
    // إذا كان الفلتر منطقة محددة، ستكون هناك مجموعة واحدة فقط
    const groupedByZone = {};
    
    // إذا كان الفلتر "الكل"، نستخدم appData.zones لترتيب العرض
    // إذا كان منطقة محددة، نستخدم تلك المنطقة فقط
    const zonesToIterate = (zoneFilter === 'all') ? appData.zones : [zoneFilter];

    zonesToIterate.forEach(zoneName => {
        // نفلتر من القائمة المجهزة للإحصائيات
        // (ملاحظة: إذا كان الفلتر منطقة محددة، stationsForStats ستحتوي فقط على تلك المنطقة)
        const zoneStations = stationsForStats.filter(s => s.zone === zoneName);
        
        if (zoneStations.length > 0) {
            const separator = document.createElement('div');
            separator.className = 'zone-separator';
            separator.innerHTML = `<span>${zoneName}</span> <span style="font-size:0.9rem; opacity:0.8;">(${zoneStations.length})</span>`;
            container.appendChild(separator);
            
            const grid = document.createElement('div');
            grid.className = 'stations-grid';
            
            zoneStations.forEach(s => {
                // ... (نفس منطق رسم البطاقة السابق) ...
                const isFault = (s.currentFault || s.secondaryFault) ? true : false;
                let cardClass = 'station-card';
                if (isFault) {
                    cardClass += ' fault-active';
                    if (s.currentFault === 'انقطاع الاتصال SCADA' || s.secondaryFault === 'انقطاع الاتصال SCADA') cardClass += ' scada-fault';
                }
                const card = document.createElement('div');
                card.className = cardClass;
                let faultHtml = '';
                if(isFault) {
                    if(s.currentFault) {
                        const icon = faultIcons[s.currentFault] || '⚠️';
                        let badgeClass = 'fault-badge';
                        if (s.currentFault === 'انقطاع الاتصال SCADA') badgeClass += ' scada-badge';
                        faultHtml += `<div class="${badgeClass}">${icon} ${s.currentFault}</div>`;
                    }
                    if(s.secondaryFault) {
                        const icon = faultIcons[s.secondaryFault] || '⚠️';
                        let badgeClass = 'fault-badge';
                        if (s.secondaryFault === 'انقطاع الاتصال SCADA') badgeClass += ' scada-badge';
                        faultHtml += `<div class="${badgeClass}" style="margin-top:2px;">${icon} ${s.secondaryFault}</div>`;
                    }
                }

                let missedUpdateHtml = '';
                if (checkShiftAdherence(s.lastUpdate)) { 
                    missedUpdateHtml = `<span class="missed-update-icon" title="لم يتم التحديث في الموعد">!</span>`;
                }

                let pressureWarningHtml = '';
                const currentPressure = parseFloat(s.pressure) || 0;
                const maxPressure = parseFloat(s.maxPressure) || 8.0;
                if (currentPressure > maxPressure) {
                    pressureWarningHtml = `<span class="pressure-warning" title="الضغط أعلى من المسموح به (${maxPressure} Bar)">!</span>`;
                }
card.innerHTML = `
                    <div style="font-weight:bold; color:var(--primary-color)">${missedUpdateHtml}${s.name}</div>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <span class="station-status ${s.status === 'نشطة' ? 'status-active' : 'status-inactive'}">${s.status}</span>
                        <span class="station-status" style="background-color:#e3f2fd; color:#0d47a1; border:1px solid #bbdefb;">${s.systemMode || '-'}</span>
                    </div>
                    ${faultHtml}
            
                    <div style="margin-top:10px; font-size:13px;">
                        <div>الضغط: ${pressureWarningHtml}${s.pressure} Bar</div>
                        <div>الجهد: ${s.voltage} V</div>
                        <div style="color:var(--secondary-color);">التدفق: ${s.waterFlow} L/Sec</div>
                        <div>المضخات: ${s.activePumps}</div>
                    </div>`;
                card.onclick = () => showStationDetails(s.name);
                grid.appendChild(card);
            });
            container.appendChild(grid);
        }
    });
};

        // --- STATION DETAILS ---
        function showStationDetails(stationId) {
            const s = appData.stations[stationId];
            if (!s) return;
            appData.currentStation = stationId;
            
            document.getElementById('station-title').textContent = s.name;
            document.getElementById('station-status-value').textContent = s.status;
            document.getElementById('operator-name-value').textContent = s.operatorName;
            document.getElementById('voltage-value').textContent = s.voltage;
            document.getElementById('station-pressure-value').textContent = s.pressure;
            // إضافة عرض اقصى ضغط في شاشة التفاصيل
            document.getElementById('max-pressure-value').textContent = s.maxPressure || '8.0';
            document.getElementById('active-pumps-value').textContent = s.activePumps;
            document.getElementById('water-flow-value').textContent = s.waterFlow;
            document.getElementById('system-mode-value').textContent = s.systemMode;
            document.getElementById('start-time-value').textContent = s.startTime || '-';
            document.getElementById('stop-time-value').textContent = s.stopTime || '-';
            
            document.getElementById('last-update-value').textContent = s.lastUpdate;
            document.getElementById('station-comments-value').textContent = s.comments || 'لا يوجد ملاحظات';

            const cons = s.consumption || {};
            document.getElementById('view-cons-t1').textContent = cons.t1 || '-';
            document.getElementById('view-cons-t2').textContent = cons.t2 || '-';
            document.getElementById('view-cons-m3').textContent = cons.m3 || '-';
            document.getElementById('view-cons-date').textContent = cons.lastUpdate || 'غير مسجل';

            const banner = document.getElementById('station-fault-banner');
            const faultList = document.getElementById('station-fault-list');
            if (s.currentFault || s.secondaryFault) {
                banner.style.display = 'block';
                faultList.innerHTML = '';
                let hasScadaFault = false;
                if(s.currentFault) {
                    if (s.currentFault === 'انقطاع الاتصال SCADA') hasScadaFault = true;
                    const descText = s.fault1Desc ? ` <span style="font-weight:normal; color:#d32f2f">(${s.fault1Desc})</span>` : '';
                    faultList.innerHTML += `<li>${s.currentFault}${descText} <span style="font-size:0.8em; color:#666">(${s.faultStartTime || '-'})</span></li>`;
                }
                if(s.secondaryFault) {
                    if (s.secondaryFault === 'انقطاع الاتصال SCADA') hasScadaFault = true;
                    const descText = s.fault2Desc ? ` <span style="font-weight:normal; color:#d32f2f">(${s.fault2Desc})</span>` : '';
                    faultList.innerHTML += `<li>${s.secondaryFault}${descText}</li>`;
                }
                if (hasScadaFault) { 
                    banner.style.background = '#fff3cd';
                    banner.style.color = '#856404'; 
                    banner.style.borderColor = '#ffeeba'; 
                } 
                else { 
                    banner.style.background = '#ffecec';
                    banner.style.color = '#b71c1c'; 
                    banner.style.borderColor = '#ffcdd2'; 
                }
            } else { 
                banner.style.display = 'none';
            }

            const tbody = document.getElementById('pumps-table-body');
            tbody.innerHTML = '';
            s.pumps.forEach(p => {
                let statusColor = p.status==='نشطة'?'green':'red';
                if(p.status === 'معطلة') statusColor = 'orange';
                tbody.innerHTML += `<tr><td>${p.id}</td><td style="color:${statusColor}">${p.status}</td><td>${p.suctionPressure||'-'}</td><td>${p.dischargePressure||'-'}</td><td>${p.frequency||'-'}</td></tr>`;
            });
            
            const canEdit = appData.currentUser && (
                appData.currentUser.permissions.edit_all || 
                appData.currentUser.permissions.edit_some || 
                appData.currentUser.permissions.edit_own
            );
            document.getElementById('edit-station-btn').style.display = canEdit ? 'block' : 'none';
            showScreen('station');
        }

        // --- EDIT MODE & FAULT RESOLUTION ---
        document.getElementById('edit-station-btn').addEventListener('click', () => {
            const s = appData.stations[appData.currentStation];
            document.getElementById('editing-station-name').textContent = `محطة: ${s.name}`;
            
            let currentOperatorName = 'غير معرّف';
            if (appData.currentUser) {
                currentOperatorName = appData.currentUser.username || 
                                     appData.currentUser.name || 
                                     appData.currentUser.id || 
                                     'غير معرّف';
            }
            document.getElementById('operator-name').value = currentOperatorName;
            
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('operator-start-time').value = s.startTime || timeString;
            document.getElementById('operator-stop-time').value = s.stopTime || '';
            document.getElementById('operator-pressure').value = s.pressure;
            document.getElementById('operator-water-flow').value = s.waterFlow;
            document.getElementById('operator-voltage').value = s.voltage;
            document.getElementById('operator-system-mode').value = s.systemMode;
            document.getElementById('operator-comments').value = s.comments;
            
            // تعيين قيمة اقصى ضغط في شاشة المشغل
            document.getElementById('operator-max-pressure').value = s.maxPressure || '8.0';
            
            // تحديد إمكانية تعديل اقصى ضغط بناءً على صلاحيات المستخدم
            const currentUser = appData.currentUser;
            const canEditMaxPressure = currentUser && (
                currentUser.type === 'admin' || 
                currentUser.type === 'engineer' || 
                currentUser.type === 'supervisor'
            );
            
            if (canEditMaxPressure) {
                document.getElementById('operator-max-pressure').readOnly = false;
                document.getElementById('operator-max-pressure').style.background = '#fff';
            } else {
                document.getElementById('operator-max-pressure').readOnly = true;
                document.getElementById('operator-max-pressure').style.background = '#eee';
            }

            const cons = s.consumption || {};
            document.getElementById('cons-trans-1').value = cons.t1 || '';
            document.getElementById('cons-trans-2').value = cons.t2 || '';
            document.getElementById('cons-water-m3').value = cons.m3 || '';

            const faultControl = document.getElementById('active-fault-control');
            const row1 = document.getElementById('fault-row-1');
            const row2 = document.getElementById('fault-row-2');
            
            row1.style.display = 'none'; row2.style.display = 'none'; faultControl.style.display = 'none';
            if (s.currentFault || s.secondaryFault) {
                faultControl.style.display = 'block';
                if(s.currentFault) { row1.style.display = 'flex'; document.getElementById('txt-fault-1').textContent = s.currentFault; }
                if(s.secondaryFault) { row2.style.display = 'flex'; document.getElementById('txt-fault-2').textContent = s.secondaryFault; }
            }

            document.getElementById('fault-selector').value = s.currentFault || "";
            document.getElementById('fault-selector-secondary').value = s.secondaryFault || "";
            document.getElementById('fault-1-desc').value = s.fault1Desc || "";
            document.getElementById('fault-2-desc').value = s.fault2Desc || "";

            updateFaultExclusions();
            const c = document.getElementById('pumps-form-container');
            let pumpsHtml = '';
            s.pumps.forEach(p => {
                pumpsHtml += `
                    <div class="pump-control">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <b>مضخة ${p.id}</b>
                            <select id="p_stat_${p.id}" onchange="togglePumpInputs(${p.id})">
                                <option value="نشطة" ${p.status==='نشطة'?'selected':''}>نشطة</option>
                                <option value="متوقفة" ${p.status==='متوقفة'?'selected':''}>متوقفة</option>
                                <option value="معطلة" ${p.status==='معطلة'?'selected':''}>معطلة</option>
                            </select>
                        </div>
                        <input type="number" placeholder="سحب" id="p_suc_${p.id}" value="${p.suctionPressure||''}" class="p_inp_${p.id}">
                        <input type="number" placeholder="طرد" id="p_dis_${p.id}" value="${p.dischargePressure||''}" class="p_inp_${p.id}" style="margin-top:5px">
                        <input type="number" placeholder="تردد" id="p_freq_${p.id}" value="${p.frequency||''}" class="p_inp_${p.id}" style="margin-top:5px">
                        <input type="number" placeholder="ساعات التشغيل" id="p_hours_${p.id}" value="${p.operatingHours||''}" class="p_hours_inp_${p.id}" style="margin-top:5px">
                    </div>`;
            });
            c.innerHTML = pumpsHtml;
            s.pumps.forEach(p => { togglePumpInputs(p.id); });
            showScreen('operator');
        });
        
        window.togglePumpInputs = (id) => {
            const active = document.getElementById(`p_stat_${id}`).value === 'نشطة';
            document.querySelectorAll(`.p_inp_${id}`).forEach(i => {
                i.disabled = !active;
                if(!active) i.style.background = '#eee'; else i.style.background = '#fff';
            });
        };
        
        function updateFaultExclusions() {
            const f1 = document.getElementById('fault-selector');
            const f2 = document.getElementById('fault-selector-secondary');
            Array.from(f2.options).forEach(opt => opt.disabled = false);
            Array.from(f1.options).forEach(opt => opt.disabled = false);
            if(f1.value) { 
                const optIn2 = f2.querySelector(`option[value="${f1.value}"]`);
                if(optIn2) optIn2.disabled = true; 
            }
            if(f2.value) { 
                const optIn1 = f1.querySelector(`option[value="${f2.value}"]`);
                if(optIn1) optIn1.disabled = true; 
            }
        }
        
        document.getElementById('fault-selector').addEventListener('change', updateFaultExclusions);
        document.getElementById('fault-selector-secondary').addEventListener('change', updateFaultExclusions);

        document.getElementById('save-operator-data').addEventListener('click', () => saveDataInternal({}));
        document.getElementById('btn-resolve-f1').addEventListener('click', () => { if(confirm("هل تم إصلاح العطل الأول؟")) saveDataInternal({ resolveTarget: 'currentFault' }); });
        document.getElementById('btn-resolve-f2').addEventListener('click', () => { if(confirm("هل تم إصلاح العطل الثاني؟")) saveDataInternal({ resolveTarget: 'secondaryFault' }); });
        
function saveDataInternal(options = {}) {
    // --- 1. تعريف الزر وتعطيله فوراً لمنع التكرار ---
    const saveBtn = document.getElementById('save-operator-data');
    const originalBtnText = "حفظ البيانات"; // أو النص الأصلي الذي تفضله

    if (saveBtn.disabled) return;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="syncing">⏳</span> جاري الحفظ...';

    // دالة مساعدة لفك قفل الزر
    const resetButton = () => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnText;
    };

    try {
        const sName = appData.currentStation;
        if (!sName || !appData.stations[sName]) { 
            alert("خطأ: لا توجد محطة محددة!");
            resetButton();
            return; 
        }
        
        const oldData = appData.stations[sName];
        const getVal = (id) => { 
            const el = document.getElementById(id);
            return el ? el.value : ''; 
        };
        
        // ... (تجهيز المتغيرات - نفس الجزء السابق في كودك تماماً) ...
        const safeOldFault1 = (oldData.currentFault && oldData.currentFault !== "undefined") ? oldData.currentFault : null;
        const safeOldFault2 = (oldData.secondaryFault && oldData.secondaryFault !== "undefined") ? oldData.secondaryFault : null;

        let newOperator = '';
        if (appData.currentUser) {
            newOperator = appData.currentUser.username || appData.currentUser.id || appData.currentUser.name || 'غير معرّف';
        } else {
            newOperator = getVal('operator-name') || 'غير معرّف';
        }
        if (!newOperator || newOperator.trim() === '' || newOperator === 'undefined') newOperator = 'مستخدم النظام';
        
        let newPressure = parseFloat(getVal('operator-pressure')) || 0;
        let newFlow = parseFloat(getVal('operator-water-flow')) || 0;
        let newVoltage = getVal('operator-voltage');
        const newMode = getVal('operator-system-mode');
        const newComments = getVal('operator-comments');
        let newMaxPressure = parseFloat(getVal('operator-max-pressure')) || 8.0;
        
        let consTrans1 = getVal('cons-trans-1');
        let consTrans2 = getVal('cons-trans-2');
        let consWater = getVal('cons-water-m3');
        let newStartTime = getVal('operator-start-time');
        let newStopTime = getVal('operator-stop-time');
        
        const nowStd = getStandardDateTime();
        const updateDate = nowStd.date;
        const updateTime = nowStd.time;
        const sysTimeShort = updateTime.substring(0, 5);
        const stationFullDateTime = nowStd.full;
        let changesDetails = [];
        let activeCount = 0;
        let currentStatus = 'متوقفة';
        
        let finalFault = safeOldFault1;
        let finalFaultDesc = oldData.fault1Desc || null;
        let finalFaultSec = safeOldFault2;
        let finalFaultSecDesc = oldData.fault2Desc || null;
        let faultStartTime = oldData.faultStartTime || null;
        const nonStoppingFaults = ['انقطاع الاتصال SCADA', 'عجز تحقيق الضغط', 'انسدادات', 'تسريب مياه'];
        let newFaultEntries = [];
        let resolvedFaultEntries = [];

        // منطق معالجة الأعطال (نفس المنطق السابق)
        if (options.resolveTarget === 'currentFault') {
            if (safeOldFault1) { 
                changesDetails.push(`✅ إصلاح: ${safeOldFault1}`);
                resolvedFaultEntries.push({ station: sName, type: safeOldFault1, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
            }
            finalFault = null; finalFaultDesc = null; 
            if (!finalFaultSec) faultStartTime = null;
        } else if (options.resolveTarget === 'secondaryFault') {
            if (safeOldFault2) { 
                changesDetails.push(`✅ إصلاح: ${safeOldFault2}`);
                resolvedFaultEntries.push({ station: sName, type: safeOldFault2, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
            }
            finalFaultSec = null; finalFaultSecDesc = null; 
            if (!finalFault) faultStartTime = null;
        } else {
            const sel1 = getVal('fault-selector');
            const selDesc1 = getVal('fault-1-desc');
            let sel2 = getVal('fault-selector-secondary');
            let selDesc2 = getVal('fault-2-desc');
            if (sel1 && sel1 === sel2) sel2 = "";
            finalFault = sel1 || null; 
            finalFaultDesc = finalFault ? selDesc1 : null; 
            finalFaultSec = sel2 || null; 
            finalFaultSecDesc = finalFaultSec ? selDesc2 : null;

            if (finalFault !== safeOldFault1) {
                if (finalFault) { 
                    changesDetails.push(`⚠️ تسجيل عطل 1: ${finalFault}`);
                    newFaultEntries.push({ station: sName, type: finalFault, startTime: stationFullDateTime, endTime: null, active: true }); 
                    if(!safeOldFault1) faultStartTime = stationFullDateTime;
                } else { 
                    if (safeOldFault1) { 
                        changesDetails.push(`✅ إصلاح: ${safeOldFault1}`);
                        resolvedFaultEntries.push({ station: sName, type: safeOldFault1, startTime: faultStartTime, endTime: stationFullDateTime, active: false });
                    } 
                    if (!finalFaultSec) faultStartTime = null;
                }
            }
            if (finalFaultSec !== safeOldFault2) {
                if (finalFaultSec) { 
                    changesDetails.push(`⚠️ تسجيل عطل 2: ${finalFaultSec}`);
                    newFaultEntries.push({ station: sName, type: finalFaultSec, startTime: stationFullDateTime, endTime: null, active: true });
                    if (!faultStartTime) faultStartTime = stationFullDateTime;
                } else { 
                    if (safeOldFault2) { 
                        changesDetails.push(`✅ إصلاح: ${safeOldFault2}`);
                        resolvedFaultEntries.push({ station: sName, type: safeOldFault2, startTime: stationFullDateTime, endTime: stationFullDateTime, active: false });
                    } 
                }
            }
        }

        const isCriticalFault = (finalFault && !nonStoppingFaults.includes(finalFault)) || (finalFaultSec && !nonStoppingFaults.includes(finalFaultSec));
        if (isCriticalFault) { 
            currentStatus = 'متوقفة'; activeCount = 0; newPressure = 0; newFlow = 0;
            if (finalFault === 'انقطاع التيار الكهربي' || finalFaultSec === 'انقطاع التيار الكهربي') newVoltage = 0;
        }
        
        if (!oldData.pumps) oldData.pumps = [];
        const updatedPumps = oldData.pumps.map(p => {
            const statElem = document.getElementById(`p_stat_${p.id}`);
            let newStatus = statElem ? statElem.value : p.status;
            if (isCriticalFault && newStatus === 'نشطة') newStatus = 'متوقفة';
            if(p.status != newStatus) changesDetails.push(`مضخة ${p.id} (من ${p.status} إلى ${newStatus})`);
// 1. قراءة قيمة ساعات التشغيل الحالية من الخانة (سواء كانت نشطة أو متوقفة)
    const hoursInput = document.getElementById(`p_hours_${p.id}`);
    // نأخذ القيمة من الخانة، وإذا لم توجد نأخذ القيمة القديمة المحفوظة
    const currentHours = hoursInput ? hoursInput.value : (p.operatingHours || 0);

    // 2. إنشاء كائن البيانات مع الحفاظ على الساعات
    let pumpData = { 
        id: p.id, 
        status: newStatus, 
        operatingHours: currentHours, // ✅ تم ربط الساعات هنا لتثبيتها
        suctionPressure: null, 
        dischargePressure: null, 
        frequency: null 
    };

    // 3. إذا كانت نشطة فقط، نقوم بتسجيل باقي القراءات اللحظية
    if(newStatus === 'نشطة') { 
        activeCount++;
        pumpData.suctionPressure = getVal(`p_suc_${p.id}`); 
        pumpData.dischargePressure = getVal(`p_dis_${p.id}`);
        pumpData.frequency = getVal(`p_freq_${p.id}`);
    }
    return pumpData;
});
        
        if (!isCriticalFault) { 
            if (activeCount > 0) currentStatus = 'نشطة';
            else { currentStatus = 'متوقفة'; newPressure = 0; newFlow = 0; } 
        }

        const oldStatus = oldData.status;
        const oldStartTime = oldData.startTime || '';
        const oldStopTime = oldData.stopTime || '';
        const enteredStartTime = getVal('operator-start-time');
        const enteredStopTime = getVal('operator-stop-time');
        
        if (oldStatus === 'متوقفة' && currentStatus === 'نشطة') {
            if (!enteredStartTime || enteredStartTime === oldStartTime) {
                newStartTime = sysTimeShort;
                changesDetails.push(`⏰ وقت التشغيل التلقائي: ${sysTimeShort}`);
            } else { newStartTime = enteredStartTime; }
            newStopTime = '';
        }
        else if (oldStatus === 'نشطة' && currentStatus === 'متوقفة') {
            if (!enteredStopTime || enteredStopTime === oldStopTime) {
                newStopTime = sysTimeShort;
                changesDetails.push(`⏰ وقت الإيقاف التلقائي: ${sysTimeShort}`);
            } else { newStopTime = enteredStopTime; }
            if (!enteredStartTime || enteredStartTime === oldStartTime) newStartTime = oldStartTime;
            else newStartTime = enteredStartTime;
        }
        else {
            if (currentStatus === 'نشطة') {
                newStopTime = '';
                if (!enteredStartTime || enteredStartTime === oldStartTime) newStartTime = oldStartTime;
                else newStartTime = enteredStartTime;
            } else {
                if (!enteredStopTime || enteredStopTime === oldStopTime) newStopTime = oldStopTime;
                else newStopTime = enteredStopTime;
                if (!enteredStartTime || enteredStartTime === oldStartTime) newStartTime = oldStartTime;
                else newStartTime = enteredStartTime;
            }
        }

        if (isCriticalFault) {
            if (oldStatus === 'نشطة' && currentStatus === 'متوقفة') {
                newStopTime = sysTimeShort;
                changesDetails.push(`⏰ وقت الإيقاف بسبب العطل: ${sysTimeShort}`);
            }
        }
        
        if (oldData.status !== currentStatus) changesDetails.push(`حالة المحطة: ${oldData.status} -> ${currentStatus}`);
        if(oldData.pressure != newPressure) changesDetails.push(`الضغط: ${oldData.pressure} -> ${newPressure}`);
        if(oldData.maxPressure != newMaxPressure) changesDetails.push(`اقصى ضغط: ${oldData.maxPressure || '8.0'} -> ${newMaxPressure}`);
        
        let consumptionLogData = null;
        const oldCons = oldData.consumption || {};
        if (consTrans1 || consTrans2 || consWater) {
            if (consTrans1 != oldCons.t1 || consTrans2 != oldCons.t2 || consWater != oldCons.m3) changesDetails.push('تم تحديث الاستهلاكات');
            consumptionLogData = { date: updateDate, time: updateTime, station: sName, t1: consTrans1, t2: consTrans2, m3: consWater, operator: newOperator };
        }
        if (oldData.operatorName !== newOperator) changesDetails.push(`المشغل: ${oldData.operatorName || 'غير معرّف'} -> ${newOperator}`);
        
        const changesString = changesDetails.length > 0 ? changesDetails.join(', ') : "تحديث دوري";
        const logDetails = [];
        if (changesString !== "تحديث دوري") logDetails.push(changesString);
        if (newStartTime && oldData.startTime !== newStartTime) logDetails.push(`وقت التشغيل: ${oldData.startTime || 'غير محدد'} -> ${newStartTime}`);
        if (newStopTime && oldData.stopTime !== newStopTime) logDetails.push(`وقت الإيقاف: ${oldData.stopTime || 'غير محدد'} -> ${newStopTime}`);
        const finalLogDetails = logDetails.length > 0 ? logDetails.join(', ') : "تحديث دوري";
        
        const log = { 
            date: updateDate, time: updateTime, station: sName, operator: newOperator,
            details: finalLogDetails, startTime: newStartTime || oldData.startTime || '', stopTime: newStopTime || oldData.stopTime || ''
        };
        const updates = {
            pressure: newPressure, waterFlow: newFlow, voltage: newVoltage,
            systemMode: newMode, operatorName: newOperator, comments: newComments,
            lastUpdate: stationFullDateTime, startTime: newStartTime, stopTime: newStopTime, 
            activePumps: activeCount, status: currentStatus, 
            currentFault: finalFault, fault1Desc: finalFaultDesc,
            secondaryFault: finalFaultSec, fault2Desc: finalFaultSecDesc,
            faultStartTime: faultStartTime, pumps: updatedPumps,
            maxPressure: newMaxPressure, 
            consumption: { t1: consTrans1, t2: consTrans2, m3: consWater, lastUpdate: stationFullDateTime }
        };

        // --- دالة الحفظ المحلي (Offline) ---
        const performOfflineSave = () => {
            console.log("Entering offline save mode...");
            addToOfflineQueue('update_station', { 
                stationId: sName, updates: updates, log: log, 
                consLog: consumptionLogData, newFaults: newFaultEntries, resolvedFaults: resolvedFaultEntries 
            });
            
            // تحديث الواجهة محلياً فوراً
            Object.assign(appData.stations[sName], updates);
            localStorage.setItem('toshka_stations_cache', JSON.stringify(appData.stations));
            
            isWeakSignal = true; // نعتبرها إشارة ضعيفة لأن الرفع فشل
            updateNetworkStatus();
            showSuccessFeedback(sName, true); // رسالة صفراء
            resetButton();
        };

        // --- محاولة الرفع مع منطق Timeout صارم ---
        if (navigator.onLine && isFirebaseConnected) {
            
            // إنشاء Promise يرفض الطلب بعد 7 ثواني
            const timeoutPromise = new Promise((_, reject) => {
                const id = setTimeout(() => {
                    clearTimeout(id);
                    reject(new Error("NetworkTimeout"));
                }, 7000);
            });

            // عملية الحفظ في Firebase
            const savePromise = db.ref('stations/' + sName).update(updates).then(() => {
                // حفظ السجلات الجانبية (لا ننتظرها لإنهاء الـ Promise الأساسي لتسريع العملية)
                if (appData.operationHistory.length >= 200000) db.ref('history').orderByKey().limitToFirst(1).once('child_added', (snapshot) => { snapshot.ref.remove(); });
                db.ref('history').push(log);
                if(consumptionLogData) db.ref('consumption_logs').push(consumptionLogData);
                
                if (newFaultEntries.length > 0 || resolvedFaultEntries.length > 0) {
                     db.ref('faults_log').once('value').then(snap => {
                        let rawVal = snap.val(); 
                        let logs = []; 
                        if (rawVal) { if (Array.isArray(rawVal)) logs = rawVal; else logs = Object.values(rawVal); }
                        newFaultEntries.forEach(newF => { 
                            const exists = logs.some(existingF => existingF.active === true && existingF.station === newF.station && existingF.type === newF.type);
                            if (!exists) logs.unshift(newF);
                        });
                        resolvedFaultEntries.forEach(rf => { 
                            const index = logs.findIndex(f => f.station === sName && f.type === rf.type && f.active === true); 
                            if (index !== -1) { 
                                logs[index].active = false; logs[index].endTime = stationFullDateTime; 
                            } else { logs.unshift(rf); } 
                        });
                        if (logs.length > 200000) logs = logs.slice(0, 200000); 
                        db.ref('faults_log').set(logs);
                    });
                }
                return "Success";
            });

            // السباق!
            Promise.race([savePromise, timeoutPromise])
                .then(() => {
                    // إذا فاز الحفظ (الشبكة جيدة)
                    isWeakSignal = false;
                    updateNetworkStatus();
                    Object.assign(appData.stations[sName], updates);
                    localStorage.setItem('toshka_stations_cache', JSON.stringify(appData.stations));
                    showSuccessFeedback(sName, false); // رسالة خضراء
                    resetButton();
                })
                .catch(err => {
                    // إذا فاز التايم أوت أو حدث خطأ
                    console.warn("Save failed or timed out:", err.message);
                    performOfflineSave(); // التوجه للحفظ المحلي فوراً
                });

        } else {
            // لا يوجد اتصال من البداية
            performOfflineSave();
        }

    } catch (e) { 
        console.error(e);
        alert("حدث خطأ برمجي: " + e.message); 
        resetButton();
    }
}

        function showSuccessFeedback(sName, isOffline = false) {
            const alertDiv = document.getElementById('operator-alert');
            alertDiv.textContent = isOffline ? 'تم الحفظ في الجهاز (سيتم الرفع عند الاتصال) ⏳' : 'تم الحفظ والمزامنة! ✅';
            alertDiv.className = isOffline ? 'alert alert-warning' : 'alert alert-success';
            alertDiv.style.display = 'block';
            setTimeout(() => { 
                alertDiv.style.display = 'none'; 
                showStationDetails(sName); 
            }, 1500);
        }

        function cleanHistoricalData() {
            if (appData.operationHistory && appData.operationHistory.length > 0) {
                appData.operationHistory = appData.operationHistory.map(log => {
                    if (!log.operator || log.operator === 'undefined') {
                        return { ...log, operator: 'مستخدم النظام' };
                    }
                    return log;
                });
            }
        }

        // --- MOBILE OPTIMIZED INSPECTION LOGIC ---
        function renderInspection(mode = 'view') {
            const container = document.getElementById('inspection-container');
            container.innerHTML = '';
            const sName = appData.currentStation;
            const sData = appData.stations[sName];
            if(!sData) return;
            const insData = sData.inspectionData || {};
            const isEdit = (mode === 'edit');
            const saveBtn = document.getElementById('inspection-actions');
            saveBtn.style.display = isEdit ? 'block' : 'none';
            
            // إظهار زر تصدير Excel فقط في وضع العرض وليس التعديل
            const exportBtn = document.getElementById('export-inspection-excel');
            exportBtn.style.display = (mode === 'view' && sData.inspectionData) ? 'block' : 'none';
            
            Object.keys(inspectionSchema).forEach((key) => {
                const schema = inspectionSchema[key];
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-accordion';
                let title = schema.title;
                if (key === 'pumps') { 
                    const totalPumps = sData.pumps ? sData.pumps.length : 4; 
                    title += ` (${totalPumps})`; 
                }
                const headerDiv = document.createElement('div');
                if (isEdit) { 
                    headerDiv.className = 'section-header-static'; 
                    headerDiv.innerHTML = `<span>${title}</span>`; 
                } 
                else {
                    headerDiv.className = 'section-accordion-header'; 
                    headerDiv.innerHTML = `<span>${title}</span> <span class="arrow">▼</span>`;
                    headerDiv.onclick = function() { 
                        const body = this.nextElementSibling; 
                        body.classList.toggle('open'); 
                        this.classList.toggle('active'); 
                    };
                }
                const bodyDiv = document.createElement('div');
                if (isEdit) bodyDiv.className = 'section-body-static'; 
                else { 
                    bodyDiv.className = 'section-accordion-body'; 
                    bodyDiv.id = `section-body-${key}`;
                }
                
                if (key === 'pumps') {
                    const totalPumps = sData.pumps ? sData.pumps.length : 4; 
                    const pumpsInsData = insData.pumps || {};
                    for (let i = 1; i <= totalPumps; i++) {
                        const pData = pumpsInsData[i] || {};
                        let headerClass = 'pump-header-green'; 
                        let icon = '✅'; 
                        const criticalIndices = [1, 5, 10, 11, 12];
                        let isRed = false; 
                        let isYellow = false;
                        schema.items.forEach((item, idx) => { 
                            const status = pData[idx] ? pData[idx].status : 'efficient'; 
                            if (criticalIndices.includes(idx)) { 
                                if (status === 'broken') isRed = true; 
                            } 
                            if (status === 'fault') isYellow = true; 
                        });
                        if (isRed) { 
                            headerClass = 'pump-header-red'; 
                            icon = '🛑'; 
                        } else if (isYellow) { 
                            headerClass = 'pump-header-yellow'; 
                            icon = '⚠️';
                        }
                        const pumpItemDiv = document.createElement('div');
                        pumpItemDiv.className = 'pump-accordion-item';
                        const pumpHeaderDiv = document.createElement('div'); 
                        pumpHeaderDiv.className = `pump-accordion-header ${headerClass}`; 
                        pumpHeaderDiv.innerHTML = `<span>مضخة رقم ${i}</span> <span class="icon-state">${icon}</span>`;
                        pumpHeaderDiv.onclick = (e) => { 
                            e.stopPropagation(); 
                            togglePumpAccordion(i); 
                        };
                        const pumpBodyDiv = document.createElement('div'); 
                        pumpBodyDiv.className = 'pump-accordion-body'; 
                        pumpBodyDiv.id = `pump-body-${i}`;
                        schema.items.forEach((item, idx) => {
                            if (idx === 0) { 
                                const subHeader = document.createElement('div'); 
                                subHeader.className = 'pump-section-divider'; 
                                subHeader.textContent = '1- خط السحب'; 
                                pumpBodyDiv.appendChild(subHeader); 
                            } 
                            else if (idx === 5) { 
                                const subHeader = document.createElement('div'); 
                                subHeader.className = 'pump-section-divider'; 
                                subHeader.textContent = '2- المضخة'; 
                                pumpBodyDiv.appendChild(subHeader); 
                            } 
                            else if (idx === 6) { 
                                const subHeader = document.createElement('div'); 
                                subHeader.className = 'pump-section-divider'; 
                                subHeader.textContent = '3- خط الطرد'; 
                                pumpBodyDiv.appendChild(subHeader); 
                            }
                            pumpBodyDiv.appendChild(createInspectionRow(idx, item, pData[idx] || {}, `pumps_${i}`, isEdit));
if (idx === 5) { // الرقم 5 يمثل "المضخه" في مصفوفة العناصر
        // جلب ساعات التشغيل من بيانات المحطة الحالية
        const currentPump = (sData.pumps && sData.pumps[i-1]) ? sData.pumps[i-1] : {};
        const hoursVal = currentPump.operatingHours || 0;
        
        // إنشاء عنصر لعرض الساعات
        const hoursDiv = document.createElement('div');
        hoursDiv.style.cssText = "padding: 0 10px 10px 10px; color: var(--secondary-color); font-weight: bold; font-size: 0.9rem; margin-top: -5px;";
        hoursDiv.innerHTML = `⏱️ إجمالي ساعات التشغيل: <span style="color: #333;">${hoursVal}</span> ساعة`;
        
        pumpBodyDiv.appendChild(hoursDiv);
    }
                        });
                        pumpItemDiv.appendChild(pumpHeaderDiv); 
                        pumpItemDiv.appendChild(pumpBodyDiv); 
                        bodyDiv.appendChild(pumpItemDiv);
                    }
                } else {
                    const sectionData = insData[key] || {};
                    schema.items.forEach((item, idx) => { 
                        bodyDiv.appendChild(createInspectionRow(idx, item, sectionData[idx] || {}, key, isEdit)); 
                    });
                }
                sectionDiv.appendChild(headerDiv); 
                sectionDiv.appendChild(bodyDiv); 
                container.appendChild(sectionDiv);
            });
        }

        function createInspectionRow(itemKey, label, dataObj, prefix, isEdit) {
            const row = document.createElement('div');
            row.className = 'inspection-row';
            const savedStatus = dataObj && dataObj.status ? dataObj.status : 'efficient'; 
            const savedDesc = dataObj && dataObj.desc ? dataObj.desc : ''; 
            const inputId = `${prefix}_${itemKey}`;
            let optionsHtml = '';
            statusOptions.forEach(opt => { 
                const isSel = savedStatus === opt.val ? 'selected' : ''; 
                optionsHtml += `<option value="${opt.val}" ${isSel}>${opt.text}</option>`; 
            });
            let selectHtml = `<select class="inspection-status-select ${savedStatus}" id="stat_${inputId}" ${isEdit ? '' : 'disabled'} onchange="updateInspectionColor(this)">${optionsHtml}</select>`;
            let descHtml = `<input type="text" class="inspection-desc-input" id="desc_${inputId}" value="${savedDesc}" placeholder="ملاحظات..." ${isEdit ? '' : 'readonly'}>`;
            row.innerHTML = `<div class="inspection-label">${label}</div><div>${selectHtml}</div><div>${descHtml}</div>`; 
            return row;
        }
        
        window.togglePumpAccordion = (id) => { 
            const target = document.getElementById(`pump-body-${id}`);
            const allPumpBodies = document.querySelectorAll('.pump-accordion-body'); 
            allPumpBodies.forEach(b => { 
                if(b !== target) b.classList.remove('open'); 
            }); 
            target.classList.toggle('open'); 
        };
        
        window.updateInspectionColor = (selectElem) => { 
            selectElem.classList.remove('efficient', 'fault', 'broken', 'none'); 
            selectElem.classList.add(selectElem.value); 
        };
        
        document.getElementById('save-inspection-btn').addEventListener('click', () => {
            const sName = appData.currentStation; 
            if(!sName) return;
            const oldInsData = (appData.stations[sName].inspectionData) || {}; 
            let newInsData = JSON.parse(JSON.stringify(oldInsData));
            
            Object.keys(inspectionSchema).forEach(key => {
                if (key === 'pumps') return; 
                if (!newInsData[key]) newInsData[key] = {};
                inspectionSchema[key].items.forEach((item, idx) => { 
                    const statEl = document.getElementById(`stat_${key}_${idx}`); 
                    const descEl = document.getElementById(`desc_${key}_${idx}`); 
                    if (statEl) { 
                        newInsData[key][idx] = { 
                            status: statEl.value, 
                            desc: descEl.value 
                        }; 
                    } 
                });
            });
            
            if (!newInsData.pumps) newInsData.pumps = {}; 
            const totalPumps = appData.stations[sName].pumps ? appData.stations[sName].pumps.length : 4;
            for(let i=1; i<=totalPumps; i++) {
                if (!newInsData.pumps[i]) newInsData.pumps[i] = {};
                inspectionSchema.pumps.items.forEach((item, idx) => { 
                    const prefix = `pumps_${i}`; 
                    const statEl = document.getElementById(`stat_${prefix}_${idx}`); 
                    const descEl = document.getElementById(`desc_${prefix}_${idx}`); 
                    if (statEl) { 
                        newInsData.pumps[i][idx] = { 
                            status: statEl.value, 
                            desc: descEl.value 
                        }; 
                    } 
                });
            }
            
            const nowStd = getStandardDateTime();
            const log = { 
                date: nowStd.date, 
                time: nowStd.time, 
                station: sName, 
                operator: appData.currentUser ? (appData.currentUser.username || appData.currentUser.name || 'مستخدم النظام') : 'مستخدم النظام',
                details: `تحديث سجل الفحص الشامل` 
            };
            
            if (!appData.stations[sName].inspectionData) appData.stations[sName].inspectionData = {}; 
            appData.stations[sName].inspectionData = newInsData; 
            localStorage.setItem('toshka_stations_cache', JSON.stringify(appData.stations));
            
            if (navigator.onLine && isFirebaseConnected) { 
                db.ref(`stations/${sName}/inspectionData`).update(newInsData).then(() => { 
                    db.ref('history').push(log); 
                    alert("تم حفظ بيانات الفحص بنجاح ✅"); 
                    renderInspection('edit'); 
                });
            } 
            else { 
                addToOfflineQueue('update_inspection', { 
                    stationId: sName, 
                    inspectionData: newInsData, 
                    log: log 
                });
                alert("تم حفظ الفحص في الجهاز (Offline) وسيتم رفعه عند الاتصال ⏳"); 
                renderInspection('edit');
            }
        });
        
        document.getElementById('view-inspection-btn').addEventListener('click', () => { 
            renderInspection('view'); 
            document.getElementById('inspection-title').textContent = `نتائج الفحص: ${appData.stations[appData.currentStation].name}`; 
            showScreen('inspection'); 
        });
        
        document.getElementById('edit-inspection-btn').addEventListener('click', () => { 
            renderInspection('edit'); 
            document.getElementById('inspection-title').textContent = `تعديل الفحص: ${appData.stations[appData.currentStation].name}`; 
            showScreen('inspection'); 
        });

        // --- تصدير تقرير الفحص إلى Excel ---
        document.getElementById('export-inspection-excel').addEventListener('click', function() {
            const sName = appData.currentStation;
            const sData = appData.stations[sName];
            
            if (!sData || !sData.inspectionData) {
                alert('لا توجد بيانات فحص متاحة لهذه المحطة');
                return;
            }
            
            exportSingleStationInspection(sName, sData);
        });
        
        function exportSingleStationInspection(stationName, stationData) {
            const inspectionData = stationData.inspectionData || {};
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ar-EG', { hour12: false });
            
            // إنشاء مصفوفة البيانات للتصدير
            let data = [];
            
            // رأس التقرير
            data.push(["تقرير الفحص الشامل للمحطة", stationName]);
            data.push(["تاريخ التصدير", `${dateStr} ${timeStr}`]);
            data.push(["آخر تحديث للمحطة", stationData.lastUpdate || "غير متوفر"]);
            data.push(["حالة المحطة", stationData.status || "غير متوفر"]);
            data.push(["المشغل", stationData.operatorName || "غير متوفر"]);
            data.push([]); // سطر فارغ
            
            // البيانات العامة
            data.push(["المعلومات العامة", "", "", ""]);
            data.push(["الجهد الكهربي", `${stationData.voltage || 0} V`, "الضغط", `${stationData.pressure || 0} Bar`]);
            data.push(["التدفق", `${stationData.waterFlow || 0} L/Sec`, "النظام", stationData.systemMode || "غير محدد"]);
            data.push(["المضخات العاملة", stationData.activePumps || 0, "إجمالي المضخات", stationData.pumps ? stationData.pumps.length : 0]);
            data.push(["اقصى ضغط مسموح", `${stationData.maxPressure || 8.0} Bar`, "", ""]);
            data.push([]);
            
            // بيانات الفحص
            data.push(["تفاصيل الفحص الشامل", "", "", ""]);
            data.push(["القسم", "المكون", "الحالة", "ملاحظات"]);
            
            // إضافة بيانات الفحص من كل قسم
            Object.keys(inspectionSchema).forEach(key => {
                if (key === 'pumps') return; // سنتعامل مع المضخات لاحقاً
                
                const schema = inspectionSchema[key];
                const sectionData = inspectionData[key] || {};
                
                data.push([schema.title, "", "", ""]);
                
                schema.items.forEach((item, idx) => {
                    const itemData = sectionData[idx] || {};
                    const status = statusTextMap[itemData.status] || "غير مسجل";
                    const desc = itemData.desc || "";
                    data.push(["", item, status, desc]);
                });
                
                data.push([]);
            });
            
            // بيانات المضخات
            if (inspectionData.pumps && stationData.pumps) {
                data.push(["بيانات المضخات", "", "", ""]);
                
                for (let i = 1; i <= stationData.pumps.length; i++) {
                    const pumpData = inspectionData.pumps[i] || {};
                    data.push([`مضخة رقم ${i}`, "", "", ""]);
                    
                    // تحديد حالة المضخة بناءً على البيانات
                    let pumpStatus = "✅ يعمل بكفاءة";
                    const criticalIndices = [1, 5, 10, 11, 12];
                    let hasCriticalFault = false;
                    let hasFault = false;
                    
                    inspectionSchema.pumps.items.forEach((item, idx) => {
                        const itemData = pumpData[idx] || {};
                        if (itemData.status === 'broken' && criticalIndices.includes(idx)) {
                            hasCriticalFault = true;
                        } else if (itemData.status === 'fault') {
                            hasFault = true;
                        }
                    });
                    
                    if (hasCriticalFault) {
                        pumpStatus = "🛑 لا يعمل (عطل حرج)";
                    } else if (hasFault) {
                        pumpStatus = "⚠️ يحتاج صيانة";
                    }
                    
                    data.push(["", "الحالة الإجمالية", pumpStatus, ""]);
                    
                    // إضافة بيانات كل مكون في المضخة
                    inspectionSchema.pumps.items.forEach((item, idx) => {
                        const itemData = pumpData[idx] || {};
                        const status = statusTextMap[itemData.status] || "غير مسجل";
                        const desc = itemData.desc || "";
                        data.push(["", item, status, desc]);
                    });
                    
                    data.push([]);
                }
            }
            
            // الأعطال المسجلة
            if (stationData.currentFault || stationData.secondaryFault) {
                data.push(["الأعطال المسجلة", "", "", ""]);
                if (stationData.currentFault) {
                    data.push(["", "العطل الرئيسي", stationData.currentFault, stationData.fault1Desc || ""]);
                }
                if (stationData.secondaryFault) {
                    data.push(["", "العطل الثانوي", stationData.secondaryFault, stationData.fault2Desc || ""]);
                }
                data.push([]);
            }
            
            // الملاحظات
            if (stationData.comments) {
                data.push(["ملاحظات التشغيل", "", "", ""]);
                data.push(["", stationData.comments, "", ""]);
            }
            
            // إنشاء ورقة العمل
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تحديد عرض الأعمدة
            const wscols = [
                { wch: 20 }, // العمود الأول
                { wch: 25 }, // العمود الثاني
                { wch: 20 }, // العمود الثالث
                { wch: 40 }  // العمود الرابع
            ];
            ws['!cols'] = wscols;
            
            // إنشاء المصنف
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "تقرير الفحص");
            
            // حفظ الملف
            const fileName = `تقرير_فحص_${stationName}_${dateStr}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`تم تصدير تقرير الفحص للمحطة ${stationName} بنجاح!`);
        }
        
       // --- شاشة تصدير تقرير الفحص لجميع المحطات (تم الإصلاح) ---
        function updateExportFilters() {
            const zoneSelect = document.getElementById('export-filter-zone');
            const stationSelect = document.getElementById('export-filter-station');
            
            // 1. حفظ الاختيار الحالي للمستخدم حتى لا يضيع عند التحديث التلقائي
            const currentZone = zoneSelect.value;
            const currentStation = stationSelect.value;
            
            // 2. تحديث قائمة المناطق
            let zoneHtml = '<option value="all">كل المناطق</option>';
            appData.zones.forEach(z => {
                // إذا كانت المنطقة هي نفسها المختارة سابقاً، نضيف خاصية selected
                const isSelected = (z === currentZone) ? 'selected' : '';
                zoneHtml += `<option value="${z}" ${isSelected}>${z}</option>`;
            });
            zoneSelect.innerHTML = zoneHtml;
            
            // 3. تحديد المنطقة الفعالة حالياً لتصفية المحطات بناءً عليها
            // (في حال تغيرت البيانات، نضمن أننا نفلتر بناءً على المنطقة المختارة حالياً)
            const activeZone = zoneSelect.value;

            // 4. تحديث قائمة المحطات
            let stationHtml = '<option value="all">كل المحطات</option>';
            const sortedStations = Object.values(appData.stations).sort((a, b) => a.name.localeCompare(b.name));
            
            let filteredStations = sortedStations;
            if (activeZone !== 'all') {
                filteredStations = sortedStations.filter(s => s.zone === activeZone);
            }
            
            filteredStations.forEach(station => {
                // إذا كانت المحطة هي نفسها المختارة سابقاً، نضيف خاصية selected
                const isSelected = (station.name === currentStation) ? 'selected' : '';
                stationHtml += `<option value="${station.name}" ${isSelected}>${station.name}</option>`;
            });
            
            stationSelect.innerHTML = stationHtml;

            // 5. التعامل مع حدث تغيير المنطقة يدوياً
            zoneSelect.onchange = function() {
                const newZone = this.value;
                let newStationHtml = '<option value="all">كل المحطات</option>';
                
                let newFiltered = sortedStations;
                if (newZone !== 'all') {
                    newFiltered = sortedStations.filter(s => s.zone === newZone);
                }
                
                newFiltered.forEach(station => {
                    newStationHtml += `<option value="${station.name}">${station.name}</option>`;
                });
                
                stationSelect.innerHTML = newStationHtml;
                // عند تغيير المنطقة يدوياً، نعيد المحطة إلى "الكل"
                stationSelect.value = 'all';
            };
        }
        
        document.getElementById('generate-inspection-report').addEventListener('click', function() {
            const zoneFilter = document.getElementById('export-filter-zone').value;
            const stationFilter = document.getElementById('export-filter-station').value;
            const reportType = document.getElementById('export-report-type').value;
            const fileFormat = document.getElementById('export-file-format').value;
            
            const exportStatus = document.getElementById('export-status');
            exportStatus.style.display = 'block';
            exportStatus.innerHTML = '<div style="color: var(--excel-color);">⏳ جاري توليد التقرير...</div>';
            
            // تصفية المحطات
            let stationsToExport = Object.values(appData.stations);
            
            if (zoneFilter !== 'all') {
                stationsToExport = stationsToExport.filter(s => s.zone === zoneFilter);
            }
            
            if (stationFilter !== 'all') {
                stationsToExport = stationsToExport.filter(s => s.name === stationFilter);
            }
            
            // تصفية المحطات التي لديها بيانات فحص
            stationsToExport = stationsToExport.filter(s => s.inspectionData);
            
            if (stationsToExport.length === 0) {
                exportStatus.innerHTML = '<div style="color: var(--danger-color);">⚠️ لا توجد محطات ببيانات فحص مطابقة للفلتر</div>';
                return;
            }
            
            setTimeout(() => {
                if (fileFormat === 'excel') {
                    exportInspectionReportExcel(stationsToExport, reportType);
                } else {
                    exportInspectionReportCSV(stationsToExport, reportType);
                }
                
                exportStatus.innerHTML = `<div style="color: var(--success-color);">✅ تم تصدير ${stationsToExport.length} محطة بنجاح!</div>`;
            }, 1000);
        });
        
        function exportInspectionReportExcel(stations, reportType) {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ar-EG', { hour12: false });
            
            // إنشاء مصنف جديد
            const wb = XLSX.utils.book_new();
            
            if (reportType === 'summary') {
                // ورقة الملخص
                let summaryData = [
                    ["ملخص تقارير الفحص الشامل"],
                    [`تاريخ التصدير: ${dateStr} ${timeStr}`],
                    [`عدد المحطات: ${stations.length}`],
                    [],
                    ["المحطة", "المنطقة", "حالة المحطة", "المشغل", "آخر تحديث", "عدد المضخات", "اقصى ضغط", "حالة الفحص"]
                ];
                
                stations.forEach(station => {
                    const hasInspection = station.inspectionData ? "✅ موجود" : "❌ غير موجود";
                    const pumpCount = station.pumps ? station.pumps.length : 0;
                    summaryData.push([
                        station.name,
                        station.zone,
                        station.status,
                        station.operatorName,
                        station.lastUpdate,
                        pumpCount,
                        station.maxPressure || "8.0",
                        hasInspection
                    ]);
                });
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                const summaryCols = [
                    { wch: 15 }, { wch: 15 }, { wch: 15 }, 
                    { wch: 20 }, { wch: 20 }, { wch: 15 }, 
                    { wch: 15 }, { wch: 15 }
                ];
                wsSummary['!cols'] = summaryCols;
                XLSX.utils.book_append_sheet(wb, wsSummary, "ملخص");
                
                // إضافة ورقة لكل محطة
                stations.forEach((station, index) => {
                    if (index < 10) { // حد أقصى 10 أوراق
                        const stationData = generateStationInspectionData(station, reportType);
                        const wsStation = XLSX.utils.aoa_to_sheet(stationData);
                        const stationCols = [
                            { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 40 }
                        ];
                        wsStation['!cols'] = stationCols;
                        // تقصير اسم الورقة إذا كان طويلاً
                        const sheetName = station.name.length > 31 ? station.name.substring(0, 31) : station.name;
                        XLSX.utils.book_append_sheet(wb, wsStation, sheetName);
                    }
                });
                
            } else if (reportType === 'faults') {
                // تقرير الأعطال فقط
                let faultsData = [
                    ["تقرير أعطال المحطات"],
                    [`تاريخ التصدير: ${dateStr} ${timeStr}`],
                    [],
                    ["المحطة", "المنطقة", "العطل الرئيسي", "وصف العطل", "العطل الثانوي", "وصف العطل", "وقت بدء العطل", "حالة المحطة", "الضغط الحالي", "اقصى ضغط"]
                ];
                
                stations.forEach(station => {
                    if (station.currentFault || station.secondaryFault) {
                        faultsData.push([
                            station.name,
                            station.zone,
                            station.currentFault || "",
                            station.fault1Desc || "",
                            station.secondaryFault || "",
                            station.fault2Desc || "",
                            station.faultStartTime || "",
                            station.status,
                            station.pressure || "0",
                            station.maxPressure || "8.0"
                        ]);
                    }
                });
                
                const wsFaults = XLSX.utils.aoa_to_sheet(faultsData);
                const faultsCols = [
                    { wch: 15 }, { wch: 15 }, { wch: 25 }, 
                    { wch: 30 }, { wch: 25 }, { wch: 30 }, 
                    { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
                ];
                wsFaults['!cols'] = faultsCols;
                XLSX.utils.book_append_sheet(wb, wsFaults, "الأعطال");
                
            } else {
                // تقرير كامل - ورقة واحدة لكل محطة
                stations.forEach((station, index) => {
                    if (index < 15) { // حد أقصى 15 محطة في التقرير الكامل
                        const stationData = generateStationInspectionData(station, reportType);
                        const wsStation = XLSX.utils.aoa_to_sheet(stationData);
                        const stationCols = [
                            { wch: 20 }, { wch: 25 }, { wch: 20 }, { wch: 40 }
                        ];
                        wsStation['!cols'] = stationCols;
                        // تقصير اسم الورقة إذا كان طويلاً
                        const sheetName = station.name.length > 31 ? station.name.substring(0, 31) : station.name;
                        XLSX.utils.book_append_sheet(wb, wsStation, sheetName);
                    }
                });
            }
            
            // حفظ الملف
            const fileName = `تقرير_فحص_${reportType}_${dateStr}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function exportInspectionReportCSV(stations, reportType) {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            if (reportType === 'summary') {
                csvContent += "المحطة,المنطقة,حالة المحطة,المشغل,آخر تحديث,عدد المضخات,اقصى ضغط,حالة الفحص\n";
                
                stations.forEach(station => {
                    const hasInspection = station.inspectionData ? "موجود" : "غير موجود";
                    const pumpCount = station.pumps ? station.pumps.length : 0;
                    csvContent += `"${station.name}","${station.zone}","${station.status}","${station.operatorName}","${station.lastUpdate}",${pumpCount},"${station.maxPressure || '8.0'}","${hasInspection}"\n`;
                });
                
            } else if (reportType === 'faults') {
                csvContent += "المحطة,المنطقة,العطل الرئيسي,وصف العطل,العطل الثانوي,وصف العطل,وقت بدء العطل,حالة المحطة,الضغط الحالي,اقصى ضغط\n";
                
                stations.forEach(station => {
                    if (station.currentFault || station.secondaryFault) {
                        csvContent += `"${station.name}","${station.zone}","${station.currentFault || ''}","${station.fault1Desc || ''}","${station.secondaryFault || ''}","${station.fault2Desc || ''}","${station.faultStartTime || ''}","${station.status}","${station.pressure || '0'}","${station.maxPressure || '8.0'}"\n`;
                    }
                });
                
            } else {
                // تقرير كامل
                csvContent += "المحطة,القسم,المكون,الحالة,ملاحظات\n";
                
                stations.forEach(station => {
                    const inspectionData = station.inspectionData || {};
                    
                    Object.keys(inspectionSchema).forEach(key => {
                        if (key === 'pumps') return;
                        
                        const schema = inspectionSchema[key];
                        const sectionData = inspectionData[key] || {};
                        
                        schema.items.forEach((item, idx) => {
                            const itemData = sectionData[idx] || {};
                            const status = statusTextMap[itemData.status] || "غير مسجل";
                            const desc = itemData.desc || "";
                            csvContent += `"${station.name}","${schema.title}","${item}","${status}","${desc}"\n`;
                        });
                    });
                    
                    // بيانات المضخات
                    if (inspectionData.pumps && station.pumps) {
                        for (let i = 1; i <= station.pumps.length; i++) {
                            const pumpData = inspectionData.pumps[i] || {};
                            
                            inspectionSchema.pumps.items.forEach((item, idx) => {
                                const itemData = pumpData[idx] || {};
                                const status = statusTextMap[itemData.status] || "غير مسجل";
                                const desc = itemData.desc || "";
                                csvContent += `"${station.name}","مضخة ${i}","${item}","${status}","${desc}"\n`;
                            });
                        }
                    }
                });
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `تقرير_فحص_${reportType}_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function generateStationInspectionData(station, reportType) {
            const inspectionData = station.inspectionData || {};
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('ar-EG', { hour12: false });
            
            let data = [];
            
            // رأس التقرير
            data.push(["تقرير الفحص الشامل للمحطة", station.name]);
            data.push(["المنطقة", station.zone]);
            data.push(["تاريخ التصدير", `${dateStr} ${timeStr}`]);
            data.push(["آخر تحديث للمحطة", station.lastUpdate || "غير متوفر"]);
            data.push(["حالة المحطة", station.status || "غير متوفر"]);
            data.push(["المشغل", station.operatorName || "غير متوفر"]);
            data.push(["اقصى ضغط مسموح", station.maxPressure || "8.0"]);
            data.push([]);
            
            if (reportType === 'full') {
                // البيانات العامة
                data.push(["المعلومات العامة", "", "", ""]);
                data.push(["الجهد الكهربي", `${station.voltage || 0} V`, "الضغط", `${station.pressure || 0} Bar`]);
                data.push(["التدفق", `${station.waterFlow || 0} L/Sec`, "النظام", station.systemMode || "غير محدد"]);
                data.push(["المضخات العاملة", station.activePumps || 0, "إجمالي المضخات", station.pumps ? station.pumps.length : 0]);
                data.push([]);
                
                // بيانات الفحص
                data.push(["تفاصيل الفحص الشامل", "", "", ""]);
                data.push(["القسم", "المكون", "الحالة", "ملاحظات"]);
                
                // إضافة بيانات الفحص من كل قسم
                Object.keys(inspectionSchema).forEach(key => {
                    if (key === 'pumps') return;
                    
                    const schema = inspectionSchema[key];
                    const sectionData = inspectionData[key] || {};
                    
                    data.push([schema.title, "", "", ""]);
                    
                    schema.items.forEach((item, idx) => {
                        const itemData = sectionData[idx] || {};
                        const status = statusTextMap[itemData.status] || "غير مسجل";
                        const desc = itemData.desc || "";
                        data.push(["", item, status, desc]);
                    });
                    
                    data.push([]);
                });
                
                // بيانات المضخات
                if (inspectionData.pumps && station.pumps) {
                    data.push(["بيانات المضخات", "", "", ""]);
                    
                    for (let i = 1; i <= station.pumps.length; i++) {
                        const pumpData = inspectionData.pumps[i] || {};
                        data.push([`مضخة رقم ${i}`, "", "", ""]);
                        
                        // تحديد حالة المضخة
                        let pumpStatus = "✅ يعمل بكفاءة";
                        const criticalIndices = [1, 5, 10, 11, 12];
                        let hasCriticalFault = false;
                        let hasFault = false;
                        
                        inspectionSchema.pumps.items.forEach((item, idx) => {
                            const itemData = pumpData[idx] || {};
                            if (itemData.status === 'broken' && criticalIndices.includes(idx)) {
                                hasCriticalFault = true;
                            } else if (itemData.status === 'fault') {
                                hasFault = true;
                            }
                        });
                        
                        if (hasCriticalFault) {
                            pumpStatus = "🛑 لا يعمل (عطل حرج)";
                        } else if (hasFault) {
                            pumpStatus = "⚠️ يحتاج صيانة";
                        }
                        
                        data.push(["", "الحالة الإجمالية", pumpStatus, ""]);
                        
                        inspectionSchema.pumps.items.forEach((item, idx) => {
                            const itemData = pumpData[idx] || {};
                            const status = statusTextMap[itemData.status] || "غير مسجل";
                            const desc = itemData.desc || "";
                            data.push(["", item, status, desc]);
                        });
                        
                        data.push([]);
                    }
                }
                
                // الأعطال المسجلة
                if (station.currentFault || station.secondaryFault) {
                    data.push(["الأعطال المسجلة", "", "", ""]);
                    if (station.currentFault) {
                        data.push(["", "العطل الرئيسي", station.currentFault, station.fault1Desc || ""]);
                    }
                    if (station.secondaryFault) {
                        data.push(["", "العطل الثانوي", station.secondaryFault, station.fault2Desc || ""]);
                    }
                    data.push([]);
                }
                
                // الملاحظات
                if (station.comments) {
                    data.push(["ملاحظات التشغيل", "", "", ""]);
                    data.push(["", station.comments, "", ""]);
                }
            }
            
            return data;
        }

        // --- USER PROFILE FUNCTIONS (ENHANCED FOR MOBILE) ---
        function renderUserProfileForm() {
            const currentUser = appData.currentUser;
            if (!currentUser) return;
            
            const username = currentUser.username;
            document.getElementById('profile-username').value = username;
            
            const userProfile = appData.userProfiles[username] || {};
            
            document.getElementById('profile-fullname').value = userProfile.fullname || '';
            document.getElementById('profile-phone').value = userProfile.phone || '';
            document.getElementById('profile-whatsapp').value = userProfile.whatsapp || '';
            document.getElementById('profile-email').value = userProfile.email || '';
            
            const stationSelect = document.getElementById('profile-station');
            stationSelect.innerHTML = '<option value="">-- اختر المحطة --</option>';
            
            const sortedStations = Object.values(appData.stations).sort((a, b) => a.name.localeCompare(b.name));
            sortedStations.forEach(station => {
                const selected = (userProfile.station === station.name) ? 'selected' : '';
                stationSelect.innerHTML += `<option value="${station.name}" ${selected}>${station.name}</option>`;
            });
            
            if (!userProfile.station && appData.currentStation) {
                stationSelect.value = appData.currentStation;
            }
        }
        
        function renderUsersProfilesList() {
            const currentUser = appData.currentUser;
            if (!currentUser) return;
            
            const tbody = document.getElementById('users-profiles-list');
            const searchInput = document.getElementById('search-profile-input').value.toLowerCase();
            const noProfilesMessage = document.getElementById('no-profiles-message');
            const loadMoreBtn = document.getElementById('load-more-profiles-btn');
            const paginationInfo = document.getElementById('profiles-pagination-info');
            
            tbody.innerHTML = '';
            
            const canViewAllProfiles = currentUser.permissions.view_profiles;
            const canDeleteProfiles = currentUser.permissions.delete_profiles;
            
            let filteredProfiles = Object.keys(appData.userProfiles).filter(username => {
                const profile = appData.userProfiles[username];
                
                if (!canViewAllProfiles && username !== currentUser.username) {
                    return false;
                }
                
                if (searchInput) {
                    const fullname = (profile.fullname || '').toLowerCase();
                    const station = (profile.station || '').toLowerCase();
                    const phone = (profile.phone || '').toLowerCase();
                    
                    if (!fullname.includes(searchInput) && 
                        !station.includes(searchInput) && 
                        !phone.includes(searchInput) &&
                        !username.toLowerCase().includes(searchInput)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            const totalProfiles = filteredProfiles.length;
            const startIndex = appData.currentProfilesPage * appData.profilesLimit;
            const endIndex = startIndex + appData.profilesLimit;
            const displayedProfiles = filteredProfiles.slice(startIndex, endIndex);
            
            if (displayedProfiles.length === 0) {
                tbody.style.display = 'none';
                loadMoreBtn.style.display = 'none';
                noProfilesMessage.style.display = 'block';
                
                if (searchInput) {
                    noProfilesMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">🔍</div>
                        <div>لا توجد نتائج بحث مطابقة لـ "${searchInput}"</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">جرب استخدام مصطلحات بحث أخرى</div>
                    `;
                } else if (!canViewAllProfiles) {
                    noProfilesMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">📋</div>
                        <div>لا توجد بيانات شخصية مسجلة لك</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">يمكنك تسجيل بياناتك الشخصية في القسم الأيسر</div>
                    `;
                } else {
                    noProfilesMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">📋</div>
                        <div>لا توجد بيانات مستخدمين مسجلة في النظام</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">يمكن للمستخدمين تسجيل بياناتهم الشخصية في القسم الأيسر</div>
                    `;
                }
                return;
            }
            
            tbody.style.display = '';
            noProfilesMessage.style.display = 'none';
            
            displayedProfiles.forEach((username, index) => {
                const profile = appData.userProfiles[username];
                const userType = appData.users[username] ? appData.users[username].type : 'غير معروف';
                const userTypeName = appData.userTypes[userType] ? appData.userTypes[userType].name : 'غير معروف';
                
                const isCurrentUser = (username === currentUser.username);
                const canDeleteThisProfile = canDeleteProfiles && !isCurrentUser && currentUser.type === 'admin';
                
                // Mobile action menu
                let mobileActionMenu = '';
                if (canDeleteThisProfile && window.innerWidth <= 768) {
                    mobileActionMenu = `
                        <div class="mobile-action-menu">
                            <button class="mobile-action-btn" onclick="toggleMobileActions('${username}')">⋯</button>
                            <div class="mobile-action-dropdown" id="mobile-actions-${username}">
                                <div class="mobile-action-item delete-action" onclick="deleteUserProfile('${username}')">
                                    🗑️ حذف بيانات المستخدم
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                let rowHTML = `
                    <tr>
                        <td>
                            ${username}
                            ${isCurrentUser ? ' <span class="user-profile-badge">أنت</span>' : ''}
                            <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">${userTypeName}</div>
                        </td>
                        <td>${profile.station || 'غير محدد'}</td>
                        <td>${profile.fullname || 'غير مسجل'}</td>
                        <td>${profile.phone || 'غير مسجل'}</td>
                        <td>${profile.whatsapp || 'غير مسجل'}</td>
                        <td>${profile.email || 'غير مسجل'}</td>
                        <td>
                            <div class="desktop-actions" style="display: flex; justify-content: center;">
                                ${canDeleteThisProfile ? 
                                    `<button class="delete-profile-btn" onclick="deleteUserProfile('${username}')" title="حذف بيانات المستخدم">
                                        🗑️ حذف
                                    </button>` : 
                                    '<span style="color:#888; font-size:0.8rem;">-</span>'
                                }
                            </div>
                            ${mobileActionMenu}
                        </td>
                    </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
            
            // Update pagination info
            const showingTo = Math.min(startIndex + displayedProfiles.length, totalProfiles);
            paginationInfo.textContent = `عرض ${startIndex + 1} إلى ${showingTo} من أصل ${totalProfiles} مستخدم`;
            
            // Show/hide load more button
            if (endIndex < totalProfiles) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `عرض المزيد من البيانات (${Math.min(appData.profilesLimit, totalProfiles - endIndex)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Mobile actions toggle function
        window.toggleMobileActions = function(username) {
            const dropdown = document.getElementById(`mobile-actions-${username}`);
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            document.querySelectorAll('.mobile-action-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
        };
        
        // Close mobile dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.mobile-action-menu')) {
                document.querySelectorAll('.mobile-action-dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });
        
        // Load more profiles button handler
        document.getElementById('load-more-profiles-btn').addEventListener('click', function() {
            appData.currentProfilesPage++;
            renderUsersProfilesList();
            // Scroll to bottom of table
            document.querySelector('.users-profiles-table').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
        
        function saveUserProfile() {
            const currentUser = appData.currentUser;
            if (!currentUser) {
                showProfileAlert('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const username = currentUser.username;
            const fullname = document.getElementById('profile-fullname').value.trim();
            const station = document.getElementById('profile-station').value;
            const phone = document.getElementById('profile-phone').value.trim();
            const whatsapp = document.getElementById('profile-whatsapp').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            
            if (!fullname) {
                showProfileAlert('الاسم الثلاثي مطلوب', 'error');
                document.getElementById('profile-fullname').focus();
                return;
            }
            
            if (!station) {
                showProfileAlert('يرجى اختيار المحطة', 'error');
                document.getElementById('profile-station').focus();
                return;
            }
            
            if (!phone) {
                showProfileAlert('رقم الهاتف مطلوب', 'error');
                document.getElementById('profile-phone').focus();
                return;
            }
            
            const phoneRegex = /^01[0-9]{9}$/;
            if (!phoneRegex.test(phone)) {
                showProfileAlert('رقم الهاتف غير صحيح. يجب أن يكون 11 رقماً ويبدأ بـ 01', 'error');
                document.getElementById('profile-phone').focus();
                return;
            }
            
            if (whatsapp && !phoneRegex.test(whatsapp)) {
                showProfileAlert('رقم الواتساب غير صحيح. يجب أن يكون 11 رقماً ويبدأ بـ 01', 'error');
                document.getElementById('profile-whatsapp').focus();
                return;
            }
            
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showProfileAlert('البريد الإلكتروني غير صحيح', 'error');
                    document.getElementById('profile-email').focus();
                    return;
                }
            }
            
            const nowStd = getStandardDateTime();
            const profileData = {
                username: username,
                fullname: fullname,
                station: station,
                phone: phone,
                whatsapp: whatsapp || '',
                email: email || '',
                lastUpdate: nowStd.full,
                userType: currentUser.type
            };
            
            if (navigator.onLine && isFirebaseConnected) {
                db.ref('userProfiles/' + username).set(profileData)
                    .then(() => {
                        showProfileAlert('تم حفظ البيانات الشخصية بنجاح ✅', 'success');
                        
                        appData.userProfiles[username] = profileData;
                        localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(appData.userProfiles));
                        
                        renderUsersProfilesList();
                        
                        const log = {
                            date: nowStd.date,
                            time: nowStd.time,
                            station: station,
                            operator: username,
                            details: `تحديث البيانات الشخصية للمستخدم: ${fullname}`
                        };
                        db.ref('history').push(log);
                    })
                    .catch(err => {
                        console.error('Error saving profile:', err);
                        showProfileAlert('حدث خطأ في حفظ البيانات: ' + err.message, 'error');
                    });
            } else {
                appData.userProfiles[username] = profileData;
                localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(appData.userProfiles));
                
                addToOfflineQueue('update_profile', {
                    username: username,
                    profileData: profileData
                });
                
                showProfileAlert('تم حفظ البيانات في الجهاز (سيتم المزامنة عند الاتصال) ⏳', 'warning');
                renderUsersProfilesList();
            }
        }
        
        function deleteUserProfile(username) {
            const currentUser = appData.currentUser;
            
            if (!currentUser || currentUser.type !== 'admin') {
                alert('ليس لديك صلاحية لحذف بيانات المستخدمين');
                return;
            }
            
            if (username === currentUser.username) {
                alert('لا يمكن حذف بياناتك الشخصية');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف البيانات الشخصية للمستخدم "${username}"؟\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
                if (navigator.onLine && isFirebaseConnected) {
                    db.ref('userProfiles/' + username).remove()
                        .then(() => {
                            showProfileAlert('تم حذف البيانات الشخصية بنجاح ✅', 'success');
                            renderUsersProfilesList();
                            
                            const nowStd = getStandardDateTime();
                            const log = {
                                date: nowStd.date,
                                time: nowStd.time,
                                station: 'النظام',
                                operator: currentUser.username,
                                details: `حذف البيانات الشخصية للمستخدم: ${username}`
                            };
                            db.ref('history').push(log);
                        })
                        .catch(err => {
                            console.error('Error deleting profile:', err);
                            showProfileAlert('حدث خطأ في حذف البيانات: ' + err.message, 'error');
                        });
                } else {
                    addToOfflineQueue('delete_profile', {
                        username: username,
                        deletedBy: currentUser.username
                    });
                    
                    delete appData.userProfiles[username];
                    localStorage.setItem('toshka_user_profiles_cache', JSON.stringify(appData.userProfiles));
                    
                    showProfileAlert('تم حذف البيانات في الجهاز (سيتم المزامنة عند الاتصال) ⏳', 'warning');
                    renderUsersProfilesList();
                }
            }
        }
        
        window.deleteUserProfile = deleteUserProfile;
        
        function showProfileAlert(message, type = 'info') {
            const alertDiv = document.getElementById('profile-alert');
            alertDiv.textContent = message;
            alertDiv.className = 'profile-alert';
            
            switch(type) {
                case 'success':
                    alertDiv.classList.add('profile-alert-success');
                    break;
                case 'warning':
                    alertDiv.classList.add('profile-alert-warning');
                    break;
                case 'error':
                    alertDiv.classList.add('profile-alert-error');
                    break;
            }
            
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        document.getElementById('save-profile-btn').addEventListener('click', saveUserProfile);
        document.getElementById('search-profile-input').addEventListener('keyup', function() {
            appData.currentProfilesPage = 0;
            renderUsersProfilesList();
        });

        // --- USERS DATA MANAGEMENT (شاشة جديدة لإدارة بيانات المستخدمين) ---
        function renderUsersDataManagement() {
            const currentUser = appData.currentUser;
            if (!currentUser || currentUser.type !== 'admin') {
                alert('يجب أن تكون مديراً للوصول إلى هذه الشاشة');
                showScreen('stations');
                return;
            }
            
            const tbody = document.getElementById('users-data-table-body');
            const searchInput = document.getElementById('search-users-data-input').value.toLowerCase();
            const noUsersDataMessage = document.getElementById('no-users-data-message');
            const loadMoreBtn = document.getElementById('load-more-users-data-btn');
            const paginationInfo = document.getElementById('users-data-pagination-info');
            
            tbody.innerHTML = '';
            
            // Combine user accounts with their profiles
            let combinedUsers = [];
            Object.keys(appData.users).forEach(username => {
                const userAccount = appData.users[username];
                const userProfile = appData.userProfiles[username] || {};
                
                combinedUsers.push({
                    username: username,
                    account: userAccount,
                    profile: userProfile
                });
            });
            
            // Filter by search
            let filteredUsers = combinedUsers.filter(user => {
                if (searchInput) {
                    const username = user.username.toLowerCase();
                    const fullname = (user.profile.fullname || '').toLowerCase();
                    const station = (user.profile.station || '').toLowerCase();
                    const phone = (user.profile.phone || '').toLowerCase();
                    const userType = appData.userTypes[user.account.type].name.toLowerCase();
                    
                    if (!username.includes(searchInput) && 
                        !fullname.includes(searchInput) && 
                        !station.includes(searchInput) &&
                        !phone.includes(searchInput) &&
                        !userType.includes(searchInput)) {
                        return false;
                    }
                }
                return true;
            });
            
            // Sort by username
            filteredUsers.sort((a, b) => a.username.localeCompare(b.username));
            
            const totalUsers = filteredUsers.length;
            const startIndex = appData.currentUsersDataPage * appData.usersDataLimit;
            const endIndex = startIndex + appData.usersDataLimit;
            const displayedUsers = filteredUsers.slice(startIndex, endIndex);
            
            if (displayedUsers.length === 0) {
                tbody.style.display = 'none';
                loadMoreBtn.style.display = 'none';
                noUsersDataMessage.style.display = 'block';
                
                if (searchInput) {
                    noUsersDataMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">🔍</div>
                        <div>لا توجد نتائج بحث مطابقة لـ "${searchInput}"</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">جرب استخدام مصطلحات بحث أخرى</div>
                    `;
                } else {
                    noUsersDataMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">👥</div>
                        <div>لا توجد بيانات مستخدمين مسجلة في النظام</div>
                    `;
                }
                return;
            }
            
            tbody.style.display = '';
            noUsersDataMessage.style.display = 'none';
            
            displayedUsers.forEach((user, index) => {
                const account = user.account;
                const profile = user.profile;
                const userTypeName = appData.userTypes[account.type].name;
                const typeClass = `type-${account.type}`;
                const isCurrentUser = (user.username === currentUser.username);
                const rowNum = startIndex + index + 1;
                
                let rowHTML = `
                    <tr>
                        <td>${rowNum}</td>
                        <td style="font-weight: bold;">
                            ${user.username}
                            ${isCurrentUser ? ' <span style="color:#1976d2; font-size:0.8rem;">(أنت)</span>' : ''}
                        </td>
                        <td>${profile.fullname || 'غير مسجل'}</td>
                        <td><span class="user-type-badge ${typeClass}">${userTypeName}</span></td>
                        <td>${profile.station || 'غير محدد'}</td>
                        <td>${profile.phone || 'غير مسجل'}</td>
                        <td>${profile.email || 'غير مسجل'}</td>
                        <td class="action-cell">
                            ${!isCurrentUser ? 
                                `<button class="delete-user-btn" onclick="deleteUserFromDataScreen('${user.username}')" title="حذف المستخدم">
                                    🗑️ حذف
                                </button>` : 
                                '<span style="color:#888; font-size:0.8rem;">-</span>'
                            }
                        </td>
                    </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
            
            // Update pagination info
            const showingTo = Math.min(startIndex + displayedUsers.length, totalUsers);
            paginationInfo.textContent = `عرض ${startIndex + 1} إلى ${showingTo} من أصل ${totalUsers} مستخدم`;
            
            // Show/hide load more button
            if (endIndex < totalUsers) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `عرض المزيد من المستخدمين (${Math.min(appData.usersDataLimit, totalUsers - endIndex)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Load more users data button handler
        document.getElementById('load-more-users-data-btn').addEventListener('click', function() {
            appData.currentUsersDataPage++;
            renderUsersDataManagement();
            // Scroll to bottom of table
            document.querySelector('.users-data-table').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
        
        window.deleteUserFromDataScreen = function(username) {
            const currentUser = appData.currentUser;
            
            if (!currentUser || currentUser.type !== 'admin') {
                alert('ليس لديك صلاحية لحذف المستخدمين');
                return;
            }
            
            if (username === 'admin') {
                alert('لا يمكن حذف حساب المدير الرئيسي (admin)');
                return;
            }
            
            if (username === currentUser.username) {
                alert('لا يمكن حذف حسابك الخاص أثناء استخدام النظام');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف المستخدم "${username}"؟\n\nهذا الإجراء سيمسح حساب المستخدم وبياناته الشخصية ولا يمكن التراجع عنه.`)) {
                // Delete user account
                db.ref('users/' + username).remove()
                    .then(() => {
                        // Delete user profile if exists
                        return db.ref('userProfiles/' + username).remove();
                    })
                    .then(() => {
                        alert('✅ تم حذف المستخدم وبياناته بنجاح');
                        renderUsersDataManagement();
                    })
                    .catch(err => {
                        alert('خطأ في حذف المستخدم: ' + err.message);
                    });
            }
        };
        
        // Search in users data screen
        document.getElementById('search-users-data-input').addEventListener('keyup', function() {
            appData.currentUsersDataPage = 0;
            renderUsersDataManagement();
        });

        // --- USERS MANAGEMENT (SIMPLIFIED - بدون عمود الحالة) ---
        function renderUsersManagement() {
            const tbody = document.getElementById('users-table-body');
            const search = document.getElementById('search-user-input').value.toLowerCase();
            const noUsersMessage = document.getElementById('no-users-message');
            const currentUser = appData.currentUser;
            const loadMoreBtn = document.getElementById('load-more-users-btn');
            const paginationInfo = document.getElementById('users-pagination-info');
            
            tbody.innerHTML = '';
            
            let filteredUsers = Object.keys(appData.users).filter(uName => {
                if (search && !uName.toLowerCase().includes(search)) return false;
                return true;
            });
            
            const totalUsers = filteredUsers.length;
            const startIndex = appData.currentUsersPage * appData.usersLimit;
            const endIndex = startIndex + appData.usersLimit;
            const displayedUsers = filteredUsers.slice(startIndex, endIndex);
            
            if (displayedUsers.length === 0) {
                tbody.style.display = 'none';
                loadMoreBtn.style.display = 'none';
                noUsersMessage.style.display = 'block';
                if (search) {
                    noUsersMessage.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">🔍</div>
                        <div>لا توجد نتائج بحث مطابقة لـ "${search}"</div>
                        <div style="font-size: 0.9rem; margin-top: 10px;">جرب استخدام مصطلحات بحث أخرى</div>
                    `;
                }
                return;
            }
            
            tbody.style.display = '';
            noUsersMessage.style.display = 'none';
            
            displayedUsers.forEach((uName, index) => {
                const user = appData.users[uName];
                const typeName = appData.userTypes[user.type].name;
                const typeClass = `type-${user.type}`;
                const isCurrentUser = (currentUser && currentUser.username === uName);
                const isActive = user.active !== false;
                const rowNum = startIndex + index + 1;
                
                const canDelete = currentUser && 
                                 currentUser.permissions.delete_users && 
                                 currentUser.permissions.can_delete_types.includes(user.type) &&
                                 !isCurrentUser;
                
                const canSeePassword = currentUser && 
                                      currentUser.permissions.view_passwords;
                
                let rowHTML = `
                    <tr>
                        <td style="font-weight: bold;">
                            ${uName}
                            ${isCurrentUser ? ' <span style="color:#1976d2; font-size:0.8rem;">(أنت)</span>' : ''}
                        </td>
                        <td><span class="user-type-badge ${typeClass}">${typeName}</span></td>
                        <td class="password-cell" id="password-cell-${uName}">
                            ${canSeePassword ? 
                                `<span class="password-visible">${user.password}</span>` : 
                                `<span class="password-masked">••••••••</span>`
                            }
                            ${canSeePassword ? 
                                `<button class="toggle-password-cell" onclick="togglePasswordVisibility('${uName}')" title="إخفاء">👁️</button>` : 
                                ''
                            }
                        </td>
                        <td>
                            ${canDelete ? 
                                `<button class="delete-user-btn" onclick="deleteUser('${uName}')" title="حذف المستخدم">
                                    🗑️ حذف
                                </button>` : 
                                ''
                            }
                        </td>
                    </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
            
            // Update pagination info
            const showingTo = Math.min(startIndex + displayedUsers.length, totalUsers);
            paginationInfo.textContent = `عرض ${startIndex + 1} إلى ${showingTo} من أصل ${totalUsers} مستخدم`;
            
            // Show/hide load more button
            if (endIndex < totalUsers) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.textContent = `عرض المزيد من المستخدمين (${Math.min(appData.usersLimit, totalUsers - endIndex)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        window.togglePasswordVisibility = function(username) {
            const cell = document.getElementById(`password-cell-${username}`);
            const user = appData.users[username];
            const span = cell.querySelector('span');
            const button = cell.querySelector('button');
            
            if (span.classList.contains('password-masked')) {
                span.classList.remove('password-masked');
                span.classList.add('password-visible');
                span.textContent = user.password;
                button.title = "إخفاء";
                button.textContent = "🔒";
            } else {
                span.classList.remove('password-visible');
                span.classList.add('password-masked');
                span.textContent = '••••••••';
                button.title = "إظهار";
                button.textContent = "👁️";
            }
        };

        window.deleteUser = function(username) {
            const currentUser = appData.currentUser;
            const targetUser = appData.users[username];
            
            if (!currentUser || !currentUser.permissions.delete_users) {
                alert('ليس لديك صلاحية لحذف المستخدمين');
                return;
            }
            
            if (!currentUser.permissions.can_delete_types.includes(targetUser.type)) {
                alert('ليس لديك صلاحية لحذف هذا النوع من المستخدمين');
                return;
            }
            
            if (username === 'admin') {
                alert('لا يمكن حذف حساب المدير الرئيسي (admin)');
                return;
            }
            
            if (username === currentUser.username) {
                alert('لا يمكن حذف حسابك الخاص أثناء استخدام النظام');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف المستخدم "${username}"؟\n\nهذا الإجراء لا يمكن التراجع عنه.`)) {
                db.ref('users/' + username).remove()
                    .then(() => {
                        alert('✅ تم حذف المستخدم بنجاح');
                        appData.currentUsersPage = 0; // Reset to first page
                        renderUsersManagement();
                    })
                    .catch(err => {
                        alert('خطأ في حذف المستخدم: ' + err.message);
                    });
            }
        };

        // Load more users button handler
        document.getElementById('load-more-users-btn').addEventListener('click', function() {
            appData.currentUsersPage++;
            renderUsersManagement();
            // Scroll to bottom of table
            document.querySelector('.users-table').scrollIntoView({ behavior: 'smooth', block: 'end' });
        });

        document.getElementById('add-user-btn').addEventListener('click', () => {
            const currentUser = appData.currentUser;
            
            if (!currentUser || !currentUser.permissions.add_users) {
                alert('ليس لديك صلاحية لإضافة مستخدمين');
                return;
            }
            
            document.getElementById('user-form-container').style.display = 'block';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            
            const sel = document.getElementById('new-user-type');
            sel.innerHTML = '';
            
            currentUser.permissions.can_add_types.forEach(k => {
                sel.innerHTML += `<option value="${k}">${appData.userTypes[k].name}</option>`;
            });
            
            if (sel.options.length === 0) {
                alert('ليس لديك صلاحية لإضافة أي نوع من المستخدمين');
                document.getElementById('user-form-container').style.display = 'none';
            }
        });

        document.getElementById('cancel-user-btn').addEventListener('click', () => {
            document.getElementById('user-form-container').style.display = 'none';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
        });

        document.getElementById('save-user-btn').addEventListener('click', () => {
            const currentUser = appData.currentUser;
            
            if (!currentUser || !currentUser.permissions.add_users) {
                alert('ليس لديك صلاحية لإضافة مستخدمين');
                return;
            }
            
            const name = document.getElementById('new-username').value.trim();
            const pass = document.getElementById('new-password').value.trim();
            const type = document.getElementById('new-user-type').value;
            
            if (!currentUser.permissions.can_add_types.includes(type)) {
                alert('ليس لديك صلاحية لإضافة هذا النوع من المستخدمين');
                return;
            }
            
            if(!name) {
                alert('يرجى إدخال اسم المستخدم');
                document.getElementById('new-username').focus();
                return;
            }
            
            if(!pass) {
                alert('يرجى إدخال كلمة المرور');
                document.getElementById('new-password').focus();
                return;
            }
            
            if(name.toLowerCase() === 'admin') {
                alert('لا يمكن استخدام اسم "admin" لمستخدم جديد');
                return;
            }
            
            if(appData.users[name]) {
                alert('المستخدم موجود بالفعل في النظام');
                return;
            }
            
            db.ref('users/' + name).set({
                type: type,
                password: pass,
                active: true
            }).then(() => {
                alert('✅ تمت إضافة المستخدم بنجاح');
                document.getElementById('user-form-container').style.display = 'none';
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                appData.currentUsersPage = 0; // Reset to first page
                renderUsersManagement();
            }).catch(err => {
                alert('خطأ في إضافة المستخدم: ' + err.message);
            });
        });

        // Search in users management
        document.getElementById('search-user-input').addEventListener('keyup', function() {
            appData.currentUsersPage = 0;
            renderUsersManagement();
        });
document.getElementById('consumptions-btn').addEventListener('click', () => {
    // أ) تعبئة قائمة المناطق
    const zoneSelect = document.getElementById('cons-filter-zone');
    if (zoneSelect && zoneSelect.options.length <= 1) {
        zoneSelect.innerHTML = '<option value="all">كل المناطق</option>';
        appData.zones.forEach(z => {
            zoneSelect.innerHTML += `<option value="${z}">${z}</option>`;
        });
    }

    // ب) استدعاء دالة تحديث المحطات بناءً على المنطقة
    if (typeof updateConsStationFilter === 'function') {
        updateConsStationFilter();
    }

    // ج) ضبط التواريخ الافتراضية
    const today = new Date();
    const firstDayThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    
    const dateToElem = document.getElementById('cons-filter-date-to');
    const dateFromElem = document.getElementById('cons-filter-date-from');
    
    if(dateToElem) dateToElem.valueAsDate = firstDayThisMonth;
    if(dateFromElem) dateFromElem.valueAsDate = firstDayLastMonth;

    renderConsumptionsTable();
    showScreen('consumptions-report');
});

// دالة مساعدة جديدة: تحديث قائمة المحطات عند تغيير المنطقة
window.updateConsStationFilter = function() {
    const zone = document.getElementById('cons-filter-zone').value;
    const stationSelect = document.getElementById('cons-filter-station');
    
    if(!stationSelect) return;

    stationSelect.innerHTML = '<option value="all">كل المحطات</option>';
    
    const sortedStations = Object.values(appData.stations).sort((a,b) => a.name.localeCompare(b.name));
    
    sortedStations.forEach(s => {
        if (zone === 'all' || s.zone === zone) {
            stationSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`;
        }
    });
};

window.renderConsumptionsTable = function() {
    // 1. جلب قيم الفلاتر
    const zoneFilter = document.getElementById('cons-filter-zone').value; // تم إضافة هذا السطر
    const stationFilter = document.getElementById('cons-filter-station').value;
    const dateFrom = document.getElementById('cons-filter-date-from').value;
    const dateTo = document.getElementById('cons-filter-date-to').value;
    const tbody = document.getElementById('consumptions-table-body');
    
    if (!dateFrom || !dateTo) {
        alert('يرجى اختيار تاريخ البداية والنهاية');
        return;
    }
    
    tbody.innerHTML = '';
    
    let filteredConsumptions = appData.consumptionLog || [];
    
    // 2. تصفية حسب التاريخ (موجود مسبقاً)
    filteredConsumptions = filteredConsumptions.filter(c => {
        const logDate = c.date; // التنسيق: DD/MM/YYYY
        const [d, m, y] = logDate.split('/');
        const logDateISO = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return logDateISO >= dateFrom && logDateISO <= dateTo;
    });

    // 3. (تصحيح هام) تصفية حسب المنطقة - كان مفقوداً
    if (zoneFilter !== 'all') {
        filteredConsumptions = filteredConsumptions.filter(c => {
            const sData = appData.stations[c.station];
            // التأكد من أن المحطة موجودة وتنتمي للمنطقة المختارة
            return sData && sData.zone === zoneFilter;
        });
    }

    // 4. تصفية حسب المحطة (موجود مسبقاً)
    if (stationFilter !== 'all') {
        filteredConsumptions = filteredConsumptions.filter(c => c.station === stationFilter);
    }
    
    if (filteredConsumptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">لا توجد بيانات استهلاك مطابقة للفلاتر المحددة</td></tr>';
        return;
    }
    
    // 5. تجميع البيانات حسب المحطة
    const stationsData = {};
    filteredConsumptions.forEach(log => {
        if (!stationsData[log.station]) {
            stationsData[log.station] = [];
        }
        stationsData[log.station].push(log);
    });

    // 6. معالجة كل محطة وعرضها
    Object.keys(stationsData).forEach(stationName => {
        const stationLogs = stationsData[stationName];
        
        // ترتيب البيانات حسب التاريخ والوقت تصاعدياً
        stationLogs.sort((a, b) => {
            const dateA = parseCustomDate(`${a.date} ${a.time}`);
            const dateB = parseCustomDate(`${b.date} ${b.time}`);
            return dateA - dateB;
        });
        
        // مطابقة منطق الإكسيل: أول قراءة في الفترة وآخر قراءة في الفترة
        const fromReading = stationLogs[0];
        const toReading = stationLogs[stationLogs.length - 1];
        
        // حساب الاستهلاك (الأخير - الأول)
        const consumptionT1 = (parseFloat(toReading.t1) || 0) - (parseFloat(fromReading.t1) || 0);
        const consumptionT2 = (parseFloat(toReading.t2) || 0) - (parseFloat(fromReading.t2) || 0);
        const consumptionM3 = (parseFloat(toReading.m3) || 0) - (parseFloat(fromReading.m3) || 0);

        // تنسيق تواريخ القراءات للعرض
        const fromDateFormatted = fromReading.date;
        const fromTimeFormatted = fromReading.time ? fromReading.time.substring(0, 5) : '-';
        const toDateFormatted = toReading.date;
        const toTimeFormatted = toReading.time ? toReading.time.substring(0, 5) : '-';
        
        // إنشاء صف جديد
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${stationName}</td>
            <td class="cons-cell">
                <div class="cons-sub-item">
                    <span class="cons-label">سابق:</span>
                    <span>${parseFloat(fromReading.t1) || 0}</span>
                </div>
                <div class="cons-sub-item">
                    <span class="cons-label">حالي:</span>
                    <span>${parseFloat(toReading.t1) || 0}</span>
                </div>
                <div class="cons-result">${consumptionT1.toFixed(2)}</div>
                <div class="cons-date-small">
                    ${fromDateFormatted} ${fromTimeFormatted} → ${toDateFormatted} ${toTimeFormatted}
                </div>
            </td>
            <td class="cons-cell">
                <div class="cons-sub-item">
                    <span class="cons-label">سابق:</span>
                    <span>${parseFloat(fromReading.t2) || 0}</span>
                </div>
                <div class="cons-sub-item">
                    <span class="cons-label">حالي:</span>
                    <span>${parseFloat(toReading.t2) || 0}</span>
                </div>
                <div class="cons-result">${consumptionT2.toFixed(2)}</div>
                <div class="cons-date-small">
                    ${fromDateFormatted} ${fromTimeFormatted} → ${toDateFormatted} ${toTimeFormatted}
                </div>
            </td>
            <td class="cons-cell">
                <div class="cons-sub-item">
                    <span class="cons-label">سابق:</span>
                    <span>${parseFloat(fromReading.m3) || 0}</span>
                </div>
                <div class="cons-sub-item">
                    <span class="cons-label">حالي:</span>
                    <span>${parseFloat(toReading.m3) || 0}</span>
                </div>
                <div class="cons-result">${consumptionM3.toFixed(2)}</div>
                <div class="cons-date-small">
                    ${fromDateFormatted} ${fromTimeFormatted} → ${toDateFormatted} ${toTimeFormatted}
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
};
window.exportConsumptionsToExcel = function() {
    const zoneFilter = document.getElementById('cons-filter-zone').value;
    const stationFilter = document.getElementById('cons-filter-station').value;
    const dateFrom = document.getElementById('cons-filter-date-from').value;
    const dateTo = document.getElementById('cons-filter-date-to').value;
    
    if (!dateFrom || !dateTo) { alert('يرجى اختيار التواريخ'); return; }

    let filtered = appData.consumptionLog || [];

    filtered = filtered.filter(c => {
        const [d, m, y] = c.date.split('/');
        const iso = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return iso >= dateFrom && iso <= dateTo;
    });

    filtered = filtered.filter(c => {
        const sData = appData.stations[c.station];
        const sZone = sData ? sData.zone : '';
        if (zoneFilter !== 'all' && sZone !== zoneFilter) return false;
        if (stationFilter !== 'all' && c.station !== stationFilter) return false;
        return true;
    });

    if (filtered.length === 0) { alert('لا توجد بيانات للتصدير'); return; }

    const dataRows = [];
    dataRows.push(["المنطقة", "المحطة", "نوع البيان", "القراءة السابقة", "تاريخ السابق", "القراءة الحالية", "تاريخ الحالي", "قيمة الاستهلاك", "الوحدة"]);

    const stationsData = {};
    filtered.forEach(log => {
        if (!stationsData[log.station]) stationsData[log.station] = [];
        stationsData[log.station].push(log);
    });

    Object.keys(stationsData).forEach(stName => {
        const logs = stationsData[stName];
        logs.sort((a, b) => parseCustomDate(`${a.date} ${a.time}`) - parseCustomDate(`${b.date} ${b.time}`));
        
        const first = logs[0];
        const last = logs[logs.length - 1];
        const zone = appData.stations[stName]?.zone || 'غير محدد';

        const t1 = (parseFloat(last.t1)||0) - (parseFloat(first.t1)||0);
        const t2 = (parseFloat(last.t2)||0) - (parseFloat(first.t2)||0);
        const m3 = (parseFloat(last.m3)||0) - (parseFloat(first.m3)||0);

        dataRows.push([zone, stName, "محول 1", parseFloat(first.t1), first.date, parseFloat(last.t1), last.date, t1, "KW"]);
        dataRows.push([zone, stName, "محول 2", parseFloat(first.t2), first.date, parseFloat(last.t2), last.date, t2, "KW"]);
        dataRows.push([zone, stName, "مياه (M3)", parseFloat(first.m3), first.date, parseFloat(last.m3), last.date, m3, "M3"]);
        dataRows.push([]); 
    });

    const ws = XLSX.utils.aoa_to_sheet(dataRows);
    ws['!cols'] = [
        { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 10 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "تقرير الاستهلاكات");
    XLSX.writeFile(wb, `Consumptions_${dateFrom}_${dateTo}.xlsx`);
};
        // --- FAULTS & HISTORY LOGIC ---
        function renderHistoryTable(applyFilters = false) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            let data = [...appData.operationHistory];
            
            if (applyFilters) {
                const fZone = document.getElementById('filter-zone').value;
                const fStation = document.getElementById('filter-station').value;
                const fDateFrom = document.getElementById('filter-date-from').value;
                const fDateTo = document.getElementById('filter-date-to').value;
              
                
                // Filter by zone
                const zoneSelect = document.getElementById('filter-zone');
                if (zoneSelect.options.length <= 1) {
                    zoneSelect.innerHTML = '<option value="all">كل المناطق</option>';
                    appData.zones.forEach(z => zoneSelect.innerHTML += `<option value="${z}">${z}</option>`);
                }
                
                if (fZone !== 'all') {
                    const zoneStations = Object.values(appData.stations).filter(s => s.zone === fZone).map(s => s.name);
                    data = data.filter(d => zoneStations.includes(d.station));
                }
                
                // Update station filter based on selected zone
                const stationSelect = document.getElementById('filter-station');
                stationSelect.innerHTML = '<option value="all">كل المحطات</option>';
                
                let filteredStations = Object.values(appData.stations);
                if (fZone !== 'all') {
                    filteredStations = filteredStations.filter(s => s.zone === fZone);
                }
                
                filteredStations.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                    stationSelect.innerHTML += `<option value="${s.name}" ${fStation === s.name ? 'selected' : ''}>${s.name}</option>`;
                });
                
                if (fStation !== 'all') {
                    data = data.filter(d => d.station === fStation);
                }
                
                if (fDateFrom) {
                    data = data.filter(d => {
                        const logDate = parseCustomDate(d.date + ' ' + d.time);
                        return logDate && logDate >= new Date(fDateFrom);
                    });
                }
                
                if (fDateTo) {
                    const toDate = new Date(fDateTo);
                    toDate.setHours(23,59,59);
                    data = data.filter(d => {
                        const logDate = parseCustomDate(d.date + ' ' + d.time);
                        return logDate && logDate <= toDate;
                    });
                }
            }
            
            data.forEach(log => {
                if (!log.operator || log.operator === 'undefined') {
                    log.operator = 'مستخدم النظام';
                }
            });
            
            const viewData = data.slice(0, appData.historyLimit);
            viewData.forEach(log => {
                // التحقق إذا كان السجل يحتوي على تغيير حالة المحطة
                let rowClass = '';
                let statusChangeHtml = '';
                
                if (log.details && (log.details.includes('نشطة -> متوقفة') || log.details.includes('متوقفة -> نشطة'))) {
                    rowClass = 'status-change-row';
                    
                    if (log.details.includes('نشطة -> متوقفة')) {
                        rowClass += ' status-to-inactive';
                        statusChangeHtml = `<span class="status-change-badge status-change-inactive">🔴 توقف</span> `;
                    } else if (log.details.includes('متوقفة -> نشطة')) {
                        statusChangeHtml = `<span class="status-change-badge status-change-active">🟢 تشغيل</span> `;
                    }
                }
                
                // عرض توقيت التشغيل والإيقاف
                const startTimeHtml = log.startTime ? 
                    `<div style="color:#27ae60; font-weight:bold;">${log.startTime}</div>` : 
                    '<div style="color:#888; font-size:0.9rem;">-</div>';
                
                const stopTimeHtml = log.stopTime ? 
                    `<div style="color:#c0392b; font-weight:bold;">${log.stopTime}</div>` : 
                    '<div style="color:#888; font-size:0.9rem;">-</div>';
                
                tbody.innerHTML += `<tr class="${rowClass}">
                    <td>
                        <div style="font-weight:bold">${log.date}</div>
                        <div style="font-size:0.85rem; color:#666">${log.time}</div>
                    </td>
                    <td>${log.station}</td>
                    <td>${log.operator}</td>
                    <td>${startTimeHtml}</td>
                    <td>${stopTimeHtml}</td>
                    <td>${statusChangeHtml}${log.details}</td>
                </tr>`;
            });
            
            document.getElementById('history-status-text').textContent = `عرض ${viewData.length} من أصل ${data.length}`;
            
            const loadMoreBtn = document.getElementById('load-more-history-btn');
            if (viewData.length < data.length) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Load more history button handler
        document.getElementById('load-more-history-btn').addEventListener('click', function() {
            appData.historyLimit += 100;
            renderHistoryTable(true);
        });
// دالة حساب مدة العطل (بالصيغة المختصرة: ي، س)
function calculateFaultDuration(startTimeStr) {
    if (!startTimeStr) return "-";
    
    const start = parseCustomDate(startTimeStr);
    if (!start) return "-";

    const now = new Date();
    const diffMs = now - start;

    if (diffMs < 0) return "< 1س";

    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHrs = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    let result = "";
    
    if (diffDays > 0) {
        result += `${diffDays}ي `; // مسافة صغيرة بعد اليوم
    }
    
    if (diffHrs > 0) {
        result += `${diffHrs}س`;
    }

    if (diffDays === 0 && diffHrs === 0) {
        return "< 1س";
    }

    return result.trim();
}
        
function renderFaultsLog() {
    const activeBody = document.getElementById('active-faults-body');
    const historyBody = document.getElementById('history-faults-body');
    const fStation = document.getElementById('fault-archive-station-filter').value;
    const loadMoreBtn = document.getElementById('load-more-faults-btn');
    
    activeBody.innerHTML = '';
    historyBody.innerHTML = '';

    // --- أولاً: عرض الأعطال النشطة ---
    const stationsList = Object.values(appData.stations);
    let hasActiveFaults = false;

    stationsList.forEach(s => {
        // حساب مدة العطل مرة واحدة للمحطة
        const startTime = s.faultStartTime || s.lastUpdate;
        const durationStr = calculateFaultDuration(startTime); // استدعاء الدالة المختصرة

        // 1. فحص العطل الرئيسي
        if (s.currentFault) {
            hasActiveFaults = true;
            const icon = faultIcons[s.currentFault] || '⚠️';
            const desc = s.fault1Desc ? ` <div style="font-size:0.8rem; color:#666; margin-top:2px;">(${s.fault1Desc})</div>` : '';
            
            activeBody.innerHTML += `<tr>
                <td style="font-weight:bold;">${s.name}</td>
                <td style="color:var(--danger-color); font-weight:bold">
                    ${icon} ${s.currentFault}
                    ${desc}
                </td>
                <td>${startTime || '-'}</td>
                <td><span class="status-inactive" style="font-size:0.9rem; font-weight:bold;">${durationStr}</span></td>
            </tr>`;
        }

        // 2. فحص العطل الثانوي
        if (s.secondaryFault) {
            hasActiveFaults = true;
            const icon = faultIcons[s.secondaryFault] || '⚠️';
            const desc = s.fault2Desc ? ` <div style="font-size:0.8rem; color:#666; margin-top:2px;">(${s.fault2Desc})</div>` : '';
            
            activeBody.innerHTML += `<tr>
                <td style="font-weight:bold;">${s.name}</td>
                <td style="color:var(--scada-fault-color); font-weight:bold">
                    ${icon} ${s.secondaryFault}
                    ${desc}
                </td>
                <td>${startTime || '-'}</td>
                <td><span class="status-inactive" style="font-size:0.9rem; font-weight:bold;">${durationStr}</span></td>
            </tr>`;
        }
    });

    if (!hasActiveFaults) {
        activeBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:green; padding: 20px;">✅ لا توجد أعطال نشطة حالياً</td></tr>`;
    }

    // --- ثانياً: عرض الأرشيف (السجل التاريخي) ---
    let histFaults = appData.faultsLog.filter(f => !f.active);
    if (fStation !== 'all') histFaults = histFaults.filter(f => f.station === fStation);
    
    // ترتيب تنازلي (الأحدث أولاً)
    histFaults.sort((a, b) => {
        const dateA = parseCustomDate(a.endTime);
        const dateB = parseCustomDate(b.endTime);
        return dateB - dateA;
    });

    const totalFaults = histFaults.length;
    const displayedFaults = histFaults.slice(0, appData.faultsLimit);
    
    displayedFaults.forEach(f => {
        const icon = faultIcons[f.type] || '⚠️';
        historyBody.innerHTML += `<tr>
            <td>${f.station}</td>
            <td>${icon} ${f.type}</td>
            <td>${f.startTime || '-'}</td>
            <td style="direction: ltr;">${f.endTime || '-'}</td>
            <td style="color:green; font-weight:bold;">تم الإصلاح</td>
        </tr>`;
    });

    document.getElementById('faults-status-text').textContent = `عرض ${displayedFaults.length} من أصل ${totalFaults} عطل سابق`;
    
    if (displayedFaults.length < totalFaults) {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.textContent = `عرض 100 عطل إضافي (إجمالي ${Math.min(appData.faultsLimit + 100, totalFaults)})`;
    } else {
        loadMoreBtn.style.display = 'none';
    }
    
    const filterSel = document.getElementById('fault-archive-station-filter');
    if (filterSel.options.length <= 1) {
        const sorted = Object.values(appData.stations).sort((a,b) => a.name.localeCompare(b.name));
        sorted.forEach(s => filterSel.innerHTML += `<option value="${s.name}">${s.name}</option>`);
    }
}
        function updateStationFilter() {
            const z = document.getElementById('filter-zone').value;
            const s = document.getElementById('filter-station');
            s.innerHTML = '<option value="all">كل المحطات</option>';
            const list = Object.values(appData.stations).filter(st => z === 'all' || st.zone === z);
            list.sort((a,b) => a.name.localeCompare(b.name)).forEach(st => s.innerHTML += `<option value="${st.name}">${st.name}</option>`);
        }

        // Initial Load
        checkRememberedUser();
        loadSystemData();
// --- دعم زر الرجوع في الموبايل (Mobile Back Button Logic) ---
        
        // 1. نحتفظ بنسخة من دالة العرض الأصلية
        const _originalShowScreen = showScreen;

        // 2. نقوم بتعديل دالة showScreen لإضافة "نقطة عودة" في ذاكرة المتصفح
        showScreen = function(screenId) {
            // تنفيذ الدالة الأصلية لتبديل الشاشة
            _originalShowScreen(screenId);

            // إذا كانت الشاشة الجديدة "شاشة فرعية" (ليست الدخول ولا الرئيسية)
            // نقوم بإضافة حالة جديدة لتاريخ المتصفح حتى يشعر زر الرجوع بوجود خطوة سابقة
            if (screenId !== 'login' && screenId !== 'stations') {
                // التأكد من عدم تكرار الحالة الحالية لتجنب تراكم التاريخ
                if (!history.state || history.state.screen !== screenId) {
                    window.history.pushState({screen: screenId}, null, `#${screenId}`);
                }
            }
        };


        // 3. الاستماع لحدث الضغط على زر "Back" في الموبايل
window.addEventListener('popstate', function(event) {
    
    // أ) التعامل مع القائمة العائمة (إذا كانت مفتوحة، نغلقها أولاً)
    const floatingMenu = document.getElementById('floating-menu');
    if (floatingMenu && floatingMenu.classList.contains('active')) {
        floatingMenu.classList.remove('active');
        // نعيد دفع الحالة لأننا لم نغير الشاشة، فقط أغلقنا القائمة
        window.history.pushState(null, null, window.location.href);
        return;
    }

    // ب) التعامل مع الشاشات
    // معرفة الشاشة النشطة حالياً
    const activeScreen = document.querySelector('.screen.active');
    // إذا كنا في أي شاشة غير "تسجيل الدخول" وغير "الرئيسية"
    if (activeScreen && activeScreen.id !== 'login-screen' && activeScreen.id !== 'stations-screen') {
        // نعود للشاشة الرئيسية يدوياً
        _originalShowScreen('stations');
        
        // --- التعديل هنا: تم حذف الكود الذي كان يعيد التبويب إلى "الكل" ---
        // وبدلاً من ذلك، نضمن أن المحطات المعروضة هي الخاصة بالمنطقة المحفوظة
        if (appData.currentZone) {
            renderStations(appData.currentZone);
        }
    }
});

        // 4. إضافة نقطة بداية عند تحميل التطبيق لمنع الخروج الفوري
        window.addEventListener('load', function() {
            if (window.location.hash) {
                // تنظيف الرابط عند التحميل
                window.history.replaceState(null, null, ' ');
            }
        });
/* =========================================
   كود تشغيل الحاسبة (تم دمجه من Source 1)
   ========================================= */

// 1. تفعيل زر القائمة وزر العودة
document.getElementById('calculator-btn').addEventListener('click', () => {
    showScreen('calculator');
    // إضافة جهاز واحد افتراضي إذا كانت القائمة فارغة
    const list = document.getElementById('machinesList');
    if(list && list.children.length === 0) {
        addMachineCalc();
    }
});

document.getElementById('back-to-stations-from-calc').addEventListener('click', () => showScreen('stations'));

// 2. دوال الحاسبة (تمت إعادة تسميتها لتجنب التعارض)
function addMachineCalc() {
    const container = document.getElementById('machinesList');
    const div = document.createElement('div');
    div.className = 'machine-card';
    
    // تم تصميم أيقونة خاصة (SVG) عبارة عن دائرة خضراء بداخلها خط نصف قطر
    const pivotIcon = `
    <svg width="24" height="24" viewBox="0 0 24 24" style="vertical-align: middle;">
        <circle cx="12" cy="12" r="10" fill="#27ae60" /> <line x1="12" y1="12" x2="21" y2="4" stroke="white" stroke-width="2.5" stroke-linecap="round" /> <circle cx="12" cy="12" r="3" fill="white" /> </svg>
    `;

    div.innerHTML = `
        <div class="machine-title" style="font-weight:bold; display:flex; align-items:center; gap:5px; width:110px;">
            ${pivotIcon}
            <span class="device-name">جهاز</span>
        </div>
        <div class="input-group">
            <input type="number" class="tower-input" placeholder="عدد الأبراج" min="1" style="padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div class="single-result" style="display:none; background:#f0f0f0; padding:5px; font-size:0.8rem; margin:0 5px;"></div>
        <button class="btn btn-delete" onclick="removeMachineCalc(this)">🗑️</button>
    `;
    container.appendChild(div);
    renumberMachinesCalc();
}

function removeMachineCalc(btn) {
    btn.closest('.machine-card').remove();
    renumberMachinesCalc();
    if(document.getElementById('grandTotalBox').style.display === 'block') {
        calculateAllCalc();
    }
}

function renumberMachinesCalc() {
    const cards = document.querySelectorAll('#calculator-screen .machine-card');
    cards.forEach((card, index) => {
        const titleSpan = card.querySelector('.device-name');
        titleSpan.innerText = `جهاز ${index + 1}`;
    });
}

function calculateAllCalc() {
    const spanLength = 55;
    const waterPerFeddan = 32.5;
    let totalFed = 0, totalM3 = 0, count = 0;
    
    // تحديد المدخلات داخل شاشة الحاسبة فقط
    const inputs = document.querySelectorAll('#calculator-screen .tower-input');
    
    for (let input of inputs) {
        const towers = parseFloat(input.value);
        const resultDiv = input.closest('.machine-card').querySelector('.single-result');

        if (towers > 0) {
            count++;
            const radius = towers * spanLength;
            const areaFed = (Math.PI * Math.pow(radius, 2)) / 4200;
            const dailyWater = areaFed * waterPerFeddan;
            const m3h = dailyWater / 24;

            totalFed += areaFed;
            totalM3 += m3h;
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `مساحة: <b>${areaFed.toFixed(1)}</b> فدان | مياه: <b>${m3h.toFixed(1)}</b> م³/س`;
        } else {
            resultDiv.style.display = 'none';
        }
    }

    const totalLPS = (totalM3 * 1000) / 3600;
    document.getElementById('calcTotalMachines').innerText = count;
    document.getElementById('calcTotalFeddan').innerText = totalFed.toFixed(2);
    document.getElementById('calcTotalM3').innerText = totalM3.toFixed(1);
    document.getElementById('calcTotalLPS').innerText = totalLPS.toFixed(1);
    document.getElementById('grandTotalBox').style.display = 'block';
}

// 3. دوال المحولات
function switchToolCalc() {
    const selectedTool = document.getElementById('toolSelect').value;
    const flowBox = document.getElementById('flowConverter');
    const powerBox = document.getElementById('powerConverter');

    flowBox.classList.remove('active');
    powerBox.classList.remove('active');

    if (selectedTool === 'flow') {
        flowBox.classList.add('active');
    } else if (selectedTool === 'power') {
        powerBox.classList.add('active');
    }
}

function convertFlowCalc() {
    const val = parseFloat(document.getElementById('flowInput').value);
    const from = document.getElementById('flowFrom').value;
    const to = document.getElementById('flowTo').value;
    const resBox = document.getElementById('flowResult');

    if (isNaN(val)) { resBox.innerText = "0"; return; }

    let baseM3H = 0;
    if (from === 'm3h') baseM3H = val;
    else if (from === 'ls') baseM3H = val * 3.6;
    else if (from === 'gpm') baseM3H = val * 0.227125;

    let result = 0;
    let unitLabel = "";
    
    if (to === 'm3h') { result = baseM3H; unitLabel = "م³/س"; }
    else if (to === 'ls') { result = baseM3H / 3.6; unitLabel = "لتر/ث"; }
    else if (to === 'gpm') { result = baseM3H / 0.227125; unitLabel = "GPM"; }

    resBox.innerText = result.toFixed(2) + " " + unitLabel;
}

function convertPowerCalc() {
    const val = parseFloat(document.getElementById('powerInput').value);
    const from = document.getElementById('powerFrom').value;
    const to = document.getElementById('powerTo').value;
    const resBox = document.getElementById('powerResult');

    if (isNaN(val)) { resBox.innerText = "0"; return; }

    let result = 0;
    let unitLabel = "";
    if (from === to) {
        result = val;
    } else if (from === 'hp' && to === 'kw') {
        result = val * 0.7457;
    } else if (from === 'kw' && to === 'hp') {
        result = val * 1.341;
    }

    if (to === 'hp') unitLabel = "حصان";
    else unitLabel = "كيلوواط";
    resBox.innerText = result.toFixed(2) + " " + unitLabel;
}

// جعل الدوال متاحة عالمياً (في حال وجود strict mode أو وحدات)
window.addMachineCalc = addMachineCalc;
window.removeMachineCalc = removeMachineCalc;
window.calculateAllCalc = calculateAllCalc;
window.switchToolCalc = switchToolCalc;
window.convertFlowCalc = convertFlowCalc;
window.convertPowerCalc = convertPowerCalc;
// ==========================================
// كود تصدير السجل العام (History Log Export)
// ==========================================

document.getElementById('btn-export-history').addEventListener('click', function() {
    exportHistoryLog();
});

function exportHistoryLog() {
    // 1. تحديد نوع الملف
    const format = document.getElementById('history-export-format').value;
    
    // 2. تطبيق الفلاتر للحصول على البيانات المعروضة فقط (أو المطلوبة)
    let data = [...appData.operationHistory]; // نسخة من البيانات الأصلية
    
    const fZone = document.getElementById('filter-zone').value;
    const fStation = document.getElementById('filter-station').value;
    const fDateFrom = document.getElementById('filter-date-from').value;
    const fDateTo = document.getElementById('filter-date-to').value;

    // فلترة المنطقة
    if (fZone !== 'all') {
        const zoneStations = Object.values(appData.stations).filter(s => s.zone === fZone).map(s => s.name);
        data = data.filter(d => zoneStations.includes(d.station));
    }

    // فلترة المحطة
    if (fStation !== 'all') {
        data = data.filter(d => d.station === fStation);
    }

    // فلترة التاريخ (من)
    if (fDateFrom) {
        data = data.filter(d => {
            const logDate = parseCustomDate(d.date + ' ' + d.time);
            return logDate && logDate >= new Date(fDateFrom);
        });
    }

    // فلترة التاريخ (إلى)
    if (fDateTo) {
        const toDate = new Date(fDateTo);
        toDate.setHours(23, 59, 59);
        data = data.filter(d => {
            const logDate = parseCustomDate(d.date + ' ' + d.time);
            return logDate && logDate <= toDate;
        });
    }

    if (data.length === 0) {
        alert('⚠️ لا توجد بيانات في السجل مطابقة لخيارات البحث للتصدير.');
        return;
    }

    // 3. تجهيز البيانات وتنسيقها (إزالة HTML من التفاصيل)
    const formattedData = data.map(log => {
        // تنظيف حقل التفاصيل من أي كود HTML (مثل الألوان والبادجات)
        let cleanDetails = log.details || "";
        // استبدال وسوم HTML بنص فارغ للحصول على النص فقط
        cleanDetails = cleanDetails.replace(/<[^>]*>?/gm, ''); 
        // استبدال رموز الأسهم لتظهر بشكل صحيح
        cleanDetails = cleanDetails.replace(/&nbsp;/g, ' ');

        return {
            "التاريخ": log.date,
            "الوقت": log.time,
            "المحطة": log.station,
            "المشغل": log.operator || "مستخدم النظام",
            "وقت التشغيل": log.startTime || "-",
            "وقت الإيقاف": log.stopTime || "-",
            "تفاصيل العملية": cleanDetails
        };
    });

    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];

    // 4. التصدير بناءً على النوع المختار
    if (format === 'xlsx') {
        // --- تصدير Excel ---
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(formattedData);

        // تنسيق عرض الأعمدة
        const wscols = [
            {wch: 12}, // التاريخ
            {wch: 10}, // الوقت
            {wch: 20}, // المحطة
            {wch: 20}, // المشغل
            {wch: 15}, // وقت التشغيل
            {wch: 15}, // وقت الإيقاف
            {wch: 80}  // التفاصيل (عريض ليظهر النص كاملاً)
        ];
        ws['!cols'] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "سجل العمليات");
        XLSX.writeFile(wb, `سجل_العمليات_${dateStr}.xlsx`);

    } else {
        // --- تصدير CSV ---
        // تحويل البيانات إلى صيغة CSV يدوياً للتحكم الأفضل
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM لدعم العربية
        
        // العناوين
        csvContent += "التاريخ,الوقت,المحطة,المشغل,وقت التشغيل,وقت الإيقاف,تفاصيل العملية\n";

        formattedData.forEach(row => {
            // معالجة النصوص التي تحتوي على فواصل بوضعها بين علامات تنصيص
            const details = row["تفاصيل العملية"].replace(/"/g, '""'); // الهروب من علامات التنصيص
            
            const csvRow = [
                `"${row["التاريخ"]}"`,
                `"${row["الوقت"]}"`,
                `"${row["المحطة"]}"`,
                `"${row["المشغل"]}"`,
                `"${row["وقت التشغيل"]}"`,
                `"${row["وقت الإيقاف"]}"`,
                `"${details}"`
            ].join(",");
            
            csvContent += csvRow + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `سجل_العمليات_${dateStr}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
// --- إدارة التزامن (Offline Queue) ---
function addToOfflineQueue(actionType, data) {
    let queue = JSON.parse(localStorage.getItem('toshka_offline_queue') || '[]');
    queue.push({ action: actionType, data: data, timestamp: Date.now() });
    localStorage.setItem('toshka_offline_queue', JSON.stringify(queue));
    updateOfflineBanner();
}

function updateOfflineBanner() {
    const queue = JSON.parse(localStorage.getItem('toshka_offline_queue') || '[]');
    const banner = document.getElementById('offline-sync-banner');
    const countSpan = document.getElementById('offline-count');
    if (queue.length > 0) {
        banner.style.display = 'block';
        countSpan.textContent = queue.length;
    } else {
        banner.style.display = 'none';
    }
}

function processOfflineQueue() {
    if (!navigator.onLine || !isFirebaseConnected) return;

    let queue = JSON.parse(localStorage.getItem('toshka_offline_queue') || '[]');
    if (queue.length === 0) return;

    console.log(`Attempting to sync ${queue.length} items...`);
    
    // نأخذ نسخة ونفرغ الطابور مؤقتاً لتجنب التكرار، إذا فشل سنعيدهم
    const currentQueue = [...queue];
    localStorage.setItem('toshka_offline_queue', '[]');
    updateOfflineBanner();

    // معالجة كل عنصر
    currentQueue.forEach(item => {
        if (item.action === 'update_station') {
            const d = item.data;
            db.ref('stations/' + d.stationId).update(d.updates);
            if(d.log) db.ref('history').push(d.log);
            if(d.consLog) db.ref('consumption_logs').push(d.consLog);
            // معالجة الأعطال بنفس المنطق... (اختصاراً هنا)
        }
        else if (item.action === 'update_inspection') {
            const d = item.data;
            db.ref(`stations/${d.stationId}/inspectionData`).update(d.inspectionData);
            if(d.log) db.ref('history').push(d.log);
        }
        // ... باقي الحالات
    });
    
    // ملاحظة: في التطبيقات المعقدة ننتظر التأكيد (Promises)، 
    // لكن للتبسيط هنا نرسل ونفترض النجاح طالما الاتصال "connected"
}
/* ==========================================================
   كود نظام البلاغات وأوامر الشغل (جديد V1.6)
   ========================================================== */

// 1. التهيئة والمتغيرات
let currentReportId = null; // لتخزين ID البلاغ الجاري العمل عليه في الـ Modals

// الاستماع لأزرار القائمة الجديدة
document.getElementById('fault-reporting-btn').addEventListener('click', () => {
    showScreen('fault-reporting');
    initFaultReportingScreen();
});
document.getElementById('work-orders-btn').addEventListener('click', () => {
    showScreen('work-orders');
    renderWorkOrdersTables();
});
document.getElementById('back-to-stations-from-reports').addEventListener('click', () => showScreen('stations'));
document.getElementById('back-to-stations-from-orders').addEventListener('click', () => showScreen('stations'));

// 2. دوال شاشة تسجيل البلاغات
function initFaultReportingScreen() {
    // تعيين مقدم البلاغ
    const reporter = appData.currentUser ? (appData.currentUser.name || appData.currentUser.username) : 'مستخدم';
    document.getElementById('report-reporter').value = reporter;

    // تعبئة المناطق
    const zoneSelect = document.getElementById('report-zone');
    zoneSelect.innerHTML = '<option value="">اختر المنطقة</option>';
    appData.zones.forEach(z => {
        zoneSelect.innerHTML += `<option value="${z}">${z}</option>`;
    });
    
    // تعبئة فلتر الجدول
    const filterZone = document.getElementById('filter-report-zone');
    if(filterZone.options.length <= 1) {
        appData.zones.forEach(z => { filterZone.innerHTML += `<option value="${z}">${z}</option>`; });
    }

    renderFaultReportsTable();
}

function updateReportStations() {
    const zone = document.getElementById('report-zone').value;
    const stationSelect = document.getElementById('report-station');
    stationSelect.innerHTML = '<option value="">اختر المحطة</option>';
    
    if (!zone) return;

    const filteredStations = Object.values(appData.stations).filter(s => s.zone === zone);
    filteredStations.sort((a,b) => a.name.localeCompare(b.name));
    filteredStations.forEach(s => {
        stationSelect.innerHTML += `<option value="${s.name}" data-pumps="${s.pumps ? s.pumps.length : 4}">${s.name}</option>`;
    });
}

function updateReportComponents() {
    const stationSelect = document.getElementById('report-station');
    const compSelect = document.getElementById('report-component');
    compSelect.innerHTML = '<option value="">حدد مكان العطل</option>';
    
    if (!stationSelect.value) return;

    // الحصول على عدد المضخات من البيانات المخزنة في الـ Option
    const selectedOption = stationSelect.options[stationSelect.selectedIndex];
    const pumpCount = parseInt(selectedOption.getAttribute('data-pumps')) || 4;

    // القائمة الثابتة
    const components = [
        "منظومة التحضير", "خط الطرد الرئيسي", "منظومة الطرق المائي", 
        "أنظمة التحكم (PLC/SCADA)", "الونش", "لوحات الكهرباء", 
        "التهوية"  ,"شبكات المياه"  , "التكييفات", "الغواطس", "المحولات", "الإنارة", "تجهيزات ومباني"
    ];

    // إضافة المضخات ديناميكياً
    for(let i=1; i<=pumpCount; i++) {
        compSelect.innerHTML += `<option value="مضخة ${i}">مضخة ${i}</option>`;
    }

    // إضافة باقي المكونات
    components.forEach(c => {
        compSelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
}

// 3. إرسال البلاغ
document.getElementById('btn-send-report').addEventListener('click', () => {
    const reporter = document.getElementById('report-reporter').value;
    const zone = document.getElementById('report-zone').value;
    const station = document.getElementById('report-station').value;
    const component = document.getElementById('report-component').value;
    const desc = document.getElementById('report-desc').value;

    if(!zone || !station || !component || !desc) {
        alert("يرجى ملء جميع الحقول المطلوبة");
        return;
    }

    const nowStd = getStandardDateTime();
    const newReport = {
        date: nowStd.date,
        time: nowStd.time,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        reporter: reporter,
        zone: zone,
        station: station,
        component: component,
        description: desc,
        status: 'pending', // pending -> confirmed -> work_order -> archived
        supervisorStatus: 'pending' // pending -> confirmed -> cancelled
    };

    db.ref('fault_reports').push(newReport).then(() => {
        alert("تم إرسال البلاغ بنجاح ✅");
        document.getElementById('report-desc').value = '';
        document.getElementById('report-component').value = '';
    });
});

// 4. عرض جدول البلاغات (Real-time)
db.ref('fault_reports').on('value', (snapshot) => {
    if(document.getElementById('fault-reporting-screen').classList.contains('active')) {
        renderFaultReportsTable();
    }
});

// --- دالة عرض جدول البلاغات (المصححة) ---
function renderFaultReportsTable() {
    const tbody = document.getElementById('fault-reports-body');
    // لا تقم بمسح الجدول هنا فوراً لتجنب الوميض، انتظر البيانات
    
    db.ref('fault_reports').orderByChild('timestamp').limitToLast(100).once('value', (snap) => {
        const data = [];
        snap.forEach(child => { data.unshift({key: child.key, ...child.val()}); }); // الأحدث أولاً
        
        const filterZone = document.getElementById('filter-report-zone').value;
        const filterStatus = document.getElementById('filter-report-status').value;
        const userType = appData.currentUser ? appData.currentUser.type : 'guest';
        
        // --- الصلاحيات ---
        const canConfirm = ['supervisor', 'engineer', 'admin'].includes(userType);
        const canAdminAction = ['engineer', 'admin'].includes(userType);
        const canEditDesc = ['admin', 'engineer', 'supervisor'].includes(userType);
        
        let rowsHtml = ''; // متغير لتجميع كود HTML

        data.forEach(item => {
            // تجاهل ما تم تحويله لأمر شغل
            if (item.status === 'work_order' || item.status === 'archived') return;
            
            // الفلاتر
            if (filterZone !== 'all' && item.zone !== filterZone) return;
            if (filterStatus === 'pending' && item.supervisorStatus !== 'pending') return;
            if (filterStatus === 'confirmed' && item.supervisorStatus !== 'confirmed') return;
            
            // تحديد حالة الصف
            let statusBadge = '<span class="status-inactive">انتظار</span>';
            if(item.supervisorStatus === 'confirmed') statusBadge = '<span class="status-active">مؤكد</span>';
            if(item.supervisorStatus === 'cancelled') statusBadge = '<span style="color:red">ملغي</span>';
let descHtml = item.description || '';

// استخدام encodeURIComponent لحماية النص من أي رموز تكسر الكود (مثل " أو ' أو سطر جديد)
const safeDescForEdit = encodeURIComponent(item.description || '');

if (canEditDesc) {
    // نفك التشفير decodeURIComponent عند الضغط
    descHtml += ` <span style="cursor:pointer; color:#2980b9; font-size:1.2em; margin-right:5px;" title="تعديل الوصف" onclick="editReportDescription('${item.key}', decodeURIComponent('${safeDescForEdit}'))">✎</span>`;
}
            let supBtns = '-';
            if (canConfirm && item.supervisorStatus === 'pending') {
                supBtns = `
                    <button class="btn btn-success btn-sm" onclick="confirmReport('${item.key}', true)">✅ تأكيد</button>
                    <button class="btn btn-danger btn-sm" onclick="confirmReport('${item.key}', false)">❌ إلغاء</button>
                `;
            } else if (item.supervisorStatus !== 'pending') {
                const badge = item.supervisorStatus === 'confirmed' ? 
                    '<span style="color:green; font-weight:bold;">تم التأكيد</span>' : 
                    '<span style="color:red; font-weight:bold;">تم الإلغاء</span>';
                const supervisorName = item.confirmedBy || 'غير مسجل';
                supBtns = `
                    <div>${badge}</div>
                    <div style="font-size: 0.85rem; color: #555; margin-top: 4px;"> 👤 ${supervisorName} </div>
                `;
            }
            
            // أزرار الإدارة
            let adminBtns = '-';
            if (canAdminAction) {
                if (item.supervisorStatus === 'confirmed') {
                    adminBtns = `
                        <button class="btn btn-primary btn-sm" onclick="openWorkOrderModal('${item.key}')">🛠️ أمر شغل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteReport('${item.key}')">🗑️ حذف</button>
                    `;
                } else if (item.supervisorStatus === 'cancelled') {
                    adminBtns = `
                        <button class="btn btn-danger btn-sm" onclick="deleteReport('${item.key}')">🗑️ حذف</button>
                    `;
                }
            }
            
            // تجميع الصف
            rowsHtml += `
                <tr>
                    <td>${item.date}<br>${item.time}</td>
                    <td>${item.zone}<br><b>${item.station}</b></td>
                    <td>${item.reporter}</td>
                    <td>${item.component}</td>
                    <td>${descHtml}</td>
                    <td>${statusBadge}</td>
                    <td>${supBtns}</td>
                    <td>${adminBtns}</td>
                </tr>
            `;
        });
        
        // تحديث الجدول مرة واحدة فقط في النهاية
        tbody.innerHTML = rowsHtml;
    });
}
// 5. إجراءات الجدول (تأكيد / تحويل)
window.confirmReport = function(key, isConfirmed) {
    if(!confirm(isConfirmed ? "تأكيد صحة البلاغ؟" : "هل أنت متأكد من إلغاء البلاغ؟")) return;
    db.ref(`fault_reports/${key}`).update({
        supervisorStatus: isConfirmed ? 'confirmed' : 'cancelled',
        confirmedBy: appData.currentUser.username
    });
};
window.deleteReport = function(key) {
    if(!confirm("هل أنت متأكد من حذف هذا البلاغ نهائياً من السجل؟")) return;
    db.ref(`fault_reports/${key}`).remove()
    // تم إزالة renderFaultReportsTable() لأن التحديث سيحدث تلقائياً
    .catch(err => alert("حدث خطأ: " + err.message));
};
// دالة تعديل وصف البلاغ
window.editReportDescription = function(key, currentDesc) {
    // طلب الوصف الجديد من المستخدم
    const newDesc = prompt("الرجاء إدخال الوصف الجديد:", currentDesc);
    
    // التحقق من أن المستخدم لم يضغط "إلغاء" وأن النص قد تغير
    if (newDesc !== null && newDesc.trim() !== "" && newDesc !== currentDesc) {
        db.ref('fault_reports/' + key).update({ description: newDesc })
            .then(() => {
                // التحديث سيظهر تلقائياً لأن الجدول يستمع للتغييرات
                alert("✅ تم تعديل الوصف بنجاح");
            })
            .catch(err => alert("حدث خطأ: " + err.message));
    }
};
// Modal Handling
window.openWorkOrderModal = function(key) {
    currentReportId = key;
    document.getElementById('modal-dept-select').classList.add('show');
    // تصفير الاختيارات
    document.querySelectorAll('.dept-checkbox-group input').forEach(c => c.checked = false);
};

window.closeModal = function(id) {
    document.getElementById(id).classList.remove('show');
    currentReportId = null;
};

// إنشاء أمر الشغل
document.getElementById('btn-confirm-work-order').addEventListener('click', () => {
    if(!currentReportId) return;
    
    // جمع الأقسام المختارة
    const selectedDepts = [];
    document.querySelectorAll('.dept-checkbox-group input:checked').forEach(cb => {
        selectedDepts.push(cb.value);
    });

    if(selectedDepts.length === 0) {
        alert("يجب اختيار قسم واحد على الأقل");
        return;
    }

    // جلب بيانات البلاغ الأصلي
    db.ref(`fault_reports/${currentReportId}`).once('value', (snap) => {
        const report = snap.val();
        const nowStd = getStandardDateTime();

        const workOrder = {
            reportId: currentReportId,
            startTimestamp: firebase.database.ServerValue.TIMESTAMP, // لحساب المدة
            startDate: nowStd.date,
            startTime: nowStd.time,
            zone: report.zone,
            station: report.station,
            component: report.component,
            description: report.description,
            departments: selectedDepts,
            status: 'active', // active -> fixed
            issuedBy: appData.currentUser.username
        };

        // حفظ أمر الشغل وتحديث حالة البلاغ
        db.ref('work_orders').push(workOrder).then(() => {
            db.ref(`fault_reports/${currentReportId}`).update({ status: 'work_order' });
            closeModal('modal-dept-select');
            alert("تم إصدار أمر الشغل بنجاح وتحويله للقسم المختص 🛠️");
            renderWorkOrdersTables();
        });
    });
});

// 6. شاشة أوامر الشغل (Tables)
db.ref('work_orders').on('value', (snapshot) => {
    if(document.getElementById('work-orders-screen').classList.contains('active')) {
        renderWorkOrdersTables();
    }
});


// 7. إتمام الإصلاح
window.openFixModal = function(key) {
    currentReportId = key; // نستخدم نفس المتغير global
    document.getElementById('fix-desc').value = '';
    document.getElementById('fix-parts').value = '';
    document.getElementById('modal-fix-details').classList.add('show');
};

document.getElementById('btn-confirm-fix').addEventListener('click', () => {
    if(!currentReportId) return;
    const fixDesc = document.getElementById('fix-desc').value;
    const fixParts = document.getElementById('fix-parts').value;

    if(!fixDesc) { alert("يجب كتابة وصف للإصلاح"); return; }

    // جلب الأمر لحساب المدة
    db.ref(`work_orders/${currentReportId}`).once('value', (snap) => {
        const order = snap.val();
        const nowStd = getStandardDateTime();
        const nowTs = Date.now();
        
        const diffTime = Math.abs(nowTs - (order.startTimestamp || nowTs));
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const updateData = {
            status: 'fixed',
            fixDate: nowStd.date,
            fixTime: nowStd.time,
            fixDescription: fixDesc,
            spareParts: fixParts,
            fixedBy: appData.currentUser.username,
            durationDays: diffDays
        };

        db.ref(`work_orders/${currentReportId}`).update(updateData).then(() => {
            closeModal('modal-fix-details');
            alert("تم تسجيل الإصلاح وإغلاق أمر الشغل ✅");
            renderWorkOrdersTables();
        });
    });
});

// 8. التصدير (Reports & Archive)
window.exportReportsTable = function() {
    // تجميع البيانات من الجدول المعروض
    const table = document.querySelector('.reports-table'); // الجدول الأول
    // استخدام مكتبة XLSX الموجودة لديك
    const wb = XLSX.utils.table_to_book(table, {sheet: "بلاغات الأعطال"});
    XLSX.writeFile(wb, `بلاغات_الأعطال_${getStandardDateTime().date.replace(/\//g,'-')}.xlsx`);
};

window.exportWorkOrdersArchive = function() {
    // تصدير الأرشيف الكامل من الداتابيز
    db.ref('work_orders').orderByChild('status').equalTo('fixed').once('value', (snap) => {
        const data = [];
        data.push(["تاريخ البدء", "تاريخ الإصلاح", "المدة (يوم)", "المنطقة", "المحطة", "الأقسام", "العطل", "الوصف", "وصف الإصلاح", "قطع الغيار", "القائم بالإصلاح"]);
        
        snap.forEach(child => {
            const o = child.val();
            data.push([
                o.startDate, o.fixDate, o.durationDays, o.zone, o.station, 
                (o.departments || []).join(', '), o.component, o.description,
                o.fixDescription, o.spareParts, o.fixedBy
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "أرشيف الإصلاحات");
        XLSX.writeFile(wb, `سجل_الاصلاحات_${getStandardDateTime().date.replace(/\//g,'-')}.xlsx`);
    });
};

// --- تحديث الصلاحيات لعرض الأزرار في القائمة ---
// أضف هذا الجزء داخل دالة login-btn event listener أو دالة تحديث المستخدم
function updateMenuPermissions() {
    if(!appData.currentUser) return;
    const type = appData.currentUser.type;
    const woBtn = document.getElementById('work-orders-btn');
    
    // أوامر الشغل متاحة للمهندس والمدير فقط
    if(type === 'admin' || type === 'engineer') {
        woBtn.style.display = 'block';
    } else {
        woBtn.style.display = 'none';
    }
}
// --- تهيئة المتغيرات الجديدة للحدود (Pagination) ---
appData.activeOrdersLimit = 100;
appData.archiveOrdersLimit = 100;

// دوال التحكم في عدد الصفوف المعروضة
function resetActiveLimit() { appData.activeOrdersLimit = 100; }
function resetArchiveLimit() { appData.archiveOrdersLimit = 100; }

function loadMoreActiveOrders() {
    appData.activeOrdersLimit += 100;
    renderWorkOrdersTables();
}

function loadMoreArchiveOrders() {
    appData.archiveOrdersLimit += 100;
    renderWorkOrdersTables();
}

// تحديث قائمة المناطق في الفلتر عند فتح الشاشة
document.getElementById('work-orders-btn').addEventListener('click', () => {
    showScreen('work-orders');
    
    // تعبئة فلتر المناطق
    const zoneSelect = document.getElementById('wo-filter-zone');
    if (zoneSelect.options.length <= 1) {
        appData.zones.forEach(z => {
            zoneSelect.innerHTML += `<option value="${z}">${z}</option>`;
        });
    }
    
    resetActiveLimit();
    resetArchiveLimit();
    renderWorkOrdersTables();
});

// --- الدالة الرئيسية لعرض الجداول (معدلة بالكامل) ---
// --- الدالة الرئيسية لعرض الجداول (المصححة) ---
function renderWorkOrdersTables() {
    const activeBody = document.getElementById('active-work-orders-body');
    const archiveBody = document.getElementById('archive-work-orders-body');
    
    // التأكد من وجود العناصر قبل البدء لتجنب الأخطاء
    if (!activeBody || !archiveBody) return;

    // قراءة قيم الفلاتر الجارية
    const fZoneElement = document.getElementById('wo-filter-zone');
    const fZone = fZoneElement ? fZoneElement.value : '';
    
    const fFaultElement = document.getElementById('wo-filter-fault');
    const fFault = fFaultElement ? fFaultElement.value.toLowerCase() : '';
    
    const fDeptElement = document.getElementById('wo-filter-dept');
    const fDept = fDeptElement ? fDeptElement.value : '';
    
    const fDurationElement = document.getElementById('wo-filter-duration');
    const fDuration = fDurationElement ? (parseInt(fDurationElement.value) || 0) : 0;
    
    const searchArchiveElement = document.getElementById('archive-search');
    const searchArchive = searchArchiveElement ? searchArchiveElement.value.toLowerCase() : '';

    activeBody.innerHTML = '';
    archiveBody.innerHTML = '';
    const now = Date.now();

    // التأكد من وجود حدود للصفحات، إذا لم تكن موجودة نضع قيمة افتراضية
    if (typeof appData.activeOrdersLimit === 'undefined') appData.activeOrdersLimit = 100;
    if (typeof appData.archiveOrdersLimit === 'undefined') appData.archiveOrdersLimit = 100;

    // تهيئة مخزن البيانات للأوامر (هام جداً لعمل النافذة العائمة)
    appData.workOrders = {};

    // جلب البيانات من Firebase مباشرة
    db.ref('work_orders').once('value', (snap) => {
        let allOrders = [];
        
        snap.forEach(c => { 
            const val = c.val();
            const key = c.key;
            // تخزين البيانات في appData لكي تستخدمها نوافذ التجميد والإصلاح
            appData.workOrders[key] = val; 
            // إضافتها للمصفوفة للمعالجة
            allOrders.push({key: key, ...val}); 
        });

        // ترتيب: الأحدث أولاً
        allOrders.sort((a, b) => (b.startTimestamp || 0) - (a.startTimestamp || 0));

        // فصل البيانات وتطبيق الفلاتر
        let activeOrders = [];
        let archiveOrders = [];

        allOrders.forEach(order => {
            // حساب المدة
            const startTs = order.startTimestamp || now;
            const diffTime = Math.abs(now - startTs);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // 1. منطق التصفية للأوامر الجارية (Active)
            if (order.status === 'active') {
                let match = true;
                if (fZone && fZone !== 'all' && order.zone !== fZone) match = false;
                if (fDept && order.departments && !order.departments.includes(fDept)) match = false;
                if (fFault && !((order.component || '').toLowerCase().includes(fFault) ||
                    (order.description || '').toLowerCase().includes(fFault))) match = false;
                if (fDuration > 0 && diffDays < fDuration) match = false;

                if (match) activeOrders.push({...order, diffDays});
            } 
            // 2. منطق التصفية للأرشيف (Fixed)
            else if (order.status === 'fixed') {
                const text = `${order.station} ${order.component} ${order.description} ${order.fixDescription}`.toLowerCase();
                if (!searchArchive || text.includes(searchArchive)) {
                    archiveOrders.push(order);
                }
            }
        });

        // --- عرض الأوامر الجارية (Active) ---
        if (activeOrders.length === 0) {
            activeBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:15px; color:#777;">لا توجد أوامر شغل مطابقة للفلاتر</td></tr>';
            const btnLoadMore = document.getElementById('load-more-active-wo');
            if(btnLoadMore) btnLoadMore.style.display = 'none';
        } else {
            // تطبيق الحد الأقصى للعرض
            const displayedActive = activeOrders.slice(0, appData.activeOrdersLimit);
            
            displayedActive.forEach(order => {
                // تنسيق الأقسام
                let deptsHtml = '';
                if (order.departments && Array.isArray(order.departments)) {
                    order.departments.forEach(d => {
                        let cls = 'dept-civil';
                        if(d==='ميكانيكا') cls='dept-mech';
                        if(d==='كهرباء') cls='dept-elec';
                        if(d==='I&C') cls='dept-ic';
                        if(d==='شبكات') cls='dept-net';
                        if(d==='تكييف') cls='dept-hvac';
                        deptsHtml += `<span class="work-order-badge ${cls}">${d}</span>`;
                    });
                } else { deptsHtml = '<span style="color:#999; font-size:0.8rem;">عام</span>'; }

                // --- منطق الأزرار وحالة التجميد ---
                let actionButtons = '';
                let rowStyle = '';

                if (order.isFrozen) {
                    // حالة التجميد
                    rowStyle = 'background-color: #fff8e1; border-right: 4px solid #f39c12;'; 
                    actionButtons = `
                        <button class="btn btn-warning btn-sm" onclick="openFreezeModal('${order.key}')" title="عرض سبب التجميد / تعديل" style="width:100%">
                            ❄️ مجمد (عرض السبب)
                        </button>
                    `;
                } else {
                    // الحالة العادية
                    actionButtons = `
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-warning btn-sm" onclick="openFreezeModal('${order.key}')" title="تجميد العمل" style="flex:1">❄️ تجميد</button>
                            <button class="btn btn-success btn-sm" onclick="openFixModal('${order.key}')" title="تم الإصلاح" style="flex:1">✅ تم</button>
                        </div>
                    `;
                }

                activeBody.innerHTML += `
                    <tr style="${rowStyle}">
                        <td>${order.startDate || '-'}</td>
                        <td>${order.zone || ''}<br><b>${order.station || ''}</b></td>
                        <td>${deptsHtml}</td>
                        <td>${order.component || ''}</td>
                        <td>${order.description || ''}</td>
                        <td>${order.issuedBy || '-'}</td>
                        <td style="color:${order.isFrozen ? '#e67e22' : 'red'}; font-weight:bold">${order.diffDays} يوم</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            });

            // زر المزيد
            const btnLoadMore = document.getElementById('load-more-active-wo');
            if (btnLoadMore) {
                if (activeOrders.length > appData.activeOrdersLimit) {
                    btnLoadMore.style.display = 'block';
                    btnLoadMore.textContent = `⬇️ عرض المزيد (${activeOrders.length - appData.activeOrdersLimit} متبقي)`;
                } else {
                    btnLoadMore.style.display = 'none';
                }
            }
        }

        // --- عرض الأرشيف (Archive) ---
        if (archiveOrders.length === 0) {
            archiveBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:15px; color:#777;">لا توجد نتائج في الأرشيف</td></tr>';
            const btnLoadMoreArch = document.getElementById('load-more-archive-wo');
            if(btnLoadMoreArch) btnLoadMoreArch.style.display = 'none';
        } else {
            const displayedArchive = archiveOrders.slice(0, appData.archiveOrdersLimit);
            displayedArchive.forEach(order => {
                let deptsHtml = '';
                if (order.departments && Array.isArray(order.departments)) {
                    order.departments.forEach(d => {
                        deptsHtml += `<span class="work-order-badge dept-civil" style="background:#777">${d}</span>`;
                    });
                }

                archiveBody.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-size:0.8rem">البدء: ${order.startDate || '-'}</div>
                            <div style="font-size:0.8rem; color:green">الإصلاح: ${order.fixDate || '-'}</div>
                        </td>
                        <td>${order.durationDays || 0} يوم</td>
                        <td>${order.station || ''}</td>
                        <td>${deptsHtml}</td>
                        <td>${order.component || ''}<br><span style="color:#666;font-size:0.8rem">${order.description || ''}</span></td>
                        <td>
                            <div>${order.fixDescription || ''}</div>
                            ${order.spareParts ? `<div style="color:#e67e22;font-size:0.8rem">🛒 ${order.spareParts}</div>` : ''}
                        </td>
                        <td>${order.fixedBy || '-'}</td>
                    </tr>
                `;
            });

            const btnLoadMoreArch = document.getElementById('load-more-archive-wo');
            if(btnLoadMoreArch) {
                if (archiveOrders.length > appData.archiveOrdersLimit) {
                    btnLoadMoreArch.style.display = 'block';
                    btnLoadMoreArch.textContent = `⬇️ عرض المزيد (${archiveOrders.length - appData.archiveOrdersLimit} متبقي)`;
                } else {
                    btnLoadMoreArch.style.display = 'none';
                }
            }
        }
    });
}
// --- دالة تصدير أوامر الشغل الجارية (المفلترة) ---
function exportActiveWorkOrders() {
    // نستخدم نفس منطق الفلترة للحصول على البيانات
    const fZone = document.getElementById('wo-filter-zone').value;
    const fFault = document.getElementById('wo-filter-fault').value.toLowerCase();
    const fDept = document.getElementById('wo-filter-dept').value;
    const fDuration = parseInt(document.getElementById('wo-filter-duration').value) || 0;
    const now = Date.now();

    db.ref('work_orders').orderByChild('status').equalTo('active').once('value', (snap) => {
        let data = [];
        // العناوين
        data.push(["تاريخ البدء", "المنطقة", "المحطة", "الأقسام", "العطل", "الوصف", "الصادر عنه", "المدة الحالية (يوم)"]);

        snap.forEach(child => {
            const o = child.val();
            const startTs = o.startTimestamp || now;
            const diffTime = Math.abs(now - startTs);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            let match = true;
            if (fZone && o.zone !== fZone) match = false;
            if (fDept && o.departments && !o.departments.includes(fDept)) match = false;
            if (fFault && !((o.component || '').toLowerCase().includes(fFault) || (o.description || '').toLowerCase().includes(fFault))) match = false;
            if (fDuration > 0 && diffDays < fDuration) match = false;

            if (match) {
                data.push([
    o.startDate, o.zone, o.station, 
    (o.departments || []).join(', '), o.component, o.description, o.issuedBy || '-', diffDays
]);
            }
        });

        if (data.length <= 1) {
            alert("لا توجد بيانات مطابقة للتصدير");
            return;
        }

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "أوامر الشغل الجارية");
        XLSX.writeFile(wb, `اوامر_شغل_جارية_${getStandardDateTime().date.replace(/\//g,'-')}.xlsx`);
    });
}
document.getElementById('btn-go-to-archive').addEventListener('click', () => {
    showScreen('archive-work-orders');
    // إعادة تعيين الحد وعرض البيانات عند الدخول للشاشة
    resetArchiveLimit(); 
    renderWorkOrdersTables(); 
});

// 2. تفعيل زر العودة من الأرشيف إلى شاشة الأوامر
document.getElementById('back-from-archive').addEventListener('click', () => {
    showScreen('work-orders');
});
// متغير لتخزين معرف الأمر الحالي
let currentFreezeOrderId = null;

function openFreezeModal(orderId) {
    currentFreezeOrderId = orderId; // تخزين المعرف لاستخدامه عند الحفظ
    
    // جلب بيانات الأمر من الذاكرة المحلية للتطبيق
    const order = appData.workOrders[orderId]; 
    if (!order) {
        alert("عفواً، لم يتم العثور على بيانات هذا الأمر.");
        return;
    }

    // تعريف عناصر النافذة المنبثقة (Modal Elements)
    const modal = document.getElementById('modal-freeze');
    const title = document.getElementById('freeze-modal-title');
    const reasonInput = document.getElementById('freeze-reason-input');
    const userInput = document.getElementById('freeze-user-input');
    const saveBtn = document.getElementById('btn-save-freeze');
    const resolveBtn = document.getElementById('btn-resolve-from-freeze');
    
    // تحديد المستخدم الحالي (من قام بالإجراء)
    const currentUser = appData.currentUser ? 
        (appData.currentUser.username || appData.currentUser.name) : 'مستخدم النظام';

    // عرض النافذة
    modal.classList.add('show');

    // === التحقق من حالة الأمر (هل هو مجمد حالياً أم جديد؟) ===
    if (order.isFrozen) {
        // --- السيناريو 1: الأمر مجمد بالفعل (عرض/تعديل السبب + زر إصلاح) ---
        title.textContent = "❄️ تفاصيل التجميد (تعديل)";
        reasonInput.value = order.freezeReason || ''; // عرض السبب القديم
        userInput.value = order.frozenBy || currentUser;
        
        saveBtn.textContent = "💾 تعديل السبب";
        saveBtn.className = "btn btn-warning"; // لون أصفر للتعديل
        
        // إظهار زر "تم الإصلاح"
        resolveBtn.style.display = "inline-block";
        
        // ** برمجة زر "تم الإصلاح" داخل نافذة التجميد **
        resolveBtn.onclick = function() {
            closeModal('modal-freeze'); // إغلاق نافذة التجميد
            // فتح نافذة الإصلاح الأصلية (بنفس منطق الزر المباشر)
            setTimeout(() => {
                openFixModal(orderId); 
            }, 200); // تأخير بسيط لضمان إغلاق النافذة الأولى
        };

    } else {
        // --- السيناريو 2: تجميد لأول مرة ---
        title.textContent = "❄️ تجميد أمر الشغل";
        reasonInput.value = ''; // تفريغ الحقل للكتابة الجديدة
        userInput.value = currentUser;
        
        saveBtn.textContent = "❄️ حفظ وتجميد";
        saveBtn.className = "btn btn-warning";
        
        // إخفاء زر "تم الإصلاح" (لأنه يجب تجميده أولاً)
        resolveBtn.style.display = "none";
    }

    // === برمجة زر الحفظ (Save Button Logic) - الجزء المفقود ===
    saveBtn.onclick = function() {
        const reason = reasonInput.value.trim();
        
        if (!reason) {
            alert("⚠️ يجب كتابة سبب تجميد العمل!");
            reasonInput.focus();
            return;
        }

        // تجهيز البيانات للتحديث في Firebase
        const updates = {
            isFrozen: true,            // علامة أن الأمر مجمد
            freezeReason: reason,      // سبب التجميد
            frozenBy: userInput.value, // من قام بالتجميد
            frozenAt: getStandardDateTime().full // توقيت التجميد
        };

        // الحفظ في قاعدة البيانات
        db.ref('work_orders/' + orderId).update(updates)
            .then(() => {
                alert("✅ تم حفظ حالة التجميد بنجاح");
                closeModal('modal-freeze');
                renderWorkOrdersTables(); // تحديث الجدول فوراً لتغيير الأزرار
            })
            .catch(error => {
                alert("حدث خطأ أثناء الحفظ: " + error.message);
            });
    };
}

 function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}
// دالة لإظهار زر الحذف بناءً على صلاحية المستخدم
function updateDeleteButtonVisibility() {
    const deleteBtn = document.getElementById('btn-delete-history');
    if (deleteBtn && appData.currentUser) {
        deleteBtn.style.display = (appData.currentUser.type === 'admin') ? 'flex' : 'none';
    }
}

// دالة لفتح نافذة حذف السجلات
function openDeleteHistoryModal() {
    if (appData.currentUser.type !== 'admin') {
        alert('⛔ هذه الصلاحية متاحة فقط للمدير');
        return;
    }
    
    // تحديث عدد السجلات الإجمالي
    const totalRecords = appData.operationHistory.length;
    const deleteCountInput = document.getElementById('delete-count');
    const deleteCountPreview = document.getElementById('delete-count-preview');
    
    // تحديد القيمة القصوى بناءً على عدد السجلات
    const maxDelete = Math.min(totalRecords, 10000);
    deleteCountInput.max = maxDelete;
    
    // تعيين قيمة افتراضية معقولة
    const defaultDelete = Math.min(100, maxDelete);
    deleteCountInput.value = defaultDelete;
    deleteCountPreview.textContent = defaultDelete;
    
    // إضافة مستمع للأحداث
    deleteCountInput.addEventListener('input', function() {
        const value = Math.min(Math.max(1, parseInt(this.value) || 1), maxDelete);
        this.value = value;
        deleteCountPreview.textContent = value;
    });
    
    // فتح النافذة
    document.getElementById('modal-delete-history').classList.add('show');
}

// دالة لتعيين عدد السجلات المطلوب حذفها
window.setDeleteCount = function(count) {
    const deleteCountInput = document.getElementById('delete-count');
    const deleteCountPreview = document.getElementById('delete-count-preview');
    const maxDelete = parseInt(deleteCountInput.max);
    
    const value = Math.min(count, maxDelete);
    deleteCountInput.value = value;
    deleteCountPreview.textContent = value;
};

// دالة لتأكيد الحذف
function confirmDeleteHistory() {
    const deleteCount = parseInt(document.getElementById('delete-count').value);
    const deleteBeforeDate = document.getElementById('delete-before-date').value;
    
    if (!deleteCount || deleteCount < 1) {
        alert('يرجى تحديد عدد السجلات المراد حذفها');
        return;
    }
    
    if (!confirm(`هل أنت متأكد من حذف ${deleteCount} سجل من أقدم السجلات؟\n\n⚠️ هذا الإجراء لا يمكن التراجع عنه!`)) {
        return;
    }
    
    const confirmBtn = document.getElementById('btn-confirm-delete');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<span class="loading-spinner"></span> جاري الحذف...';
    confirmBtn.disabled = true;
    
    // الحصول على أقدم السجلات بناءً على التاريخ
    let recordsToDelete = [...appData.operationHistory];
    
    // إذا تم تحديد تاريخ محدد، فلتر السجلات الأقدم منه
    if (deleteBeforeDate) {
        const selectedDate = new Date(deleteBeforeDate);
        recordsToDelete = recordsToDelete.filter(record => {
            const recordDate = parseCustomDate(record.timestamp || '');
            return recordDate && recordDate < selectedDate;
        });
    }
    
    // ترتيب السجلات من الأقدم للأحدث
    recordsToDelete.sort((a, b) => {
        const dateA = parseCustomDate(a.timestamp || '') || new Date(0);
        const dateB = parseCustomDate(b.timestamp || '') || new Date(0);
        return dateA - dateB;
    });
    
    // تحديد السجلات المراد حذفها
    const recordsToRemove = recordsToDelete.slice(0, deleteCount);
    
    if (recordsToRemove.length === 0) {
        alert('لا توجد سجلات تطابق معايير الحذف');
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
        return;
    }
    
    // إنشاء نسخة جديدة من السجلات بدون السجلات المحددة للحذف
    const updatedHistory = appData.operationHistory.filter(record => 
        !recordsToRemove.some(toDelete => 
            JSON.stringify(toDelete) === JSON.stringify(record)
        )
    );
    
    // حفظ السجلات المحدثة في Firebase
    db.ref('history').set(updatedHistory.reverse()) // إعادة ترتيب من الأحدث للأقدم
        .then(() => {
            // تحديث البيانات المحلية
            appData.operationHistory = updatedHistory;
            
            // تحديث الواجهة
            if (document.getElementById('history-screen').classList.contains('active')) {
                renderHistoryTable(true);
            }
            
            // إظهار رسالة نجاح
            alert(`✅ تم حذف ${recordsToRemove.length} سجل بنجاح`);
            
            // إغلاق النافذة
            closeModal('modal-delete-history');
            
            // إعادة تعيين الزر
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error deleting history:', error);
            alert(`❌ فشل حذف السجلات: ${error.message}`);
            
            // إعادة تعيين الزر
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
}

// دالة إغلاق النافذة
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// إضافة مستمع الأحداث لزر الحذف
document.addEventListener('DOMContentLoaded', function() {
    // إضافة زر الحذف إذا لم يكن موجوداً
    const filtersContainer = document.querySelector('.filters-container');
    if (filtersContainer && !document.getElementById('btn-delete-history')) {
        const deleteButtonHtml = `
            <div class="filter-item" style="display:flex; align-items:flex-end; gap: 5px;">
                <button id="btn-delete-history" class="btn btn-danger" style="height: 38px; display: none;">
                    🗑️ حذف السجلات
                </button>
            </div>
        `;
        
        // إضافة زر الحذف بعد زر التصدير
        const exportDiv = document.querySelector('.filter-item:has(#btn-export-history)');
        if (exportDiv) {
            exportDiv.insertAdjacentHTML('afterend', deleteButtonHtml);
        }
    }
    
    // إضافة مستمع الحدث لزر الحذف
    document.getElementById('btn-delete-history').addEventListener('click', openDeleteHistoryModal);
    
    // إضافة مستمع الحدث لتأكيد الحذف
    document.getElementById('btn-confirm-delete').addEventListener('click', confirmDeleteHistory);
    
    // تحديث ظهور زر الحذف عند الدخول
    updateDeleteButtonVisibility();
});

// تحديث ظهور زر الحذف عند تسجيل الدخول أو تغيير الشاشة
const originalShowScreen = showScreen;
showScreen = function(screenId) {
    originalShowScreen(screenId);
    
    if (screenId === 'history') {
        setTimeout(updateDeleteButtonVisibility, 100);
    }
};

// إضافة مستمع لحدث الإدخال في حقل عدد السجلات
document.addEventListener('input', function(e) {
    if (e.target.id === 'delete-count') {
        const value = parseInt(e.target.value) || 1;
        const maxDelete = parseInt(e.target.max) || 10000;
        const validValue = Math.min(Math.max(1, value), maxDelete);
        
        if (value !== validValue) {
            e.target.value = validValue;
        }
        
        document.getElementById('delete-count-preview').textContent = validValue;
    }
});
    </script>
</body>
</html>
